'use strict';pandora.ui.siteDialog=function(section){var canSeeVersion=pandora.site.capabilities.canSeeSoftwareVersion[pandora.user.level],dialogHeight=Math.round((window.innerHeight-48)*0.75),dialogWidth=Math.round(window.innerWidth*0.75),isEditable=pandora.site.capabilities.canEditSitePages[pandora.user.level],tabs=Ox.clone(pandora.site.sitePages,true).map(function(page){page.title=Ox._(page.title);return page;}).concat([{id:'software',title:Ox._('Software')}]);Ox.getObjectById(tabs,section).selected=true;var $tabPanel=Ox.TabPanel({content:function(id){var $content=Ox.Element().css({padding:'16px',overflowY:'auto'});if(id!='contact'){$content.addClass('OxTextPage');}
if(id=='contact'){pandora.$ui.contactForm=pandora.ui.contactForm().appendTo($content);}else if(id=='news'){pandora.$ui.news=pandora.ui.news(dialogWidth,dialogHeight).appendTo($content);}else if(id=='software'){Ox.Element().html(Ox._('<h1><b>pan.do/ra</b></h1>'
+'<sub>open media archive</sub>'
+'<p><b>{0}</b> is based on <b>pan.do/ra</b>, '
+'a free, open source platform for media archives.</p>'
+'<b>pan.do/ra</b> includes <b>OxJS</b>, '
+'a new JavaScript library for web applications.</p>'
+'<p>To learn more about <b>pan.do/ra</b> and <b>OxJS</b>, '
+'please visit <a href="https://pan.do/ra">pan.do/ra</a> '
+'and <a href="https://oxjs.org">oxjs.org</a>.</p>'
+(canSeeVersion?'<sub><b>{0}'
+'</b> is running <b>pan.do/ra</b> revision '
+'{1}.</sub>':''),[pandora.site.site.name,pandora.site.site.version])).appendTo($content);pandora.createLinks($content);}else{pandora.api.getPage({name:id},function(result){Ox.Editable({clickLink:pandora.clickLink,editable:isEditable,tooltip:isEditable?pandora.getEditTooltip():'',type:'textarea',placeholder:isEditable?Ox._('Doubleclick to insert text'):'',value:result.data.text}).css({width:'100%'}).bindEvent({submit:function(data){Ox.Request.clearCache('getPage');pandora.api.editPage({name:id,text:data.value});}}).appendTo($content);});}
return Ox.SplitPanel({elements:[{element:Ox.Element().css({padding:'16px'}).append($('<img>').attr({src:'/static/png/'+(id=='software'?'software':'logo')+'.png'}).css({width:'256px',height:'auto',marginTop:id=='software'?'-16px':0})),size:272},{element:$content}],orientation:'horizontal'});},tabs:tabs}).bindEvent({change:function(data){that.options({title:Ox.getObjectById(tabs,data.selected).title});pandora.UI.set({page:data.selected});}});var that=Ox.Dialog({buttons:[Ox.Button({id:'close',title:Ox._('Close')}).bindEvent({click:function(){that.close();}})],closeButton:true,content:$tabPanel,height:dialogHeight,maximizeButton:true,minHeight:256,minWidth:688,removeOnClose:true,title:Ox.getObjectById(tabs,section).title,width:dialogWidth}).bindEvent({close:function(data){Ox.getObjectById(tabs,pandora.user.ui.page)&&pandora.UI.set({page:''});},resize:function(data){var selected=$tabPanel.selected();dialogHeight=data.height;dialogWidth=data.width;if(selected=='contact'){pandora.$ui.contactForm.resizeElement();}else if(selected=='news'){pandora.$ui.news.resizeElement(data);}},key_down:function(){pandora.user.ui.page=='news'&&pandora.$ui.news.selectItem(1);},key_up:function(){pandora.user.ui.page=='news'&&pandora.$ui.news.selectItem(-1);}});that.select=function(id){$tabPanel.select(id);return that;};return that;};'use strict';pandora.ui.documentsDialog=function(options){options=options||{};var dialogHeight=Math.round((window.innerHeight-48)*0.9),dialogWidth=Math.round(window.innerWidth*0.9),itemWidth=272+Ox.UI.SCROLLBAR_SIZE,selected=null,$reloadButton=Ox.Button({disabled:true,title:'redo',tooltip:Ox._('Reload'),type:'image'}).css({float:'left',margin:'4px 2px 4px 4px'}).bindEvent({click:function(){$reloadButton.options({disabled:true});Ox.Request.clearCache('findDocuments');$list.reloadList(true);}}),$userCheckbox=Ox.Checkbox({title:Ox._('Only show my documents'),value:false}).css({float:'left',margin:'4px 2px'}).bindEvent({change:function(data){data.value?$robotsCheckbox.show():$robotsCheckbox.hide().options({value:false});updateList();}}),$findSelect=Ox.Select({items:[{id:'all',title:Ox._('Find: All')},{id:'user',title:Ox._('Find: Username')},{id:'file',title:Ox._('Find: Filename')}],overlap:'right',type:'image'}).bindEvent({change:function(data){$findInput.value()&&updateList();$findInput.options({placeholder:data.title});}}),$findInput=Ox.Input({changeOnKeypress:true,clear:true,placeholder:Ox._('Find: All'),width:192}).bindEvent({change:updateList}),$findElement=Ox.FormElementGroup({elements:[$findSelect,$findInput]}).css({float:'right',margin:'4px'}),$list=Ox.TableList({columns:[{id:'user',operator:'+',title:Ox._('Username'),visible:true,width:128},{align:'right',id:'name',operator:'+',title:Ox._('Filename'),visible:true,width:256},{id:'extension',operator:'+',title:Ox._('Extension'),visible:true,width:64},{align:'right',format:function(value){return Ox.formatValue(value,'B');},id:'size',operator:'-',title:Ox._('Size'),visible:true,width:64},{align:'right',id:'matches',operator:'-',title:Ox._('Matches'),visible:true,width:64},{id:'description',operator:'+',title:Ox._('Description'),visible:true,width:256},{align:'right',format:function(value){return Ox.formatDate(value,'%F %T');},id:'created',operator:'-',title:Ox._('Created'),visible:true,width:144},{align:'right',format:function(value){return Ox.formatDate(value,'%F %T');},id:'modified',operator:'-',title:Ox._('Modified'),visible:true,width:144}],columnsVisible:true,items:pandora.api.findDocuments,keys:['ratio'],query:{conditions:[],operator:'&'},scrollbarVisible:true,sort:[{key:'user',operator:'+'}],unique:'id'}).bindEvent({init:function(data){$status.html(Ox.toTitleCase(Ox.formatCount(data.items,'file')));},load:function(){$reloadButton.options({disabled:false});},select:function(data){selected=data.ids[0];selectFile();options.callback&&$doneButton.options({disabled:!data.ids.length});}}),$embedButton=Ox.Button({title:'embed',tooltip:Ox._('Embed'),type:'image'}).css({float:'left',margin:'4px 2px 4px 4px'}).bindEvent({click:function(){pandora.ui.embedDocumentDialog($list.options('selected')[0]).open();}}),$closeButton=Ox.Button({title:'close',tooltip:Ox._('Close'),type:'image'}).css({float:'left',margin:'4px 4px 4px 2px'}).bindEvent({click:function(){$list.options({selected:[]});}}),$item=Ox.Element().css({overflowY:'scroll'}),$preview,$form,$itemToolbar=Ox.Bar({size:24}),$deleteButton=Ox.Button({title:Ox._('Delete Document...'),width:128}).css({float:'left',margin:'4px'}).hide().bindEvent({click:deleteFile}).appendTo($itemToolbar),$doneButton=Ox.Button({disabled:!!options.callback,id:'done',title:options.callback?Ox._('Select'):Ox._('Done'),width:48}).bindEvent({click:function(){options.callback&&options.callback($list.options('selected'));that.close();}}),$uploadButton=Ox.FileButton({maxFiles:1,title:Ox._('Upload Document...'),width:128}).css({float:'right',margin:'4px'}).bindEvent({click:uploadFile}).appendTo($itemToolbar),$content=Ox.SplitPanel({elements:[{element:Ox.SplitPanel({elements:[{element:Ox.Bar({size:24}).append($reloadButton).append($userCheckbox).append($findElement),size:24},{element:$list}],orientation:'vertical'})},{element:Ox.SplitPanel({elements:[{element:Ox.Bar({size:24}).append($itemLabel),size:24},{element:$item},{element:$itemToolbar,size:24}],orientation:'vertical'}).bindEvent({resize:setWidth}),resizable:true,resize:[272+Ox.UI.SCROLLBAR_SIZE,400+Ox.UI.SCROLLBAR_SIZE,528+Ox.UI.SCROLLBAR_SIZE],size:272+Ox.UI.SCROLLBAR_SIZE}],orientation:'horizontal'}),$itemLabel=Ox.Label({textAlign:'center',title:Ox._('No document selected'),width:getLabelWidth()}).css({float:'left',margin:'4px'}),that=Ox.Dialog({buttons:[$doneButton],closeButton:true,content:$content,height:dialogHeight,maximizeButton:true,minHeight:256,minWidth:512,padding:0,removeOnClose:true,title:Ox._('Manage Documents'),width:dialogWidth}),$status=$('<div>').css({position:'absolute',top:'4px',left:'128px',right:'384px',bottom:'4px',paddingTop:'2px',fontSize:'9px',textAlign:'center'}).appendTo(that.find('.OxButtonsbar'));that.superClose=that.close;that.close=function(){Ox.Request.clearCache('findDocuments');that.superClose();};function deleteFile(){pandora.ui.deleteDocumentDialog($list.options('selected')[0],function(){Ox.Request.clearCache('findDocuments');$list.reloadList();}).open();}
function getLabelWidth(){return $content.size(1)-(selected?48:8);}
function getPreviewSize(){var ratio=$list.value(selected,'ratio'),height=ratio<1?256:256/ratio,width=ratio>=1?256:256*ratio,left=Math.floor((itemWidth-16-Ox.UI.SCROLLBAR_SIZE-width)/2);return{height:height,margin:[8,8,8,8+left].map(function(px){return px/2+'px';}).join(' '),width:width};}
function renderForm(){var file=$list.value(selected),editable=file.user==pandora.user.username||pandora.site.capabilities.canEditMedia[pandora.user.level];return Ox.Form({items:[Ox.Input({disabled:true,id:'username',label:Ox._('Username'),labelWidth:80,value:file.user,width:itemWidth-16-Ox.UI.SCROLLBAR_SIZE}),Ox.Input({disabled:!editable,id:'name',label:Ox._('Filename'),labelWidth:80,value:file.name,width:itemWidth-16-Ox.UI.SCROLLBAR_SIZE}),Ox.Input({disabled:true,id:'extension',label:Ox._('Extension'),labelWidth:80,value:file.extension,width:itemWidth-16-Ox.UI.SCROLLBAR_SIZE}),Ox.Input({disabled:true,id:'size',label:Ox._('Size'),labelWidth:80,value:Ox.formatValue(file.size,'B'),width:itemWidth-16-Ox.UI.SCROLLBAR_SIZE}),Ox.Input({disabled:true,id:'matches',label:Ox._('Matches'),labelWidth:80,value:file.matches,width:itemWidth-16-Ox.UI.SCROLLBAR_SIZE}),Ox.Input({disabled:!editable,height:256,id:'description',placeholder:Ox._('Description'),type:'textarea',value:file.description,width:itemWidth-16-Ox.UI.SCROLLBAR_SIZE})],width:240}).css({margin:'12px 8px 8px 8px'}).bindEvent({change:function(event){var data=Ox.extend({id:file.id},event.id,event.data.value);pandora.api.editFile(data,function(result){$list.value(result.data.id,event.id,result.data[event.id]);if(event.id=='name'){$list.value(file.id,'id',result.data.id);}
Ox.Request.clearCache('findDocuments');$list.reloadList();});}});}
function renderPreview(){var isImage=Ox.contains(['jpg','png'],selected.split('.').pop()),size=getPreviewSize(),src='/documents/'+selected+(isImage?'':'.jpg');return Ox.ImageElement({height:size.height,src:src,width:size.width}).css({margin:size.margin,borderRadius:'8px'});}
function selectFile(){var file=$list.value(selected),editable=file.user==pandora.user.username||pandora.site.capabilities.canEditMedia[pandora.user.level];$embedButton[selected?'show':'hide']();$closeButton[selected?'show':'hide']();setLabel();$item.empty();if(selected){$preview=renderPreview().appendTo($item);$form=renderForm().appendTo($item);$deleteButton.options({disabled:!editable}).show();}else{$deleteButton.hide();}}
function setLabel(){$itemLabel.options({title:selected?selected.split(':').slice(1).join(':'):Ox._('No document selected'),width:getLabelWidth()});}
function setWidth(){var size;$itemLabel.options({width:getLabelWidth()});if(selected){size=getPreviewSize(),$preview.options({height:size.height,width:size.width}).css({margin:size.margin});$form.options('items').forEach(function($item){$item.options({width:itemWidth-16-Ox.UI.SCROLLBAR_SIZE});});}
$status.css({right:itemWidth+128+'px'});}
function updateList(){var user=$userCheckbox.value(),key=$findSelect.value(),value=$findInput.value(),query={conditions:value?[].concat(key!='name'?[{key:'user',value:value,operator:'='}]:[],key!='user'?[{key:'name',value:value,operator:'='}]:[]):[],operator:'|'};$list.options({query:user?{conditions:[{key:'user',value:pandora.user.username,operator:'='},query],operator:'&'}:query});}
function uploadFile(data){pandora.ui.uploadDocumentDialog(data.files[0],function(file){Ox.Request.clearCache('findDocuments');pandora.api.findDocuments({positions:[file.id],query:$list.options('query'),sort:$list.options('sort'),},function(data){$list.bindEventOnce({load:function(){$list.options({selected:[file.id]});}});if(data.data.positions[file.id]>-1){$list.reloadList();}else{$list.options({query:{conditions:[],operator:'&'}});}});}).open();}
return that;};'use strict';pandora.ui.embedPlayer=function(){var that=Ox.Element(),ui=pandora.user.ui,defaults={annotationsFont:ui.annotationsFont,annotationsRange:ui.annotationsRange,annotationsSort:ui.annotationsSort,invertHighlight:true,matchRatio:false,paused:true,playInToOut:true,showAnnotations:false,showCloseButton:false,showLayers:pandora.site.layers.map(function(layer){return layer.id;}),showTimeline:false,timeline:ui.videoTimeline,width:window.innerWidth},options=getOptions(),removed=false,video,$innerPanel,$outerPanel,$title,$player,$controls,$timeline,$annotations;pandora.api.get({id:ui.item,keys:['duration','durations','layers','parts','posterFrame','rightslevel','size','title','videoRatio']},function(result){if(removed){return;}
video=Ox.extend(result.data,pandora.getVideoOptions(result.data));Ox.print('OPTIONS::::::::',options)
var isFrame=options['in']&&options['in']==options.out,sizes=getSizes();options.height=sizes.videoHeight;if(options.title){$title=Ox.Element().css({position:'absolute'}).append($('<div>').css({marginTop:!options.title.match(/\\n/)?'8px':'2px',textAlign:'center'}).html(options.title.replace(/\\n/g,'<br>')));}else{$title=Ox.Element();}
$player=Ox.VideoPlayer(Ox.extend({censored:video.censored,censoredIcon:pandora.site.cantPlay.icon,censoredTooltip:pandora.site.cantPlay.text,controlsBottom:(isFrame?[]:['play','volume']).concat(['scale']).concat(Ox.Fullscreen.available&&options.showCloseButton?['fullscreen']:[]).concat(['timeline','position','settings']),controlsTooltips:{close:Ox._('Close'),open:Ox._('Watch on {0}',[pandora.site.site.name])},controlsTop:[options.showCloseButton?'close':Ox.Fullscreen.available?'fullscreen':'space16'].concat(['title','open']),duration:video.duration,enableFullscreen:Ox.Fullscreen.available,enableKeyboard:!isFrame,enableMouse:!isFrame,enablePosition:!isFrame,enableSubtitles:true,enableTimeline:!isFrame,enableVolume:!isFrame,height:options.height,invertHighlight:options.invertHighlight,muted:ui.videoMuted,paused:options.paused,playInToOut:options.playInToOut,position:options.position,poster:'/'+options.item+'/'+'96p'+(options.position!==void 0?options.position:options['in']!==void 0?options['in']:video.posterFrame)+'.jpg',resolution:ui.videoResolution,scaleToFill:ui.videoScale=='fill',subtitles:video.subtitles,timeline:options.playInToOut?function(size,i){return'/'+options.item
+'/timelineantialias'
+size+'p'+i+'.jpg'}:'/'+options.item+'/'+'timeline16p.png',timelineType:options.showTimeline?options.timeline:'',timelineTypes:options.showTimeline?pandora.site.timelines:[],title:video.title,video:video.video,volume:ui.videoVolume,width:options.width},options['in']?{'in':options['in']}:{},options.out?{out:options.out}:{})).bindEvent({fullscreen:function(data){Ox.Fullscreen.toggle();},open:function(){$player.options({paused:true});var url=document.location.protocol+'//'
+document.location.hostname+'/'
+options.item+'/'
+Ox.formatDuration($player.options('position'));window.open(url,'_blank');},playing:function(data){setPosition(data.position,true);},position:function(data){setPosition(data.position);},subtitles:function(data){options.showTimeline&&$timeline.options({subtitles:data.subtitles?video.subtitles:[]});},timeline:function(data){options.showTimeline&&$timeline.options({type:data.timeline});}}).bindEvent(function(data,event){if(Ox.contains(['close','paused'],event)){Ox.$parent.postMessage(event,data);}});Ox.Fullscreen.bind('change',function(state){$player.options({fullscreen:state});});$controls=Ox.Element();if(options.showTimeline){$timeline=Ox.LargeVideoTimeline(Ox.extend({disabled:isFrame,duration:video.duration,getImageURL:function(type,i){return'/'+ui.item+'/timeline'+type+'64p'+i+'.jpg';},position:options.position,showInToOut:options.playInToOut&&options['in']<options.out,subtitles:ui.videoSubtitles?video.subtitles:[],type:options.timeline,width:window.innerWidth-16},options['in']?{'in':options['in']}:{},options.out?{out:options.out}:{})).css({top:'4px',left:'4px'}).bindEvent({mousedown:that.gainFocus,position:dragTimeline}).appendTo($controls);}
if(options.showAnnotations){video.annotations=video.annotations.filter(function(layer){return Ox.contains(options.showLayers,layer.id);});if(options.playInToOut){video.annotations.forEach(function(layer){var items=[];layer.items.forEach(function(item){if((item['in']>=options['in']&&item['in']<=options.out)||(item.out>=options['in']&&item.out<=options.out)){items.push(item);}});layer.items=items;});}
$annotations=Ox.AnnotationPanel(Ox.extend({font:options.annotationsFont,layers:video.annotations,position:options.position,range:options.annotationsRange,showLayers:ui.showLayers,showUsers:true,sort:options.annotationsSort,width:window.innerWidth},options['in']?{'in':options['in']}:{},options.out?{out:options.out}:{})).bindEvent({select:selectAnnotation})}else{$annotations=Ox.Element();}
$innerPanel=Ox.SplitPanel({elements:[{element:$title,size:options.title?32:0},{element:$player},{element:$controls,size:options.showTimeline?80:0}],orientation:'vertical'});$outerPanel=Ox.SplitPanel({elements:[{element:$innerPanel,size:sizes.innerHeight},{element:$annotations}],orientation:'vertical'});that.setElement($outerPanel);Ox.$parent.postMessage('loaded');});function dragTimeline(data){var position=options.playInToOut?Ox.limit(data.position,options['in'],options.out):data.position;$player.options({position:position});position!=data.position&&$timeline.options({position:position});options.showAnnotations&&$annotations.options({position:position});}
function getOptions(){var options={};if(ui._hash.query){ui._hash.query.forEach(function(condition){options[condition.key]=condition.value;});}
options=Ox.extend({item:ui.item},ui.videoPoints[ui.item]||{},defaults,options);if(!options.position){options.position=options['in']||0;}
if(!options['in']&&!options.out){options.playInToOut=false;}else if(options['in']&&options['in']==options.out){options.invertHighlight=false;options.paused=true;options.playInToOut=false;}
return options;}
function getSizes(){var innerHeight,maxVideoHeight=window.innerHeight
-(options.title?32:0)
-(options.showTimeline?80:0)
-(options.showAnnotations?128:0),videoHeight;if(options.matchRatio||options.showAnnotations){videoHeight=Math.round(window.innerWidth/video.videoRatio);options.matchRatio=videoHeight<=maxVideoHeight;if(!options.matchRatio){videoHeight=maxVideoHeight;}}else{videoHeight=window.innerHeight
-(options.title?32:0)
-(options.showTimeline?80:0);}
innerHeight=videoHeight
+(options.title?32:0)
+(options.showTimeline?80:0);return{innerHeight:innerHeight,videoHeight:videoHeight};}
function getSmallTimelineFPS(){return Math.floor((options.out-options['in'])*25)<32768?25:1;}
function getSmallTimelineURL(){var fps=getSmallTimelineFPS(),width=Math.ceil((options.out-options['in'])*fps),height=fps==1?16:64;pandora[fps==1?'getSmallClipTimelineURL':'getLargeClipTimelineURL'](options.item,options['in'],options.out,options.timeline,function(url){$player.options({timeline:url});});return Ox.$('<canvas>').attr({width:width,height:height})[0].toDataURL();}
function selectAnnotation(data){if(data.id){setPosition(Math.max(data['in'],options['in']||0));$annotations.options({selected:''});}}
function setPosition(position,playing){!playing&&$player.options({position:position});options.showTimeline&&$timeline.options({position:position});options.showAnnotations&&$annotations.options({position:position});}
that.reloadPanel=function(data){if(Ox.isUndefined(data)||data.value!=data.previousValue){removed=true;pandora.$ui.embedPanel.replaceWith(pandora.$ui.embedPanel=pandora.ui.embedPanel());return pandora.$ui.embedPanel;}
return that;};that.resizePanel=function(){var sizes=getSizes();$player.options({width:window.innerWidth,height:sizes.videoHeight});$outerPanel.size(0,sizes.innerHeight);options.showTimeline&&$timeline.options({width:window.innerWidth-16});options.showAnnotations&&$annotations.options({width:window.innerWidth});return that;};return that;};'use strict';pandora.ui.folderBrowserList=function(id,section){section=pandora.user.ui.section;var ui=pandora.user.ui,columnWidth=(ui.sidebarSize-Ox.UI.SCROLLBAR_SIZE-(section=='items'?96:48))/2,i=Ox.getIndexById(pandora.site.sectionFolders[section],id),folderItems=section=='items'?'Lists':Ox.toTitleCase(section),folderItem=folderItems.slice(0,-1),that=Ox.TableList({columns:[{clickable:true,format:function(value){return $('<img>').attr({src:'/list/'+encodeURIComponent(value)+'/icon.jpg'}).css({width:'14px',height:'14px',borderRadius:'4px',margin:'0 0 0 -3px'});},id:'id',titleImage:'icon',visible:true,width:16},{format:function(value){return Ox.encodeHTMLEntities(value);},id:'user',operator:'+',title:Ox._('User'),visible:true,width:Math.floor(columnWidth)},{format:function(value){return Ox.encodeHTMLEntities(value);},id:'name',operator:'+',title:Ox._(folderItem),visible:true,width:Math.ceil(columnWidth)},{align:'right',id:'items',format:{type:'number'},operator:'-',title:Ox._('Items'),visible:section=='items',width:48},{clickable:function(data){return section=='items'&&(data.type=='smart'||data.user==pandora.user.username);},format:function(value,data){return $('<img>').attr({src:Ox.UI.getImageURL(value=='static'?'symbolClick':value=='smart'?'symbolFind':value=='html'?'symbolFile':'symbolBook')}).css({width:'10px',height:'10px',padding:'3px',opacity:section=='texts'||data.user==pandora.user.username?1:0.25});},id:'type',operator:'+',titleImage:'edit',tooltip:function(data){return data.type=='static'?(data.user==pandora.user.username?Ox._('Edit Default View'):Ox._('Default View: ...')):data.type=='smart'?(data.user==pandora.user.username?Ox._('Edit Query'):Ox._('Show Query')):Ox._(data.type.toUpperCase());},visible:true,width:16},{clickable:true,format:function(value){return $('<img>').attr({src:Ox.UI.getImageURL('symbol'+(id=='favorite'?'Like':'Star'))}).css({width:'10px',height:'10px',padding:'3px',opacity:id=='favorite'?(value?1:0.25):(value=='featured'?1:0.25)});},id:id=='favorite'?'subscribed':'status',operator:'+',titleImage:id=='favorite'?'like':'star',tooltip:function(data){var checked=id=='favorite'?data.subscribed:data.status=='featured';return Ox._((checked?'Remove from':'Add to')
+' '+Ox.toTitleCase(id)+' '+folderItems);},visible:true,width:16}],columnsVisible:true,items:function(data,callback){var query=id=='favorite'?{conditions:[{key:'status',value:'public',operator:'='},{key:'user',value:pandora.user.username,operator:'!=='}],operator:'&'}:{conditions:[{key:'status',value:'private',operator:'!='}],operator:''};return pandora.api['find'+folderItems](Ox.extend(data,{query:query}),callback);},keys:id=='featured'?['subscribed']:[],pageLength:1000,selected:pandora.getListData().folder==id?[section=='items'?ui._list:ui[section.slice(0,-1)]]:[],sort:[{key:'name',operator:'+'}],unique:'id'}).bindEvent({click:function(data){if(data.key=='type'){}else if(data.key=='subscribed'){var subscribed=that.value(data.id,'subscribed');pandora.api[subscribed?'unsubscribeFrom'+folderItem:'subscribeTo'+folderItem]({id:data.id},function(result){that.value(data.id,'subscribed',!subscribed);});}else if(data.key=='status'){pandora.api['edit'+folderItem]({id:data.id,status:that.value(data.id,'status')=='featured'?'public':'featured'},function(result){Ox.Log('','result',result)
if(result.data.user==pandora.user.username||result.data.subscribed){Ox.Request.clearCache();pandora.$ui.folderList[result.data.user==pandora.user.username?'personal':'favorite'].reloadList();}
that.value(data.id,'status',result.data.status);});}},init:function(data){pandora.site.sectionFolders[section][i].items=data.items;pandora.$ui.folder[i].$content.css({height:40+data.items*16+'px'});pandora.$ui.folderList[id].css({height:16+data.items*16+'px'});pandora.resizeFolders();},paste:function(data){if(section=='items'){pandora.$ui.list.triggerEvent('paste',data);}},select:function(data){var list=data.ids.length?data.ids[0]:'';if(list){Ox.forEach(pandora.$ui.folderList,function($list,id_){id!=id_&&$list.options('selected',[]);});}
if(section=='items'){pandora.UI.set({find:{conditions:list?[{key:'list',value:data.ids[0],operator:'=='}]:[],operator:'&'}});}else{pandora.UI.set(section.slice(0,-1),list);}}});return that;};'use strict';pandora.ui.importAnnotations=function(data){var content=Ox.Element().css({margin:'16px'}),file,height=128,layers=pandora.site.layers.filter(function(layer){return layer.canAddAnnotations[pandora.user.level];}),layer,srt=[],total=0,importButton,selectLayer,selectFile,that=Ox.Dialog({buttons:[Ox.Button({id:'close',title:Ox._('Close')}).bindEvent({click:function(){that.close();}}),importButton=Ox.Button({disabled:true,id:'import',title:Ox._('Import')}).bindEvent({click:function(){importButton.hide();addAnnotations();}})],closeButton:true,content:content,keys:{'escape':'close'},height:128,removeOnClose:true,width:368,title:Ox._('Import Annotations')}).bindEvent({close:function(data){that.close();}}),$status=$('<div>').css({padding:'4px',paddingBottom:'8px'}).appendTo(content);setStatus(Ox._('Please select layer and .srt file'))
function addAnnotations(){var annotations,task;if(srt.length>0){setStatus(Ox._('Loading...'));var annotations=srt.filter(function(data){return!Ox.isUndefined(data['in'])&&!Ox.isUndefined(data.out)&&data.text;}).map(function(data){return{'in':data['in'],out:data.out,value:Ox.sanitizeHTML(data.text).replace(/<br[ /]*?>\n/g,'\n').replace(/\n\n/g,'<br>\n').replace(/\n/g,'<br>\n')};});pandora.api.addAnnotations({annotations:annotations,item:pandora.user.ui.item,layer:layer},function(result){if(result.data.taskId){$status.html('').append(Ox.LoadingScreen({text:Ox._('Importing {0} annotations...',[srt.length])}));pandora.wait(result.data.taskId,function(result){if(result.data.status=='SUCCESS'){setStatus(Ox._('{0} annotations imported.',[annotations.length]));Ox.Request.clearCache(pandora.user.ui.item);pandora.$ui.contentPanel.replaceElement(1,pandora.$ui.item=pandora.ui.item());}else{setStatus(Ox._('Importing annotations failed.'));}});}else{setStatus(Ox._('Importing annotations failed.'));}});}}
function parseSRT(data){var srt=Ox.parseSRT(data),length=srt.length-1;for(var i=0;i<length;i++){if(srt[i].out==srt[i+1]['in']){srt[i].out=srt[i].out-0.001;}}
return srt;}
function setStatus(status){$status.html(status);}
selectLayer=Ox.Select({items:layers,title:Ox._('Select Layer'),}).css({margin:'4px 2px 4px 4px'}).bindEvent({change:function(data){selectLayer.options({title:null});layer=data.value;total&&layer&&importButton.options({disabled:false});}}).appendTo(content);selectFile=Ox.FileButton({image:'upload',lbael:'File',title:Ox._('Select SRT...'),width:156}).css({margin:'4px 2px 4px 4px'}).bindEvent({click:function(data){if(data.files.length){var reader=new FileReader();reader.onloadend=function(event){srt=parseSRT(this.result);total=srt.length;if(total&&layer){importButton.options({disabled:false});selectLayer.hide();selectFile.hide();}
setStatus(Ox._('File contains {0} annotation'
+(total==1?'':'s')+'.',[total]));};reader.readAsText(data.files[0]);}else{srt=[];total=0;importButton.options({disabled:true});}}}).appendTo(content);return that;};'use strict';pandora.ui.sortElement=function(isNavigationView){var isClipView=pandora.isClipView(),isEmbed=pandora.isEmbedURL(),items=(isClipView?pandora.site.clipKeys.map(function(key){return Ox.extend(Ox.clone(key),{title:Ox._((!pandora.user.ui.item?'Sort by Clip {0}':'Sort by {0}'),[Ox._(key.title)])});}):[]).concat(!pandora.user.ui.item?pandora.site.sortKeys.map(function(key){return Ox.extend(Ox.clone(key),{title:Ox._('Sort by {0}',[Ox._(key.title)])});}):[]),sortKey=!pandora.user.ui.item?'listSort':'itemSort',$sortSelect=Ox.Select({items:items,value:pandora.user.ui[sortKey][0].key,width:!isEmbed&&isNavigationView?120+Ox.UI.SCROLLBAR_SIZE:144}).bindEvent({change:function(data){var key=data.value;pandora.UI.set(sortKey,[{key:key,operator:pandora.getSortOperator(key)}]);}}),$orderButton=Ox.Button({overlap:'left',title:getButtonTitle(),tooltip:getButtonTooltip(),type:'image'}).bindEvent({click:function(){pandora.UI.set(sortKey,[{key:pandora.user.ui[sortKey][0].key,operator:pandora.user.ui[sortKey][0].operator=='+'?'-':'+'}]);}}),that=Ox.FormElementGroup({elements:[$sortSelect,$orderButton],float:'right'}).css({float:isNavigationView?'right':'left',margin:isNavigationView?'4px 4px 0 0':'4px 0 0 4px'}).bindEvent('pandora_'+sortKey.toLowerCase(),updateElement);function getButtonTitle(){return pandora.user.ui[sortKey][0].operator=='+'?'up':'down';}
function getButtonTooltip(){return Ox._(pandora.user.ui[sortKey][0].operator=='+'?'Ascending':'Descending');}
function updateElement(){$sortSelect.value(pandora.user.ui[sortKey][0].key);$orderButton.options({title:getButtonTitle(),tooltip:getButtonTooltip()});}
return that;};'use strict';pandora.tests=function(){var tests=[];pandora.api.find({query:{conditions:[{key:'rendered',value:true,operator:'='}],operator:'&'},sort:[{key:'random',operator:'+'}],keys:['id','duration'],range:[0,10]},function(result){var item=result.data.items.filter(function(item){return item.duration>300;})[0],position=60;pandora.UI.set('videoPoints.'+item.id,{annotation:'','in':position,out:position,position:position});pandora.UI.set({item:item.id,itemView:'player'});test('set item',pandora.user.ui.item,item.id);startPlayback();function startPlayback(){if(pandora.$ui.player){pandora.$ui.player.options({paused:false});setTimeout(function(){pandora.$ui.player.options({paused:true});test('video position increased after playback',pandora.user.ui.videoPoints[item.id].position>position,true);results();},5000);}else{setTimeout(startPlayback,500);}}});function test(title,actual,expected){tests.push({actual:actual,expected:expected,passed:Ox.isEqual(actual,expected),title:title})}
function results(){var passed=tests.filter(function(test){return test.passed;}).length,failed=tests.length-passed;Ox.print(JSON.stringify({tests:tests.length,passed:passed,failed:failed,results:tests},null,'  '));}}
'use strict';pandora.ui.viewSelect=function(){var ui=pandora.user.ui,sortKey=!ui.item?'listSort':'itemSort',viewKey=!ui.item?'listView':'itemView',items=pandora.site[viewKey+'s'].filter(function(view){return view.id!='data'&&view.id!='media';}).map(function(view){return{id:view.id,title:Ox._('View {0}',[Ox._(view.title)])};}),that;if(viewKey=='itemView'&&pandora.site.capabilities.canSeeExtraItemViews[pandora.user.level]){items=items.concat([{},{id:'data',title:Ox._('View Data')},{id:'media',title:Ox._('View Media')}]);}
that=Ox.Select({id:'viewSelect',items:items,value:ui[viewKey],width:!ui.item?144:128}).css({float:'left',margin:'4px 0 0 4px'}).bindEvent({change:function(data){pandora.UI.set(viewKey,data.value);},pandora_listview:function(data){!ui.item&&that.value(data.value);},pandora_itemview:function(data){ui.item&&that.value(data.value);}});return that;};'use strict';pandora.ui.browser=function(){var that;if(!pandora.user.ui.item){pandora.user.ui.filterSizes=pandora.getFilterSizes();pandora.$ui.filters=pandora.ui.filters();that=Ox.SplitPanel({elements:[{element:pandora.$ui.filters[0],size:pandora.user.ui.filterSizes[0]},{element:pandora.$ui.filtersInnerPanel=pandora.ui.filtersInnerPanel()},{element:pandora.$ui.filters[4],size:pandora.user.ui.filterSizes[4]},],id:'browser',orientation:'horizontal'}).bindEvent({resize:function(data){pandora.$ui.filters.forEach(function(list){list.size();});if(pandora.user.ui.listView=='map'){pandora.$ui.map.resizeMap();}else if(pandora.user.ui.listView=='calendar'){pandora.$ui.calendar.resizeCalendar();}else if(pandora.user.ui.listView=='video'){pandora.$ui.list.size();}},resizeend:function(data){pandora.UI.set({filtersSize:data.size});},toggle:function(data){data.collapsed&&pandora.$ui.list.gainFocus();pandora.UI.set({showFilters:!data.collapsed});if(!data.collapsed){pandora.$ui.filters.forEach(function($filter){var selected=$filter.options('_selected');if(selected){$filter.bindEventOnce({load:function(){$filter.options({_selected:false,selected:selected});}}).reloadList();}});pandora.$ui.filters.updateMenus();}
if(pandora.user.ui.listView=='map'){pandora.$ui.map.resizeMap();}else if(pandora.user.ui.listView=='calendar'){pandora.$ui.calendar.resizeCalendar();}else if(pandora.user.ui.listView=='video'){pandora.$ui.list.size();}}});}else{var that=Ox.IconList({borderRadius:pandora.user.ui.icons=='posters'?0:8,centered:true,defaultRatio:pandora.user.ui.icons=='posters'?pandora.site.posters.ratio:1,draggable:true,id:'list',item:function(data,sort,size){size=size||64;var ui=pandora.user.ui,ratio=ui.icons=='posters'?(ui.showSitePosters?pandora.site.posters.ratio:data.posterRatio):1,url='/'+data.id+'/'+(ui.icons=='posters'?(ui.showSitePosters?'siteposter':'poster'):'icon')+'128.jpg?'+data.modified,format,info,sortKey=sort[0].key;if(['title','director','random'].indexOf(sortKey)>-1){info=data['year'];}else{format=pandora.getSortKeyData(sortKey).format;if(format){info=(/^color/.test(format.type.toLowerCase())?Ox.Theme:Ox)['format'+Ox.toTitleCase(format.type)].apply(this,[data[sortKey]].concat(format.args||[]));if(sortKey=='rightslevel'){info.css({width:size*0.75+'px'});}}else{info=data[sortKey];}}
return{height:ratio<=1?size:size/ratio,id:data.id,info:info,title:data.title+(data.director&&data.director.length?' ('+data.director.join(', ')+')':''),url:url,width:ratio>=1?size:size*ratio};},items:function(data,callback){pandora.api.find(Ox.extend(data,{query:pandora.user.ui.find}),callback);},keys:['director','id','modified','posterRatio','title','year'],max:1,min:1,orientation:'horizontal',pageLength:32,selected:[pandora.user.ui.item],size:64,sort:getSort(),unique:'id'}).addClass('OxMedia').bindEvent({copy:function(){pandora.clipboard.copy(pandora.user.ui.item,'item');},copyadd:function(){pandora.clipboard.add(pandora.user.ui.item,'item');},gainfocus:function(){pandora.$ui.mainMenu.replaceItemMenu();},open:function(){that.scrollToSelection();},openpreview:function(){if(pandora.isVideoView()){pandora.$ui[pandora.user.ui.itemView].gainFocus().triggerEvent('key_space');}},select:function(data){data.ids.length&&pandora.UI.set({'item':data.ids[0]});},toggle:function(data){pandora.UI.set({showBrowser:!data.collapsed});if(data.collapsed){if(pandora.user.ui.itemView=='editor'){pandora.$ui.editor&&pandora.$ui.editor.gainFocus();}}
if(pandora.user.ui.itemView=='timeline'){pandora.$ui.timeline.options({height:pandora.$ui.contentPanel.size(1)});}else if(pandora.user.ui.itemView=='map'){pandora.$ui.map.resizeMap();}else if(pandora.user.ui.itemView=='calendar'){pandora.$ui.calendar.resizeCalendar();}},pandora_icons:function(data){that.options({borderRadius:data.value=='posters'?0:8,defaultRatio:data.value=='posters'?pandora.site.posters.ratio:1}).reloadList();},pandora_item:function(data){that.options({selected:[data.value]});if(['accessed','timesaccessed'].indexOf(pandora.user.ui.listSort[0].key)>-1){Ox.Request.clearCache('find');that.reloadList();}},pandora_listsort:function(){that.options({sort:getSort()})},pandora_showsiteposters:function(){pandora.user.ui.icons=='posters'&&that.reloadList(true);}}).bindEventOnce({load:function(){if(Ox.Focus.focused()===null||(pandora.$ui.list&&pandora.$ui.list.hasFocus())){that.gainFocus();}}});that.css({overflowY:'hidden'});pandora.enableDragAndDrop(that,false);}
function getSort(){return['text','position'].indexOf(pandora.user.ui.listSort[0].key)>-1?pandora.site.user.ui.listSort:pandora.user.ui.listSort}
return that;};'use strict';pandora.ui.mainMenu=function(){var isGuest=pandora.user.level=='guest',ui=pandora.user.ui,findState=pandora.getFindState(ui.find),fromMenu=false,fullscreenState=Ox.Fullscreen.getState(),that=Ox.MainMenu({extras:pandora.site.menuExtras.map(function(menuExtra){if(menuExtra=='user'){return pandora.$ui.userButton=pandora.ui.userButton();}else if(menuExtra=='locale'){return pandora.$ui.localeButton=pandora.ui.localeButton();}else if(menuExtra=='reload'){return pandora.$ui.loadingIcon=pandora.ui.loadingIcon();}else if(menuExtra=='persona'){return pandora.$ui.personaButton=pandora.ui.personaButton();}}),id:'mainMenu',menus:[].concat([{id:pandora.site.site.id+'Menu',title:pandora.site.site.name,items:[].concat([{id:'home',title:Ox._('Home')},{}],Ox.clone(pandora.site.sitePages,true).map(function(page){page.title=Ox._(page.title);return page;}),[{},{id:'software',title:Ox._('Software')}])},{id:'userMenu',title:Ox._('User'),items:[{id:'username',title:Ox._('User: {0}',[isGuest?'not signed in':Ox.encodeHTMLEntities(pandora.user.username)]),disabled:true},{},{id:'preferences',title:Ox._('Preferences...'),disabled:isGuest,keyboard:'control ,'},{id:'archives',title:Ox._('Archives...'),disabled:true},{},{id:'signup',title:Ox._('Sign Up...'),disabled:!isGuest},isGuest?{id:'signin',title:Ox._('Sign In...')}:{id:'signout',title:Ox._('Sign Out...')}]},getListMenu(),getItemMenu(),{id:'viewMenu',title:Ox._('View'),items:[{id:'items',title:Ox._('View {0}',[Ox._(pandora.site.itemName.plural)]),items:[{group:'listview',min:1,max:1,items:pandora.site.listViews.map(function(view){return Ox.extend({checked:ui.listView==view.id},view,{title:Ox._(view.title)});})},]},{id:'icons',title:Ox._('Icons'),items:[].concat([{group:'viewicons',min:1,max:1,items:['posters','frames'].map(function(icons){return{id:icons,title:Ox._(Ox.toTitleCase(icons)),checked:ui.icons==icons};})},{},],pandora.site.media.importPosters?[{id:'showsiteposters',title:Ox._('Always Show {0} Poster',[pandora.site.site.name]),checked:ui.showSitePosters},{}]:[],[{id:'showreflections',title:Ox._('Show Reflections'),checked:true,disabled:true}])},{id:'timelines',title:Ox._('Timelines'),items:[{group:'viewtimelines',min:1,max:1,items:pandora.site.timelines.map(function(mode){return{id:mode.id,title:Ox._(mode.title),checked:ui.videoTimeline==mode.id};})}]},{id:'columns',title:Ox._('Columns'),items:[{id:'loadcolumns',title:Ox._('Load Layout...'),disabled:true},{id:'savecolumns',title:Ox._('Save Layout...'),disabled:true},{},{id:'resetcolumns',title:Ox._('Reset Layout'),disabled:true}]},{},{id:'item',title:[Ox._('Open {0}',[Ox._(pandora.site.itemName.singular)]),Ox._('Open {0}',[Ox._(pandora.site.itemName.plural)])],items:[{group:'itemview',min:1,max:1,items:pandora.site.itemViews.map(function(view){return Ox.extend({checked:ui.itemView==view.id},view);})},]},{id:'clips',title:Ox._('Open Clips'),items:[{group:'videoview',min:1,max:1,items:['player','editor','timeline'].map(function(view){return{id:view,title:Ox._(Ox.toTitleCase(view)),checked:ui.videoView==view};})}]},{},{id:'filters',title:Ox._('Filters'),disabled:ui.section!='items',items:[{id:'clearfilters',title:Ox._('Clear Filters'),disabled:Ox.sum(ui._filterState.map(function(filterState){return filterState.selected.length;}))==0,keyboard:'shift alt control a'},{},{group:'filters',min:5,max:5,items:pandora.site.filters.map(function(filter){return Ox.extend({checked:Ox.getIndexById(ui.filters,filter.id)>-1},filter,{title:Ox._(filter.title)});})},{},{id:'resetfilters',title:Ox._('Reset Filters')}]},{},{id:'showsidebar',title:Ox._((ui.showSidebar?'Hide':'Show')+' Sidebar'),keyboard:'shift s'},{id:'showinfo',title:Ox._((ui.showInfo?'Hide':'Show')+' Info'),disabled:!ui.showSidebar,keyboard:'shift i'},{id:'showfilters',title:Ox._((ui.showFilters?'Hide':'Show')+' Filters'),disabled:ui.section!='items'||!!ui.item,keyboard:'shift f'},{id:'showbrowser',title:Ox._((ui.showBrowser?'Hide':'Show')+' {0} Browser',[Ox._(pandora.site.itemName.singular)]),disabled:!ui.item,keyboard:'shift b'},{id:'showtimeline',title:Ox._((ui.showTimeline?'Hide':'Show')+' Timeline'),disabled:!hasTimeline(),keyboard:'shift t'},{id:'showannotations',title:Ox._((ui.showAnnotations?'Hide':'Show')+' Annotations'),disabled:!hasAnnotations(),keyboard:'shift a'},{id:'showclips',title:Ox._((ui.showClips?'Hide':'Show')+' Clips'),disabled:!hasClips(),keyboard:'shift c'},{},{id:'togglefullscreen',title:Ox._((fullscreenState?'Exit':'Enter')+' Fullscreen'),disabled:fullscreenState===void 0,keyboard:/^Mac/.test(window.navigator.platform)?'shift alt control f':'F11'},{id:'entervideofullscreen',title:Ox._('Enter Video Fullscreen'),disabled:!ui.item||ui.itemView!='player'},{},{id:'theme',title:Ox._('Theme'),items:[{group:'settheme',min:1,max:1,items:pandora.site.themes.map(function(theme){return{id:theme,title:Ox.Theme.getThemeData(theme).themeName,checked:ui.theme==theme}})}]},{id:'locale',disabled:pandora.user.level!='admin',title:Ox._('Language'),items:[{group:'setlocale',min:1,max:1,items:Object.keys(Ox.LOCALE_NAMES).map(function(locale){return{id:locale,title:Ox.LOCALE_NAMES[locale],checked:ui.locale==locale}})}]}]},getSortMenu(),{id:'findMenu',title:Ox._('Find'),items:[{id:'find',title:Ox._('Find'),items:[{group:'find',min:0,max:1,items:pandora.site.findKeys.map(function(key,i){return{id:key.id,checked:key.id==findState.key,title:Ox._(key.title)};})}]},{id:'advancedfind',title:Ox._('Advanced Find...'),keyboard:'shift control f'},{},{id:'findsimilar',title:Ox._('Find Similar Clips...'),keyboard:'alt control f',disabled:!pandora.getItemIdAndPosition()}]},{id:'dataMenu',title:Ox._('Data'),items:[{id:'documents',title:Ox._('Manage Documents...'),disabled:!pandora.site.capabilities.canManageDocuments[pandora.user.level]},{},{id:'titles',title:Ox._('Manage Titles...'),disabled:!pandora.site.capabilities.canManageTitlesAndNames[pandora.user.level]},{id:'names',title:Ox._('Manage Names...'),disabled:!pandora.site.capabilities.canManageTitlesAndNames[pandora.user.level]},{},{id:'places',title:Ox._('Manage Places...'),disabled:!pandora.site.capabilities.canManagePlacesAndEvents[pandora.user.level]},{id:'events',title:Ox._('Manage Events...'),disabled:!pandora.site.capabilities.canManagePlacesAndEvents[pandora.user.level]},{},{id:'users',title:Ox._('Manage Users...'),disabled:!pandora.site.capabilities.canManageUsers[pandora.user.level]},{id:'statistics',title:Ox._('Statistics...'),disabled:!pandora.site.capabilities.canManageUsers[pandora.user.level]}]},{id:'helpMenu',title:Ox._('Help'),items:[{id:'help',title:Ox._('Help...'),keyboard:'control ?'},{id:'api',title:Ox._('API Documentation...'),keyboard:'shift control ?'}]}],pandora.site.capabilities.canSeeDebugMenu[pandora.user.level]?[{id:'debugMenu',title:Ox._('Debug'),items:[{id:'clearcache',title:Ox._('Clear Cache')},{},{id:'cache',title:Ox._((pandora.localStorage('enableCache')!==false?'Disable':'Enable')+' Cache')},{id:'debugmode',title:Ox._((pandora.localStorage('enableDebugMode')?'Disable':'Enable')+' Debug Mode')},{id:'eventlogging',title:Ox._((pandora.localStorage('enableEventLogging')?'Disable':'Enable')+' Event Logging')},{},{id:'errorlogs',title:Ox._('View Error Logs...')},{id:'tests',title:Ox._('Run Tests')}]}]:[])}).bindKeyboard().bindEvent({change:function(data){var value=data.checked[0]?data.checked[0].id:null;if(data.id=='allitems'){if(data.checked){pandora.UI.set({find:{conditions:[],operator:'&'}});}else{that.checkItem('allitems');}}else if(data.id=='cliporder'){if(!ui.item){pandora.UI.set({listSort:[{key:ui.listSort[0].key,operator:value=='ascending'?'+':'-'}]});}else{pandora.UI.set({itemSort:[{key:ui.itemSort[0].key,operator:value=='ascending'?'+':'-'}]});}}else if(data.id=='clipsort'){if(!ui.item){pandora.UI.set({listSort:[{key:value,operator:pandora.getSortOperator(value)}]});}else{pandora.UI.set({itemSort:[{key:value,operator:pandora.getSortOperator(value)}]});}}else if(data.id=='find'){if(value){pandora.$ui.findSelect.value(value);if(ui._findState.key=='advanced'){pandora.$ui.findInput.options({placeholder:''});}}else{that.checkItem('findMenu_find_'+pandora.$ui.findSelect.value());}
pandora.$ui.findInput.focusInput(true);}else if(data.id=='itemorder'){pandora.UI.set({listSort:[{key:ui.listSort[0].key,operator:value=='ascending'?'+':'-'}]});}else if(data.id=='itemsort'){pandora.UI.set({listSort:[{key:value,operator:pandora.getSortOperator(value)}]});}else if(data.id=='itemview'){pandora.UI.set({itemView:value});}else if(data.id=='listview'){var set={listView:value};if(!pandora.isClipView(key,ui.item)&&['title','position'].indexOf(ui.listSort[0].key)>-1){set.listSort=pandora.site.user.ui.listSort;}
pandora.UI.set(set);}else if(Ox.startsWith(data.id,'orderfilter')){var filters=Ox.clone(ui.filters),id=data.id.replace('orderfilter',''),index=Ox.getIndexById(filters,id),key=filters[index].sort[0].key,operator=value=='ascending'?'+':'-';pandora.$ui.filters[index].options({sort:[{key:key,operator:operator}]});filters[index].sort[0].operator=operator;pandora.UI.set({filters:filters});}else if(data.id=='setlocale'){pandora.UI.set({locale:value});pandora.setLocale(value,pandora.$ui.appPanel.reload);}else if(data.id=='settheme'){pandora.UI.set({theme:value});pandora.setTheme(value);}else if(data.id=='showsiteposters'){pandora.UI.set({showSitePosters:data.checked});}else if(Ox.startsWith(data.id,'sortfilter')){var filters=Ox.clone(ui.filters),id=data.id.replace('sortfilter',''),index=Ox.getIndexById(filters,id),type=Ox.getObjectById(pandora.site.filters,id).type,key=value,operator=key=='name'&&type=='string'?'+':'-';pandora.$ui.mainMenu.checkItem('sortMenu_orderfilters_orderfilter'+id+'_'
+(operator=='+'?'ascending':'descending'));pandora.$ui.filters[index].options({sort:[{key:key,operator:operator}]});filters[index].sort[0].key=key;pandora.UI.set({filters:filters});}else if(data.id=='videoview'){var set={videoView:value};if((value=='timeline'&&['player','editor'].indexOf(ui.itemView)>-1)||(value=='player'&&['timeline','editor'].indexOf(ui.itemView)>-1)||(value=='editor'&&['timeline','player'].indexOf(ui.itemView)>-1)){set.itemView=value;}
pandora.UI.set(set);}else if(data.id=='viewicons'){pandora.UI.set({icons:value});}else if(data.id.slice(0,8)=='viewlist'){pandora.UI.set({find:{conditions:data.checked?[{key:'list',value:data.id.slice(8).replace(/\t/g,'_'),operator:'=='}]:[],operator:'&'}});}else if(data.id=='viewtimelines'){pandora.UI.set({videoTimeline:value});}},click:function(data){if(['home','software','signup','signin','signout','preferences','help','api'].concat(pandora.site.sitePages.map(function(page){return page.id;})).indexOf(data.id)>-1){pandora.UI.set({page:data.id});}else if(['newlist','newlistfromselection','newsmartlist','newsmartlistfromresults'].indexOf(data.id)>-1){pandora.addList(data.id.indexOf('smart')>-1,data.id.indexOf('from')>-1);}else if(data.id=='duplicatelist'){pandora.addList(ui._list);}else if(data.id=='editlist'){pandora.ui.listDialog().open();}else if(data.id=='add'){pandora.addItem();}else if(data.id=='upload'){pandora.$ui.uploadVideoDialog=pandora.ui.uploadVideoDialog().open();}else if(data.id=='deletelist'){pandora.ui.deleteListDialog().open();}else if(data.id=='print'){window.open(document.location.href+'#print','_blank');}else if(data.id=='tv'){pandora.UI.set({'part.tv':ui._list});pandora.UI.set({page:'tv'});}else if(data.id=='selectall'){pandora.$ui[ui.section=='edits'?'editPanel':!ui.item?'list':'clipList'].selectAll();}else if(data.id=='selectnone'){ui.section=='edits'?pandora.$ui.editPanel.options({selected:[]}):!ui.item?pandora.UI.set({listSelection:[]}):pandora.$ui.clipList.options({selected:[]});}else if(data.id=='invertselection'){pandora.$ui[ui.section=='edits'?'editPanel':!ui.item?'list':'clipList'].invertSelection();}else if(data.id=='cut'||data.id=='cutadd'){var action=data.id=='cut'?'copy':'add';fromMenu=true;pandora.clipboard[action](ui.listSelection,'item');pandora.doHistory('cut',ui.listSelection,ui._list,function(){pandora.UI.set({listSelection:[]});pandora.reloadList();});}else if(data.id=='copy'||data.id=='copyadd'){var action=data.id=='copy'?'copy':'add';fromMenu=true;pandora.isVideoView()&&!pandora.$ui.browser.hasFocus()?pandora.clipboard[action]([{annotation:ui.videoPoints[ui.item].annotation,'in':pandora.user.ui.videoPoints[ui.item]['in'],item:ui.item,out:ui.videoPoints[ui.item].out}],'clip'):pandora.isClipView()&&!pandora.$ui.browser.hasFocus()?pandora.clipboard[action](pandora.$ui.clipList.options('selected'),'clip'):pandora.clipboard[action](ui.listSelection,'item');}else if(data.id=='paste'){fromMenu=true;var items=pandora.clipboard.paste();pandora.doHistory('paste',items,ui._list,function(){pandora.UI.set({listSelection:items});pandora.reloadList();});}else if(data.id=='clearclipboard'){pandora.clipboard.clear();}else if(data.id=='delete'){pandora.doHistory('delete',ui.listSelection,ui._list,function(){pandora.UI.set({listSelection:[]});pandora.reloadList();});}else if(data.id=='undo'){fromMenu=true;pandora.undoHistory();}else if(data.id=='redo'){fromMenu=true;pandora.redoHistory();}else if(data.id=='clearhistory'){fromMenu=true;pandora.history.clear();}else if(data.id=='clearfilters'){pandora.$ui.filters.clearFilters();}else if(data.id=='resetfilters'){pandora.UI.set({filters:pandora.site.user.ui.filters});pandora.$ui.contentPanel.replaceElement(0,pandora.$ui.browser=pandora.ui.browser());}else if(data.id=='showsidebar'){pandora.UI.set({showSidebar:!ui.showSidebar});}else if(data.id=='showinfo'){pandora.UI.set({showInfo:!ui.showInfo});}else if(data.id=='showfilters'){pandora.UI.set({showFilters:!ui.showFilters});}else if(data.id=='showbrowser'){pandora.UI.set({showBrowser:!ui.showBrowser});}else if(data.id=='showtimeline'){pandora.UI.set({showTimeline:!ui.showTimeline});}else if(data.id=='showannotations'){pandora.UI.set({showAnnotations:!ui.showAnnotations});}else if(data.id=='showclips'){pandora.UI.set({showClips:!ui.showClips});}else if(data.id=='togglefullscreen'){Ox.Fullscreen.toggle();}else if(data.id=='entervideofullscreen'){pandora.$ui.player.options({fullscreen:true});}else if(data.id=='advancedfind'){pandora.$ui.filterDialog=pandora.ui.filterDialog().open();}else if(data.id=='findsimilar'){pandora.$ui.similarClipsDialog=pandora.ui.similarClipsDialog().open();}else if(data.id=='documents'){pandora.$ui.documentsDialog=pandora.ui.documentsDialog().open();}else if(data.id=='titles'){(pandora.$ui.titlesDialog||(pandora.$ui.titlesDialog=pandora.ui.titlesDialog())).open();}else if(data.id=='names'){(pandora.$ui.namesDialog||(pandora.$ui.namesDialog=pandora.ui.namesDialog())).open();}else if(data.id=='places'){(pandora.$ui.placesDialog||(pandora.$ui.placesDialog=pandora.ui.placesDialog())).open();}else if(data.id=='events'){(pandora.$ui.eventsDialog||(pandora.$ui.eventsDialog=pandora.ui.eventsDialog())).open();}else if(data.id=='users'){pandora.$ui.usersDialog=pandora.ui.usersDialog().open();}else if(data.id=='statistics'){pandora.$ui.statisticsDialog=pandora.ui.statisticsDialog().open();}else if(data.id=='clearcache'){Ox.Request.clearCache();}else if(data.id=='cache'){var enabled=pandora.localStorage('enableCache')===false;pandora.localStorage('enableCache',enabled);Ox.Request.options({cache:enabled})
that.setItemTitle('cache',Ox._((enabled?'Disable':'Enable')+' Cache'));that[enabled?'enableItem':'disableItem']('clearcache');}else if(data.id=='debugmode'){if(pandora.localStorage('enableDebugMode')){pandora.localStorage['delete']('enableDebugMode');}else{pandora.localStorage('enableDebugMode',true);}
window.location.reload();}else if(data.id=='eventlogging'){if(pandora.localStorage('enableEventLogging')){pandora.localStorage['delete']('enableEventLogging');}else{pandora.localStorage('enableEventLogging',true);}
Ox.Event[pandora.localStorage('enableEventLogging')?'bind':'unbind'](pandora.logEvent);that.setItemTitle('eventlogging',Ox._((pandora.localStorage('enableEventLogging')?'Disable':'Enable')+' Event Logging'));}else if(data.id=='errorlogs'){pandora.$ui.logsDialog=pandora.ui.logsDialog().open();}else if(data.id=='tests'){pandora.tests();}},key_alt_control_f:function(){if(!pandora.hasDialogOrScreen()&&pandora.getItemIdAndPosition()){pandora.$ui.similarClipsDialog=pandora.ui.similarClipsDialog().open();}},key_alt_control_shift_a:function(){if(!pandora.hasDialogOrScreen()&&!ui.item){pandora.$ui.filters.clearFilters();}},key_alt_control_shift_f:function(){Ox.Fullscreen.toggle();},key_backtick:function(){changeFocus(1);},key_control_comma:function(){if(!pandora.hasDialogOrScreen()){pandora.UI.set({page:'preferences'});}},key_control_f:function(){if(!pandora.hasDialogOrScreen()){if(ui._findState.key!='advanced'){setTimeout(function(){pandora.$ui.findInput.focusInput(true);},25);}else{pandora.$ui.filterDialog=pandora.ui.filterDialog().open();}}},key_control_m:function(){if(!pandora.hasDialogOrScreen()&&!that.isSelected()){that.options('menus')[0].element.trigger('click');}},key_control_p:function(){window.open(document.location.href+'#?print=true','_blank');},key_control_shift_f:function(){if(!pandora.hasDialogOrScreen()){pandora.$ui.filterDialog=pandora.ui.filterDialog().open();}},key_control_shift_slash:function(){if(!pandora.hasDialogOrScreen()){pandora.UI.set({page:'api'});}},key_control_shift_w:function(){if(!pandora.hasDialogOrScreen()||(ui.item||ui._list)){pandora.UI.set({find:{conditions:[],operator:'&'}});}},key_control_shift_z:function(){pandora.redoHistory();},key_control_slash:function(){if(!pandora.hasDialogOrScreen()){pandora.UI.set({page:'help'});}},key_control_space:function(){if(!pandora.hasDialogOrScreen()){pandora.UI.set({'part.tv':ui._list});pandora.UI.set({page:'tv'});}},key_control_w:function(){if(!pandora.hasDialogOrScreen()){if(ui.section=='items'){if(ui.item){pandora.UI.set({item:''});}else if(ui._list){pandora.UI.set({find:{conditions:[],operator:'&'}});}}else if(ui.section=='edits'){pandora.UI.set({edit:''});}else if(ui.section=='texts'){pandora.UI.set({text:''});}}},key_control_z:function(){pandora.undoHistory();},key_shift_a:function(){hasAnnotations()&&pandora.UI.set({showAnnotations:!ui.showAnnotations});},key_shift_b:function(){ui.item&&pandora.UI.set({showBrowser:!ui.showBrowser});},key_shift_c:function(){hasClips&&pandora.UI.set({showClips:!ui.showClips});},key_shift_backtick:function(){changeFocus(-1);},key_shift_f:function(){!ui.item&&pandora.UI.set({showFilters:!ui.showFilters});},key_shift_i:function(){ui.showSidebar&&pandora.UI.set({showInfo:!ui.showInfo});},key_shift_s:function(){pandora.UI.set({showSidebar:!ui.showSidebar});},key_shift_t:function(){hasTimeline()&&pandora.UI.set({showTimeline:!ui.showTimeline});},pandora_edit:function(){},pandora_find:function(){var action=pandora.getListData().editable?'enableItem':'disableItem',list=ui._list,previousList=pandora.UI.getPrevious()._list;if(list!=previousList){that.uncheckItem(previousList==''?'allitems':'viewlist'+previousList.replace(/_/g,Ox.char(9)));that.checkItem(list==''?'allitems':'viewlist'+list.replace(/_/g,'\t'));}
that[action]('editlist');that[action]('duplicatelist');that[action]('deletelist');that[ui.listSelection.length?'enableItem':'disableItem']('newlistfromselection');that.replaceMenu('itemMenu',getItemMenu());that[Ox.sum(ui._filterState.map(function(filterState){return filterState.selected.length;}))>0?'enableItem':'disableItem']('clearfilters');},pandora_filters:function(data){that.replaceMenu('sortMenu',getSortMenu());},pandora_item:function(data){if(!!data.value!=!!data.previousValue){that.replaceMenu('itemMenu',getItemMenu());that[data.value?'disableItem':'enableItem']('showfilters');that[data.value?'enableItem':'disableItem']('showbrowser');that.replaceMenu('sortMenu',getSortMenu());}
if(!data.value){that.disableItem('showannotations');that.disableItem('showtimeline');that.disableItem('entervideofullscreen');}else{if(['timeline','player','editor'].indexOf(ui.itemView)>-1){that.enableItem('showannotations');}
if(ui.itemView=='player'){that.enableItem('showtimeline');that.enableItem('entervideofullscreen');}}},pandora_itemsort:function(data){that.checkItem('sortMenu_sortclips_'+data.value[0].key);that.checkItem('sortMenu_orderclips_'+(data.value[0].operator=='+'?'ascending':'descending'));},pandora_itemview:function(data){var action,isClipView=pandora.isClipView(),isVideoView=pandora.isVideoView(),wasClipView=pandora.isClipView(data.previousValue),wasVideoView=pandora.isVideoView(data.previousValue);if(isClipView!=wasClipView||isVideoView!=wasVideoView){that.replaceMenu('itemMenu',getItemMenu());}
that.checkItem('viewMenu_item_'+data.value);if(isVideoView){that.checkItem('viewMenu_clips_'+data.value);}
if(isVideoView!=wasVideoView){that[isVideoView?'enableItem':'disableItem']('showannotations');}
if((data.value=='player')!=(data.previousValue=='player')){action=data.value=='player'?'enableItem':'disableItem';that[action]('showtimeline');that[action]('entervideofullscreen');}
if(isClipView!=wasClipView){that.replaceMenu('sortMenu',getSortMenu());}
that[pandora.getItemIdAndPosition()?'enableItem':'disableItem']('findsimilar');},pandora_listselection:function(data){var action=data.value.length?'enableItem':'disableItem';that[action]('newlistfromselection');that.replaceMenu('itemMenu',getItemMenu());that[pandora.getItemIdAndPosition()?'enableItem':'disableItem']('findsimilar');},pandora_listsort:function(data){if(pandora.isClipView(ui.listView,false)){that.checkItem('sortMenu_sortclips_'+data.value[0].key);that.checkItem('sortMenu_orderclips_'+(data.value[0].operator=='+'?'ascending':'descending'));}else{that.checkItem('sortMenu_sortitems_'+data.value[0].key);that.checkItem('sortMenu_orderitems_'+(data.value[0].operator=='+'?'ascending':'descending'));}},pandora_listview:function(data){that.checkItem('viewMenu_items_'+data.value);if(pandora.isClipView()!=pandora.isClipView(data.previousValue)||pandora.isVideoView()!=pandora.isVideoView(data.previousValue)){that.replaceMenu('itemMenu',getItemMenu());}
if(pandora.isClipView()!=pandora.isClipView(data.previousValue)){that.replaceMenu('sortMenu',getSortMenu());}
that[pandora.getItemIdAndPosition()?'enableItem':'disableItem']('findsimilar');},pandora_section:function(){that.replaceMenu('listMenu',getListMenu());that.replaceMenu('itemMenu',getItemMenu());that.replaceMenu('sortMenu',getSortMenu());},pandora_showannotations:function(data){that.setItemTitle('showannotations',Ox._((data.value?'Hide':'Show')+' Annotations'));},pandora_showbrowser:function(data){that.setItemTitle('showbrowser',Ox._((data.value?'Hide':'Show')+' {0} Browser',[Ox._(pandora.site.itemName.singular)]));},pandora_showclips:function(data){that.setItemTitle('showclips',Ox._((data.value?'Hide':'Show')+' Clips'));},pandora_showfilters:function(data){that.setItemTitle('showfilters',Ox._((data.value?'Hide':'Show')+' Filters'));},pandora_showinfo:function(data){that.setItemTitle('showinfo',Ox._((data.value?'Hide':'Show')+' Info'));},pandora_showsidebar:function(data){that.setItemTitle('showsidebar',Ox._((data.value?'Hide':'Show')+' Sidebar'));that[data.value?'enableItem':'disableItem']('showinfo');},pandora_showtimeline:function(data){that.setItemTitle('showtimeline',Ox._((data.value?'Hide':'Show')+' Timeline'));},pandora_videopoints:function(data){var action;if(data.value&&data.value['in']){action=data.value['in']!=data.value.out?'enableItem':'disableItem';that[action]('copy');that[action]('copyadd');}},pandora_videotimeline:function(data){that.checkItem('viewMenu_timelines_'+data.value);}});pandora.clipboard.bindEvent(function(data,event){if(Ox.contains(['add','copy','clear'],event)){that.replaceMenu('itemMenu',getItemMenu());}
if(Ox.contains(['add','copy','paste'],event)&&!fromMenu){that.highlightMenu('itemMenu');}
fromMenu=false;});pandora.history.bindEvent(function(data,event){that.replaceMenu('itemMenu',getItemMenu());if(Ox.contains(['undo','redo'],event)&&!fromMenu){that.highlightMenu('itemMenu');}
fromMenu=false;});Ox.Fullscreen.bind('change',function(state){that.setItemTitle('togglefullscreen',Ox._((state?'Exit':'Enter')+' Fullscreen'));});function changeFocus(direction){var elements=[],index,listData=pandora.getListData();elements[0]=!listData.folder?pandora.$ui.allItems:pandora.$ui.folderList[listData.folder];if(!ui.item&&ui.showFilters){pandora.$ui.filters.forEach(function($filter){if($filter.options('selected').length){elements.push($filter);}});}else if(ui.item&&ui.showBrowser){elements.push(pandora.$ui.browser);}
if(!ui.item){if(['map','calendar'].indexOf(ui.listView)>-1){elements.push(pandora.$ui[ui.listView]);if(pandora.$ui.clipList.options('selected').length){elements.push(pandora.$ui.clipList);}}else if(pandora.$ui.list.options('selected').length){elements.push(pandora.$ui.list);}}else{if(['player','editor','timeline','map','calendar'].indexOf(ui.itemView)>-1){elements.push(pandora.$ui[ui.itemView]);}
if(['clips','map','calendar'].indexOf(ui.itemView)>-1&&pandora.$ui.clipList.options('selected').length){elements.push(pandora.$ui.clipList);}
if(ui.itemView=='data'&&pandora.$ui.item.options('selected').length){elements.push(pandora.$ui.item);}}
index=direction==1?-1:elements.length;Ox.forEach(elements,function(element,i){if(element.hasFocus()){index=i;return false;}});elements[Ox.mod((index+direction),elements.length)].gainFocus();}
function getItemMenu(){var listData=pandora.getListData(),isClipView=pandora.isClipView()&&pandora.$ui.clipList&&pandora.$ui.clipList.hasFocus(),isVideoView=pandora.isVideoView()&&pandora.$ui[ui.itemView]&&pandora.$ui[ui.itemView].hasFocus(),listName=isVideoView||isClipView?'':ui.section=='items'?'from List':'from Edit',listItemsName=Ox._(ui.section=='edits'||isVideoView||isClipView?'Clips':pandora.site.itemName.plural),selectionItems=isVideoView?1:isClipView?pandora.$ui.clipList.options('selected').length:ui.listSelection.length,selectionItemName=(selectionItems>1?Ox.formatNumber(selectionItems)+' ':'')+Ox._(isVideoView?'Clip':ui.section=='edits'||isClipView?(selectionItems==1?'Clip':'Clips'):pandora.site.itemName[selectionItems==1?'singular':'plural']),clipboardItems=pandora.clipboard.items(),clipboardType=pandora.clipboard.type(),clipboardItemName=clipboardItems==0?'':(clipboardItems>1?Ox.formatNumber(clipboardItems)+' ':'')+Ox._(clipboardType=='item'?pandora.site.itemName[clipboardItems==1?'singular':'plural']:clipboardType=='clip'?(clipboardItems==1?'Clip':'Clips'):''),canSelect=ui.section=='edits'||!ui.item||isClipView,canCopy=isVideoView?ui.videoPoints[ui.item]['in']!=ui.videoPoints[ui.item].out:isClipView?pandora.$ui.clipList.options('selected').length:!!ui.listSelection.length,canAdd=canCopy&&clipboardItems>0&&((clipboardType=='item')==(!isVideoView&&!isClipView)),canPaste=!ui.item&&!isClipView&&!isVideoView&&listData.editable&&listData.type=='static'&&pandora.clipboard.type()=='item',canCut=canCopy&&!ui.item&&!isClipView&&!isVideoView&&listData.editable&&listData.type=='static',historyItems=pandora.history.items(),undoText=pandora.history.undoText(),redoText=pandora.history.redoText();return{id:'itemMenu',title:Ox._('Item'),items:[{id:'add',title:Ox._('Add {0}',[Ox._(pandora.site.itemName.singular)]),disabled:pandora.site.itemRequiresVideo||!pandora.site.capabilities.canAddItems[pandora.user.level]},{id:'upload',title:Ox._('Upload Video...'),disabled:!pandora.site.capabilities.canAddItems[pandora.user.level]},{},{id:'selectall',title:Ox._('Select All {0}',[listItemsName]),disabled:!canSelect,keyboard:'control a'},{id:'selectnone',title:Ox._('Select None'),disabled:!canSelect,keyboard:'shift control a'},{id:'invertselection',title:Ox._('Invert Selection'),disabled:!canSelect,keyboard:'alt control a'},{},{id:'cut',title:Ox._('Cut {0}',[selectionItemName]),disabled:!canCut,keyboard:'control x'},{id:'cutadd',title:Ox._('Cut and Add to Clipboard'),disabled:!canCut||!canAdd,keyboard:'shift control x'},{id:'copy',title:Ox._('Copy {0}',[selectionItemName]),disabled:!canCopy,keyboard:'control c'},{id:'copyadd',title:Ox._('Copy and Add to Clipboard'),disabled:!canCopy||!canAdd,keyboard:'shift control c'},{id:'paste',title:clipboardItems==0?Ox._('Paste'):Ox._('Paste {0}',[clipboardItemName]),disabled:!canPaste,keyboard:'control v'},{id:'clearclipboard',title:Ox._('Clear Clipboard'),disabled:!clipboardItems},{},{id:'delete',title:Ox._('Delete {0} {1}',[selectionItemName,listName]),disabled:!canCut,keyboard:'delete'},{},{id:'undo',title:undoText?Ox._('Undo {0}',[undoText]):Ox._('Undo'),disabled:!undoText,keyboard:'control z'},{id:'redo',title:redoText?Ox._('Redo {0}',[redoText]):Ox._('Redo'),disabled:!redoText,keyboard:'shift control z'},{id:'clearhistory',title:Ox._('Clear History'),disabled:!historyItems}]};}
function getListMenu(lists){var itemNameSingular=ui.section=='items'?'List':ui.section=='edits'?'Edit':'Text',itemNamePlural=ui.section=='items'?'Lists':ui.section=='edits'?'Edits':'Texts';return{id:'listMenu',title:Ox._(itemNameSingular),items:[].concat({id:'allitems',title:pandora.getAllItemsTitle(),checked:ui.section=='items'?!ui.item&&!ui._list:ui.section=='edits'?!ui.edit:!ui.text,keyboard:'shift control w'},['personal','favorite','featured'].map(function(folder){return{id:folder+'lists',title:Ox._(Ox.toTitleCase(folder)+' '+itemNamePlural),items:Ox.isUndefined(lists)?[{id:'loading',title:Ox._('Loading...'),disabled:true}]:lists[folder].length==0?[{id:'nolists',title:Ox._('No '+Ox.toTitleCase(folder)+' '+itemNamePlural),disabled:true}]:lists[folder].map(function(list){return{id:'viewlist'+list.id.replace(/_/g,Ox.char(9)),title:Ox.encodeHTMLEntities((folder=='favorite'?list.user+': ':'')+list.name),checked:ui.section=='items'?list.id==ui._list:ui.section=='edits'?list.id==ui.edit:list.id==ui.text};})};}),[{},{id:'newlist',title:Ox._('New '+itemNameSingular),disabled:isGuest,keyboard:'control n'},],ui.section!='texts'?[{id:'newlistfromselection',title:Ox._('New '+itemNameSingular+' from Selection'),disabled:isGuest||ui.listSelection.length==0,keyboard:'shift control n'},{id:'newsmartlist',title:Ox._('New Smart '+itemNameSingular),disabled:isGuest,keyboard:'alt control n'},{id:'newsmartlistfromresults',title:Ox._('New Smart '+itemNameSingular+' from Results'),disabled:isGuest,keyboard:'shift alt control n'},]:[],[{},{id:'duplicatelist',title:Ox._('Duplicate Selected '+itemNameSingular),disabled:isGuest||!ui._list,keyboard:'control d'},{id:'editlist',title:Ox._('Edit Selected '+itemNameSingular+'...'),disabled:isGuest||!ui._list,keyboard:'control e'},{id:'deletelist',title:Ox._('Delete Selected '+itemNameSingular+'...'),disabled:isGuest||!ui._list,keyboard:'delete'}],ui.section=='items'?[{},{id:'print',title:Ox._('Print'),keyboard:'control p'},{id:'tv',title:Ox._('TV'),keyboard:'control space'}]:[])};};function getSortMenu(){var isClipView=pandora.isClipView(),clipItems=(isClipView?pandora.site.clipKeys.map(function(key){return Ox.extend(Ox.clone(key),{checked:ui.listSort[0].key==key.id,title:(!ui.item?Ox._('Clip')+' ':'')+Ox._(key.title)});}):[]).concat(!ui.item?pandora.site.sortKeys.map(function(key){return Ox.extend({checked:ui.listSort[0].key==key.id},key);}):[]);return{id:'sortMenu',title:Ox._('Sort'),items:[{id:'sortitems',title:Ox._('Sort {0} by',[Ox._(pandora.site.itemName.plural)]),disabled:ui.section!='items'||(!ui.item&&isClipView),items:[{group:'itemsort',min:1,max:1,items:pandora.site.sortKeys.map(function(key){return Ox.extend({checked:ui.listSort[0].key==key.id},key,{title:Ox._(key.title)});})}]},{id:'orderitems',title:Ox._('Order {0}',[Ox._(pandora.site.itemName.plural)]),disabled:ui.section!='items'||(!ui.item&&isClipView),items:[{group:'itemorder',min:1,max:1,items:[{id:'ascending',title:Ox._('Ascending'),checked:(ui.listSort[0].operator||pandora.getSortOperator(ui.listSort[0].key))=='+'},{id:'descending',title:Ox._('Descending'),checked:(ui.listSort[0].operator||pandora.getSortOperator(ui.listSort[0].key))=='-'}]}]},{id:'sortclips',title:Ox._('Sort Clips by'),disabled:!isClipView,items:[{group:'clipsort',min:1,max:1,items:clipItems}]},{id:'orderclips',title:Ox._('Order Clips'),disabled:!isClipView,items:[{group:'cliporder',min:1,max:1,items:[{id:'ascending',title:Ox._('Ascending'),checked:(ui.listSort[0].operator||pandora.getSortOperator(ui.listSort[0].key))=='+'},{id:'descending',title:Ox._('Descending'),checked:(ui.listSort[0].operator||pandora.getSortOperator(ui.listSort[0].key))=='-'}]}]},{id:'advancedsort',title:Ox._('Advanced Sort...'),keyboard:'shift control s',disabled:true},{},{id:'sortfilters',title:Ox._('Sort Filters'),disabled:ui.section!='items',items:ui.filters.map(function(filter){return{id:'sortfilter'+filter.id,title:Ox._('Sort {0} Filter by',[Ox._(Ox.getObjectById(pandora.site.filters,filter.id).title)]),items:[{group:'sortfilter'+filter.id,min:1,max:1,items:[{id:'name',title:Ox._('Name'),checked:filter.sort[0].key=='name'},{id:'items',title:Ox._('Items'),checked:filter.sort[0].key=='items'}]}]}})},{id:'orderfilters',title:Ox._('Order Filters'),disabled:ui.section!='items',items:ui.filters.map(function(filter){return{id:'orderfilter'+filter.id,title:Ox._('Order {0} Filter',[Ox._(Ox.getObjectById(pandora.site.filters,filter.id).title)]),items:[{group:'orderfilter'+filter.id,min:1,max:1,items:[{id:'ascending',title:Ox._('Ascending'),checked:filter.sort[0].operator=='+'},{id:'descending',title:Ox._('Descending'),checked:filter.sort[0].operator=='-'}]}]}})}]};}
function hasAnnotations(){return ui.section=='items'&&ui.item&&pandora.isVideoView();}
function hasClips(){return ui.section=='edits'&&ui.edit;}
function hasTimeline(){return(ui.section=='items'&&ui.item&&ui.itemView=='player')||(ui.section=='edits'&&ui.edit);}
that.replaceItemMenu=function(){that.replaceMenu('itemMenu',getItemMenu());return that;};var counter=0,lists={},queries={personal:{conditions:[{key:'user',value:pandora.user.username,operator:'=='},{key:'status',value:'featured',operator:'!='}],operator:'&'},favorite:{conditions:[{key:'subscribed',value:true,operator:'='},{key:'status',value:'featured',operator:'!='},],operator:'&'},featured:{conditions:[{key:'status',value:'featured',operator:'='}],operator:'&'}};Ox.forEach(queries,function(query,folder){pandora.api[ui.section=='items'?'findLists':ui.section=='edits'?'findEdits':'findTexts']({query:query,keys:['id','name','user'],sort:[{key:'position',operator:'+'}]},function(result){lists[folder]=result.data.items;if(++counter==3){pandora.$ui.mainMenu.replaceMenu('listMenu',getListMenu(lists));}});});return that;};'use strict';pandora.ui.embedNavigation=function(type){var that=pandora.ui.navigationView(type,pandora.site.video.previewRatio);that.resizePanel=function(){pandora.$ui.map.resizeMap();return that;};return that;};'use strict';pandora.ui.editor=function(data){var ui=pandora.user.ui,that=Ox.VideoAnnotationPanel({annotationsCalendarSize:ui.annotationsCalendarSize,annotationsFont:ui.annotationsFont,annotationsMapSize:ui.annotationsMapSize,annotationsRange:ui.annotationsRange,annotationsSize:ui.annotationsSize,annotationsSort:ui.annotationsSort,annotationsTooltip:Ox._('annotations {0}',['<span class="OxBright">'+Ox.SYMBOLS.SHIFT+'A</span>']),censored:data.censored,censoredIcon:pandora.site.cantPlay.icon,censoredTooltip:pandora.site.cantPlay.text,clickLink:pandora.clickLink,cuts:data.cuts||[],duration:data.duration,enableDownload:pandora.site.capabilities.canDownloadVideo[pandora.user.level]>=data.rightslevel,enableImport:pandora.site.capabilities.canImportAnnotations[pandora.user.level],enableSetPosterFrame:!pandora.site.media.importFrames&&data.editable,enableSubtitles:ui.videoSubtitles,find:ui.itemFind,getFrameURL:function(position){return'/'+ui.item+'/'+ui.videoResolution+'p'+position+'.jpg?'+data.modified;},getLargeTimelineURL:function(type,i){return'/'+ui.item+'/timeline'+type+'64p'+i+'.jpg?'+data.modified;},getSmallTimelineURL:function(type,i){return'/'+ui.item+'/timeline'+type+'16p'+i+'.jpg?'+data.modified;},height:pandora.$ui.contentPanel.size(1),id:'editor','in':ui.videoPoints[ui.item]['in'],layers:data.annotations.map(function(layer){return Ox.extend({editable:layer.canAddAnnotations[pandora.user.level]},layer);}),loop:ui.videoLoop,muted:ui.videoMuted,out:ui.videoPoints[ui.item].out,position:ui.videoPoints[ui.item].position,posterFrame:data.posterFrame,resolution:ui.videoResolution,selected:ui.videoPoints[ui.item].annotation?ui.item+'/'+ui.videoPoints[ui.item].annotation:'',showAnnotations:ui.showAnnotations,showAnnotationsCalendar:ui.showAnnotationsCalendar,showAnnotationsMap:ui.showAnnotationsMap,showLargeTimeline:true,showLayers:Ox.clone(ui.showLayers),showUsers:pandora.site.annotations.showUsers,subtitles:data.subtitles,subtitlesLayer:data.subtitlesLayer,timeline:ui.videoTimeline,timelines:pandora.site.timelines,video:data.video,videoRatio:data.videoRatio,videoSize:ui.videoSize,volume:ui.videoVolume,width:pandora.$ui.document.width()-pandora.$ui.mainPanel.size(0)-1}).bindEvent({addannotation:function(data){Ox.Log('','addAnnotation',data);setTimeout(function(){var created=Ox.formatDate(new Date(),'%Y-%m-%dT%H:%M:%SZ'),type=Ox.getObjectById(pandora.site.layers,data.layer).type;that.addAnnotation(data.layer,Ox.extend({created:created,duration:data.out-data['in'],editable:true,id:'_'+Ox.uid(),'in':data['in'],modified:created,out:data.out,user:pandora.user.username,value:''},type=='place'?{place:{lat:null,lng:null}}:type=='event'?{event:{start:'',end:''}}:{}));Ox.Request.clearCache();});},annotationsfont:function(data){pandora.UI.set({annotationsFont:data.font});},annotationsrange:function(data){pandora.UI.set({annotationsRange:data.range});},annotationssize:function(data){pandora.UI.set({annotationsSize:data.size});},annotationssort:function(data){pandora.UI.set({annotationsSort:data.sort});},censored:function(){pandora.URL.push(pandora.site.cantPlay.link);},copy:function(data){pandora.clipboard.copy(data.map(function(clip){return clip.annotation||ui.item+'/'+clip['in']+'-'+clip.out}),'clip');},copyadd:function(data){pandora.clipboard.add(data.map(function(clip){return clip.annotation||ui.item+'/'+clip['in']+'-'+clip.out}),'clip');},define:function(data){var dialog=data.type+'sDialog';pandora.$ui[dialog]&&pandora.$ui[dialog].remove();pandora.$ui[dialog]=pandora.ui[dialog](data).open();},downloadvideo:function(data){document.location.href=pandora.getDownloadLink(ui.item);},downloadselection:function(data){document.location.href='/'+ui.item
+'/'+Ox.max(pandora.site.video.resolutions)
+'p.webm?t='+data['in']+','+data.out;},editannotation:function(data){Ox.Log('','editAnnotation',data);function callback(result){Ox.Log('','editAnnotation result',result);result.data.date=Ox.formatDate(result.data.modified.slice(0,10),'%B %e, %Y');that.updateAnnotation(data.id,result.data);Ox.Request.clearCache();};if(data.id[0]=='_'){pandora.api.addAnnotation({'in':data['in'],item:ui.item,layer:data.layer,out:data.out,value:data.value},callback);}else{pandora.api.editAnnotation({id:data.id,'in':data['in'],out:data.out,value:data.value},callback);}},embedselection:function(){pandora.$ui.embedVideoDialog&&pandora.$ui.embedVideoDialog.remove();pandora.$ui.embedVideoDialog=pandora.ui.embedVideoDialog().open();},find:function(data){pandora.UI.set({itemFind:data.find});},findannotations:function(data){pandora.UI.set({item:'',find:{conditions:[{key:data.key,value:data.value,operator:'='}],operator:'&'},listView:'clip'});},gainfocus:function(){pandora.$ui.mainMenu.replaceItemMenu();},importannotations:function(data){pandora.ui.importAnnotations().open();},info:function(data){pandora.ui.annotationDialog(Ox.getObjectById(pandora.site.layers,data.layer).title).open();},loop:function(data){pandora.UI.set({videoLoop:data.loop});},muted:function(data){pandora.UI.set({videoMuted:data.muted});},playing:function(data){pandora.UI.set('videoPoints.'+ui.item+'.position',data.position);},points:function(data){pandora.UI.set('videoPoints.'+ui.item,{annotation:ui.videoPoints[ui.item].annotation,'in':data['in'],out:data.out,position:data.position});},position:function(data){pandora.UI.set('videoPoints.'+ui.item+'.position',data.position);},posterframe:function(data){pandora.api.setPosterFrame({id:ui.item,position:data.position},function(){if(pandora.$ui.videoPreview){pandora.$ui.videoPreview.options({position:data.position});}
if(ui.listSort[0].key=='modified'){Ox.Request.clearCache('find');pandora.$ui.browser.reloadList().bindEventOnce({load:function(){updateBrowser();}});}else{updateBrowser();}});},removeannotation:function(data){pandora.UI.set('videoPoints.'+ui.item+'.annotation',null);pandora.api.removeAnnotation({id:data.id},function(result){Ox.Request.clearCache();});},resize:function(data){that.options({height:data.size});},resizecalendar:function(data){pandora.UI.set({annotationsCalendarSize:data.size});},resizemap:function(data){pandora.UI.set({annotationsMapSize:data.size});},resolution:function(data){pandora.UI.set({videoResolution:data.resolution});},select:function(data){pandora.UI.set('videoPoints.'+ui.item+'.annotation',data.id.split('/')[1]||'');},subtitles:function(data){pandora.UI.set({videoSubtitles:data.subtitles});},timeline:function(data){pandora.UI.set({videoTimeline:data.timeline});},toggleannotations:function(data){pandora.UI.set({showAnnotations:data.showAnnotations});},togglecalendar:function(data){pandora.UI.set({showAnnotationsCalendar:!data.collapsed});},togglelayer:function(data){pandora.UI.set('showLayers.'+data.layer,!data.collapsed);},togglemap:function(data){pandora.UI.set({showAnnotationsMap:!data.collapsed});},togglesize:function(data){pandora.UI.set({videoSize:data.size});},pandora_showannotations:function(data){that.options({showAnnotations:data.value});},pandora_videotimeline:function(data){that.options({timeline:data.value});}});function updateBrowser(){pandora.$ui.browser.find('img[src*="/'+ui.item+'/"]').each(function(){$(this).attr({src:'/'+ui.item+'/'+(ui.icons=='posters'?'poster':'icon')+'128.jpg?'+Ox.uid()});});}
return that;};'use strict';pandora.ui.player=function(data){var ui=pandora.user.ui,that=Ox.VideoPlayerPanel({annotationsCalendarSize:ui.annotationsCalendarSize,annotationsFont:ui.annotationsFont,annotationsMapSize:ui.annotationsMapSize,annotationsRange:ui.annotationsRange,annotationsSize:ui.annotationsSize,annotationsSort:ui.annotationsSort,annotationsTooltip:Ox._('annotations {0}',['<span class="OxBright">'+Ox.SYMBOLS.SHIFT+'A</span>']),censored:data.censored,censoredIcon:pandora.site.cantPlay.icon,censoredTooltip:pandora.site.cantPlay.text,clickLink:pandora.clickLink,cuts:data.cuts||[],duration:data.duration,enableDownload:pandora.site.capabilities.canDownloadVideo[pandora.user.level]>=data.rightslevel,enableSubtitles:ui.videoSubtitles,find:ui.itemFind,getLargeTimelineURL:function(type,i){return'/'+ui.item+'/timeline'+type+'64p'+i+'.jpg';},height:pandora.$ui.contentPanel.size(1),'in':ui.videoPoints[ui.item]['in'],layers:data.annotations,loop:ui.videoLoop,muted:ui.videoMuted,out:ui.videoPoints[ui.item].out,position:ui.videoPoints[ui.item].position,resolution:ui.videoResolution,scaleToFill:ui.videoScale=='fill',selected:ui.videoPoints[ui.item].annotation?ui.item+'/'+ui.videoPoints[ui.item].annotation:'',showAnnotations:ui.showAnnotations,showAnnotationsCalendar:ui.showAnnotationsCalendar,showAnnotationsMap:ui.showAnnotationsMap,showLayers:Ox.clone(ui.showLayers),showUsers:pandora.site.annotations.showUsers,showTimeline:ui.showTimeline,smallTimelineURL:'/'+ui.item+'/timeline16p.jpg',subtitles:data.subtitles,timeline:ui.videoTimeline,timelineTooltip:'timeline <span class="OxBright">'+Ox.SYMBOLS.SHIFT+'T</span>',video:data.video,volume:ui.videoVolume,width:pandora.$ui.document.width()-pandora.$ui.mainPanel.size(0)-1}).bindEvent({annotationsfont:function(data){pandora.UI.set({annotationsFont:data.font});},annotationsrange:function(data){pandora.UI.set({annotationsRange:data.range});},annotationssize:function(data){pandora.UI.set({annotationsSize:data.size});},annotationssort:function(data){pandora.UI.set({annotationsSort:data.sort});},censored:function(){that.options('fullscreen')&&that.options({fullscreen:false});pandora.URL.push(pandora.site.cantPlay.link);},copy:function(data){pandora.clipboard.copy(data.map(function(clip){return clip.annotation||ui.item+'/'+clip['in']+'-'+clip.out;}),'clip');},copyadd:function(data){pandora.clipboard.add(data.map(function(clip){return clip.annotation||ui.item+'/'+clip['in']+'-'+clip.out;}),'clip');},downloadvideo:function(data){document.location.href=pandora.getDownloadLink(ui.item);},find:function(data){pandora.UI.set({itemFind:data.find});},gainfocus:function(){pandora.$ui.mainMenu.replaceItemMenu();},info:function(data){pandora.ui.annotationDialog(Ox.getObjectById(pandora.site.layers,data.layer).title).open();},loop:function(data){pandora.UI.set({videoLoop:data.loop});},muted:function(data){pandora.UI.set({videoMuted:data.muted});},playing:function(data){pandora.UI.set('videoPoints.'+ui.item+'.position',data.position);},points:function(data){pandora.UI.set('videoPoints.'+ui.item,{annotation:ui.videoPoints[ui.item].annotation,'in':data['in'],out:data.out,position:data.position});},position:function(data){pandora.UI.set('videoPoints.'+ui.item+'.position',data.position);},resizeannotations:function(data){pandora.UI.set({annotationsSize:data.annotationsSize});},resizecalendar:function(data){pandora.UI.set({annotationsCalendarSize:data.size});},resizemap:function(data){pandora.UI.set({annotationsMapSize:data.size});},resolution:function(data){pandora.UI.set({videoResolution:data.resolution});},scale:function(data){pandora.UI.set({videoScale:data.scale});},select:function(data){pandora.UI.set('videoPoints.'+ui.item+'.annotation',data.id.split('/')[1]||'');},subtitles:function(data){pandora.UI.set({videoSubtitles:data.subtitles});},toggleannotations:function(data){pandora.UI.set({showAnnotations:data.showAnnotations});},togglelayer:function(data){pandora.UI.set('showLayers.'+data.layer,!data.collapsed);},togglemap:function(data){pandora.UI.set({showAnnotationsMap:!data.collapsed});},togglesize:function(data){pandora.UI.set({videoSize:data.size});},toggletimeline:function(data){pandora.UI.set({showTimeline:data.showTimeline});},volume:function(data){pandora.UI.set({videoVolume:data.volume});},pandora_showannotations:function(data){that.options({showAnnotations:data.value});},pandora_showtimeline:function(data){that.options({showTimeline:data.value});},pandora_videotimeline:function(data){that.options({timeline:data.value});}});return that;};'use strict';pandora.ui.embedVideoDialog=function(){var width=640,height=360,url=document.location.href+(document.location.hash?'embed':'#embed'),$content=Ox.Element().css({margin:'16px'}).html(Ox._('To embed this clip, use the following HTML:<br>')),$embed=$('<textarea>').css({width:'336px',height:'64px',marginTop:'8px'}).val('<iframe width="'+width
+'" height="'+height
+'" src="'+url
+'" frameborder="0" '
+'allowfullscreen></iframe>').on({click:function(){this.focus();this.select();}}).appendTo($content),that=Ox.Dialog({buttons:[Ox.Button({id:'close',title:Ox._('Close')}).bindEvent({click:function(){that.close();}})],closeButton:true,content:$content,fixedSize:true,height:128,keys:{escape:'close'},removeOnClose:true,title:Ox._('Embed Video'),width:368});return that;};'use strict';pandora.ui.localeButton=function(){var isGuest=pandora.user.level=='guest',that=Ox.Element({tooltip:'Click to change language'}).addClass('OxLight').css({padding:'0 2px',margin:'2px 3px 2px 1px',fontSize:'9px'}).html('['+pandora.user.ui.locale.toUpperCase()+']').bindEvent({anyclick:function(){if(isGuest){pandora.$ui.appearanceDialog=pandora.ui.appearanceDialog().open();}else{pandora.UI.set({'part.preferences':'appearance'});pandora.UI.set({page:'preferences'});}}});return that;};'use strict';pandora.ui.item=function(){var isVideoView=['timeline','player','editor'].indexOf(pandora.user.ui.itemView)>-1,item=pandora.user.ui.item,that=Ox.Element(),videopointsEvent='pandora_videopoints.'+item.toLowerCase();pandora.api.get({id:pandora.user.ui.item,keys:isVideoView?['cuts','director','duration','durations','editable','layers','modified','parts','posterFrame','rendered','rightslevel','size','title','videoRatio','year']:pandora.user.ui.itemView=='documents'?['director','documents','duration','durations','editable','rightslevel','size','title','videoRatio','year']:[]},pandora.user.ui.itemView=='info'&&pandora.site.capabilities.canEditMetadata[pandora.user.level]?0:-1,function(result){if(pandora.user.ui.item!=item){return;}
if(result.status.code==200){var documentTitle=pandora.getDocumentTitle(result.data);document.title=pandora.getPageTitle(document.location.pathname)||documentTitle;}
pandora.$ui.itemTitle.options({title:'<b>'+pandora.getItemTitle(result.data)+'</b>'}).show();isVideoView&&Ox.extend(result.data,pandora.getVideoOptions(result.data));if(!result.data.rendered&&['clips','timeline','player','editor','map','calendar'].indexOf(pandora.user.ui.itemView)>-1){pandora.$ui.contentPanel.replaceElement(1,Ox.Element().css({marginTop:'32px',fontSize:'12px',textAlign:'center'}).html(Ox._('Sorry, <i>{0}</i>'
+' currently doesn\'t have '
+(['a','e','i','o'].indexOf(pandora.user.ui.itemView.slice(0,1))>-1?'an':'a')+' '
+'{1} view.',[result.data.title,Ox._(pandora.user.ui.itemView)])));}else if(pandora.user.ui.itemView=='info'){pandora.$ui.contentPanel.replaceElement(1,pandora.$ui.item=pandora.ui.infoView(result.data).bindEvent({resize:function(){pandora.$ui.item.resizeElement&&pandora.$ui.item.resizeElement();}}));}else if(pandora.user.ui.itemView=='documents'){pandora.$ui.contentPanel.replaceElement(1,pandora.$ui.documents=pandora.ui.documentsView(result.data));}else if(pandora.user.ui.itemView=='player'){pandora.$ui.contentPanel.replaceElement(1,pandora.$ui.player=pandora.ui.player(result.data));}else if(pandora.user.ui.itemView=='editor'){pandora.$ui.contentPanel.replaceElement(1,pandora.$ui.editor=pandora.ui.editor(result.data));}else if(pandora.user.ui.itemView=='timeline'){pandora.$ui.contentPanel.replaceElement(1,pandora.$ui.timeline=pandora.ui.timeline(result.data));}else if(pandora.user.ui.itemView=='clips'){pandora.$ui.contentPanel.replaceElement(1,pandora.ui.clipsView(result.data.videoRatio));}else if(pandora.user.ui.itemView=='map'){pandora.$ui.contentPanel.replaceElement(1,pandora.ui.navigationView('map',result.data.videoRatio));}else if(pandora.user.ui.itemView=='calendar'){pandora.$ui.contentPanel.replaceElement(1,pandora.ui.navigationView('calendar',result.data.videoRatio));}else if(pandora.user.ui.itemView=='data'){pandora.$ui.item=Ox.TreeList({data:result.data,width:pandora.$ui.mainPanel.size(1)-Ox.UI.SCROLLBAR_SIZE});pandora.$ui.contentPanel.replaceElement(1,Ox.Container().append(pandora.$ui.item));}else if(pandora.user.ui.itemView=='media'){pandora.$ui.contentPanel.replaceElement(1,pandora.$ui.item=pandora.ui.mediaView({id:result.data.id}));}else if(pandora.user.ui.itemView=='frames'||pandora.user.ui.itemView=='posters'){pandora.$ui.contentPanel.replaceElement(1,pandora.$ui.item=pandora.ui.PostersView().bindEvent({resize:function(){pandora.$ui.item.resizeElement();}}));}
if(isVideoView&&result.data.rendered){pandora.$ui[pandora.user.ui.itemView].bindEvent(videopointsEvent,function(data,event,element){var options={};if(event==videopointsEvent){if(data&&data.value&&data.value.annotation){options.selected=pandora.user.ui.item+'/'+data.value.annotation;}else{['annotation','in','out','position'].forEach(function(key){if(!Ox.isUndefined(data.value[key])){options[key=='annotation'?'selected':key]=data.value[key];}});}
pandora.$ui[pandora.user.ui.itemView].options(options);}});}});return that;};'use strict';pandora.ui.uploadVideoDialog=function(data){var cancelled=false,file,hasFirefogg=!(typeof Firefogg=='undefined'),selectFile,$actionButton,$closeButton,$content=Ox.Element().css({margin:'16px'}),$info=$('<div>').css({padding:'4px'}).html(Ox._('Please select the video file you want to upload.')),$progress,$status=$('<div>').css({padding:'4px',paddingTop:'8px'}),that=Ox.Dialog({buttons:[$closeButton=Ox.Button({id:'close',title:Ox._('Close')}).css({float:'left'}).bindEvent({click:function(){if($closeButton.options('title')==Ox._('Cancel')){cancelled=true;pandora.firefogg&&pandora.firefogg.cancel();pandora.$ui.upload&&pandora.$ui.upload.abort();$closeButton.options('title',Ox._('Close'));$actionButton.show();}else{that.triggerEvent('close');}}}),$actionButton=hasFirefogg?Ox.Button({id:'action',title:Ox._('Select Video')}).bindEvent({click:function(){if($actionButton.options('title')==Ox._('Select Video')){if(selectVideo()){$actionButton.options('title',Ox._('Upload'));}}else if($actionButton.options('title')==Ox._('Cancel')){cancelled=true;pandora.firefogg&&pandora.firefogg.cancel();pandora.$ui.upload&&pandora.$ui.upload.abort();$actionButton.options('title',Ox._('Select Video'));$closeButton.show();}else{$closeButton.options('title',Ox._('Cancel'));$actionButton.hide().options('title',Ox._('Select Video'));encode();}}}):Ox.FileButton({id:'action',title:Ox._('Select Video'),maxFiles:1,width:96}).bindEvent({click:function(data){if(data.files.length){$actionButton.hide();$closeButton.options('title',Ox._('Cancel'));upload(data.files[0]);}}})],content:$content,height:128,removeOnClose:true,width:368,title:Ox._('Upload Video'),}).bindEvent({close:function(data){if(pandora.firefogg){pandora.firefogg.cancel();delete pandora.firefogg;}
that.close();}});if(!pandora.site.itemRequiresVideo&&!pandora.user.ui.item){$info.html(Ox._('You can only upload a video to an existing {0}.'
+' Please check if an entry for the {0}'
+' you want to upload exists and create otherwise.',[pandora.site.itemName.singular.toLowerCase()]));$actionButton.hide();}
$content.append($info);$content.append($status);function aspectratio(ratio){var denominator,numerator;ratio=ratio.split(':');numerator=ratio[0];if(ratio.length==2){denominator=ratio[1];}
if(Math.abs(numerator/denominator-4/3)<0.03){numerator=4;denominator=3;}else if(Math.abs(numerator/denominator-16/9)<0.02){numerator=16;denominator=9;}
return{denominator:denominator,'float':numerator/denominator,numerator:numerator,ratio:numerator+':'+denominator};}
function resetProgress(status){$progress=Ox.Progressbar({progress:0,showPercent:true,showTime:true,width:304});$status.html(status||'').append($progress);}
function encode(){var filename=pandora.firefogg.sourceFilename,info=JSON.parse(pandora.firefogg.sourceInfo),item,oshash=info.oshash;$info.html('<b>'+filename+'</b><br>'+Ox._('encoding...'));resetProgress();pandora.api.addMedia({filename:filename,id:oshash,info:info,item:pandora.site.itemRequiresVideo?undefined:pandora.user.ui.item},function(result){item=result.data.item;pandora.firefogg.encode(getEncodingOptions(info),function(result,file){result=JSON.parse(result);if(result.progress!=1){$status.html(cancelled?Ox._('Encoding cancelled.'):Ox._('Encoding failed.'));delete pandora.firefogg;return;}
setTimeout(function(){$info.html('<b>'+filename+'</b><br>'+Ox._('uploading...'));uploadStream(item,oshash,file);});},function(progress){progress=JSON.parse(progress).progress||0;$progress.options({progress:progress});});});}
function uploadStream(item,oshash,file){var format=pandora.site.video.formats[0],resolution=Ox.max(pandora.site.video.resolutions);pandora.$ui.upload=pandora.chunkupload({file:file,url:'/api/upload/?profile='+resolution+'p.'+format+'&id='+oshash,data:{}}).bindEvent({done:function(data){if(data.progress==1){Ox.Request.clearCache();if(pandora.user.ui.item==item&&pandora.user.ui.itemView=='media'){pandora.$ui.item.reload();}else{pandora.UI.set({item:item,itemView:'media'});}
delete pandora.firefogg;that.close();}else{$status.html(Ox._('Upload Failed.'));pandora.api.log({text:data.responseText,url:'/'+item,line:1});}},progress:function(data){$progress.options({progress:data.progress||0});},});}
function upload(file){resetProgress();$info.html(Ox._('Uploading {0}',[file.name]));Ox.oshash(file,function(oshash){pandora.api.findMedia({query:{conditions:[{key:'oshash',value:oshash}]},keys:['id','item','available']},function(result){if(result.data.items.length===0||!result.data.items[0].available){pandora.api.addMedia({filename:file.name,id:oshash,item:pandora.site.itemRequiresVideo?undefined:pandora.user.ui.item},function(result){var item=result.data.item;pandora.$ui.upload=pandora.chunkupload({file:file,url:'/api/upload/direct/',data:{id:oshash}}).bindEvent({done:function(data){if(data.progress==1){Ox.Request.clearCache();if(pandora.user.ui.item==item&&pandora.user.ui.itemView=='media'){pandora.$ui.item.reload();}else{pandora.UI.set({item:item,itemView:'media'});}
that.close();}else{$status.html(cancelled?Ox._('Upload cancelled.'):Ox._('Upload failed.'));!cancelled&&pandora.api.log({text:data.responseText,url:'/'+item,line:1});}},progress:function(data){$progress.options({progress:data.progress||0});}});});}else{pandora.UI.set({item:result.data.items[0].item,itemView:'media'});that.close();}});});}
function getEncodingOptions(info){var bpp=0.17,dar,format=pandora.site.video.formats[0],fps,options={},resolution=Ox.max(pandora.site.video.resolutions);if(format=='webm'){options.videoCodec='vp8';options.audioCodec='vorbis';}else if(format=='ogv'){options.videoCodec='theora';options.audioCodec='vorbis';}
if(resolution==720){options.height=720;options.samplerate=48000;options.audioQuality=5;}else if(resolution==480){options.height=480;options.samplerate=44100;options.audioQuality=3;options.channels=2;}else if(resolution==432){options.height=432;options.samplerate=44100;options.audioQuality=3;options.channels=2;}else if(resolution==360){options.height=320;options.samplerate=44100;options.audioQuality=1;options.channels=1;}else if(resolution==288){options.height=288;options.samplerate=44100;options.audioQuality=0;options.channels=1;}else if(resolution==240){options.height=240;options.samplerate=44100;options.audioQuality=0;options.channels=1;}else if(resolution==144){options.height=144;options.samplerate=22050;options.audioQuality=-1;options.audioBitrate=22;options.channels=1;}else if(resolution==96){options.height=96;options.samplerate=22050;options.audioQuality=-1;options.audioBitrate=22;options.channels=1;}
if(info.video&&info.video[0].display_aspect_ratio){dar=aspectratio(info.video[0].display_aspect_ratio);fps=aspectratio(info.video[0].framerate).float;options.width=parseInt(dar.float*options.height,10);options.width+=options.width%2;if(fps==50){options.framerate=25;}else if(fps==60){options.framerate=30;}
if(Math.abs(options.width/options.height-dar.float)<0.02){options.aspect=options.width+':'+options.height;}else{options.aspect=dar.ratio;}
options.videoBitrate=Math.round(options.height*options.width*fps*bpp/1000);options.denoise=true;options.deinterlace=true;}else{options.noVideo=true;}
if(info.audio){if(options.cannels&&info.audio[0].channels<options.channels){delete options.channels;}}else{options.noAudio=true;delete options.samplerate;delete options.audioQuality;delete options.channels;}
options.noUpscaling=true;if((!info.video.length||(info.video[0].codec==options.videoCodec&&info.video[0].height<=options.height))&&(!info.audio.length||info.audio[0].codec==options.audioCodec)){options={passthrough:true};}
return JSON.stringify(options);}
function formatInfo(info){var html='<b>'+info.path+'</b><br>';if(info.video&&info.video.length>0){var video=info.video[0];html+=video.width+''+video.height+' ('+video.codec+')';}
if(info.video&&info.video.length>0&&info.audio&&info.audio.length>0){html+=' / ';}
if(info.audio&&info.audio.length>0){var audio=info.audio[0];html+={1:'mono',2:'stereo',6:'5.1'}[audio.channels]
+' '+audio.samplerate/1000+' kHz ('+audio.codec+')';}
html+='<br>'+Ox.formatValue(info.size,'B')
+' / '+Ox.formatDuration(info.duration);return html;}
function selectVideo(){cancelled=false;pandora.firefogg=new Firefogg();pandora.firefogg.setFormat(pandora.site.video.formats[0]);if(pandora.firefogg.selectVideo()){var info=JSON.parse(pandora.firefogg.sourceInfo),options=JSON.parse(getEncodingOptions(info)),oshash=info.oshash,filename=pandora.firefogg.sourceFilename,item;pandora.api.findMedia({query:{conditions:[{key:'oshash',value:oshash}]},keys:['id','available']},function(result){if(result.data.items.length===0||!result.data.items[0].available){$info.html(formatInfo(info));$status.html(options.passthrough?Ox._('Your video will be uploaded directly.'):Ox._('Your video will be transcoded before upload.'));}else{pandora.api.find({query:{conditions:[{key:'oshash',value:oshash}]},keys:['id']},function(result){pandora.UI.set({item:result.data.items[0].id,itemView:'media'});delete pandora.firefogg;that.close();});}});return true;}
return false;}
return that;};'use strict';pandora.persona={};pandora.persona.init=function(callback){(!navigator.id?Ox.getFile:Ox.noop)('https://login.persona.org/include.js',function(){navigator.id.watch({loggedInUser:pandora.user.email?pandora.user.email:null,onlogin:onlogin,onlogout:onlogout});callback&&callback();});function getUsername(callback){pandora.$ui.accountDialog=pandora.ui.accountDialog('username').open();pandora.$ui.accountForm.bindEvent({submit:function(data){callback(data.values.username);pandora.$ui.accountDialog.close();}});return pandora.$ui.accountDialog;}
function onlogin(assertion,username){pandora.api.signin({assertion:assertion,username:username},function(result){if(!result.data.errors&&result.status.code==200){pandora.signin(result.data);}else if(!username&&result.data.errors&&result.data.errors.username){getUsername(function(username){onlogin(assertion,username);});}else{onlogout();}});}
function onlogout(){pandora.UI.set({page:''});pandora.api.signout({},function(result){pandora.signout(result.data);});}};pandora.persona.signin=function(){navigator.id.request();};pandora.persona.signout=function(){navigator.id.logout();};pandora.ui.personaButton=function(){var isGuest=pandora.user.level=='guest',that=Ox.Element({tooltip:Ox._(isGuest?'Click to sign with Persona':'Click to open preferences or doubleclick to sign out')}).css({marginLeft:'3px'}).bindEvent({singleclick:function(){isGuest?pandora.persona.signin():pandora.UI.set({page:'preferences'});},doubleclick:function(){pandora.UI.set({page:isGuest?'signin':'signout'});}});pandora.persona.init();$('<div>').addClass('OxLight').css({float:'left',marginTop:'2px',fontSize:'9px'}).html(isGuest?Ox._('Sign in'):Ox.encodeHTMLEntities(pandora.user.username)).appendTo(that);Ox.Button({style:'symbol',title:'user',type:'image'}).css({float:'left'}).appendTo(that);return that;};'use strict';pandora.ui.preferencesDialog=function(){var isReloading=false,tabs=[{id:'account',title:Ox._('Account')},{id:'appearance',title:Ox._('Appearance')},{id:'advanced',title:Ox._('Advanced')}];Ox.getObjectById(tabs,pandora.user.ui.part.preferences||'account').selected=true;var $tabPanel=Ox.TabPanel({content:function(id){var $content=Ox.Element().css({overflowY:'auto'}).append($('<img>').attr({src:'/static/png/icon.png'}).css({position:'absolute',left:'16px',top:'16px',width:'64px',height:'64px'}));if(id=='account'){$content.append(Ox.Form({items:[Ox.Input({disabled:true,id:'username',label:Ox._('Username'),labelWidth:120,value:pandora.user.username,width:320}),Ox.Input({autovalidate:/.+/,id:'password',label:Ox._('New Password'),labelWidth:120,type:'password',validate:pandora.validateNewPassword,width:320}).bindEvent({validate:function(data){data.valid&&pandora.api.editPreferences({password:data.value});}}),Ox.Input({autovalidate:pandora.autovalidateEmail,id:'email',label:Ox._('E-Mail Address'),labelWidth:120,validate:pandora.validateNewEmail,value:pandora.user.email,width:320}).bindEvent({validate:function(data){if(data.valid&&data.value!=pandora.user.email){pandora.user.email=data.value;pandora.api.editPreferences({email:data.value});}}}),Ox.Input({disabled:true,id:'level',label:Ox._('Level'),labelWidth:120,value:Ox.toTitleCase(pandora.user.level),width:320}),Ox.Checkbox({id:'newsletter',label:Ox._('Newsletter'),labelWidth:120,title:pandora.user.newsletter?Ox._('Subscribed'):Ox._('Unsubscribed'),value:pandora.user.newsletter,width:320}).bindEvent({change:function(data){pandora.user.newsletter=data.value;this.options({title:pandora.user.newsletter?Ox._('Subscribed'):Ox._('Unsubscribed')});pandora.api.editPreferences({newsletter:pandora.user.newsletter});}})]}).css({position:'absolute',left:'96px',top:'16px'}));}else if(id=='appearance'){$content.append(Ox.Form({items:[Ox.Select({id:'theme',items:pandora.site.themes.map(function(theme){return{id:theme,title:Ox.Theme.getThemeData(theme).themeName}}),label:Ox._('Theme'),labelWidth:120,value:pandora.user.ui.theme,width:320}).bindEvent({change:function(data){pandora.UI.set({theme:data.value});pandora.setTheme(data.value);}}),Ox.Select({disabled:pandora.user.level!='admin',id:'locale',items:Object.keys(Ox.LOCALE_NAMES).map(function(locale){return{id:locale,title:Ox.LOCALE_NAMES[locale]}}),label:Ox._('Language'),labelWidth:120,value:pandora.user.ui.locale,width:320}).bindEvent({change:function(data){pandora.UI.set({locale:data.value});pandora.setLocale(data.value,function(){isReloading=true;$dialog.close();pandora.$ui.appPanel.reload();});}})]}).css({position:'absolute',left:'96px',top:'16px'}));}else if(id=='advanced'){$content.append(Ox.Button({title:Ox._('Reset UI Settings...'),width:160}).bindEvent({click:function(){pandora.$ui.resetUIDialog=pandora.ui.resetUIDialog().open();}}).css({position:'absolute',left:'96px',top:'16px'})).append(Ox.Button({title:Ox._('Run Script on Load...'),width:160}).bindEvent({click:function(){pandora.$ui.onloadDialog=pandora.ui.onloadDialog().open();}}).css({position:'absolute',left:'96px',top:'40px'}));}
return $content;},tabs:tabs}).bindEvent({change:function(data){pandora.UI.set({'part.preferences':data.selected});}}),$dialog=Ox.Dialog({buttons:[Ox.Button({id:'signout',title:Ox._('Sign Out...')}).bindEvent({click:function(){pandora.UI.set({page:'signout'});}}),{},Ox.Button({id:'done',title:Ox._('Done')}).bindEvent({click:function(){$dialog.close();}})],closeButton:true,content:$tabPanel,height:192,minHeight:192,minWidth:432,title:Ox._('Preferences'),width:432}).bindEvent({close:function(){if(pandora.user.ui.page=='preferences'&&!isReloading){pandora.UI.set({page:''});}},'pandora_part.preferences':function(data){if(pandora.user.ui.page=='preferences'){$tabPanel.select(data.value==''?'account':data.value);}}});return $dialog;};'use strict';pandora.ui.appearanceDialog=function(){var that=pandora.ui.iconDialog({buttons:[Ox.Button({id:'done',title:Ox._('Done')}).bindEvent({click:function(){that.close();}})],content:Ox.Form({items:[Ox.Select({id:'theme',items:pandora.site.themes.map(function(theme){return{id:theme,title:Ox.Theme.getThemeData(theme).themeName}}),label:Ox._('Theme'),labelWidth:120,value:pandora.user.ui.theme,width:320}).bindEvent({change:function(data){pandora.UI.set({theme:data.value});pandora.setTheme(data.value);}}),Ox.Select({disabled:pandora.user.level!='admin',id:'locale',items:Object.keys(Ox.LOCALE_NAMES).map(function(locale){return{id:locale,title:Ox.LOCALE_NAMES[locale]}}),label:Ox._('Language'),labelWidth:120,value:pandora.user.ui.locale,width:320}).bindEvent({change:function(data){pandora.UI.set({locale:data.value});pandora.setLocale(data.value,function(){pandora.$ui.appPanel.reload();});}})]}),keys:{enter:'done',escape:'done'},title:Ox._('Appearance'),width:432});return that;};'use strict';pandora.ui.home=function(){var that=$('<div>').addClass('OxScreen').css({position:'absolute',width:'100%',height:'100%',opacity:0,zIndex:1001}),$reflectionImage=$('<img>').addClass('logo').attr({src:'/static/png/logo.png'}).css({position:'absolute',left:0,top:'160px',right:0,bottom:0,width:'320px',margin:'auto',opacity:0,MozTransform:'scaleY(-1)',OTransform:'scaleY(-1)',WebkitTransform:'scaleY(-1)'}).appendTo(that),$reflectionGradient=$('<div>').addClass('OxReflection logo').css({position:'absolute',left:0,top:'160px',right:0,bottom:0,width:'322px',height:'162px',margin:'auto',}).appendTo(that),$logo=$('<img>').addClass('logo').attr({id:'logo',src:'/static/png/logo.png'}).css({position:'absolute',left:0,top:0,right:0,bottom:'160px',width:window.innerWidth+'px',margin:'auto',cursor:'pointer'}).on({click:function(){$browseButton.triggerEvent('click');}}).appendTo(that),$findInput=Ox.Input({width:156}).css({position:'absolute',left:0,top:'48px',right:'164px',bottom:0,margin:'auto',opacity:0}).click(function(e){e.stopPropagation();}).bindEvent({submit:function(data){if(data.value){$findButton.triggerEvent('click');}else{$browseButton.triggerEvent('click');}}}).appendTo(that),$findButton=Ox.Button({title:Ox._('Find'),width:74}).css({position:'absolute',left:'82px',top:'48px',right:0,bottom:0,margin:'auto',opacity:0}).bindEvent({click:function(){var folder=pandora.getListData().folder,value=$findInput.value();folder&&pandora.$ui.folderList[folder].options({selected:[]});if(pandora.user.ui.section=='items'){pandora.$ui.findSelect.value('*');pandora.$ui.findInput.value(value);}
that.fadeOutScreen();pandora.UI.set({page:'',find:{conditions:value===''?[]:[{key:'*',value:value,operator:'='}],operator:'&'},section:'items'});}}).appendTo(that),$browseButton=Ox.Button({title:Ox._('Browse'),width:74}).css({position:'absolute',left:'246px',top:'48px',right:0,bottom:0,margin:'auto',opacity:0}).bindEvent({click:function(){pandora.UI.set({page:pandora.user.ui.page=='home'?'':pandora.user.ui.page,section:'items'});that.fadeOutScreen();}}).appendTo(that),$signupButton=Ox.Button({title:Ox._('Sign Up'),width:74}).css({position:'absolute',left:0,top:'112px',right:'246px',bottom:0,margin:'auto',opacity:0}).bindEvent({click:function(){pandora.UI.set({page:'signup'});that.fadeOutScreen();}}),$signinButton=Ox.Button({title:Ox._('Sign In'),width:74}).css({position:'absolute',left:0,top:'112px',right:'82px',bottom:0,margin:'auto',opacity:0}).bindEvent({click:function(){pandora.UI.set({page:'signin'});that.fadeOutScreen();}}),$preferencesButton=Ox.Button({title:Ox._('Preferences'),width:156}).css({position:'absolute',left:0,top:'112px',right:'164px',bottom:0,margin:'auto',opacity:0}).bindEvent({click:function(){pandora.UI.set({page:'preferences'});that.fadeOutScreen();}}),$aboutButton=Ox.Button({title:Ox._('About {0}',[pandora.site.site.name]),width:156}).css({position:'absolute',left:'164px',top:'112px',right:0,bottom:0,margin:'auto',opacity:0}).bindEvent({click:function(){pandora.UI.set({page:'about'});that.fadeOutScreen();}}).appendTo(that),$text=$('<div>').html(Ox._('pan.do/ra. \u2620 2007-{0} 0x2620. All Open Source.',[Ox.formatDate(new Date(),'%Y')])).css({position:'absolute',left:0,top:'176px',right:0,bottom:0,width:'360px',height:'16px',margin:'auto',opacity:0,textAlign:'center'}).appendTo(that);if(pandora.user.level=='guest'){$signupButton.appendTo(that);$signinButton.appendTo(that);}else{$preferencesButton.appendTo(that);}
that.fadeInScreen=function(){that.appendTo(Ox.UI.$body).animate({opacity:1},500,function(){that.find(':not(#logo)').animate({opacity:1},250,function(){$findInput.focusInput(true);});});$logo.animate({width:'320px'},500);return that;};that.fadeOutScreen=function(){that.find(':not(#logo)').hide();$logo.animate({width:window.innerWidth+'px'},500);that.animate({opacity:0},500,function(){that.remove();});pandora.$ui.tv&&pandora.$ui.tv.unmute().find('.OxControls.OxVolume').hide();return that;};that.hideScreen=function(){that.hide().remove();that.find(':not(#logo)').css({opacity:0});$logo.css({width:window.innerWidth+'px'});return that;};that.showScreen=function(callback){var $elements=that.find(':not(.logo)'),count=0;$logo.css({width:'320px'});that.css({opacity:1}).appendTo(Ox.UI.$body);that.find(':not(#logo)').css({opacity:1});$elements.animate({opacity:1},500,function(){if(callback&&++count==$elements.length){callback();}});$findInput.focusInput(true);return that;};return that;};'use strict';pandora.autovalidateCode=function(value,blur,callback){value=value.toUpperCase().split('').map(function(v){return/[A-Z]/.test(v)?v:null;}).join('').slice(0,16);callback({valid:value.length==16,value:value});};pandora.autovalidateEmail=function(value,blur,callback){value=value.toLowerCase().split('').map(function(v,i){return/[0-9a-z\.\+\-_@]/.test(v)?v:null;}).join('').slice(0,255);callback({valid:Ox.isValidEmail(value),value:value});};pandora.autovalidateListname=function(value,blur,callback){var length=value.length;value=value.toLowerCase().split('').map(function(v,i){return/\s/.test(v)&&(i==0||(i==length-1&&blur))?null:v;}).join('');value=value.replace(/\s+/g,' ').slice(0,255);callback({valid:!!value.length,value:value});};pandora.autovalidateUsername=function(value,blur,callback){var length=value.length;value=value.toLowerCase().split('').map(function(v,i){return/\s/.test(v)&&(i==0||(i==length-1&&blur))?null:v;}).join('');value=value.replace(/\s+/g,' ').slice(0,255);callback({valid:!!value.length,value:value});};pandora.validateCode=function(value,callback){callback({message:'',valid:value.length>0});};pandora.validateNewEmail=function(value,callback){value==pandora.user.email?callback({message:'',valid:true,value:value}):Ox.isValidEmail(value)?pandora.api.findUser({key:'email',value:value,operator:'=='},function(result){callback({message:!!result.data.users.length?Ox._('E-Mail Address already exists'):'',valid:!result.data.users.length,value:value});}):callback({message:value.length?Ox._('Invalid e-mail address'):'',valid:false,value:value});};pandora.validateNewPassword=function(value,callback){callback({message:'',valid:value.length>0,value:value});};pandora.validatePassword=function(value,callback){callback({message:'',valid:value.length>0,value:value});};pandora.validateUser=function(key,existing){existing=existing||false;var string=key=='username'?'username':'e-mail address';return function(value,callback){var valid=key=='username'?!!value.length:Ox.isValidEmail(value);valid?pandora.api.findUser({key:key,value:value,operator:'=='},function(result){var valid=existing==!!result.data.users.length;callback({message:existing?Ox._('Unknown '+string):Ox._(string[0].toUpperCase()+string.slice(1)+' already exists'),valid:valid});}):callback({message:value.length?Ox._('Invalid '+string):'',valid:false});};};'use strict';pandora.ui.sortMenu=function(){var that=Ox.MenuButton({items:[].concat(pandora.site.clipKeys.map(function(key){return Ox.extend(Ox.clone(key),{checked:key.id==pandora.user.ui.itemSort[0].key,id:key.id,title:Ox._('Sort by {0}',[key.title])});}),[{},{id:'ascending',title:Ox._('Ascending'),checked:pandora.user.ui.itemSort[0].operator=='+'},{id:'descending',title:Ox._('Descending'),checked:pandora.user.ui.itemSort[0].operator=='-'}]),tooltip:Ox._('Sort clips'),type:'image'}).css({float:'left',margin:'2px'}).bindEvent({click:function(data){if(data.checked){if(['ascending','descending'].indexOf(data.id)>-1){pandora.UI.set({itemSort:[{key:pandora.user.ui.itemSort[0].key,operator:data.id=='ascending'?'+':'-'}]});}else{pandora.UI.set({itemSort:[{key:data.id,operator:pandora.getSortOperator(data.id)}]});}}},pandora_itemsort:function(){pandora.$ui.sortMenu.replaceWith(pandora.$ui.sortMenu=pandora.ui.sortMenu());}});return that;};'use strict';pandora.ui.annotationDialog=function(layer){var isEditor=pandora.user.ui.itemView=='editor',that=pandora.ui.iconDialog({buttons:[].concat(isEditor?[Ox.Button({title:Ox._('Sign Up...')}).bindEvent({click:function(){that.close();pandora.$ui.accountDialog=pandora.ui.accountDialog('signup').open();}}),Ox.Button({title:Ox._('Sign In...')}).bindEvent({click:function(){that.close();pandora.$ui.accountDialog=pandora.ui.accountDialog('signin').open();}})]:[Ox.Button({title:Ox._('Switch to Editor')}).bindEvent({click:function(){that.close();pandora.UI.set({itemView:'editor'});}})],[{},Ox.Button({title:Ox._('Not Now')}).bindEvent({click:function(){that.close();}})]),content:Ox._('To add or edit {0}, '+(isEditor?'please sign up or sign in.':'just switch to the editor.'),[layer.toLowerCase()]),title:Ox.toTitleCase(layer)});return that;};'use strict';pandora.ui.folderBrowser=function(id,section){var that=Ox.SplitPanel({elements:[{element:pandora.ui.folderBrowserBar(id,section),size:24},{element:pandora.$ui.folderList[id]=pandora.ui.folderBrowserList(id,section)}],orientation:'vertical'});return that;};'use strict';pandora.ui.appPanel=function(){var that=Ox.SplitPanel({elements:[{element:pandora.$ui.mainMenu=pandora.ui.mainMenu(),size:20},{element:pandora.$ui.mainPanel=pandora.ui.mainPanel()}],orientation:'vertical'});setPage(pandora.user.ui.page);that.display=function(){var animate=$('.OxScreen').length==0;Ox.Log('','ANIMATE?',animate)
animate&&pandora.$ui.body.css({opacity:0});that.appendTo(pandora.$ui.body);animate&&pandora.$ui.body.animate({opacity:1},1000);return that;};that.reload=function(){Ox.Request.cancel();Ox.Request.clearCache();pandora.$ui.appPanel.remove();pandora.$ui.appPanel=pandora.ui.appPanel().appendTo(pandora.$ui.body);return that;};that.bindEvent({pandora_page:function(data){setPage(data.value);}});function setPage(page){var dialogPages={site:pandora.site.sitePages.map(function(page){return page.id;}).concat(['software']),account:['signup','signin'],accountSignout:['signout'],preferences:['preferences'],help:['help'],api:['api']};if(page===''){if(pandora.$ui.appPanel&&pandora.$ui.home){pandora.$ui.home.fadeOutScreen();}
Ox.forEach(dialogPages,function(pages,dialog){if(pandora.$ui[dialog+'Dialog']){pandora.$ui[dialog+'Dialog'].close();}});pandora.$ui.tv&&pandora.$ui.tv.fadeOutScreen();}else if(page=='home'){if(pandora.$ui.appPanel){pandora.$ui.home=pandora.ui.home().fadeInScreen();}}else if(page=='tv'){pandora.$ui.tv=pandora.ui.tv()[!pandora.$ui.appPanel?'showScreen':'fadeInScreen']();pandora.$ui.home&&pandora.$ui.tv.mute();}else{Ox.forEach(dialogPages,function(pages,dialog){if(pages.indexOf(page)==-1&&pandora.$ui[dialog+'Dialog']){pandora.$ui[dialog+'Dialog'].close();}});pandora.$ui.tv&&pandora.$ui.tv.remove();if(Ox.getIndexById(pandora.site.sitePages,page)>-1||page=='software'){if(pandora.$ui.siteDialog&&pandora.$ui.siteDialog.is(':visible')){pandora.$ui.siteDialog.select(page);}else{pandora.$ui.siteDialog=pandora.ui.siteDialog(page).open();}}else if(['signup','signin'].indexOf(page)>-1){if(pandora.user.level=='guest'){if(pandora.$ui.accountDialog&&pandora.$ui.accountDialog.is(':visible')){pandora.$ui.accountDialog.options(pandora.ui.accountDialogOptions(page));}else{pandora.$ui.accountDialog=pandora.ui.accountDialog(page).open();}}else{pandora.UI.set({page:''});}}else if(['preferences','signout'].indexOf(page)>-1){if(pandora.user.level=='guest'){pandora.UI.set({page:''});}else if(page=='preferences'){pandora.$ui.preferencesDialog=pandora.ui.preferencesDialog().open();}else{pandora.ui.accountSignoutDialog().open();}}else if(page=='help'){pandora.$ui.helpDialog=pandora.ui.helpDialog().open();}else if(page=='api'){pandora.$ui.apiDialog=pandora.ui.apiDialog().open();}}}
return that;};'use strict';pandora.ui.onloadDialog=function(){var dialogHeight=Math.round((window.innerHeight-48)*0.75),dialogWidth=Math.round(window.innerWidth*0.75),$input=Ox.Input({height:dialogHeight-32,id:'onload',placeholder:Ox._('/*\nAny JavaScript you paste here will run on load.\n'
+'If you ever need to manually change or remove it, '
+'you can do so by setting localStorage["pandora.onload"] in the console.\n*/'),type:'textarea',value:localStorage['pandora.onload']||'',width:dialogWidth-32}).css({margin:'16px'}),that=Ox.Dialog({buttons:[Ox.Button({title:Ox._('Clear')}).css({margin:'4px 4px 4px 0'}).bindEvent({click:function(){clear();}}),Ox.Button({id:'done',title:Ox._('Done'),width:48}).bindEvent({click:function(){that.close();}})],closeButton:true,content:$input,height:dialogHeight,maximizeButton:true,minHeight:256,minWidth:512,removeOnClose:true,title:Ox._('Run Script on Load'),width:dialogWidth}).bindEvent({resize:resize});function resize(data){dialogHeight=data.height;dialogWidth=data.width;$input.options({height:dialogHeight-32,width:dialogWidth-32});}
function clear(){delete localStorage['pandora.onload'];$input.options({value:''});}
that.superClose=that.close;that.close=function(){var value=$input.value();if(value){localStorage['pandora.onload']=value;}else{delete localStorage['pandora.onload'];}
that.superClose();};return that;};'use strict';pandora.ui.uploadPDFDialog=function(options){var cancelled=false,file,selectFile,$cancelButton,$closeButton,$content=Ox.Element().css({margin:'16px'}),$progress,$status=$('<div>').css({padding:'4px',paddingTop:'8px'}),that=Ox.Dialog({buttons:[$closeButton=Ox.Button({id:'close',title:Ox._('Close')}).bindEvent({click:function(){that.triggerEvent('close');}}),$cancelButton=Ox.Button({id:'cancel',title:Ox._('Cancel'),disabled:true}).bindEvent({click:function(data){cancelled=true;pandora.$ui.upload&&pandora.$ui.upload.abort();$fileButton.show();$cancelButton.hide()
$closeButton.show();}}),],content:$content,height:128,removeOnClose:true,width:368,title:Ox._('Upload PDF'),}).bindEvent({close:function(data){that.close();}});$content.append($status);upload(options.file);function resetProgress(){$progress=Ox.Progressbar({progress:0,showPercent:true,showTime:true,width:304});$status.html('').append($progress);}
function upload(file){resetProgress();pandora.$ui.upload=pandora.chunkupload({file:file,url:'/api/upload/text/',data:{name:file.name,id:options.id},}).bindEvent({progress:function(data){$progress.options({progress:data.progress||0});},done:function(data){if(data.progress==1){Ox.Request.clearCache();pandora.$ui.mainPanel.replaceElement(1,pandora.$ui.textPanel=pandora.ui.textPanel());that.close();}else{$content.html("failed: "+data.responseText);}}});}
return that;};'use strict';pandora.ui.videoView=function(isEmbed){var ui=pandora.user.ui,itemsQuery,query,that=Ox.Element().css({width:'100%',hegiht:'100%',}).update({sort:function(){loadPlayer();}}),range=[0,500],clips=[],player;if(!ui.item){itemsQuery=ui.find;query={conditions:[],operator:'&'};itemsQuery.conditions.forEach(function(condition){if(condition.key=='annotations'||Ox.getIndexById(pandora.site.layers,condition.key)>-1){query.conditions.push(condition);}});}else{itemsQuery={conditions:[{key:'id',value:ui.item,operator:'=='}],operator:'&'};query={conditions:ui.itemFind===''?[]:[{key:'annotations',value:ui.itemFind,operator:'='}],operator:'&'};}
loadPlayer();function loadPlayer(){pandora.api.findClips({query:query,itemsQuery:itemsQuery,keys:['id','in','out','durations','parts'],range:range,sort:pandora.user.ui.listSort},function(result){pandora.$ui.statusbar&&pandora.$ui.statusbar.set('total',{items:result.data.items.length});player&&player.remove();player=Ox.VideoPlayer({controlsBottom:['play','previous','next','volume'],controlsTop:(isEmbed?[]:['fullscreen']).concat(['scale']),enableMouse:true,height:getHeight(),paused:true,position:0,video:Ox.flatten(result.data.items.map(function(clip){clip.item=clip.id.split('/')[0];return pandora.getClipVideos(clip);})),width:getWidth()}).appendTo(that);});}
function getHeight(){return isEmbed?window.innerHeight:that.height();}
function getWidth(){return isEmbed?window.innerWidth:that.width();}
that.reloadList=function(){loadPlayer();};that.size=function(){player&&player.options({height:getHeight(),width:getWidth(),})}
return that;};'use strict';pandora.ui.accountDialog=function(action){var that=Ox.Dialog(Ox.extend({fixedSize:true,height:192,id:'accountDialog',removeOnClose:true,width:432},pandora.ui.accountDialogOptions(action))).bindEvent({open:function(){pandora.$ui.accountForm.find('input')[0].focus();},resize:function(data){var width=data.width-32;pandora.$ui.accountForm.items.forEach(function(item){item.options({width:width});});}});return that;};pandora.ui.accountDialogOptions=function(action,value){pandora.$ui.accountForm&&pandora.$ui.accountForm.remove();var buttons={signin:['signup','reset'],signup:['signin'],username:[],reset:['signin'],resetAndSignin:[]},buttonTitle={signin:'Sign In',signup:'Sign Up',username:'Sign Up',reset:'Reset Password',resetAndSignin:'Sign In'},dialogText={signin:Ox._('To sign in to your account, please enter your username and password.'),signup:Ox._('To sign up for an account, please choose a username and password, and enter your e-mail address.'),username:Ox._('To sign up for an account, please choose a username.'),reset:Ox._('To reset your password, please enter either your username or your e-mail address.'),resetAndSignin:Ox._('To sign in to your account, please choose a new password, and enter the code that we have just e-mailed to you.')},dialogTitle={signin:Ox._('Sign In'),signup:Ox._('Sign Up'),username:Ox._('Sign Up'),reset:Ox._('Reset Password'),resetAndSignin:Ox._('Reset Password')};function button(type){if(type=='cancel'){return Ox.Button({id:'cancel'+Ox.toTitleCase(action),title:Ox._('Cancel')}).bindEvent({click:function(){pandora.$ui.accountDialog.close();pandora.UI.set({page:''});}});}else if(type=='submit'){return Ox.Button({disabled:true,id:'submit'+Ox.toTitleCase(action),title:Ox._(buttonTitle[action])}).bindEvent({click:function(){pandora.$ui.accountForm.submit();}});}else{return Ox.Button({id:type,title:Ox._(buttonTitle[type]+'...')}).bindEvent({click:function(){if(['signin','signup'].indexOf(type)>-1&&type!=pandora.user.ui.page){pandora.UI.set({page:type});}else{pandora.$ui.accountDialog.options(pandora.ui.accountDialogOptions(type));}
pandora.$ui.accountForm.find('input.OxInput')[0].focus();}});}}
return{buttons:[].concat(buttons[action].map(function(type){return button(type);}),buttons[action].length?[{}]:[],[button('cancel'),button('submit')]),content:Ox.Element().append($('<img>').attr({src:'/static/png/icon.png'}).css({position:'absolute',left:'16px',top:'16px',width:'64px',height:'64px'})).append(Ox.Element().css({position:'absolute',left:'96px',top:'16px',width:'320px'}).append(Ox.Element().addClass('OxText').html(dialogText[action]+'<br/><br/>')).append(pandora.$ui.accountForm=pandora.ui.accountForm(action,value))),keys:{enter:'submit'+Ox.toTitleCase(action),escape:'cancel'+Ox.toTitleCase(action)},title:dialogTitle[action]};};pandora.ui.accountForm=function(action,value){if(pandora.$ui.accountForm){pandora.$ui.accountForm.items.forEach(function(item){item.remove();});}
var items={'signin':['username','password'],'signup':['newUsername','password','email'],'username':['newUsername'],'reset':['usernameOrEmail'],'resetAndSignin':['oldUsername','newPassword','code']},$items=items[action].map(function(v){return item(v,value);}),that=Ox.Form({id:'accountForm'+Ox.toTitleCase(action),items:$items}).bindEvent({submit:function(data){pandora.$ui.accountDialog.disableButtons();if(action=='signin'){pandora.api.signin(data.values,function(result){if(!result.data.errors){pandora.$ui.accountDialog.close();pandora.signin(result.data);}else{pandora.$ui.accountDialog.enableButtons();that.setMessages([{id:'password',message:Ox._('Incorrect password')}]);}});}else if(action=='signup'){pandora.api.signup(data.values,function(result){if(!result.data.errors){pandora.$ui.accountDialog.close();pandora.signin(result.data);pandora.ui.accountWelcomeDialog().open();}else{pandora.$ui.accountDialog.enableButtons();}});}else if(action=='reset'){var usernameOrEmail=data.values.usernameOrEmail,key=usernameOrEmail[0];data={};data[key]=usernameOrEmail[1];pandora.api.requestToken(data,function(result){if(!result.data.errors){pandora.$ui.accountDialog.options(pandora.ui.accountDialogOptions('resetAndSignin',result.data.username));pandora.$ui.accountDialog.enableButtons();}else{pandora.$ui.accountDialog.enableButtons();that.setMessages([{id:'usernameOrEmail',message:Ox._('Unknown '+(key=='username'?'username':'e-mail address'))}])}});}else if(action=='resetAndSignin'){pandora.api.resetPassword(data.values,function(result){if(!result.data.errors){pandora.$ui.accountDialog.close();pandora.signin(result.data);}else{pandora.$ui.accountDialog.enableButtons();that.setMessages([{id:'code',message:Ox._('Incorrect code')}]);}});}},validate:function(data){pandora.$ui.accountDialog[(data.valid?'enable':'disable')+'Button']('submit'+Ox.toTitleCase(action));}});that.items=$items;function item(type,value){if(type=='code'){return Ox.Input({autovalidate:pandora.autovalidateCode,id:'code',label:Ox._('Code'),labelWidth:120,validate:pandora.validateCode,width:320});}else if(type=='email'){return Ox.Input({autovalidate:pandora.autovalidateEmail,id:'email',label:Ox._('E-Mail Address'),labelWidth:120,type:'email',validate:pandora.validateUser('email'),width:320});}else if(type=='newPassword'){return Ox.Input({autovalidate:/.+/,id:'password',label:Ox._('New Password'),labelWidth:120,type:'password',validate:pandora.validateNewPassword,width:320});}else if(type=='newUsername'){return Ox.Input({autovalidate:pandora.autovalidateUsername,id:'username',label:Ox._('Username'),labelWidth:120,validate:pandora.validateUser('username'),width:320});}else if(type=='oldUsername'){return Ox.Input({disabled:true,id:'username',label:Ox._('Username'),labelWidth:120,value:value,width:320});}else if(type=='password'){return Ox.Input({autovalidate:/.+/,id:'password',label:Ox._('Password'),labelWidth:120,type:'password',validate:pandora.validatePassword,width:320});}else if(type=='username'){return Ox.Input({autovalidate:pandora.autovalidateUsername,id:'username',label:Ox._('Username'),labelWidth:120,validate:pandora.validateUser('username',true),width:320});}else if(type=='usernameOrEmail'){return Ox.FormElementGroup({id:'usernameOrEmail',elements:[pandora.$ui.usernameOrEmailSelect=Ox.Select({id:'usernameOrEmailSelect',items:[{id:'username',title:Ox._('Username')},{id:'email',title:Ox._('E-Mail Address')},],overlap:'right',width:128}).bindEvent({change:function(data){pandora.$ui.usernameOrEmailInput.options({autovalidate:data.value=='username'?pandora.autovalidateUsername:pandora.autovalidateEmail,validate:pandora.validateUser(data.value,true),value:''}).focusInput(true);that.find('.OxFormMessage:visible').html('').hide();pandora.$ui.accountDialog.disableButton('submitReset');}}),pandora.$ui.usernameOrEmailInput=Ox.Input({autovalidate:pandora.autovalidateUsername,id:'usernameOrEmailInput',validate:pandora.validateUser('username',true),width:192})],separators:[{title:'',width:0}],validate:function(value,callback){pandora.validateUser(value[0],true)(value[1],callback);}});}}
return that;};pandora.ui.accountSignoutDialog=function(){var that=Ox.Dialog({buttons:[Ox.Button({id:'stay',title:Ox._('Stay Signed In')}).bindEvent({click:function(){that.close();pandora.UI.set({page:''});}}),Ox.Button({id:'signout',title:Ox._('Sign Out')}).bindEvent({click:function(){that.close();pandora.UI.set({page:''});pandora.api.signout({},function(result){pandora.signout(result.data);});}})],content:Ox.Element().append($('<img>').attr({src:'/static/png/icon.png'}).css({position:'absolute',left:'16px',top:'16px',width:'64px',height:'64px'})).append($('<div>').css({position:'absolute',left:'96px',top:'16px',width:'192px'}).html(Ox._('Are you sure you want to sign out?'))),fixedSize:true,height:128,keys:{enter:'signout',escape:'stay'},removeOnClose:true,title:Ox._('Sign Out'),width:304});return that;};pandora.ui.accountWelcomeDialog=function(){var that=Ox.Dialog({buttons:[Ox.Button({id:'preferences',title:Ox._('Preferences...')}).bindEvent('click',function(){that.close();pandora.UI.set({page:'preferences'})}),{},Ox.Button({id:'close',title:Ox._('Close')}).bindEvent('click',function(){that.close();})],content:Ox.Element().append($('<img>').attr({src:'/static/png/icon.png'}).css({position:'absolute',left:'16px',top:'16px',width:'64px',height:'64px'})).append(Ox.Element().css({position:'absolute',left:'96px',top:'16px',width:'192px'}).html(Ox._('Welcome, {0}!<br/><br/>Your account has been created.',[Ox.encodeHTMLEntities(pandora.user.username)]))),fixedSize:true,height:128,keys:{enter:'close',escape:'close'},removeOnClose:true,title:Ox._('Welcome to {0}',[pandora.site.site.name]),width:304});return that;};'use strict';pandora.ui.makeListPrivateDialog=function(name,subscribers,callback){var that=pandora.ui.iconDialog({buttons:[Ox.Button({id:'keep',title:Ox._('Keep List Public')}).bindEvent({click:function(){that.close();callback(false);}}),Ox.Button({id:'make',title:Ox._('Make List Private')}).bindEvent({click:function(){that.close();callback(true);}})],content:Ox._('Are you sure you want to make the list "{0}" private and lose its {1}?',[name,subscribers==1?Ox._('subscriber'):Ox._('{0} subscribers',[subscribers])]),keys:{enter:'make',escape:'keep'},title:Ox._('Make List Private')});return that;};'use strict';pandora.ui.posterView=function(){var item=pandora.user.ui.item,view=pandora.user.ui.itemView,listWidth=144+Ox.UI.SCROLLBAR_SIZE,selectedImage={};$preview=Ox.Element(),that=Ox.SplitPanel({elements:[{element:Ox.Element(),size:listWidth},{element:$preview}],orientation:'horizontal'});that.resizeElement=function(){selectedImage.url&&renderPreview();};pandora.api.get({id:item,keys:[view]},function(result){var images=result.data[view];selectedImage=images.filter(function(image){return image.selected;})[0];var $list=Ox.IconList({item:function(data,sort,size){var ratio=data.width/data.height;size=size||128;return{height:ratio<=1?size:size/ratio,id:data['id'],info:data.width+' x '+data.height+' px',title:view=='frames'?Ox.formatDuration(data.position):data.source,url:data.url,width:ratio>=1?size:size*ratio}},items:images,keys:view=='frames'?['index','position','width','height','url']:['index','source','width','height','url'],max:1,min:1,orientation:'vertical',selected:[selectedImage['index']],size:128,sort:[{key:'index',operator:'+'}],unique:'index'}).css({background:'rgb(16, 16, 16)'}).bindEvent({select:function(event){var index=event.ids[0];selectedImage=images.filter(function(image){return image.index==index;})[0];renderPreview(selectedImage);pandora.api[view=='frames'?'setPosterFrame':'setPoster'](Ox.extend({id:item},view=='frames'?{position:selectedImage.index}:{source:selectedImage.source}),function(result){var imageRatio=selectedImage.width/selectedImage.height;$('img[src*="/'+item+'/poster"]').each(function(){var $this=$(this),size=Math.max($this.width(),$this.height()),src=$this.attr('src').split('?')[0]+'?'+Ox.uid();$('<img>').attr({src:src}).load(function(){$this.attr({src:src});view=='posters'&&$this.css(imageRatio<1?{width:Math.round(size*imageRatio)+'px',height:size+'px'}:{width:size+'px',height:Math.round(size/imageRatio)+'px'});});});});}});that.replaceElement(0,$list);renderPreview();});function renderPreview(){var previewWidth=pandora.$ui.document.width()-pandora.$ui.mainPanel.size(0)-1-listWidth,previewHeight=pandora.$ui.contentPanel.size(1),previewRatio=previewWidth/previewHeight,imageRatio=selectedImage.width/selectedImage.height,imageWidth=imageRatio>previewRatio?previewWidth:Math.round(previewHeight*imageRatio),imageHeight=imageRatio<previewRatio?previewHeight:Math.round(previewWidth/imageRatio),imageLeft=Math.floor((previewWidth-imageWidth)/2),imageTop=Math.floor((previewHeight-imageHeight)/2);$preview.html($('<img>').attr({src:selectedImage.url}).css({position:'absolute',left:imageLeft+'px',top:imageTop+'px',width:imageWidth+'px',height:imageHeight+'px'}));if(view=='frames'){var left=Math.floor((imageWidth-imageHeight)/2),right=Math.ceil((imageWidth-imageHeight)/2);$('<div>').addClass('OxPosterMarker OxPosterMarkerLeft').css({display:'block',left:imageLeft+'px',top:imageTop+'px',width:left+'px',height:imageHeight+'px'}).appendTo($preview.$element);$('<div>').addClass('OxPosterMarker OxPosterMarkerCenter').css({display:'block',left:imageLeft+left+'px',top:imageTop+'px',width:imageHeight-2+'px',height:imageHeight-2+'px'}).appendTo($preview.$element);$('<div>').addClass('OxPosterMarker OxPosterMarkerRight').css({display:'block',left:imageLeft+left+imageHeight+'px',top:imageTop+'px',width:right+'px',height:imageHeight+'px'}).appendTo($preview.$element);}}
return that;}
'use strict';pandora.ui.loadingIcon=function(){var self={},that=Ox.LoadingIcon({tooltip:Ox._('Click to reload {0}',[pandora.site.site.name])},self).attr({src:Ox.UI.getImageURL('symbolRedo')}).css(getCSS('stop')).bindEvent({anyclick:function(){pandora.$ui.appPanel.reload();}});that.superStart=that.start;that.superStop=that.stop;that.start=function(){if(!self.loadingInterval){that.css(getCSS('start')).attr({src:Ox.UI.getImageURL('symbolLoading')});that.superStart();}};that.stop=function(){if(self.loadingInterval){that.superStop(function(){that.css(getCSS('stop')).attr({src:Ox.UI.getImageURL('symbolRedo')});});}};that.update=function(requests){that[requests?'start':'stop']();};function getCSS(action){return action=='start'?{width:'16px',height:'16px',margin:0,opacity:0}:{width:'10px',height:'10px',margin:'3px',opacity:1};}
return that;};'use strict';pandora.ui.embedDocumentDialog=function(id){var isImage=Ox.contains(['jpg','png'],selected.split('.').pop()),url='http'+(pandora.site.site.https?'s':'')+'://'
+pandora.site.site.url+'/documents/'+id,$content=Ox.Element().css({margin:'16px'}).html(Ox._('To embed this file, use the following HTML:<br>')),$embed=$('<textarea>').css({width:'336px',height:'64px',marginTop:'8px',}).val(isImage?'<img src="'+url+'">':'<a href="'+url+'"><img src="'+url+'.jpg"></a>').on({click:function(){this.focus();this.select();}}).appendTo($content),that=Ox.Dialog({buttons:[Ox.Button({id:'close',title:Ox._('Close')}).bindEvent({click:function(){that.close();}})],closeButton:true,content:$content,fixedSize:true,height:128,keys:{escape:'close'},removeOnClose:true,title:Ox._('Embed File'),width:368});return that;};'use strict';pandora.ui.rightPanel=function(){var that=Ox.SplitPanel({elements:[{element:pandora.$ui.toolbar=pandora.ui.toolbar(),size:24},{element:pandora.$ui.contentPanel=pandora.ui.contentPanel()}],id:'rightPanel',orientation:'vertical'}).bindEvent({resize:function(data){var clipsItems,previousClipsItems;if(!pandora.user.ui.item){pandora.resizeFilters();pandora.$ui.list.size();if(pandora.user.ui.listView=='clips'){clipsItems=pandora.getClipsItems();previousClipsItems=pandora.getClipsItems(pandora.$ui.list.options('width'));pandora.$ui.list.options({width:data.size});if(clipsItems!=previousClipsItems){Ox.Request.clearCache();pandora.$ui.list.reloadList(true);}}else if(pandora.user.ui.listView=='timelines'){pandora.$ui.list.options({width:data.size});}else if(pandora.user.ui.listView=='map'){pandora.$ui.map.resizeMap();}else if(pandora.user.ui.listView=='calendar'){pandora.$ui.calendar.resizeCalendar();}else if(pandora.user.ui.listView=='video'){pandora.$ui.list.resize();}}else{pandora.$ui.browser.scrollToSelection();if(pandora.user.ui.itemView=='clips'){pandora.$ui.clipList.size();}else if(pandora.user.ui.itemView=='timeline'){pandora.$ui.timeline.options({width:data.size});}else if(pandora.user.ui.itemView=='player'){pandora.$ui.player.options({width:data.size});}else if(pandora.user.ui.itemView=='editor'){pandora.$ui.editor.options({width:data.size});}else if(pandora.user.ui.listView=='map'){pandora.$ui.map.resizeMap();}else if(pandora.user.ui.listView=='calendar'){pandora.$ui.calendar.resizeCalendar();}else if(pandora.user.ui.listView=='video'){pandora.$ui.list.size();}}}});return that;};'use strict';pandora.ui.embedPanel=function(){var that,ui=pandora.user.ui,view=!ui.item?ui.listView:ui.itemView;if(ui.section!='texts'&&!ui.page){if(!ui.item){if(Ox.contains(['grid','clip'],view)){that=pandora.ui.embedError(true);}else if(view=='video'){that=pandora.ui.videoView(true);}else if(Ox.contains(['map','calendar'],view)){that=pandora.ui.embedNavigation(view);}}else{if(view=='info'){that=pandora.ui.embedError(true);}else if(Ox.contains(['player','editor'],view)){that=pandora.ui.embedPlayer();}else if(view=='timeline'){that=pandora.ui.embedTimeline();}else if(view=='clips'){that=pandora.ui.embedError(true);}else if(Ox.contains(['map','calendar'],view)){that=pandora.ui.embedNavigation(view);}}}
if(!that){that=pandora.ui.embedError();}
that.display=function(){var animate=$('.OxScreen').length==0;Ox.Log('','ANIMATE?',animate)
animate&&pandora.$ui.body.css({opacity:0});that.appendTo(pandora.$ui.body);animate&&pandora.$ui.body.animate({opacity:1},1000);return that;};that.reloadPanel=that.reloadPanel||function(data){if(Ox.isUndefined(data)||data.value!=data.previousValue){pandora.$ui.embedPanel.replaceWith(pandora.$ui.embedPanel=pandora.ui.embedPanel());return pandora.$ui.embedPanel;}
return that;};that.bindEvent({pandora_item:that.reloadPanel,pandora_itemview:that.reloadPanel,pandora_videopoints:that.reloadPanel,pandora_hash:that.reloadPanel});return that;};'use strict';pandora.ui.listDialog=function(section){section=section||'general';var listData=pandora.getListData(),tabs=[].concat([{id:'general',title:Ox._('General')},{id:'icon',title:Ox._('Icon')}],listData.type=='smart'?[{id:'query',title:Ox._('Query')}]:[]),ui=pandora.user.ui,width=getWidth(section),folderItems=ui.section=='items'?'Lists':Ox.toTitleCase(ui.section),folderItem=folderItems.slice(0,-1);Ox.getObjectById(tabs,section).selected=true;pandora.$ui.listDialogTabPanel=Ox.TabPanel({content:function(id){if(id=='general'){return pandora.ui.listGeneralPanel(listData);}else if(id=='icon'){return pandora.$ui.listIconPanel=pandora.ui.listIconPanel(listData);}else if(id=='query'){return pandora.$ui.filterForm=pandora.ui.filterForm(listData).bindEvent({change:function(data){listData.query=data.query;}});}},tabs:tabs}).bindEvent({change:function(data){var width=getWidth(data.selected);$dialog.options({maxWidth:width,minWidth:width});$dialog.setSize(width,312);$findElement[data.selected=='icon'?'show':'hide']();$updateCheckbox[data.selected=='query'?'show':'hide']();if(pandora.user.ui.section=='items'&&data.selected!='query'&&!pandora.user.ui.updateAdvancedFindResults){pandora.$ui.filterForm.updateResults();}}});pandora.$ui.listDialogTabPanel.find('.OxButtonGroup').css({width:'256px'});var $findElement=Ox.FormElementGroup({elements:[pandora.$ui.findIconItemSelect=Ox.Select({items:pandora.site.findKeys.map(function(findKey){return{id:findKey.id,title:Ox._('Find: {0}',[Ox._(findKey.title)])};}),overlap:'right',type:'image'}).bindEvent({change:function(data){pandora.$ui.findIconItemInput.options({placeholder:data.title});setTimeout(function(){pandora.$ui.findIconItemInput.focusInput(true);},250);}}),pandora.$ui.findIconItemInput=Ox.Input({changeOnKeypress:true,clear:true,placeholder:Ox._('Find: All'),width:128+Ox.UI.SCROLLBAR_SIZE}).bindEvent({change:function(data){pandora.$ui.listIconPanel.updateQuery(pandora.$ui.findIconItemSelect.value(),data.value);}})],}).css({float:'right',margin:'4px',align:'right'})
[section=='icon'?'show':'hide']().appendTo(pandora.$ui.listDialogTabPanel.children('.OxBar')),$dialog=Ox.Dialog({buttons:[Ox.Button({id:'done',title:Ox._('Done')}).bindEvent({click:function(){if(pandora.$ui.listDialogTabPanel.selected()=='query'&&!pandora.user.ui.updateAdvancedFindResults){pandora.$ui.filterForm.updateResults();}
$dialog.close();}})],closeButton:true,content:pandora.$ui.listDialogTabPanel,maxWidth:width,minHeight:312,minWidth:width,height:312,removeOnClose:true,title:folderItem+' &mdash; '+Ox.encodeHTMLEntities(listData.name),width:width}),$updateCheckbox=Ox.Checkbox({title:Ox._('Update Results in the Background'),value:pandora.user.ui.updateAdvancedFindResults}).css({float:'left',margin:'4px'})
[section=='query'?'show':'hide']().bindEvent({change:function(data){pandora.UI.set({updateAdvancedFindResults:data.value});data.value&&pandora.$ui.filterForm.updateResults();}});$($updateCheckbox.find('.OxButton')[0]).css({margin:0});$($dialog.$element.find('.OxBar')[2]).append($updateCheckbox);function getWidth(section){return section=='general'?496:(section=='icon'?696:648)+Ox.UI.SCROLLBAR_SIZE;}
return $dialog;};pandora.ui.listGeneralPanel=function(listData){var that=Ox.Element(),ui=pandora.user.ui,folderItems=ui.section=='items'?'Lists':Ox.toTitleCase(ui.section),folderItem=folderItems.slice(0,-1);pandora.api['find'+folderItems]({query:{conditions:[{key:'id',value:listData.id,operator:'=='}]},keys:['description','subscribers']},function(result){var description=result.data.items[0].description,subscribers=result.data.items[0].subscribers,$icon=Ox.Element({element:'<img>',tooltip:Ox._('Doubleclick to edit icon')}).attr({src:'/'+folderItem.toLowerCase()+'/'+encodeURIComponent(listData.id)+'/icon256.jpg?'+Ox.uid()}).css({position:'absolute',left:'16px',top:'16px',width:'128px',height:'128px',borderRadius:'32px'}).bindEvent({doubleclick:function(){pandora.$ui.listDialogTabPanel.select('icon');}}).appendTo(that),$nameInput=Ox.Input({label:Ox._('Name'),labelWidth:80,value:listData.name,width:320}).css({position:'absolute',left:'160px',top:'16px'}).bindEvent({blur:editName,submit:editName}).appendTo(that),$itemsInput=ui.section=='items'?Ox.Input({disabled:true,label:Ox._('Items'),labelWidth:80,value:listData.items,width:320}).css({position:'absolute',left:'160px',top:'40px'}).appendTo(that):Ox.Select({items:pandora.site.textRightsLevels.map(function(rightsLevel,i){console.log(listData);return{id:i,title:rightsLevel.name,};}),label:Ox._('Rights Level'),labelWidth:80,value:listData.rightslevel,width:320}).css({position:'absolute',left:'160px',top:'40px'}).bindEvent({change:editRightsLevel}).appendTo(that),$statusSelect=listData.status=='featured'?Ox.Input({disabled:true,label:Ox._('Status'),labelWidth:80,value:'Featured',width:320}).css({position:'absolute',left:'160px',top:'64px'}).appendTo(that):Ox.Select({items:[{id:'private',title:Ox._('Private')},{id:'public',title:Ox._('Public')}],label:Ox._('Status'),labelWidth:80,value:listData.status,width:320}).css({position:'absolute',left:'160px',top:'64px'}).bindEvent({change:editStatus}).appendTo(that),$subscribersInput=Ox.Input({disabled:true,label:Ox._('Subscribers'),labelWidth:80,value:subscribers,width:320}).css({position:'absolute',left:'160px',top:'88px'})
[getSubscribersAction()]().appendTo(that),$descriptionInput=Ox.Input({height:getDescriptionHeight(),placeholder:Ox._('Description'),type:'textarea',value:description,width:320}).css({position:'absolute',left:'160px',top:getDescriptionTop()+'px'}).bindEvent({blur:editDescription,submit:editDescription}).appendTo(that);function editDescription(data){if(data.value!=description){pandora.api['edit'+folderItem]({id:listData.id,description:data.value},function(result){description=result.data.description;Ox.Request.clearCache('find'+folderItems);pandora.$ui.info.updateListInfo();});}}
function editName(data){if(data.value!=listData.name){pandora.api['edit'+folderItem]({id:listData.id,name:data.value},function(result){if(result.data.id!=listData.id){pandora.renameList(listData.id,result.data.id,result.data.name);listData.id=result.data.id;listData.name=result.data.name;Ox.Request.clearCache('find'+folderItems);pandora.$ui.info.updateListInfo();pandora.$ui.listDialog.options({title:Ox._(folderItem)+' &mdash; '+Ox.encodeHTMLEntities(listData.name)});}});}}
function editStatus(data){var status=data.value;$statusSelect.value(status=='private'?'public':'private');pandora.changeFolderItemStatus(listData.id,status,function(result){listData.status=result.data.status;if(result.data.status=='private'){subscribers=0;$subscribersInput.value(0);}
$statusSelect.value(result.data.status);$subscribersInput[getSubscribersAction()]();$descriptionInput.options({height:getDescriptionHeight()}).css({top:getDescriptionTop()+'px'});pandora.$ui.folderList[listData.folder].value(result.data.id,'status',result.data.status);});}
function editRightsLevel(data){var rightslevel=data.value;pandora.api.editText({id:listData.id,rightslevel:rightslevel},function(result){Ox.Request.clearCache('getText');$itemsInput.value(result.data.rightslevel);});}
function getDescriptionHeight(){return listData.status=='private'?184:160;}
function getDescriptionTop(){return listData.status=='private'?88:112;}
function getSubscribersAction(){return listData.status=='private'?'hide':'show';}});return that;};pandora.ui.listIconPanel=function(listData){var quarter=0,quarters=['top-left','top-right','bottom-left','bottom-right'],ui=pandora.user.ui,folderItems=ui.section=='items'?'Lists':Ox.toTitleCase(ui.section),folderItem=folderItems.slice(0,-1),$iconPanel=Ox.Element(),$icon=$('<img>').attr({src:'/'+folderItem.toLowerCase()+'/'+encodeURIComponent(listData.id)+'/icon256.jpg?'+Ox.uid()}).css({position:'absolute',borderRadius:'64px',margin:'16px'}).appendTo($iconPanel),$previewPanel=Ox.Element(),$preview,$list=Ox.Element(),ui=pandora.user.ui,folderItems=ui.section=='items'?'Lists':Ox.toTitleCase(ui.section),folderItem=folderItems.slice(0,-1),that=Ox.SplitPanel({elements:[{element:$iconPanel,size:280},{element:$previewPanel},{element:$list,size:144+Ox.UI.SCROLLBAR_SIZE}],orientation:'horizontal'});pandora.api['find'+folderItems]({query:{conditions:[{key:'id',value:listData.id,operator:'=='}],operator:'&'},keys:['posterFrames']},function(result){var posterFrames=result.data.items[0].posterFrames,posterFrame=posterFrames[quarter],$interface=Ox.Element({tooltip:function(e){var quarterName=($(e.target).attr('id')||'').replace('-',' ');return quarterName?Ox._('Edit '+quarterName+' image'):null;}}).css({position:'absolute',width:'256px',height:'256px',marginLeft:'16px',marginTop:'16px',cursor:'pointer'}).on({click:function(e){clickIcon(e);},dblclick:function(e){clickIcon(e,true);}}).appendTo($iconPanel);renderQuarters();$list=Ox.IconList({borderRadius:16,item:function(data,sort){var size=128;return{height:size,id:data.id,info:data[['title','director'].indexOf(sort[0].key)>-1?'year':sort[0].key],title:data.title+(data.director.length?' ('+data.director.join(', ')+')':''),url:'/'+data.id+'/icon'+size+'.jpg?'+data.modified,width:size};},items:function(data,callback){pandora.api.find(Ox.extend(data,{query:{conditions:ui.section=='items'?[{key:'list',value:listData.id,operator:'=='}]:[],operator:'&'}}),callback);},keys:['director','duration','id','modified','posterFrame','title','videoRatio','year'],max:1,min:1,selected:posterFrame?[posterFrame.item]:[],size:128,sort:ui.section=='items'?pandora.user.ui.listSort:pandora.site.user.ui.listSort,unique:'id'}).bindEvent({open:function(data){setPosterFrame(data.ids[0],$list.value(data.ids[0],'posterFrame'))},select:function(data){renderPreview($list.value(data.ids[0]));}}).bindEventOnce({load:function(){var itemData;if(!posterFrame){itemData=$list.value(0);$list.options({selected:[itemData.id]});}else{itemData=$list.value(posterFrame.item);}
itemData&&renderPreview(itemData);}}).gainFocus();that.replaceElement(2,$list);function clickIcon(e,isDoubleClick){quarter=quarters.indexOf($(e.target).attr('id'));renderQuarters();if(isDoubleClick&&posterFrames.length){var item=posterFrames[quarter].item;$list.options({selected:[item]});renderPreview($list.value(item),posterFrames[quarter].position);}}
function renderPreview(itemData,position){$preview=pandora.ui.videoPreview({duration:itemData.duration,frameRatio:itemData.videoRatio,height:256,id:itemData.id,position:position,width:256}).css({marginLeft:'8px',marginTop:'16px',overflow:'hidden'}).bindEvent({click:function(data){setPosterFrame(itemData.id,data.position);}});$previewPanel.empty().append($preview);}
function renderQuarters(){$interface.empty();quarters.forEach(function(q,i){$interface.append($('<div>').attr({id:q}).css({float:'left',width:'126px',height:'126px',border:'1px solid rgba(255, 255, 255, '+(i==quarter?0.75:0)+')',background:'rgba(0, 0, 0, '+(i==quarter?0:0.75)+')'}).css('border-'+q+'-radius','64px'));});}
function setPosterFrame(item,position){var posterFrame={item:item,position:position};if(posterFrames.length){posterFrames[quarter]=posterFrame;}else{posterFrames=Ox.range(4).map(function(){return Ox.clone(posterFrame);});}
pandora.api['edit'+folderItem]({id:listData.id,posterFrames:posterFrames},function(){$icon.attr({src:'/'+folderItem.toLowerCase()+'/'+encodeURIComponent(listData.id)+'/icon256.jpg?'+Ox.uid()});pandora.$ui.folderList[listData.folder].$element.find('img[src*="/'+encodeURIComponent(listData.id)+'/"]').attr({src:'/'+folderItem.toLowerCase()+'/'+encodeURIComponent(listData.id)+'/icon.jpg?'+Ox.uid()});pandora.$ui.info.updateListInfo();});$preview.options({position:position});}});function renderFrame(){$frame.css({borderRadius:0});$frame.css('border-'+quarters[quarter]+'-radius','128px');}
that.updateQuery=function(key,value){$list.options({items:function(data,callback){pandora.api.find(Ox.extend(data,{query:{conditions:(ui.section=='items'?[{key:'list',value:listData.id,operator:'=='}]:[]).concat(value!==''?[{key:key,value:value,operator:'='}]:[]),operator:'&'}}),callback);}});};return that;}
'use strict';pandora.ui.folderBrowserBar=function(id,section){section=section||pandora.user.ui.section;var ui=pandora.user.ui,folderItems=section=='items'?'Lists':Ox.toTitleCase(section),folderItem=folderItems.slice(0,-1),that=Ox.Bar({size:24});pandora.$ui.findListElement[id]=Ox.FormElementGroup({elements:[pandora.$ui.findListSelect[id]=Ox.Select({items:[{id:'user',title:Ox._('Find: User')},{id:'name',title:Ox._('Find: {0}',[folderItem])}],overlap:'right',type:'image'}).bindEvent({change:function(data){var key=data.value,value=pandora.$ui.findListInput[id].value();value&&updateList(key,value);pandora.$ui.findListInput[id].options({placeholder:data.title});}}),pandora.$ui.findListInput[id]=Ox.Input({changeOnKeypress:true,clear:true,placeholder:Ox._('Find: User'),width:pandora.getFoldersWidth()-24}).bindEvent({change:function(data){var key=pandora.$ui.findListSelect[id].value(),value=data.value;updateList(key,value);}})]}).css({float:'right',margin:'4px',align:'right'}).appendTo(that);function updateList(key,value){pandora.$ui.folderList[id].options({items:function(data,callback){var query=id=='favorite'?{conditions:[{key:'status',value:'public',operator:'='},{key:'user',value:pandora.user.username,operator:'!=='},{key:key,value:value,operator:'='}],operator:'&'}:{conditions:[{key:'status',value:'private',operator:'!='},{key:key,value:value,operator:'='}],operator:'&'};return pandora.api['find'+folderItems](Ox.extend(data,{query:query}),callback);}});}
return that;};'use strict';pandora.ui.findElement=function(){var findIndex=pandora.user.ui._findState.index,findKey=pandora.user.ui._findState.key,findValue=pandora.user.ui._findState.value,hasPressedClear=false,previousFindKey=findKey,that=Ox.FormElementGroup({elements:[].concat(pandora.user.ui._list?[pandora.$ui.findListSelect=Ox.Select({items:[{id:'all',title:Ox._('Find: All {0}',[Ox._(pandora.site.itemName.plural)])},{id:'list',title:Ox._('Find: This List')}],overlap:'right',type:'image',tooltip:Ox._('Find: This List'),value:'list'}).bindEvent({change:function(data){pandora.$ui.findListSelect.options({tooltip:Ox.getObjectById(pandora.$ui.findListSelect.options('items'),data.value).title});pandora.$ui.findInput.focusInput(true);}}),]:[],[pandora.$ui.findSelect=Ox.Select({id:'select',items:[].concat(pandora.site.findKeys.filter(function(key,i){return!key.capability||pandora.site.capabilities[key.capability][pandora.user.level];}).map(function(key){return{id:key.id,title:Ox._('Find: {0}',[Ox._(key.title)])};}),[{},{id:'advanced',title:Ox._('Find: Advanced...')}]),overlap:'right',value:findKey,width:112}).bindEvent({change:function(data){if(data.value=='advanced'){that.updateElement();pandora.$ui.mainMenu.checkItem('findMenu_find_'+previousFindKey);pandora.$ui.filterDialog=pandora.ui.filterDialog().open();}else{pandora.$ui.mainMenu.checkItem('findMenu_find_'+data.value);pandora.$ui.findInput.options({autocomplete:autocompleteFunction(),placeholder:''}).focusInput(true);previousFindKey=data.value;}}}),pandora.$ui.findInput=Ox.Input({autocomplete:autocompleteFunction(),autocompleteSelect:true,autocompleteSelectHighlight:true,autocompleteSelectMaxWidth:256,autocompleteSelectSubmit:true,clear:true,clearTooltip:Ox._('Click to clear or doubleclick to reset query'),id:'input',placeholder:findKey=='advanced'?Ox._('Edit Query...'):'',value:findValue,width:192}).bindEvent({clear:function(){hasPressedClear=true;},focus:function(data){if(pandora.$ui.findSelect.value()=='advanced'){if(hasPressedClear){pandora.UI.set({find:pandora.site.user.ui.find});that.updateElement();hasPressedClear=false;}
pandora.$ui.findInput.blurInput();pandora.$ui.filterDialog=pandora.ui.filterDialog().open();}},submit:function(data){var findInList=pandora.user.ui._list&&pandora.$ui.findListSelect.value()=='list',key=pandora.$ui.findSelect.value(),conditions=[].concat(findInList?[{key:'list',value:pandora.user.ui._list,operator:'=='}]:[],data.value?[{key:key,value:data.value,operator:'='}]:[]);pandora.UI.set({find:{conditions:conditions,operator:'&'}});}})]),id:'findElement'}).css({float:'right',margin:'4px'});function autocompleteFunction(){var key=!that?pandora.user.ui._findState.key:that.value()[pandora.user.ui._list?1:0],findKey=Ox.getObjectById(pandora.site.findKeys,key);return findKey&&findKey.autocomplete?function(value,callback){value===''&&Ox.Log('','Warning: autocomplete function should never be called with empty value');pandora.api.autocomplete({key:key,query:{conditions:pandora.user.ui._list&&pandora.$ui.findListSelect.value()=='list'?[{key:'list',value:pandora.user.ui._list,operator:'=='}]:[],operator:'&'},range:[0,20],sort:findKey.autocompleteSort,value:value},function(result){callback(result.data.items.map(function(item){return Ox.decodeHTMLEntities(item);}));});}:null;}
that.updateElement=function(){var findState=pandora.user.ui._findState;pandora.$ui.findSelect.value(findState.key);pandora.$ui.findInput.options(findState.key=='advanced'?{placeholder:Ox._('Edit Query...'),value:''}:{autocomplete:autocompleteFunction(),placeholder:'',value:findState.value});};return that;};'use strict';pandora.ui.folders=function(section){section=section||pandora.user.ui.section;var ui=pandora.user.ui,counter=0,that=Ox.Element().css({overflowX:'hidden',overflowY:'auto'}).bindEvent({resize:pandora.resizeFolders}),folderItems=section=='items'?'Lists':Ox.toTitleCase(section),folderItem=folderItems.slice(0,-1);pandora.$ui.allItems=pandora.ui.allItems(section).appendTo(that);pandora.$ui.folder=[];pandora.$ui.folderBrowser={};pandora.$ui.folderList={};pandora.$ui.findListElement={};pandora.$ui.findListSelect={};pandora.$ui.findListInput={};pandora.$ui.manageListsButton={};pandora.site.sectionFolders[section].forEach(function(folder,i){var extras,$select;if(folder.id=='personal'){if(pandora.user.level=='guest'){extras=[infoButton(Ox._('Personal '+folderItems),Ox._('To create and share your own list of {0} please sign up or sign in.',[Ox._(pandora.site.itemName.plural.toLowerCase())]),Ox._('To create and share your own {0} please sign up or sign in.',[section]))];}else{if(section=='items'){extras=[pandora.$ui.personalListsMenu=Ox.MenuButton({items:[{id:'newlist',title:Ox._('New List')},{id:'newlistfromselection',title:Ox._('New List from Selection'),disabled:ui.listSelection.length==0},{id:'newsmartlist',title:Ox._('New Smart List')},{id:'newsmartlistfromresults',title:Ox._('New Smart List from Results')},{},{id:'duplicatelist',title:Ox._('Duplicate Selected List'),disabled:!pandora.user.ui._list},{id:'editlist',title:Ox._('Edit Selected List...'),disabled:!pandora.user.ui._list},{id:'deletelist',title:Ox._('Delete Selected List...'),disabled:!pandora.user.ui._list}],title:'edit',tooltip:Ox._('Manage Personal Lists'),type:'image'}).bindEvent({click:function(data){var $list=pandora.$ui.folderList[folder.id];if(['newlist','newlistfromselection','newsmartlist','newsmartlistfromresults'].indexOf(data.id)>-1){pandora.addList(data.id.indexOf('smart')>-1,data.id.indexOf('from')>-1);}else if(data.id=='duplicatelist'){pandora.addList(pandora.user.ui._list);}else if(data.id=='editlist'){pandora.ui.listDialog().open();}else if(data.id=='deletelist'){pandora.ui.deleteListDialog().open();}},pandora_find:function(){var action=ui._list&&pandora.getListData(ui._list).user==pandora.user.username?'enableItem':'disableItem';pandora.$ui.personalListsMenu[action]('editlist');pandora.$ui.personalListsMenu[action]('duplicatelist');pandora.$ui.personalListsMenu[action]('deletelist');pandora.$ui.personalListsMenu[ui.listSelection.length?'enableItem':'disableItem']('newlistfromselection');},pandora_listselection:function(data){pandora.$ui.personalListsMenu[data.value.length?'enableItem':'disableItem']('newlistfromselection');}})];}else if(section=='texts'){extras=[pandora.$ui.personalListsMenu=Ox.MenuButton({items:[{id:'newtext',title:Ox._('New Text')},{id:'newpdf',title:Ox._('New  PDF')},{},{id:'deletetext',title:Ox._('Delete Selected Text...'),disabled:!ui.text}],title:'edit',tooltip:Ox._('Manage Personal Texts'),type:'image'}).bindEvent({click:function(data){var $list=pandora.$ui.folderList[folder.id];if(data.id=='newtext'){pandora.addText({type:'text'});}else if(data.id=='newpdf'){pandora.addText({type:'pdf'});}else if(data.id=='deletetext'){pandora.ui.deleteListDialog().open();}}}).bindEvent('pandora_text',function(data){pandora.$ui.personalListsMenu[data.value&&data.value.length?'enableItem':'disableItem']('deletetext');})];}else if(section=='edits'){extras=[pandora.$ui.personalListsMenu=Ox.MenuButton({items:[{id:'newedit',title:Ox._('New Edit')},{},{id:'deleteedit',title:Ox._('Delete Selected Edit...'),disabled:!ui.text}],title:'edit',tooltip:Ox._('Manage Personal Edits'),type:'image'}).bindEvent({click:function(data){var $list=pandora.$ui.folderList[folder.id];if(data.id=='newedit'){pandora.addEdit();}else if(data.id=='deleteedit'){pandora.ui.deleteListDialog().open();}}}).bindEvent('pandora_edit',function(data){pandora.$ui.personalListsMenu[data.value&&data.value.length?'enableItem':'disableItem']('deleteedit');})];}else{extras=[];}}}else if(folder.id=='favorite'){if(pandora.user.level=='guest'){extras=[infoButton(Ox._('Favorite '+folderItems),Ox._('To browse and subscribe to shared {0} from other users, please sign up or sign in.',[Ox._(folderItems.toLowerCase())]))];}else{extras=[pandora.$ui.manageListsButton['favorite']=Ox.Button({selectable:true,style:'symbol',title:'edit',tooltip:Ox._('Manage Favorite {0}',[Ox._(folderItems)]),type:'image'}).bindEvent({change:function(data){var listData;Ox.Request.clearCache();pandora.site.sectionFolders[section][i].showBrowser=!pandora.site.sectionFolders[section][i].showBrowser;this.options({tooltip:data.value?Ox._('Done'):Ox._('Manage Favorite {0}',[Ox._(folderItems)])});if(pandora.site.sectionFolders[section][i].showBrowser){pandora.$ui.folderList.favorite.replaceWith(pandora.$ui.folderBrowser.favorite=pandora.ui.folderBrowser('favorite',section));}else{listData=pandora.getListData();if(pandora.$ui.folderList.favorite.options('selected').length&&!listData.subscribed){pandora.$ui.folderList.favorite.options({selected:[]});if(Ox.getObjectById(pandora.site.sectionFolders[section],'featured').showBrowser){pandora.$ui.folderList.featured.options({selected:[listData.id]});}else{pandora.UI.set({find:pandora.site.user.ui.find});}}
pandora.$ui.folderBrowser.favorite.replaceWith(pandora.$ui.folderList.favorite=pandora.ui.folderList('favorite',section));}
pandora.resizeFolders();}})];}}else if(folder.id=='featured'){if(pandora.user.level!='admin'){extras=[infoButton(Ox._('Featured '+folderItems),Ox._('Featured {0} are selected public {0}, picked by the {1} staff.',[Ox._(folderItems.toLowerCase()),pandora.site.site.name]))];}else{extras=[pandora.$ui.manageListsButton['featured']=Ox.Button({selectable:true,style:'symbol',title:'edit',tooltip:Ox._('Manage Featured {0}',[Ox._(folderItems)]),type:'image'}).bindEvent({change:function(data){var listData;Ox.Request.clearCache();pandora.site.sectionFolders[section][i].showBrowser=!pandora.site.sectionFolders[section][i].showBrowser;this.options({tooltip:data.value?Ox._('Done'):Ox._('Manage Favorite {0}',[Ox._(folderItems)])});if(pandora.site.sectionFolders[section][i].showBrowser){pandora.$ui.folderList.featured.replaceWith(pandora.$ui.folderBrowser.featured=pandora.ui.folderBrowser('featured',section));}else{listData=pandora.getListData();Ox.Log('','FEATURED',listData)
if(pandora.$ui.folderList.featured.options('selected').length&&listData.status!='featured'){pandora.$ui.folderList.featured.options({selected:[]});if(listData.user==pandora.user.username){pandora.$ui.folderList.personal.options({selected:[listData.id]});}else if(listData.subscribed||Ox.getObjectById(pandora.site.sectionFolders[section],'favorite').showBrowser){pandora.$ui.folderList.favorite.options({selected:[listData.id]});}else{pandora.UI.set({find:pandora.site.user.ui.find});}}
pandora.$ui.folderBrowser.featured.replaceWith(pandora.$ui.folderList.featured=pandora.ui.folderList('featured',section));}
pandora.resizeFolders();}})];}}else if(folder.id=='volumes'){if(pandora.user.level=='guest'){extras=[infoButton(Ox._('Local Volumes'),Ox._('To import {0} from a local disk, please sign up or sign in.',[Ox._(pandora.site.itemName.plural.toLocaleLowerCase())]))];}else{extras=[Ox.MenuButton({items:[{id:'add',title:Ox._('Add Volume...'),disabled:true},{id:'scan',title:Ox._('Scan Selected Volume...'),disabled:true},{id:'remove',title:Ox._('Remove Selected Volume...'),disabled:true},{},{id:'import',title:Ox._('Import {0}...',[Ox._(pandora.site.itemName.plural.toLocaleLowerCase())]),disabled:true}],title:'edit',tooltip:Ox._('Manage Volumes'),type:'image'}).bindEvent({click:function(data){}})];}}
pandora.$ui.folder[i]=Ox.CollapsePanel({id:folder.id,collapsed:!ui.showFolder.items[folder.id],extras:extras,size:16,title:Ox._(folder.title)}).bindEvent({click:function(data){var $list=pandora.$ui.folderList[i],hasFocus,id;if(data.id=='new'||data.id=='newsmart'){pandora.api.addList({name:Ox._('Untitled'),status:'private',type:data.id=='new'?'static':'smart'},function(result){id=result.data.id;pandora.URL.set('?find=list:'+id)
Ox.Request.clearCache();$list.reloadList().bindEventOnce({load:function(data){$list.gainFocus().options({selected:[id]}).editCell(id,'name');}});});}else if(data.id=='browse'){}},toggle:function(data){data.collapsed&&pandora.$ui.folderList[folder.id].loseFocus();pandora.UI.set('showFolder.items.'+folder.id,!data.collapsed);pandora.resizeFolders();}});pandora.$ui.folderList[folder.id]=pandora.ui.folderList(folder.id,section).bindEvent({selectnext:function(){},selectprevious:function(){}}).bindEventOnce({init:function(data){if(++counter==pandora.site.sectionFolders[section].length){pandora.$ui.folder.forEach(function($folder){that.append($folder);});pandora.resizeFolders(section);pandora.selectList();}}}).appendTo(pandora.$ui.folder[i].$content);});function infoButton(title,text){return Ox.Button({style:'symbol',title:'info',type:'image'}).bindEvent({click:function(){var $dialog=pandora.ui.iconDialog({buttons:title!=Ox._('Featured Lists')?[Ox.Button({title:Ox._('Sign Up...')}).bindEvent({click:function(){$dialog.close();pandora.$ui.accountDialog=pandora.ui.accountDialog('signup').open();}}),Ox.Button({title:Ox._('Sign In...')}).bindEvent({click:function(){$dialog.close();pandora.$ui.accountDialog=pandora.ui.accountDialog('signin').open();}}),{},Ox.Button({title:Ox._('Not Now')}).bindEvent({click:function(){$dialog.close();}})]:[Ox.Button({title:Ox._('Close')}).bindEvent({click:function(){$dialog.close();}})],content:text,title:title}).open();}});}
that.bindEvent({pandora_edit:function(){if(!pandora.user.ui.edit){Ox.forEach(pandora.$ui.folderList,function($list,id){$list.options('selected',[]);});}},pandora_find:function(){var folder=pandora.getListData().folder,list=pandora.user.ui._list,previousList=pandora.UI.getPrevious()._list;if(list!=previousList){Ox.forEach(pandora.$ui.folderList,function($list,id){id!=folder&&$list.options('selected',[]);});folder&&pandora.$ui.folderList[folder].options({selected:[list]});}},pandora_text:function(){if(!pandora.user.ui.text){Ox.forEach(pandora.$ui.folderList,function($list,id){$list.options('selected',[]);});}}})
return that;};'use strict';pandora.ui.embedList=function(){var that=Ox.Element();that.resizePanel=function(){return that;};return that;};'use strict';pandora.ui.contactForm=function(){var that=Ox.Element(),width=getWidth(),$form=Ox.Form({items:[Ox.Input({id:'name',label:Ox._('Your Name'),labelWidth:128,validate:function(value,callback){callback({valid:true});},value:pandora.user.username,width:width}),Ox.Input({autovalidate:pandora.autovalidateEmail,id:'email',label:Ox._('Your E-Mail Address'),labelWidth:128,validate:function(value,callback){callback({message:Ox._('Please enter '
+(value.length==0?'your':'a valid')
+' e-mail address'),valid:Ox.isValidEmail(value)});},value:pandora.user.email,width:width}),Ox.Input({id:'subject',label:Ox._('Subject'),labelWidth:128,validate:function(value,callback){callback({valid:true});},value:'',width:width}),Ox.Input({autovalidate:function(value,blur,callback){callback({valid:value.length>0,value:value});},height:256,id:'message',placeholder:'Message',type:'textarea',validate:function(value,callback){callback({message:Ox._('Please enter a message'),valid:value.length>0});},value:'',width:width})]}).css({width:width+'px'}).bindEvent({validate:function(data){$sendButton.options({disabled:!data.valid});}}).appendTo(that),$receiptCheckbox=Ox.Checkbox({id:'receipt',title:Ox._('Send a receipt to {0}',[pandora.user.email]),value:pandora.user.level!='guest',width:width-136}).css({float:'left',margin:'8px 4px 8px 0'}).bindEvent({change:function(data){$receiptCheckbox.options({title:data.value?Ox._('Send a receipt to {0}',[pandora.user.email]):Ox._('Don\'t send me a receipt')});}}).appendTo(that),$sendButton=Ox.Button({disabled:true,title:Ox._('Send Message'),width:128}).css({float:'left',margin:'8px 0 8px '+(pandora.user.level=='guest'?width-128:4)+'px'}).bindEvent({click:function(){var data=$form.values();$sendButton.options({disabled:true,title:Ox._('Sending Message...')});pandora.api.contact({name:data.name,email:data.email,subject:data.subject,message:data.message,receipt:$receiptCheckbox.value()},function(result){var $dialog=pandora.ui.iconDialog({buttons:[Ox.Button({id:'close',title:Ox._('Close')}).bindEvent({click:function(){$dialog.close();$form.values({subject:'',message:''});}})],content:Ox._('Thanks for your message!<br/><br/>We will get back to you as soon as possible.'),keys:{enter:'close',escape:'close'},title:Ox._('Message Sent')}).open();$sendButton.options({disabled:false,title:Ox._('Send Message')});});}}).appendTo(that),$text=$('<div>').css({width:width+'px'}).html('&nbsp;'+Ox._('Alternatively, you can contact us via {0}',['<a href="mailto:'+pandora.site.site.email.contact+'">'
+pandora.site.site.email.contact+'</a>'])).appendTo(that);pandora.user.level=='guest'&&$receiptCheckbox.hide();function getWidth(){return Math.min((pandora.$ui.siteDialog?parseInt(pandora.$ui.siteDialog.css('width')):Math.round(window.innerWidth*0.75))-304-Ox.UI.SCROLLBAR_SIZE,512);}
that.resizeElement=function(){var width=getWidth();$form.css({width:width+'px'});$form.options('items').forEach(function($input,i){i<4&&$input.options({width:width});});if(pandora.user.level=='guest'){$sendButton.css({marginLeft:width-128+'px'});}else{$receiptCheckbox.options({width:width-136});}
$text.css({width:width+'px'});};return that;};'use strict';pandora.ui.clipList=function(videoRatio){var ui=pandora.user.ui,fixedRatio=!ui.item?pandora.site.video.previewRatio:videoRatio,isClipView=!ui.item?ui.listView=='clip':ui.itemView=='clips',isEmbed=pandora.isEmbedURL(),that=Ox.IconList({draggable:true,find:!ui.item?pandora.getItemFind(ui.find):ui.itemFind,fixedRatio:fixedRatio,item:function(data,sort,size){size=size||128;var ratio,width,height,format,info,sortKey,title,url;if(!ui.item){ratio=data.videoRatio;width=ratio>fixedRatio?size:Math.round(size*ratio/fixedRatio);height=Math.round(width/ratio);}else{width=fixedRatio>1?size:Math.round(size*fixedRatio);height=fixedRatio>1?Math.round(size/fixedRatio):size;}
title=data.annotations?data.annotations.sort(function(a,b){var layerA=pandora.site.clipLayers.indexOf(a.layer),layerB=pandora.site.clipLayers.indexOf(b.layer);return layerA<layerB?-1:layerA>layerB?1:a.value<b.value?-1:a.value>b.value?1:0;}).map(function(annotation){return Ox.stripTags(annotation.value.replace(/\n/g,' '));}).join('; '):'';url='/'+data.id.split('/')[0]+'/'+height+'p'+data['in']+'.jpg';sortKey=sort[0].key;if(['text','position','duration','random'].indexOf(sortKey)>-1){info=Ox.formatDuration(data['in'])+' - '
+Ox.formatDuration(data.out);}else{format=pandora.getSortKeyData(sortKey).format;if(format){info=(/^color/.test(format.type.toLowerCase())?Ox.Theme:Ox)['format'+Ox.toTitleCase(format.type)].apply(this,[data[sortKey]].concat(format.args||[]));if(sortKey=='rightslevel'){info.css({width:size*0.75+'px'});}}else{info=data[sortKey];}}
return{height:height,id:data.id,info:info,title:title,url:url,width:width};},items:function(data,callback){if(!isClipView){callback({data:{items:data.keys?[]:0}});return;}
var itemsQuery,query;if(!ui.item){itemsQuery=ui.find;query={conditions:[],operator:'&'};itemsQuery.conditions.forEach(function(condition){if(condition.key=='annotations'||Ox.getIndexById(pandora.site.layers,condition.key)>-1){query.conditions.push(condition);}});}else{itemsQuery={conditions:[{key:'id',value:ui.item,operator:'=='}],operator:'&'};query={conditions:ui.itemFind===''?[]:[{key:'annotations',value:ui.itemFind,operator:'='}],operator:'&'};}
pandora.api.findClips(Ox.extend(data,{itemsQuery:itemsQuery,query:query}),callback);},keys:['annotations','id','in','out'].concat(!ui.item?['videoRatio']:[]),orientation:isEmbed&&!isClipView?'horizontal':'both',size:128,sort:!ui.item?ui.listSort:ui.itemSort,unique:'id'}).addClass('OxMedia').bindEvent({copy:function(data){var items=data.ids.map(function(id){var item=!ui.item?id.split('/')[0]:ui.item,annotation=that.value(id,'annotations')[0].id;return annotation||item+'/'+that.value(id,'in')+'-'+that.value(id,'out');})
pandora.clipboard.copy(items,'clip');},copyadd:function(data){var items=data.ids.map(function(id){var item=!ui.item?id.split('/')[0]:ui.item,annotation=that.value(id,'annotations')[0].id;return annotation||item+'/'+that.value(id,'in')+'-'+that.value(id,'out');})
pandora.clipboard.add(items,'clip');},gainfocus:function(){pandora.$ui.mainMenu.replaceItemMenu();},init:function(data){if(!ui.item&&ui.listView=='clip'){pandora.$ui.statusbar.set('total',data);}},open:function(data){var id=data.ids[0],item=!ui.item?id.split('/')[0]:ui.item,annotation=that.value(id,'annotations')[0].id,points={annotation:annotation?annotation.split('/')[1]:'','in':that.value(id,'in'),out:that.value(id,'out'),position:that.value(id,'in')},set;if(isEmbed){window.open('/'+item+'/'
+(annotation?points.annotation:points['in']+','+points.out),'_blank');}else{set={item:item,itemView:pandora.user.ui.videoView};set['videoPoints.'+item]=Ox.extend(points,{position:points['in']});if(['accessed','timesaccessed'].indexOf(ui.listSort[0].key)>-1){Ox.Request.clearCache('find');}
pandora.UI.set(set);}},openpreview:function(data){if(data.ids.length==1){var $video=that.find('.OxItem.OxSelected > .OxIcon > .OxVideoPlayer');if($video){$video.trigger('mousedown');Ox.UI.$window.trigger('mouseup');}}
that.closePreview();},select:function(data){if(data.ids.length==1){var id=data.ids[0],item=id.split('/')[0],width,height,$img=that.find('.OxItem.OxSelected > .OxIcon > img'),$video=that.find('.OxItem.OxSelected > .OxIcon > .OxVideoPlayer'),size=128,ratio,width,height;if($img.length){if(!ui.item){ratio=that.value(id,'videoRatio');width=ratio>fixedRatio?size:Math.round(size*ratio/fixedRatio);height=Math.round(width/ratio);}else{width=fixedRatio>1?size:Math.round(size*fixedRatio);height=fixedRatio>1?Math.round(size/fixedRatio):size;}
pandora.api.get({id:item,keys:['durations','rightslevel']},function(result){var points=[that.value(id,'in'),that.value(id,'out')],$player=Ox.VideoPlayer({censored:pandora.site.capabilities.canPlayClips[pandora.user.level]<result.data.rightslevel?[{'in':0,out:points[1]-points[0]}]:[],censoredIcon:pandora.site.cantPlay.icon,censoredTooltip:pandora.site.cantPlay.text,height:height,paused:true,poster:'/'+item+'/'+height+'p'+points[0]+'.jpg',rewind:true,video:pandora.getClipVideos({item:item,parts:result.data.durations.length,durations:result.data.durations,'in':points[0],out:points[1]},Ox.min(pandora.site.video.resolutions)),width:width}).addClass('OxTarget').bindEvent({censored:function(){pandora.URL.push(pandora.site.cantPlay.link);},singleclick:function(e){if($player.$element.is('.OxSelectedVideo')&&!$(e.target).is('.OxCensoredIcon')){$player.togglePaused();}}});$img.replaceWith($player.$element);$('.OxSelectedVideo').removeClass('OxSelectedVideo');$player.$element.addClass('OxSelectedVideo');});}else if($video.length){setTimeout(function(){$('.OxSelectedVideo').removeClass('OxSelectedVideo');$video.addClass('OxSelectedVideo');},300);}
!ui.item&&pandora.UI.set({listSelection:[item]});!isEmbed&&pandora.$ui.mainMenu.enableItem('findsimilar');}else{$('.OxSelectedVideo').removeClass('OxSelectedVideo');!ui.item&&pandora.UI.set({listSelection:[]});!isEmbed&&pandora.$ui.mainMenu.disableItem('findsimilar');}
pandora.$ui.mainMenu.replaceItemMenu();},pandora_itemsort:function(data){that.options({sort:data.value});},pandora_listsort:function(data){that.options({sort:data.value});}});pandora.enableDragAndDrop(that,true,'edits');return that;}
'use strict';pandora.ui.resetUIDialog=function(data){var that=pandora.ui.iconDialog({buttons:[Ox.Button({id:'cancel',title:Ox._('Don\'t Reset')}).bindEvent({click:function(){that.close();}}),Ox.Button({id:'reset',title:Ox._('Reset')}).bindEvent({click:function(){that.close();pandora.$ui.preferencesDialog.close();pandora.UI.set({page:''});pandora.UI.reset();}})],content:Ox._('Are you sure you want to reset all UI settings?'),keys:{enter:'reset',escape:'cancel'},title:Ox._('Reset UI Settings')});return that;};'use strict';pandora.ui.helpDialog=function(){var text={},$panel,$list,$text,$image,that=Ox.Dialog({buttons:[Ox.Button({id:'switch',title:Ox._('API Documentation...')}).bindEvent({click:function(){pandora.UI.set({page:'api'});}}),{},Ox.Button({id:'close',title:Ox._('Close')}).bindEvent({click:function(){that.close();}})],closeButton:true,content:Ox.LoadingScreen(),height:384,keys:{escape:'close'},maximizeButton:true,minHeight:256,minWidth:544+2*Ox.UI.SCROLLBAR_SIZE,removeOnClose:true,title:Ox._('Help'),width:672+2*Ox.UI.SCROLLBAR_SIZE}).bindEvent({close:function(){pandora.user.ui.page=='help'&&pandora.UI.set({page:''});},resize:resize,'pandora_part.help':function(data){if(pandora.user.ui.page=='help'){that.select(data.value==''?'help':data.value);}}});Ox.get('/static/html/help.html',function(html){var $html=$('<div>'),strings=Ox.clone(pandora.site,true);strings.addAnnotationShortcuts=strings.layers.map(function(layer,index){return'<tr><td>'+index+'</td><td>'+Ox._('Add {0}',[layer.item.toLowerCase()])+'</td></tr>';}).join('\n');strings.itemName=Ox.map(strings.itemName,function(v){return v.toLowerCase();});strings.signup=pandora.user.level=='guest'?'<a href="/signup">'+Ox._('sign up')+'</a>':Ox._('sign up');$html.html(Ox.formatString(html,strings));pandora.site.help.forEach(function(section){var html=$html.find('#'+section.id).html();text[section.id]='<h1><b>'+Ox._(section.title)+'</b></h1>\n'+html;});$list=Ox.TableList({_tree:true,columns:[{id:'title',visible:true,width:128-Ox.UI.SCROLLBAR_SIZE}],items:pandora.site.help.map(function(value,index){return Ox.extend({index:index},value,{title:Ox._(value.title)});}),max:1,min:1,scrollbarVisible:true,selected:[pandora.user.ui.part.help||'help'],sort:[{key:'index',operator:'+'}],unique:'id'}).bindEvent({select:function(data){var id=data.ids[0]=='help'?'':data.ids[0];pandora.UI.set({'part.help':id});}});$text=Ox.Element().addClass('OxTextPage OxSelectable').css({padding:'16px',overflowY:'scroll'});$panel=Ox.SplitPanel({elements:[{element:$list,size:128+Ox.UI.SCROLLBAR_SIZE},{element:$text}],orientation:'horizontal'});that.select(pandora.user.ui.part.help).options({content:$panel});pandora.createLinks($text);$list.gainFocus();});function getImageSize(){var width=that.options('width')-160-2*Ox.UI.SCROLLBAR_SIZE,height=Math.round(width*5/8);return{width:width,height:height};}
function resize(data){$list.size();$image&&$image.options(getImageSize());}
that.select=function(id){var img,$img;$text.html(text[id||'help']).scrollTop(0);img=$text.find('img');if(img){$img=$(img);$img.replaceWith($image=Ox.ImageElement(Ox.extend(getImageSize(),{src:$img.attr('src')})).css({borderRadius:'8px'}));}
$text.find('td:first-child').css({height:'16px',paddingRight:'8px',textAlign:'right',whiteSpace:'nowrap'});return that;}
return that;};'use strict';pandora.ui.uploadDocumentDialog=function(file,callback){var extension=file.name.split('.').pop().toLowerCase(),extensions=['gif','jpg','jpeg','pdf','png'],filename=file.name.split('.').slice(0,-1).join('.')+'.'
+(extension=='jpeg'?'jpg':extension),id=pandora.user.username+':'+filename,upload,$errorDialog,$content=Ox.Element().css({margin:'16px'}),$text=$('<div>').html(Ox._('Uploading {0}',[file.name])).appendTo($content),$progress=Ox.Progressbar({width:256,showPercent:true,showTime:true}).css({margin:'16px 0 16px 0'}).appendTo($content),$message=$('<div>').appendTo($content),$uploadDialog=Ox.Dialog({buttons:[Ox.Button({id:'close',title:Ox._('Cancel Upload')}).bindEvent({click:function(){var title=this.options('title');$uploadDialog.close();if(title==Ox._('Cancel Upload')){upload.abort();}else if(title==Ox._('Done')){callback({id:id});}}})],content:$content,height:112,keys:{escape:'close'},width:288,title:Ox._('Upload File')}).bindEvent({open:function(){upload=pandora.chunkupload({data:{filename:filename},file:file,url:'/api/upload/document/',}).bindEvent({done:function(data){if(data.progress==1){$uploadDialog.options('buttons')[0].options({title:Ox._('Done')});Ox.print('SUCCEEDED');}else{$message.html(Ox._('Upload failed.'))
$uploadDialog.options('buttons')[0].options({title:Ox._('Close')});Ox.print('FAILED');}},progress:function(data){$progress.options({progress:data.progress||0});}});}});if(!Ox.contains(extensions,extension)){return errorDialog(Ox._('Supported file types are GIF, JPG, PNG and PDF.'));}else{Ox.oshash(file,function(oshash){pandora.api.findDocuments({keys:['id'],query:{conditions:[{key:'oshash',value:oshash,operator:'=='}],operator:'&'},range:[0,1],sort:[{key:'name',operator:'+'}]},function(result){if(result.data.items.length){errorDialog(filename==result.data.items[0].id?Ox._('The file {0} already exists',[filename]):Ox._('The file {0} already exists as {1}',[filename,result.data.items[0].id])).open();}else{$uploadDialog.open();}})});return{open:Ox.noop};}
function errorDialog(text){return $errorDialog=pandora.ui.iconDialog({buttons:[Ox.Button({id:'close',title:Ox._('Close')}).bindEvent({click:function(){$errorDialog.close();}})],content:text,title:Ox._('Upload File')});}};'use strict';pandora.ui.itemClips=function(options){var self={},that=Ox.Element().css({height:'192px',margin:'4px'}).bindEvent({doubleclick:doubleclick,singleclick:singleclick});self.options=Ox.extend({clips:[],duration:0,id:'',ratio:8/5},options);self.size=128;self.width=self.options.ratio>1?self.size:Math.round(self.size*self.options.ratio);self.height=self.options.ratio>1?Math.round(self.size/self.options.ratio):self.size;self.options.clips.forEach(function(clip,i){var annotations=clip.annotations.sort(function(a,b){var layerA=pandora.site.clipLayers.indexOf(a.layer),layerB=pandora.site.clipLayers.indexOf(b.layer);return layerA<layerB?-1:layerA>layerB?1:a.value<b.value?-1:a.value>b.value?1:0;}),url='/'+self.options.id+'/'+self.height+'p'+clip['in']+'.jpg',$item=Ox.IconItem({find:pandora.user.ui.itemFind,imageHeight:self.height,imageWidth:self.width,id:clip.id,info:Ox.formatDuration(clip['in'])+' - '+Ox.formatDuration(clip.out),title:annotations.map(function(annotation){return Ox.stripTags(annotation.value.replace(/\n/g,' '));}).join('; '),url:url}).addClass('OxInfoIcon').css({float:'left',margin:i==0?'2px 2px 2px -2px':i==self.options.clips.length-1?'2px -2px 2px 2px':'2px'}).data(Ox.extend(annotations.length&&annotations[0].id?{annotation:annotations[0].id.split('/')[1]}:{},{'in':clip['in'],out:clip.out}));$item.find('.OxTarget').addClass('OxSpecialTarget');that.append($item);});function doubleclick(data){var $item,$target=$(data.target),annotation,item,points,set;if($target.parent().parent().is('.OxSpecialTarget')){$target=$target.parent().parent();}
if($target.is('.OxSpecialTarget')){$item=$target.parent().parent();item=self.options.id;annotation=$item.data('annotation');points=[$item.data('in'),$item.data('out')];set={};set['videoPoints.'+item]=Ox.extend(annotation?{annotation:annotation}:{},{'in':points[0],out:points[1],position:points[0]});pandora.UI.set(set);}}
function singleclick(data){var $img,$item,$target=$(data.target),points;if($target.is('.OxSpecialTarget')){$item=$target.parent().parent();$img=$item.find('.OxIcon > img');points=[$item.data('in'),$item.data('out')];if($img.length){pandora.api.get({id:self.options.id,keys:['durations','rightslevel']},function(result){var partsAndPoints=pandora.getVideoPartsAndPoints(result.data.durations,points),$player=Ox.VideoPlayer({censored:pandora.site.capabilities.canPlayClips[pandora.user.level]<result.data.rightslevel?[{'in':partsAndPoints.points[0],out:partsAndPoints.points[1]}]:[],enableMouse:true,height:self.height,'in':partsAndPoints.points[0],out:partsAndPoints.points[1],playInToOut:true,poster:'/'+self.options.id+'/'+self.height+'p'+points[0]+'.jpg',rewind:true,video:partsAndPoints.parts.map(function(i){return pandora.getVideoURL(self.options.id,Ox.min(pandora.site.video.resolutions),i+1);}),width:self.width}).addClass('OxTarget OxSpecialTarget');$img.replaceWith($player.$element);});}}}
return that;};'use strict';pandora.ui.tv=function(){var that=Ox.Element().addClass('OxScreen').css({position:'absolute',width:'100%',height:'100%',opacity:0,zIndex:1000}),$player,list=pandora.user.ui.part.tv,lists=[],muted;function getList(direction){lists.length==0&&getLists();var index=lists.indexOf(list);return lists[direction==-1?(index==0?lists.length-1:index-1):(index==lists.length-1?0:index+1)];}
function getLists(){var menu=pandora.$ui.mainMenu.options('menus')[2];lists=[''];Ox.loop(3,function(f){menu.items[f+1].items.forEach(function(l){lists.push(l.id.slice(8));});});}
function play(){var $loading=$('<img>').attr({src:Ox.UI.getImageURL('symbolLoadingAnimated')}).css({position:'absolute',left:0,top:0,right:0,bottom:0,width:'32px',height:'32px',margin:'auto'}).appendTo(that);pandora.api.tv({list:list},function(result){var videoOptions=pandora.getVideoOptions(result.data);$loading.remove();$player&&$player.remove();$player=Ox.VideoPlayer({censored:videoOptions.censored,censoredIcon:pandora.site.cantPlay.icon,controlsBottom:['zapPrevious','zapHome','zapNext','volume','scale','timeline','position','settings'],controlsTooltips:{open:Ox._('Open in {0} View',[Ox._(Ox.getObjectById(pandora.site.itemViews,pandora.user.ui.videoView).title)])},controlsTop:['close','title','open'],duration:result.data.duration,enableSubtitles:pandora.user.ui.videoSubtitles,fullscreen:true,logo:pandora.site.tv.showLogo?'/static/png/logo.png':'',muted:muted||pandora.user.ui.videoMuted,position:result.data.position,resolution:pandora.user.ui.videoResolution,scaleToFill:pandora.user.ui.videoScale=='fill',subtitles:videoOptions.subtitles,tooltips:true,timeline:'/'+result.data.item+'/timeline16p.jpg',title:pandora.site.site.name+' &mdash; '+(list||Ox._('All {0}',[Ox._(pandora.site.itemName.plural)]))+' &mdash; '
+result.data.title
+(result.data.director?' ('+result.data.director.join(', ')+') ':'')+result.data.year,video:videoOptions.video,volume:pandora.user.ui.videoVolume}).bindEvent({close:that.fadeOutScreen,ended:play,muted:function(data){!muted&&pandora.UI.set({videoMuted:data.muted});},open:function(){var item=result.data.item,position=$player.options('position'),set={item:item,itemView:pandora.user.ui.videoView,page:''};if(pandora.user.ui.videoPoints[item]){set['videoPoints.'+item+'.position']=position;}else{set['videoPoints.'+item]={'in':0,out:0,position:position};}
pandora.UI.set(set);},resolution:function(data){pandora.UI.set({videoResolution:data.resolution});},scale:function(data){pandora.UI.set({videoScale:data.scale});},subtitles:function(data){pandora.UI.set({videoSubtitles:data.subtitles});},volume:function(data){pandora.UI.set({videoVolume:data.volume});},zap:function(data){if(!(data.direction==0&&list=='')){list=data.direction==0?'':getList(data.direction);play();}},key_enter:function(){$player.triggerEvent('open');},key_escape:function(){$player.triggerEvent('close');},key_left:function(){$player.triggerEvent('zap',{direction:-1});},key_right:function(){$player.triggerEvent('zap',{direction:1});},key_up:function(){$player.triggerEvent('zap',{direction:0});}}).appendTo(that);});}
that.fadeInScreen=function(){that.appendTo(Ox.UI.$body).animate({opacity:1},500);play();return that;};that.fadeOutScreen=function(){that.animate({opacity:0},500,function(){that.remove();});pandora.UI.set({page:''});return that;};that.hideScreen=function(){that.remove();pandora.UI.set({page:''});return that;};that.mute=function(){muted=true;$player&&$player.options({muted:muted});return that;};that.showScreen=function(){that.css({opacity:1}).appendTo(Ox.UI.$body);play();return that;};that.unmute=function(){$player&&$player.options({muted:pandora.user.ui.videoMuted});muted=false;return that;};return that;}
'use strict';pandora.ui.logsDialog=function(){var height=Math.round((window.innerHeight-48)*0.9),width=Math.round(window.innerWidth*0.9),$reloadButton=Ox.Button({disabled:true,title:'redo',tooltip:Ox._('Reload'),type:'image'}).css({float:'left',margin:'4px'}).bindEvent({click:function(){$reloadButton.options({disabled:true});Ox.Request.clearCache('findLogs');$list.reloadList(true);}}),$findSelect=Ox.Select({items:[{id:'all',title:Ox._('Find: All')},{id:'user',title:Ox._('Find: User')},{id:'url',title:Ox._('Find: URL')},{id:'text',title:Ox._('Find: Text')}],overlap:'right',type:'image',value:'all'}).bindEvent({change:function(data){var key=data.value,value=$findInput.value();value&&updateList(key,value);$findInput.options({placeholder:data.title});}}),$findInput=Ox.Input({changeOnKeypress:true,clear:true,placeholder:Ox._('Find: All'),width:192}).bindEvent({change:function(data){var key=$findSelect.value(),value=data.value;updateList(key,value);}}),$findElement=Ox.FormElementGroup({elements:[$findSelect,$findInput]}).css({float:'right',margin:'4px'}),$list=Ox.TableList({columns:[{id:'id',title:Ox._('ID'),visible:false},{format:function(value){return Ox.encodeHTMLEntities(value);},id:'user',operator:'+',title:Ox._('User'),visible:true,width:72},{align:'right',format:function(value){return Ox.formatDate(value,"%Y-%m-%d %H:%M:%S");},id:'created',operator:'-',title:Ox._('Date'),visible:true,width:144},{format:function(value,data){return formatURL(value,data.line);},id:'url',operator:'+',title:Ox._('URL'),visible:true,width:320},{format:function(value){return Ox.encodeHTMLEntities(value);},id:'text',operator:'+',title:Ox._('Text'),visible:true,width:640},],columnsMovable:true,columnsResizable:true,columnsVisible:true,items:pandora.api.findLogs,keys:['line'],scrollbarVisible:true,sort:[{key:'created',operator:'-'}],unique:'id'}).bindEvent({init:function(data){$status.html(Ox.toTitleCase(Ox.formatCount(data.items,'entry','entries')));},'delete':function(data){pandora.api.removeLogs({ids:data.ids},function(result){Ox.Request.clearCache('findLogs');$list.reloadList();});},load:function(){$reloadButton.options({disabled:false});},open:function(data){var value=$list.value(Ox.last(data.ids)),$dialog;if(/^Traceback/.test(value.text)){$dialog=Ox.Dialog({buttons:[Ox.Button({id:'close',title:Ox._('Close')}).bindEvent({click:function(){$dialog.close();}})],closeButton:true,content:$('<code>').append($('<pre>').addClass('OxSelectable').css({margin:'16px'}).text(value.text)),height:height-48,keys:{enter:'close',escape:'close'},maximizeButton:true,removeOnClose:true,title:formatURL(value.url,value.line),width:width-48}).open();}}}),that=Ox.Dialog({buttons:[Ox.Button({id:'done',title:Ox._('Done'),width:48}).bindEvent({click:function(){that.close();}})],closeButton:true,content:Ox.SplitPanel({elements:[{element:Ox.Bar({size:24}).append($reloadButton).append($findElement),size:24},{element:$list}],orientation:'vertical'}),height:height,maximizeButton:true,minHeight:256,minWidth:512,padding:0,removeOnClose:true,title:Ox._('Error Logs'),width:width}),$status=$('<div>').css({position:'absolute',top:'4px',left:'128px',right:'128px',bottom:'4px',paddingTop:'2px',fontSize:'9px',textAlign:'center'}).appendTo(that.find('.OxButtonsbar'));that.superClose=that.close;that.close=function(){Ox.Request.clearCache('findLogs');that.superClose();};function formatURL(url,line){return Ox.encodeHTMLEntities(url.split('?')[0])+':'+line;}
function renderLog(logData){var $checkbox;return Ox.Element().css({padding:'8px'}).append($('<pre>').html(logData.text));}
function updateList(key,value){var query={conditions:[].concat(key!='url'?[{key:'user',value:value,operator:'='}]:[],key!='user'?[{key:'url',value:value,operator:'='}]:[]),operator:key=='all'?'|':'&'};$list.options({items:function(data,callback){return pandora.api.findLogs(Ox.extend(data,{query:query}),callback);}});}
return that;};'use strict';pandora.ui.idDialog=function(data){data=Ox.clone(data,true);var originalData=Ox.clone(data,true),dialogHeight=Math.round((window.innerHeight-48)*0.9),dialogWidth=Math.round(window.innerWidth*0.9),formWidth=getFormWidth(),$content,$input=[],$checkboxGroup,that=Ox.Dialog({buttons:[Ox.Button({distabled:true,id:'switch',title:Ox._('Update Metadata...')}).bindEvent({click:function(){that.close();pandora.$ui.metadataDialog=pandora.ui.metadataDialog(originalData).open();}}),{},Ox.Button({id:'cancel',title:Ox._('Don\'t Update')}).bindEvent({click:function(){that.close();}}),Ox.Button({disabled:true,id:'update',title:Ox._('Update IMDb ID')}).bindEvent({click:updateId})],closeButton:true,content:Ox.LoadingScreen(),height:dialogHeight,maximizeButton:true,minHeight:256,minWidth:512,removeOnClose:true,title:Ox._('Update IMDb ID'),width:dialogWidth}).bindEvent({resize:setSize});getIds();function getFormWidth(){return dialogWidth-32-Ox.UI.SCROLLBAR_SIZE;}
function getIds(){var get={};['title','director','year'].forEach(function(key){if(!Ox.isEmpty(data[key])){get[key]=data[key];}});pandora.api.getIds(get,function(result){var checkboxes=[];if(!data.imdbId){checkboxes.push({id:'none',title:getTitle({id:data.imdbId,title:data.title,director:data.director,year:data.year})});}
$content=Ox.Element().css({padding:'13px',overflowY:'auto'});['title','director','year'].forEach(function(key){$input.push(Ox.Input({label:Ox.toTitleCase(key),labelWidth:128,value:Ox.decodeHTMLEntities(key=='director'&&data[key]?data[key].join(', '):(''+data[key])),width:formWidth}).css({display:'inline-block',margin:'3px'}).bindEvent({change:function(data_){data[key]=key=='director'?data_.value.split(', '):data_.value;that.options({content:Ox.LoadingScreen()});getIds();}}).appendTo($content));});$('<div>').css({width:'1px',height:'8px'}).appendTo($content);(data.imdbId&&Ox.getIndexById(result.data.items,data.imdbId)==-1?pandora.api.findId:Ox.noop)({id:data.imdbId},function(result_){if(result_&&result_.data.items.length){checkboxes.push({id:data.imdbId,title:getTitle(result_.data.items[0])})}
checkboxes=checkboxes.concat(result.data.items.map(function(item){return{id:item.id,title:getTitle(item)};}));$checkboxGroup=Ox.CheckboxGroup({checkboxes:checkboxes,type:'list',width:formWidth,value:!data.imdbId?'none':data.imdbId}).css({display:'inline-block',margin:'3px'}).bindEvent({change:updateButton}).appendTo($content);var elements=$checkboxGroup.find('.OxCheckbox:not(.OxButton)');checkboxes.forEach(function(checkbox,index){if(checkbox.id!='none'){Ox.Button({title:'arrowRight',tooltip:Ox._('View on IMDb'),type:'image'}).css({float:'right',marginTop:'-18px'}).bindEvent({click:function(){window.open('/url='+encodeURIComponent('http://imdb.com/title/tt'
+checkbox.id+'/combined'),'_blank');}}).appendTo(elements[index]);}});that.options({content:$content});updateButton();});});}
function getTitle(item){item=Ox.clone(item,true);if(item.id&&item.id==data.imdbId){item.id=highlightTitle(item.id);}
if(item.title==data.title){item.title=highlightTitle(item.title);}
if(item.originalTitle==data.title){item.originalTitle=highlightTitle(item.originalTitle);}
if(item.director){item.director.forEach(function(director,i){if(Ox.contains(data.director,director)){item.director[i]=highlightTitle(director);}})}
if(item.year&&item.year==data.year){item.year=highlightTitle(item.year);}
return Ox.filter([item.id,item.title+(item.originalTitle?' ('+item.originalTitle+')':''),item.director?item.director.join(', '):'',item.year]).join(' &mdash; ');}
function highlightTitle(value){return'<span style="font-weight: bold">'+value+'</span>';}
function isEmpty(value){return Ox.isEmpty(value)||Ox.isUndefined(value);}
function setSize(data){dialogHeight=data.height;dialogWidth=data.width;formWidth=getFormWidth();$input.forEach(function($element){$element.options({width:formWidth});});$checkboxGroup.options({width:formWidth});}
function updateButton(){that[$checkboxGroup.options('value')==data.imdbId||($checkboxGroup.options('value')=='none'&&!data.imdbId)?'disableButton':'enableButton']('update');}
function updateId(){that.options({content:Ox.LoadingScreen()}).disableButtons();pandora.api.edit({id:data.id,imdbId:$checkboxGroup.options('value')},function(result){that.close();pandora.updateItemContext();pandora.$ui.contentPanel.replaceElement(1,pandora.$ui.item=pandora.ui.item());});}
return that;};'use strict';pandora.ui.metadataDialog=function(data){var keys=['title','alternativeTitles','director','country','year','language','runtime','color','sound','productionCompany','producer','writer','cinematographer','editor','composer','actor','genre','keyword','summary'],updateKeys,dialogHeight=Math.round((window.innerHeight-48)*0.9),dialogWidth=Math.round(window.innerWidth*0.9),formWidth=getFormWidth(),imdb,$confirmDialog,$selectAllButton,$selectNoneButton,$label={},$input={},that=data.imdbId?updateDialog():idDialog();data.imdbId&&getMetadata();function idDialog(){return pandora.ui.iconDialog({buttons:[Ox.Button({id:'close',title:Ox._('Not Now')}).bindEvent({click:function(){that.close();}}),Ox.Button({distabled:true,id:'update',title:Ox._('Update IMDb ID...')}).bindEvent({click:function(){that.close();pandora.$ui.idDialog=pandora.ui.idDialog(data).open();}})],content:Ox._('To update the metadata for this {0}, please enter its IMDb ID.',[pandora.site.itemName.singular.toLowerCase()]),keyboard:{enter:'update',escape:'close'},title:Ox._('Update Metadata')});}
function updateDialog(){return Ox.Dialog({buttons:[Ox.Button({id:'switch',title:Ox._('Update IMDb ID...')}).bindEvent({click:function(){that.close();pandora.$ui.idDialog=pandora.ui.idDialog(data).open();}}),{},Ox.Button({id:'cancel',title:Ox._('Don\'t Update')}).bindEvent({click:function(){that.close();}}),Ox.Button({disabled:true,id:'update',title:Ox._('Update Metadata...')}).bindEvent({click:function(){$confirmDialog=confirmDialog().open();}})],closeButton:true,content:Ox.LoadingScreen(),height:dialogHeight,maximizeButton:true,minHeight:256,minWidth:512,removeOnClose:true,title:Ox._('Update Metadata'),width:dialogWidth}).bindEvent({resize:setSize});}
function confirmDialog(){return pandora.ui.iconDialog({buttons:[Ox.Button({id:'cancel',title:Ox._('Don\'t Update')}).bindEvent({click:function(){$confirmDialog.close();}}),Ox.Button({id:'update',title:Ox._('Update')}).bindEvent({click:function(){$confirmDialog.close();updateMetadata();}})],content:Ox._('Are you sure you want to update the value'
+(updateKeys.length==1?'':'s')
+' for {0}?',[updateKeys.map(function(key,index){return(index==0?'':index<updateKeys.length-1?', ':' '+Ox._('and')+' ')+getTitle(key)}).join('')]),height:192,keyboard:{enter:'update',escape:'cancel'},title:Ox._('Update Metadata')});}
function formatValue(key,value){return!value?'':key=='alternativeTitles'?value.map(function(v){return v[0];}).join('; '):key=='runtime'?Math.round(value/60)+' min':key=='productionCompany'?value.join('; '):Ox.isArray(Ox.getObjectById(pandora.site.itemKeys,key).type)?value.join(', '):value;}
function getFormWidth(){return dialogWidth-32-Ox.UI.SCROLLBAR_SIZE;}
function getMetadata(){pandora.api.getMetadata({id:data.imdbId,keys:keys.concat(['originalTitle'])},function(result){var $bar=Ox.Bar({size:24}),$data=Ox.Element().css({padding:'13px',overflowY:'auto'}),$content=Ox.SplitPanel({elements:[{element:$bar,size:24},{element:$data}],orientation:'vertical'});$selectNoneButton=Ox.Button({title:Ox._('Select No Updates'),}).css({float:'left',margin:'4px 2px 4px 4px'}).bindEvent({click:function(){selectAll(0)}}).appendTo($bar),$selectAllButton=Ox.Button({title:Ox._('Select All Updates'),}).css({float:'left',margin:'4px 2px 4px 2px'}).bindEvent({click:function(){selectAll(1);}}).appendTo($bar);if(result.data){imdb=Ox.clone(result.data,true);if(imdb.originalTitle){imdb.alternativeTitles=[[imdb.title,[]]].concat(imdb.alternativeTitles||[]);imdb.title=imdb.originalTitle;}
keys.forEach(function(key,index){var isEqual=Ox.isEqual(data[key],imdb[key])||(isEmpty(data[key])&&isEmpty(imdb[key])),checked=isEqual?[true,true]:isEmpty(data[key])&&!isEmpty(imdb[key])?[false,true]:[true,false];if(index>0){$('<div>').css({width:'1px',height:'8px'}).appendTo($data);}
$label[key]=Ox.Label({title:getTitle(key),width:formWidth}).css({display:'inline-block',margin:'3px 3px 5px 3px'}).appendTo($data);$input[key]=[data[key],imdb[key]].map(function(v,i){return Ox.InputGroup({inputs:[Ox.Checkbox({disabled:isEqual,value:checked[i],width:16}).bindEvent({change:function(){toggle(key);}}),Ox.Input({disabled:true,value:formatValue(key,v),width:formWidth-80}).bindEvent({change:function(){$input[key][i].options({value:[$input[key][i].options('value')[0],formatValue(key,v)]});}})],separators:[{title:[Ox._('Current'),Ox._('Update')][i],width:64}]}).css({display:'inline-block',margin:'3px'}).appendTo($data);});});that.options({content:$content});updateKeys=getUpdateKeys();updateButtons();}else{}});}
function getTitle(key){return Ox._(key=='alternativeTitles'?'Alternative Titles':Ox.getObjectById(pandora.site.itemKeys,key).title);}
function getUpdateKeys(){return keys.filter(function(key){return $input[key][0].options('inputs')[0].options('value')===false;});}
function isEmpty(value){return Ox.isEmpty(value)||Ox.isUndefined(value);}
function selectAll(i){keys.forEach(function(key){var $checkbox=$input[key][1].options('inputs')[0];if(!$checkbox.options('disabled')){if((i==0&&$checkbox.options('value'))||(i==1&&!$checkbox.options('value'))){toggle(key);}}})}
function setSize(data){dialogHeight=data.height;dialogWidth=data.width;formWidth=getFormWidth();Ox.forEach($input,function($inputs,key){$label[key].options({width:formWidth});$inputs.forEach(function($element){$element.options('inputs')[1].options({width:formWidth-80});});});}
function toggle(key){var $checkbox=$input[key][1].options('inputs')[0];if(!$checkbox.options('disabled')){Ox.loop(2,function(i){var value=$input[key][i].options('value');$input[key][i].options({value:[!value[0],value[1]]});})}
updateKeys=getUpdateKeys();updateButtons();}
function updateButtons(){var checked=[0,0];keys.forEach(function(key){var $checkbox=$input[key][1].options('inputs')[0];if(!$checkbox.options('disabled')){checked[$checkbox.options('value')?1:0]++;}});$selectNoneButton.options({disabled:checked[1]==0});$selectAllButton.options({disabled:checked[0]==0})
that[updateKeys.length?'enableButton':'disableButton']('update');}
function updateMetadata(){var edit={id:data.id},type;updateKeys.forEach(function(key){type=key=='alternativeTitles'?[]:Ox.getObjectById(pandora.site.itemKeys,key).type;edit[key]=imdb[key]||(Ox.isArray(type)?[]:'');});that.options({content:Ox.LoadingScreen()}).disableButtons();pandora.api.edit(edit,function(result){that.close();pandora.updateItemContext();pandora.$ui.contentPanel.replaceElement(1,pandora.$ui.item=pandora.ui.item());});}
return that;};'use strict';pandora.ui.mediaView=function(options,self){var self=self||{},that=Ox.Element({},self).defaults({id:''}).options(options||{});self.filesQuery={conditions:[{key:'id',value:self.options.id,operator:'=='}]};self.numberOfItems=0;self.selected=[];self.wasChecked=false;self.$toolbar=Ox.Bar({size:24});self.$menu=Ox.MenuButton({items:[{disabled:true,id:'ignore',title:Ox._('Ignore Selected Files')},{},{disabled:!pandora.site.capabilities.canRemoveItems[pandora.user.level],id:'delete',title:Ox._('Delete {0}...',[Ox._(pandora.site.itemName.singular)])}],title:'set',type:'image'}).css({float:'left',margin:'4px'}).bindEvent({click:function(data){if(data.id=='ignore'){ignoreFiles();}else if(data.id=='delete'){deleteItem();}}}).appendTo(self.$toolbar);self.$saveButton=Ox.Button({disabled:true,title:Ox._('Save Changes'),width:128}).css({float:'right',margin:'4px'}).bindEvent({click:saveChanges}).appendTo(self.$toolbar);self.$filesList=Ox.TableList({columns:[{clickable:function(data){return['uploading','queued','encoding'].indexOf(data.state)==-1;},format:function(value,data){return $('<img>').attr({src:['uploading','queued','encoding','failed'].indexOf(data.state)>-1?Ox.UI.getImageURL('symbol'+{'uploading':'Upload','queued':'Data','encoding':'Sync','failed':'Warning'}[data.state]):data.wanted?Ox.UI.getImageURL('symbolUp'):Ox.UI.getImageURL('symbolCheck')}).css({width:'10px',height:'10px',padding:'3px',opacity:(value||data.wanted)?1:0});},id:'selected',operator:'-',title:Ox._('Status'),titleImage:'check',tooltip:function(data){return['uploading','queued','encoding','failed'].indexOf(data.state)>-1?Ox._({'uploading':'Video is currently uploaded to server','queued':'Waiting for server to process video','encoding':'Processing video on server','failed':'Encoding failed'}[data.state]):data.instances.filter(function(i){return i.ignore;}).length>0?Ox._('Use this file'):Ox._('Dont use this file');},visible:true,width:16},{align:'left',id:'users',operator:'+',title:Ox._('Users'),visible:true,width:60},{align:'left',id:'path',operator:'+',title:Ox._('Path'),visible:true,width:360},{editable:true,id:'version',operator:'+',title:Ox._('Version'),visible:true,width:120},{editable:true,id:'part',operator:'+',title:Ox._('Part'),visible:true,width:60},{editable:true,id:'partTitle',operator:'+',title:Ox._('Part Title'),visible:true,width:120},{editable:true,id:'language',operator:'+',title:Ox._('Language'),visible:true,width:60},{editable:true,id:'extension',operator:'+',title:Ox._('Extension'),visible:true,width:60},{align:'left',id:'type',operator:'+',title:Ox._('Type'),visible:true,width:60},{align:'right',format:{type:'value',args:['B']},id:'size',operator:'-',title:Ox._('Size'),visible:true,width:90},{align:'right',format:{type:'resolution',args:['px']},id:'resolution',operator:'-',title:Ox._('Resolution'),visible:true,width:90},{align:'right',format:{type:'duration',args:[0,'short']},id:'duration',operator:'-',title:Ox._('Duration'),visible:true,width:90},{align:'left',id:'id',operator:'+',title:Ox._('ID'),visible:false,width:120},{align:'left',id:'instances',operator:'+',title:Ox._('Instances'),visible:false,width:120}],columnsMovable:true,columnsRemovable:true,columnsResizable:true,columnsVisible:true,id:'files',items:function(data,callback){pandora.api.findMedia(Ox.extend(data,{query:self.filesQuery}),callback);},keys:['state','instances','wanted','error'],scrollbarVisible:true,sort:[{key:'path',operator:'+'}],unique:'id'}).bindEvent({click:function(data){if(data.key=='selected'){var value=self.$filesList.value(data.id);console.log(data,value);if(value.state=='failed'){var $dialog=Ox.Dialog({buttons:[Ox.Button({id:'close',title:Ox._('Close')}).bindEvent({click:function(){$dialog.close();}})],closeButton:true,content:$('<code>').append($('<pre>').addClass('OxSelectable').css({margin:'16px'}).text(value.error)),height:Math.round((window.innerHeight-48)*0.9),keys:{enter:'close',escape:'close'},maximizeButton:true,removeOnClose:true,title:'Encoding Failed',width:Math.round(window.innerWidth*0.9)}).open();}else{var ignored=self.$filesList.value(data.id,'instances').filter(function(i){return i.ignore;}).length>0;pandora.api.editMedia({files:[{id:data.id,ignore:!ignored}]},function(result){Ox.Request.clearCache();self.$filesList.reloadList();});}}},'delete':function(data){var ids=data.ids.filter(function(id){return self.$filesList.value(id,'instances').length==0;});if(ids.length>0&&pandora.user.level=='admin'){pandora.api.removeMedia({ids:ids},function(result){Ox.Request.clearCache();self.$filesList.reloadList();});}},init:function(data){self.numberOfItems=data.items;},select:selectFiles,submit:function(data){var value=self.$filesList.value(data.id,data.key);if(data.value!=value&&!(data.value===''&&value===null)){self.$saveButton.options({disabled:false});self.$filesList.value(data.id,data.key,data.value||null);}}});self.$instancesList=Ox.TableList({columns:[{align:'left',id:'user',operator:'+',title:Ox._('User'),visible:true,width:120},{align:'left',id:'volume',operator:'+',title:Ox._('Volume'),visible:true,width:120},{align:'left',id:'path',operator:'+',title:Ox._('Path'),visible:true,width:480},],columnsMovable:true,columnsRemovable:true,columnsResizable:true,columnsVisible:true,id:'files',items:[],scrollbarVisible:true,sort:[{key:'user',operator:'+'}],unique:'path'}).bindEvent({open:openFiles});self.$movieLabel=Ox.Label({textAlign:'center',title:Ox._('Move selected files to another {0}',[Ox._(pandora.site.itemName.singular.toLowerCase())]),width:240}).css({margin:'8px'});['title','director','year','id'].forEach(function(key){var itemKey=Ox.getObjectById(pandora.site.itemKeys,key);self['$'+key+'Input']=Ox.Input({label:Ox._(key=='id'?'ID':itemKey?itemKey.title:Ox.toTitleCase(key)),labelWidth:64,width:240}).bindEvent({change:function(data){var conditions,matches;if(key=='id'&&data.value.substr(0,2)!='0x'){if(pandora.site.site.id=='0xdb'){matches=data.value.match(/\d{7}/);}else{matches=data.value.match(/[A-Z]+/);}
data.value=matches?matches[0]:'';self.$idInput.value(data.value);}
if(data.value.length){conditions={};['id','title','director','year'].map(function(key){var value=self['$'+key+'Input'].value();if(value.length){conditions[key]=key=='director'?value.split(', '):value;}});pandora.api.findId(conditions,function(result){var length=result.data.items.length;if(length==0){if(key!='id'){self.$idInput.value('');}}else if(result.data.items.length==1){['title','director','year','id'].forEach(function(key){self['$'+key+'Input'].value(key=='director'?result.data.items[0][key].join(', '):result.data.items[0][key]);});}else{self.$idInput.value('');}});}}});});self.$switch=Ox.Checkbox({title:Ox._('Switch to this {0} after moving files',[Ox._(pandora.site.itemName.singular.toLowerCase())]),value:false,width:240});self.$movieForm=Ox.Form({items:[self.$titleInput,self.$directorInput,self.$yearInput,self.$idInput,self.$switch],width:240}).css({margin:'8px'});self.$clearButton=Ox.Button({title:Ox._('Clear Form'),width:116}).css({margin:'0 4px 4px 8px'}).bindEvent({click:function(){['title','director','year','id'].forEach(function(key){self['$'+key+'Input'].value('');});}});self.$moveButton=Ox.Button({disabled:true,title:Ox._('Move Files'),width:116}).css({margin:'0 4px 4px 4px'}).bindEvent({click:moveFiles});self.$moviePanel=Ox.Element().append(self.$movieLabel).append(self.$movieForm).append(self.$clearButton).append(self.$moveButton);that.setElement(Ox.SplitPanel({elements:[{element:Ox.SplitPanel({elements:[{element:self.$toolbar,size:24},{element:self.$filesList},{element:self.$instancesList,size:80}],orientation:'vertical'})},{collapsible:true,element:self.$moviePanel,size:256}],orientation:'horizontal'}));function deleteItem(data){pandora.api.get({id:pandora.user.ui.item,keys:['id','title']},function(result){pandora.ui.deleteItemDialog(result.data).open();});}
function ignoreFiles(){pandora.api.editMedia({files:self.selected.map(function(id){return{id:id,ignore:true};})},function(result){Ox.Request.clearCache();self.$filesList.reloadList();});}
function moveFiles(data){var data={ids:self.selected,item:self.$idInput.value()};['title','director','year'].forEach(function(key){data[key]=self['$'+key+'Input'].value();});self.$moveButton.options({disabled:true,title:Ox._('Moving Files...')});pandora.api.moveMedia(data,function(result){if(pandora.user.ui.item==self.options.id&&pandora.user.ui.itemView=='media'){Ox.Request.clearCache();if(self.$switch.value()){pandora.UI.set({item:result.data.item});pandora.updateItemContext();}else{self.$filesList.reloadList();self.$instancesList.reloadList();self.$moveButton.options({disabled:false,title:Ox._('Move Files')});}}});}
function openFiles(data){data.ids.length==1&&pandora.api.parsePath({path:self.$instancesList.value(data.ids[0],'path')},function(result){self.$idInput.value('');['title','director','year'].forEach(function(key){if(result.data[key]){self['$'+key+'Input'].value(key=='director'?result.data[key].join(', '):result.data[key]);}});updateForm();self.$titleInput.triggerEvent('change',{value:result.data['title']});});}
function selectFiles(data){self.selected=data.ids;self.$instancesList.options({items:data.ids.length==1?self.$filesList.value(data.ids[0],'instances'):[]});updateForm();}
function saveChanges(){self.$saveButton.options({disabled:true,title:Ox._('Saving Changes...')});pandora.api.findMedia({keys:['id'],query:self.filesQuery},function(result){pandora.api.editMedia({files:result.data.items.map(function(item){['version','part','partTitle','language','extension'].forEach(function(key){Ox.extend(item,key,self.$filesList.value(item.id,key));})
return item;})},function(result){self.$saveButton.options({title:Ox._('Save Changes')});Ox.Request.clearCache();self.$filesList.reloadList();});});}
function updateForm(){if(self.selected.length==self.numberOfItems){self.wasChecked=self.$switch.value();self.$switch.options({disabled:true,value:true});}else{self.$switch.options({disabled:false,value:self.wasChecked});}
self.$moveButton.options({disabled:self.selected.length==0});self.$menu[self.selected.length==0?'disableItem':'enableItem']('ignore');}
that.reload=function(){self.$filesList.reloadList();}
return that;};'use strict';pandora.ui.sectionbar=function(mode,isDragAndDrop){var that=Ox.Bar({size:24}).append(mode=='buttons'?pandora.$ui.sectionButtons=pandora.ui.sectionButtons(isDragAndDrop):pandora.$ui.sectionSelect=pandora.ui.sectionSelect(isDragAndDrop)).bindEvent({doubleclick:function(e){if($(e.target).is('.OxBar')){pandora.$ui.folders.animate({scrollTop:0},250);}}});return that;};'use strict';pandora.ui.leftPanel=function(section){var that=Ox.SplitPanel({elements:[{element:pandora.$ui.sectionbar=pandora.ui.sectionbar('buttons',section),size:24},{element:pandora.$ui.folders=pandora.ui.folders(section)},{collapsed:!pandora.user.ui.showInfo,collapsible:true,element:pandora.$ui.info=pandora.ui.info(),size:pandora.getInfoHeight(true),tooltip:Ox._('info')+' <span class="OxBright">'
+Ox.SYMBOLS.SHIFT+'I</span>'}],id:'leftPanel',orientation:'vertical'}).bindEvent({resize:function(data){pandora.user.ui.sidebarSize=data.size;var infoHeight=pandora.getInfoHeight(true);if(data.size<pandora.site.sectionButtonsWidth&&pandora.$ui.sectionButtons){pandora.$ui.sectionButtons.remove();delete pandora.$ui.sectionButtons;pandora.$ui.sectionbar.append(pandora.$ui.sectionSelect=pandora.ui.sectionSelect(section));}else if(data.size>=pandora.site.sectionButtonsWidth&&pandora.$ui.sectionSelect){pandora.$ui.sectionSelect.remove();delete pandora.$ui.sectionSelect;pandora.$ui.sectionbar.append(pandora.$ui.sectionButtons=pandora.ui.sectionButtons(section));}
pandora.$ui.leftPanel.size(2,infoHeight);!pandora.user.ui.showInfo&&pandora.$ui.leftPanel.css({bottom:-infoHeight+'px'});pandora.resizeFolders();pandora.$ui.info.resizeInfo();},resizeend:function(data){pandora.user.ui.sidebarSize=0;pandora.UI.set({sidebarSize:data.size});},toggle:function(data){pandora.UI.set({showSidebar:!data.collapsed});if(data.collapsed){Ox.forEach(pandora.$ui.folderList,function($list){$list.loseFocus();});}},pandora_showinfo:function(data){data.value==that.options('elements')[2].collapsed&&that.toggle(2);}});return that;};'use strict';pandora.ui.titlesDialog=function(){var height=Math.round((window.innerHeight-48)*0.9),width=512+Ox.UI.SCROLLBAR_SIZE,$findInput=Ox.Input({changeOnKeypress:true,clear:true,placeholder:'Find',width:192}).css({float:'right',margin:'4px'}).bindEvent({change:function(data){var query={conditions:[{key:'title',value:data.value,operator:'='},{key:'sorttitle',value:data.value,operator:'='}],operator:'|'};$list.options({query:query});}}),$list=Ox.TableList({columns:[{id:'id',title:Ox._('ID'),visible:false},{id:'title',operator:'+',removable:false,title:Ox._('Title'),visible:true,width:256},{editable:true,id:'sorttitle',operator:'+',title:Ox._('Sort Title'),visible:true,width:256},],columnsVisible:true,items:pandora.api.findTitles,keys:[],max:1,scrollbarVisible:true,sort:[{key:'sorttitle',operator:'+'}],unique:'id'}).bindEvent({init:function(data){$status.html(Ox.toTitleCase(Ox.formatCount(data.items,'title')));},open:function(data){$list.find('.OxItem.OxSelected > .OxCell.OxColumnSorttitle').trigger('mousedown').trigger('mouseup');},select:function(data){$findButton.options({disabled:!data.ids.length});},submit:function(data){Ox.Request.clearCache('findTitles');pandora.api.editTitle({id:data.id,sorttitle:data.value});}}),$findButton=Ox.Button({disabled:true,title:Ox._('Find'),width:48}).bindEvent({click:function(){that.close();pandora.UI.set({find:{conditions:[{key:'title',value:$list.value($list.options('selected'),'title'),operator:'='}],operator:'&'}});pandora.$ui.findElement.updateElement();}}),that=Ox.Dialog({buttons:[Ox.Button({title:Ox._('Manage Names...')}).bindEvent({click:function(){that.close();(pandora.$ui.namesDialog||(pandora.$ui.namesDialog=pandora.ui.namesDialog())).open();}}),{},$findButton,Ox.Button({title:Ox._('Done'),width:48}).bindEvent({click:function(){that.close();}})],closeButton:true,content:Ox.SplitPanel({elements:[{element:Ox.Bar({size:24}).append($status).append($findInput),size:24},{element:$list}],orientation:'vertical'}),height:height,maximizeButton:true,minHeight:256,minWidth:512,padding:0,title:Ox._('Manage Titles'),width:width}).bindEvent({resizeend:function(data){var width=(data.width-Ox.UI.SCROLLBAR_SIZE)/2;[{id:'title',width:Math.ceil(width)},{id:'sorttitle',width:Math.floor(width)}].forEach(function(column){$list.resizeColumn(column.id,column.width);});}}),$status=$('<div>').css({position:'absolute',top:'4px',left:'128px',right:'128px',bottom:'4px',paddingTop:'2px',fontSize:'9px',textAlign:'center'}).appendTo(that.find('.OxButtonsbar'));return that;};'use strict';pandora.ui.allItems=function(section){section=section||pandora.user.ui.section;var canAddItems=!pandora.site.itemRequiresVideo&&pandora.site.capabilities.canAddItems[pandora.user.level],canUploadVideo=pandora.site.capabilities.canAddItems[pandora.user.level],that=Ox.Element().addClass('OxSelectableElement'+(pandora.user.ui._list?'':' OxSelected')).css({height:'16px',cursor:'default',overflow:'hidden'}).on({click:function(){that.gainFocus();if(section=='items'){pandora.user.ui._list&&pandora.UI.set({find:{conditions:[],operator:'&'}});}else{pandora.UI.set(section.slice(0,-1),'');}}}).bindEvent({pandora_edit:updateSelected,pandora_find:updateSelected,pandora_section:updateSelected,pandora_text:updateSelected}),$icon=$('<img>').attr({src:'/static/png/icon.png'}).css({float:'left',width:'14px',height:'14px',margin:'1px'}).appendTo(that),$name=$('<div>').css({float:'left',height:'14px',margin:'1px 4px 1px 3px',textOverflow:'ellipsis',overflow:'hidden',whiteSpace:'nowrap'}).html(pandora.getAllItemsTitle(section)).appendTo(that),$items,$buttons=[];if(section=='items'){$items=$('<div>').css({float:'left',width:'42px',margin:'1px 4px 1px 3px',textAlign:'right'}).appendTo(that);$buttons[0]=Ox.Button({style:'symbol',title:'add',tooltip:canAddItems?Ox._('Add {0}',[Ox._(pandora.site.itemName.singular)]):'',type:'image'}).css({opacity:canAddItems?1:0.25}).hide().bindEvent({click:pandora.addItem}).appendTo(that);$buttons[1]=Ox.Button({style:'symbol',title:'upload',tooltip:canUploadVideo?Ox._('Upload Video...'):'',type:'image'}).css({opacity:canUploadVideo?1:0.25}).hide().bindEvent({click:function(){pandora.$ui.uploadVideoDialog=pandora.ui.uploadVideoDialog().open();}}).appendTo(that);pandora.api.find({query:{conditions:[],operator:'&'}},function(result){that.update(result.data.items);});}else if(section=='edits'){}else if(section=='texts'){$buttons[0]=Ox.Button({style:'symbol',title:'file',tooltip:Ox._('HTML'),type:'image'}).hide().appendTo(that);$buttons[1]=Ox.Button({style:'symbol',title:'help',tooltip:Ox._('Help'),type:'image'}).hide().bindEvent({click:function(){pandora.UI.set({page:'help'});}}).appendTo(that);}
updateSelected();function updateSelected(){that[(section=='items'&&pandora.user.ui._list)||(section=='edits'&&pandora.user.ui.edit)||(section=='texts'&&pandora.user.ui.text)?'removeClass':'addClass']('OxSelected');}
that.update=function(items){$items&&$items.html(Ox.formatNumber(items));};that.resizeElement=function(width){$name.css({width:width+'px'});$buttons.forEach(function($button){$button.show();});};return that;};'use strict';pandora.ui.infoView=function(data){var ui=pandora.user.ui,descriptions=[],canEdit=pandora.site.capabilities.canEditMetadata[pandora.user.level]||data.editable,canRemove=pandora.site.capabilities.canRemoveItems[pandora.user.level],css={marginTop:'4px',textAlign:'justify'},html,iconRatio=ui.icons=='posters'?data.posterRatio:1,iconSize=ui.infoIconSize,iconWidth=iconRatio>1?iconSize:Math.round(iconSize*iconRatio),iconHeight=iconRatio<1?iconSize:Math.round(iconSize/iconRatio),iconLeft=iconSize==256?Math.floor((iconSize-iconWidth)/2):0,borderRadius=ui.icons=='posters'?0:iconSize/8,margin=16,nameKeys=['director'],listKeys=nameKeys.concat(['country','groups']),statisticsWidth=128,$bar=Ox.Bar({size:16}).bindEvent({doubleclick:function(e){if($(e.target).is('.OxBar')){$info.animate({scrollTop:0},250);}}}),$options=Ox.MenuButton({items:[{id:'delete',title:Ox._('Delete {0}...',[pandora.site.itemName.singular]),disabled:!canRemove}],style:'square',title:'set',tooltip:Ox._('Options'),type:'image',}).css({float:'left',borderColor:'rgba(0, 0, 0, 0)',background:'rgba(0, 0, 0, 0)'}).bindEvent({click:function(data_){if(data_.id=='delete'){pandora.$ui.deleteItemDialog=pandora.ui.deleteItemDialog(data).open();}}}).appendTo($bar),$edit=Ox.MenuButton({items:[{id:'insert',title:Ox._('Insert HTML...'),disabled:true}],style:'square',title:'edit',tooltip:Ox._('Edit'),type:'image',}).css({float:'right',borderColor:'rgba(0, 0, 0, 0)',background:'rgba(0, 0, 0, 0)'}).bindEvent({click:function(data){}}).appendTo($bar),$info=Ox.Element().css({overflowY:'auto'}),that=Ox.SplitPanel({elements:[{element:$bar,size:16},{element:$info}],orientation:'vertical'}),$icon=Ox.Element({element:'<img>',}).attr({src:'/'+data.id+'/'+(ui.icons=='posters'?'poster':'icon')+'512.jpg?'+data.modified}).css({position:'absolute',left:margin+iconLeft+'px',top:margin+'px',width:iconWidth+'px',height:iconHeight+'px',borderRadius:borderRadius+'px',cursor:'pointer'}).bindEvent({singleclick:toggleIconSize}).appendTo($info),$reflection=$('<div>').addClass('OxReflection').css({position:'absolute',left:margin+'px',top:margin+iconHeight+'px',width:iconSize+'px',height:iconSize/2+'px',overflow:'hidden'}).appendTo($info),$reflectionIcon=$('<img>').attr({src:'/'+data.id+'/'+(ui.icons=='posters'?'poster':'icon')+'512.jpg?'+data.modified}).css({position:'absolute',left:iconLeft+'px',width:iconWidth+'px',height:iconHeight+'px',borderRadius:borderRadius+'px'}).appendTo($reflection),$reflectionGradient=$('<div>').css({position:'absolute',width:iconSize+'px',height:iconSize/2+'px'}).appendTo($reflection),$text=Ox.Element().addClass('OxTextPage').css({position:'absolute',left:margin+(iconSize==256?256:iconWidth)+margin+'px',top:margin+'px',right:margin+statisticsWidth+margin+'px',}).appendTo($info),$statistics=$('<div>').css({position:'absolute',width:statisticsWidth+'px',top:margin+'px',right:margin+'px'}).appendTo($info),$capabilities;[$options,$edit].forEach(function($element){$element.find('input').css({borderWidth:0,borderRadius:0,padding:'3px'});});if(!canEdit){pandora.createLinks($info);}
$('<div>').css({marginTop:'-2px',}).append(Ox.EditableContent({editable:canEdit,tooltip:canEdit?pandora.getEditTooltip():'',value:data.title||''}).css({marginBottom:'-3px',fontWeight:'bold',fontSize:'13px'}).bindEvent({submit:function(event){editMetadata('title',event.value);}})).appendTo($text);renderGroup(['director','year','country']);if(canEdit||data.summary){$('<div>').append(Ox.EditableContent({clickLink:pandora.clickLink,editable:canEdit,format:function(value){return value.replace(/<img src=/g,'<img style="float: left; max-width: 256px; max-height: 256px; margin: 0 16px 16px 0" src=');},maxHeight:Infinity,placeholder:formatLight(Ox._('No Summary')),tooltip:canEdit?pandora.getEditTooltip():'',type:'textarea',value:data.summary||''}).css(css).css({marginTop:'12px',overflow:'hidden'}).bindEvent({submit:function(event){editMetadata('summary',event.value);}})).appendTo($text);}
['duration','aspectratio'].forEach(function(key){var itemKey=Ox.getObjectById(pandora.site.itemKeys,key),value=data[key]||0;$('<div>').css({marginBottom:'4px'}).append(formatKey(itemKey.title,'statistics')).append(Ox.Theme.formatColor(null,'gradient').css({textAlign:'right'}).html(Ox['format'+Ox.toTitleCase(itemKey.format.type)].apply(null,[value].concat(itemKey.format.args)))).appendTo($statistics);});['hue','saturation','lightness','volume'].forEach(function(key){$('<div>').css({marginBottom:'4px'}).append(formatKey(key,'statistics')).append(Ox.Theme.formatColor(data[key]||0,key=='volume'?'lightness':key).css({textAlign:'right'})).appendTo($statistics);});$('<div>').css({marginBottom:'4px'}).append(formatKey('cuts per minute','statistics')).append(Ox.Theme.formatColor(null,'gradient').css({textAlign:'right'}).html(Ox.formatNumber(data['cutsperminute']||0,3))).appendTo($statistics);var $rightsLevel=$('<div>');$('<div>').css({marginBottom:'4px'}).append(formatKey('Rights Level','statistics')).append($rightsLevel).appendTo($statistics);renderRightsLevel();if(canEdit){$('<div>').css({marginBottom:'4px'}).append(formatKey('Notes','statistics').options({tooltip:Ox._('Only {0} can see and edit these comments',[Object.keys(pandora.site.capabilities.canEditMetadata).map(function(level,i){return(i==0?'':i<Ox.len(pandora.site.capabilities.canEditMetadata)-1?', ':' '+Ox._('and')+' ')+Ox.toTitleCase(level)}).join('')])})).append(Ox.EditableContent({height:128,placeholder:formatLight(Ox._('No notes')),tooltip:pandora.getEditTooltip(),type:'textarea',value:data.notes||'',width:128}).bindEvent({submit:function(event){editMetadata('notes',event.value);}})).appendTo($statistics);}
$('<div>').css({height:'16px'}).appendTo($statistics);function editMetadata(key,value){if(value!=data[key]){var edit={id:data.id};if(key=='title'){edit[key]=value;}else if(listKeys.indexOf(key)>=0){edit[key]=value?value.split(', '):[];}else{edit[key]=value?value:null;}
pandora.api.edit(edit,function(result){var src;data[key]=result.data[key];descriptions[key]&&descriptions[key].options({value:result.data[key+'description']});Ox.Request.clearCache();if(result.data.id!=data.id){pandora.UI.set({item:result.data.id});pandora.$ui.browser.value(data.id,'id',result.data.id);}
pandora.updateItemContext();pandora.$ui.browser.value(result.data.id,key,result.data[key]);pandora.$ui.itemTitle.options({title:'<b>'+result.data.title
+(Ox.len(result.data.director)?' ('+result.data.director.join(', ')+')':'')
+(result.data.year?' '+result.data.year:'')+'</b>'});if(Ox.contains(['title','director','year'],key)&&ui.icons=='posters'){src='/'+data.id+'/poster512.jpg?'+Ox.uid()
$icon.attr({src:src});$reflectionIcon.attr({src:src});}});}}
function formatKey(key,mode){var item=Ox.getObjectById(pandora.site.itemKeys,key);key=Ox._(item?item.title:key);mode=mode||'text';return mode=='text'?'<span style="font-weight: bold">'+Ox.toTitleCase(key)+':</span> ':mode=='description'?Ox.toTitleCase(key):Ox.Element().css({marginBottom:'4px',fontWeight:'bold'}).html(Ox.toTitleCase(key).replace(' Per ',' per '));}
function formatLight(str){return'<span class="OxLight">'+str+'</span>';}
function formatLink(value,key){return(Ox.isArray(value)?value:[value]).map(function(value){return key?'<a href="/'+key+'='+value+'">'+value+'</a>':value;}).join(', ');}
function formatValue(key,value){var ret;if(key=='year'){ret=formatLink(value,'year');}else if(nameKeys.indexOf(key)>-1){ret=formatLink(value.split(', '),'name');}else if(listKeys.indexOf(key)>-1){ret=formatLink(value.split(', '),key);}else{ret=value;}
return ret;}
function getRightsLevelElement(rightsLevel){return Ox.Theme.formatColorLevel(rightsLevel,pandora.site.rightsLevels.map(function(rightsLevel){return rightsLevel.name;}));}
function getValue(key,value){return!value?'':Ox.contains(listKeys,key)?value.join(', '):value;}
function renderCapabilities(rightsLevel){var capabilities=[].concat(canEdit?[{name:'canSeeItem',symbol:'Find'}]:[],[{name:'canPlayClips',symbol:'PlayInToOut'},{name:'canPlayVideo',symbol:'Play'},{name:'canDownloadVideo',symbol:'Download'}]),userLevels=canEdit?pandora.site.userLevels:[pandora.user.level];$capabilities.empty();userLevels.forEach(function(userLevel,i){var $element,$line=$('<div>').css({height:'16px',marginBottom:'4px'}).appendTo($capabilities);if(canEdit){$element=Ox.Theme.formatColorLevel(i,userLevels.map(function(userLevel){return Ox.toTitleCase(userLevel);}),[0,240]);Ox.Label({textAlign:'center',title:Ox.toTitleCase(userLevel),width:60}).addClass('OxColor OxColorGradient').css({float:'left',height:'12px',paddingTop:'2px',background:$element.css('background'),fontSize:'8px',color:$element.css('color')}).data({OxColor:$element.data('OxColor')}).appendTo($line);}
capabilities.forEach(function(capability){var hasCapability=pandora.site.capabilities[capability.name][userLevel]>=rightsLevel,$element=Ox.Theme.formatColorLevel(hasCapability,['','']);Ox.Button({tooltip:(canEdit?Ox.toTitleCase(userLevel):'You')+' '
+(hasCapability?'can':'can\'t')+' '
+Ox.toSlashes(capability.name).split('/').slice(1).join(' ').toLowerCase(),title:capability.symbol,type:'image'}).addClass('OxColor OxColorGradient').css({background:$element.css('background')}).css('margin'+(canEdit?'Left':'Right'),'4px').data({OxColor:$element.data('OxColor')}).appendTo($line);});if(!canEdit){Ox.Button({title:Ox._('Help'),tooltip:Ox._('About Rights'),type:'image'}).css({marginLeft:'52px'}).bindEvent({click:function(){pandora.UI.set({page:'rights'});}}).appendTo($line);}});}
function renderGroup(keys){var $element;if(canEdit||keys.filter(function(key){return data[key];}).length){$element=$('<div>').addClass('OxSelectable').css(css);keys.forEach(function(key,i){if(canEdit||data[key]){if($element.children().length){$('<span>').html('; ').appendTo($element);}
$('<span>').html(formatKey(key)).appendTo($element);Ox.EditableContent({clickLink:pandora.clickLink,format:function(value){return formatValue(key,value);},placeholder:formatLight('unknown'),tooltip:canEdit?pandora.getEditTooltip():'',value:getValue(key,data[key])}).bindEvent({submit:function(data){editMetadata(key,data.value);}}).appendTo($element);}});$element.appendTo($text);}}
function renderRightsLevel(){var $rightsLevelElement=getRightsLevelElement(data.rightslevel),$rightsLevelSelect;$rightsLevel.empty();if(canEdit){$rightsLevelSelect=Ox.Select({items:pandora.site.rightsLevels.map(function(rightsLevel,i){return{id:i,title:rightsLevel.name};}),width:128,value:data.rightslevel}).addClass('OxColor OxColorGradient').css({marginBottom:'4px',background:$rightsLevelElement.css('background')}).data({OxColor:$rightsLevelElement.data('OxColor')}).bindEvent({change:function(event){var rightsLevel=event.value;$rightsLevelElement=getRightsLevelElement(rightsLevel);$rightsLevelSelect.css({background:$rightsLevelElement.css('background')}).data({OxColor:$rightsLevelElement.data('OxColor')})
renderCapabilities(rightsLevel);pandora.api.edit({id:data.id,rightslevel:rightsLevel},function(result){});}}).appendTo($rightsLevel);}else{$rightsLevelElement.css({marginBottom:'4px'}).appendTo($rightsLevel);}
$capabilities=$('<div>').appendTo($rightsLevel);renderCapabilities(data.rightslevel);}
function toggleIconSize(){iconSize=iconSize==256?512:256;iconWidth=iconRatio>1?iconSize:Math.round(iconSize*iconRatio);iconHeight=iconRatio<1?iconSize:Math.round(iconSize/iconRatio);iconLeft=iconSize==256?Math.floor((iconSize-iconWidth)/2):0,borderRadius=ui.icons=='posters'?0:iconSize/8;$icon.animate({left:margin+iconLeft+'px',width:iconWidth+'px',height:iconHeight+'px',borderRadius:borderRadius+'px'},250);$reflection.animate({top:margin+iconHeight+'px',width:iconSize+'px',height:iconSize/2+'px'},250);$reflectionIcon.animate({left:iconLeft+'px',width:iconWidth+'px',height:iconHeight+'px',borderRadius:borderRadius+'px'},250);$reflectionGradient.animate({width:iconSize+'px',height:iconSize/2+'px'},250);$text.animate({left:margin+(iconSize==256?256:iconWidth)+margin+'px',},250);pandora.UI.set({infoIconSize:iconSize});}
that.reload=function(){var src=src='/'+data.id+'/'+(ui.icons=='posters'?'poster':'icon')+'512.jpg?'+Ox.uid();$icon.attr({src:src});$reflectionIcon.attr({src:src});iconSize=iconSize==256?512:256;iconRatio=ui.icons=='posters'?(ui.showSitePosters?pandora.site.posters.ratio:data.posterRatio):1;toggleIconSize();};that.bindEvent({pandora_icons:that.reload,pandora_showsiteposters:function(){ui.icons=='posters'&&that.reload();}});return that;};'use strict';pandora.ui.editPanel=function(){var ui=pandora.user.ui,edit,listSizes=[144+Ox.UI.SCROLLBAR_SIZE,280+Ox.UI.SCROLLBAR_SIZE,416+Ox.UI.SCROLLBAR_SIZE],listSize=listSizes[ui.clipColumns],smallTimelineCanvas,smallTimelineContext,that=Ox.Element();ui.edit?getEdit(renderEdit):renderEdits();function editsKey(key){return'edits.'+ui.edit.replace(/\./g,'\\.')+'.'+key;}
function enableDragAndDrop(){pandora.enableDragAndDrop(Ox.UI.elements[that.find('.OxIconList').data('oxid')],edit.editable);}
function getClips(ids){return ids.map(function(id){return Ox.getObjectById(edit.clips,id);});}
function getEdit(callback){pandora.api.getEdit({id:ui.edit},function(result){edit=result.data;edit.duration=0;edit.clips.forEach(function(clip){clip.position=edit.duration;edit.duration+=clip.duration;});callback();});}
function getSmallTimelineCanvas(){var fps=getSmallTimelineFPS(),width=Math.ceil(edit.duration*fps),height=fps==1?16:64;return Ox.$('<canvas>').attr({width:width,height:height})[0];}
function getSmallTimelineFPS(){return Math.floor(edit.duration*25)<32768?25:1;}
function getSmallTimelineURL(){var fps=getSmallTimelineFPS(),width=Math.ceil(edit.duration*fps),height=fps==1?16:64;smallTimelineCanvas=Ox.$('<canvas>').attr({width:width,height:height})[0];smallTimelineContext=smallTimelineCanvas.getContext('2d');return smallTimelineCanvas.toDataURL();}
function getVideos(){var videos={};pandora.site.video.resolutions.forEach(function(resolution){videos[resolution]=Ox.flatten(edit.clips.map(function(clip){return pandora.getClipVideos(clip,resolution);}));});return videos;}
function renderEdit(){that=pandora.$ui.editPanel=Ox.VideoEditPanel({clips:Ox.clone(edit.clips),clipSize:listSize,clipSort:ui.edits[ui.edit].sort,clipSortOptions:[],clipTooltip:'clips <span class="OxBright">'+Ox.SYMBOLS.SHIFT+'C</span>',clipView:ui.edits[ui.edit].view,duration:edit.duration,editable:edit.editable,enableSubtitles:ui.videoSubtitles,fullscreen:false,getClipImageURL:function(id,width,height){var clip=Ox.getObjectById(edit.clips,id);return'/'+clip.item+'/'+height+'p'+clip['in']+'.jpg';},getLargeTimelineURL:function(type,i,callback){pandora.getLargeEditTimelineURL(edit,type,i,callback);},height:pandora.$ui.appPanel.size(1),'in':ui.edits[ui.edit]['in'],loop:ui.videoLoop,muted:ui.videoMuted,out:ui.edits[ui.edit].out,position:ui.edits[ui.edit].position,resolution:ui.videoResolution,scaleToFill:ui.videoScale=='fill',selected:ui.edits[ui.edit].selection,showClips:ui.showClips,showTimeline:ui.showTimeline,smallTimelineURL:getSmallTimelineURL(),sort:ui.edits[ui.edit].sort,sortOptions:[{id:'index',title:Ox._('Sort Manually'),operator:'+'}].concat(pandora.site.clipKeys.map(function(key){return Ox.extend(Ox.clone(key),{title:Ox._(('Sort by Clip {0}'),[Ox._(key.title)])});})).concat(pandora.site.sortKeys.map(function(key){return Ox.extend(Ox.clone(key),{title:Ox._('Sort by {0}',[Ox._(key.title)])});})),timeline:ui.videoTimeline,timelineTooltip:'timeline <span class="OxBright">'+Ox.SYMBOLS.SHIFT+'T</span>',video:getVideos(),volume:ui.videoVolume,width:pandora.$ui.document.width()-pandora.$ui.mainPanel.size(0)-1}).bindEvent({copy:function(data){pandora.clipboard.copy(serializeClips(data.ids),'clip');},copyadd:function(data){pandora.clipboard.add(serializeClips(data.ids),'clip');},cut:function(data){var clips=serializeClips(data.ids);pandora.clipboard.copy(clips,'clip');pandora.doHistory('cut',clips,ui.edit,function(result){Ox.Request.clearCache('getEdit');updateClips(result.data.clips);});},cutadd:function(data){var clips=serializeClips(data.ids);pandora.clipboard.add(clips,'clip');pandora.doHistory('cut',clips,ui.edit,function(result){Ox.Request.clearCache('getEdit');updateClips(result.data.clips);});},'delete':function(data){var clips=serializeClips(data.ids);pandora.doHistory('delete',clips,ui.edit,function(result){Ox.Request.clearCache('getEdit');updateClips(result.data.clips);});},edit:function(data){var args={id:data.id},index=Ox.getIndexById(edit.clips,data.id),clip=edit.clips[index];if(data.key=='duration'){data.key='out';data.value+=clip['in'];}
pandora.api.get({id:clip.item,keys:['duration']},function(result){var clips;if(data.key=='out'){data.value=Math.min(data.value,result.data.duration);}
clips=serializeClips([data.id]).concat(serializeClips([{id:data.id,'in':data.key=='in'?data.value:clip['in'],item:clip.item,out:data.key=='out'?data.value:clip.out}]));pandora.doHistory('edit',clips,ui.edit,function(result){if(result.status.code==200){edit.clips[index]=result.data;that.updateClip(data.id,result.data);updateVideos();}else{Ox.print('failed to edit clip',result);}});});},join:function(data){var clips=[serializeClips(data.ids),serializeClips(data.join)];pandora.doHistory('join',clips,ui.edit,function(result){updateClips(edit.clips.filter(function(clip){return!Ox.contains(data.ids,clip.id);}).concat(result.data.clips));});},loop:function(data){pandora.UI.set({videoLoop:data.loop});},move:function(data){pandora.api.orderClips({edit:edit.id,ids:data.ids},function(result){Ox.Request.clearCache('getEdit');orderClips(data.ids);});},muted:function(data){pandora.UI.set({videoMuted:data.muted});},open:function(data){pandora.UI.set(editsKey('clip'),data.ids[0]);},paste:function(){var clips=pandora.clipboard.paste();pandora.doHistory('paste',clips,ui.edit,function(result){Ox.Request.clearCache('getEdit');updateClips(edit.clips.concat(result.data.clips));});},playing:function(data){var set={};set[editsKey('clip')]='';set[editsKey('position')]=data.position;pandora.UI.set(set);},position:function(data){var set={};set[editsKey('clip')]='';set[editsKey('position')]=data.position;pandora.UI.set(set);},resize:function(data){that.options({width:data.size});},resizeclips:function(data){pandora.UI.set({clipsSize:data.clipsSize});},resolution:function(data){pandora.UI.set({videoResolution:data.resolution});},scale:function(data){pandora.UI.set({videoScale:data.scale});},select:function(data){pandora.UI.set(editsKey('selection'),data.ids);},size:function(data){pandora.UI.set({clipSize:data.size});},sort:function(data){pandora.UI.set(editsKey('sort'),data);var key=data[0].key;if(key=='position'){key='in';}
if(['id','index','in','out','duration','title','director','year','videoRatio'].indexOf(key)>-1){edit.clips=Ox.sortBy(edit.clips,key);if(data[0].operator=='-'){edit.clips.reverse();}
updateClips(edit.clips);}else{pandora.api.sortClips({edit:edit.id,sort:data},function(result){edit.clips.forEach(function(clip){clip['sort']=result.data.clips.indexOf(clip.id);});edit.clips=Ox.sortBy(edit.clips,'sort');updateClips(edit.clips);});}},split:function(data){var clips=[serializeClips(data.ids),serializeClips(data.split)];pandora.doHistory('split',clips,ui.edit,function(result){updateClips(edit.clips.filter(function(clip){return!Ox.contains(data.ids,clip.id);}).concat(result.data.clips));});},subtitles:function(data){pandora.UI.set({videoSubtitles:data.subtitles});},timeline:function(data){pandora.UI.set({videoTimeline:data.timeline});},toggleclips:function(data){pandora.UI.set({showClips:data.showClips});},toggletimeline:function(data){pandora.UI.set({showTimeline:data.showTimeline});},view:function(data){pandora.UI.set(editsKey('view'),data.view);data.view=='grid'&&enableDragAndDrop();},volume:function(data){pandora.UI.set({videoVolume:data.volume});},pandora_showclips:function(data){that.options({showClips:data.value});},pandora_showtimeline:function(data){that.options({showTimeline:data.value});},pandora_videotimeline:function(data){that.options({timeline:data.value});}});that.updatePanel=function(){Ox.Request.clearCache('getEdit');getEdit(updateClips);};pandora.$ui.mainPanel.replaceElement(1,that);updateSmallTimelineURL();ui.edits[ui.edit].view=='grid'&&enableDragAndDrop();}
function renderEdits(){that=Ox.IconList({borderRadius:16,defaultRatio:1,draggable:true,item:function(data,sort,size){size=size||128;var ui=pandora.user.ui,url='/edit/'+data.id+'/icon'+size+'.jpg?'+data.modified,info=Ox.formatDuration(data.duration);return{height:size,id:data.id,title:data.name,info:info,url:url,width:size,};},items:function(data,callback){pandora.api.findEdits(data,callback);return Ox.clone(data,true);},keys:['id','modified','name','duration'],size:128,sort:[{key:'id',operator:'+'}],unique:'id'}).addClass('OxMedia').bindEvent({open:function(data){pandora.UI.set('edit',data.ids[0]);}});}
function orderClips(ids){edit.clips.forEach(function(clip){clip.index=ids.indexOf(clip.id);});edit.clips=Ox.sortBy(edit.clips,'index');updateVideos();}
function serializeClips(clips){return clips.map(function(clip){if(Ox.isString(clip)){clip=Ox.getObjectById(edit.clips,clip);}
return(clip.annotation||clip.item+'/'+clip['in']+'-'+clip.out)+'/'+(clip.id||'');});}
function updateClips(clips){clips=clips||edit.clips;edit.clips=clips;edit.duration=0;edit.clips.forEach(function(clip){clip.position=edit.duration;edit.duration+=clip.duration;});that.options({clips:Ox.clone(edit.clips),duration:edit.duration,smallTimelineURL:getSmallTimelineURL(),video:getVideos()});updateSmallTimelineURL();}
function updateSmallTimelineURL(){var canvas=getSmallTimelineCanvas(),context=canvas.getContext('2d'),fps=getSmallTimelineFPS();Ox.serialForEach(edit.clips,function(clip){var callback=Ox.last(arguments);pandora[fps==1?'getSmallClipTimelineURL':'getLargeClipTimelineURL'](clip.item,clip['in'],clip.out,ui.videoTimeline,function(url){var image=Ox.$('<img>').on({load:function(){context.drawImage(image,Math.floor(clip.position*fps),0);that.options({smallTimelineURL:canvas.toDataURL()});callback();}}).attr({src:url})[0];});});}
function updateVideos(){edit.duration=0;edit.clips.forEach(function(clip){clip.position=edit.duration;edit.duration+=clip.duration;});that.options({duration:edit.duration,smallTimelineURL:getSmallTimelineURL(),video:getVideos()});updateSmallTimelineURL();}
return that;};'use strict';pandora.addItem=function(){pandora.api.add(function(result){Ox.Request.clearCache('find');pandora.UI.set({item:result.data.id,itemView:'info'});});};pandora.addEdit=function(options){var $folderList=pandora.$ui.folderList.personal;options=options||{};pandora.api.addEdit(options,function(result){reloadFolder(result.data.id);});function reloadFolder(newId){pandora.$ui.folder[0].options({collapsed:false});Ox.Request.clearCache('findEdits');$folderList.bindEventOnce({load:function(data){$folderList.gainFocus().options({selected:[newId]}).editCell(newId,'name',true);pandora.UI.set(pandora.user.ui.section.slice(0,-1),newId);}}).reloadList();}};pandora.addList=function(){var $folderList=pandora.$ui.folderList.personal,isDuplicate=arguments.length==1,isSmart,isFrom,list,listData,data;if(!isDuplicate){isSmart=arguments[0];isFrom=arguments[1];data={name:Ox._('Untitled'),status:'private',type:!isSmart?'static':'smart'};if(isFrom){if(!isSmart){data.items=pandora.user.ui.listSelection;}else{data.query=pandora.user.ui.find;}}
addList();}else{list=arguments[0];listData=pandora.getListData();data={name:listData.name,status:listData.status,type:listData.type};if(data.type=='smart'){data.query=listData.query;}
pandora.api.findLists({query:{conditions:[{key:'id',value:list,operator:'=='}]},keys:['description']},function(result){data.description=result.data.items[0].description;if(data.type=='static'){var query={conditions:[{key:'list',value:list,operator:'=='}],operator:'&'};pandora.api.find({query:query},function(result){if(result.data.items){pandora.api.find({query:query,keys:['id'],sort:[{key:'id',operator:''}],range:[0,result.data.items]},function(result){var items=result.data.items.map(function(item){return item.id;});addList(items);});}else{addList();}});}else{addList();}});}
function addList(items){pandora.api.addList(data,function(result){var newList=result.data.id;if(items){pandora.api.addListItems({list:newList,items:items},function(){getPosterFrames(newList);});}else{getPosterFrames(newList);}});}
function getPosterFrames(newList){var sortKey=Ox.getObjectById(pandora.site.itemKeys,'votes')?'votes':'timesaccessed';if(!isDuplicate){pandora.api.find({query:{conditions:[{key:'list',value:newList,operator:'=='}],operator:'&'},keys:['id','posterFrame'],sort:[{key:sortKey,operator:''}],range:[0,4]},function(result){var posterFrames=result.data.items.map(function(item){return{item:item.id,position:item.posterFrame};});posterFrames=posterFrames.length==1?Ox.repeat([posterFrames[0]],4):posterFrames.length==2?[posterFrames[0],posterFrames[1],posterFrames[1],posterFrames[0]]:posterFrames.length==3?[posterFrames[0],posterFrames[1],posterFrames[2],posterFrames[0]]:posterFrames;setPosterFrames(newList,posterFrames);})}else{pandora.api.findLists({query:{conditions:[{key:'id',value:list,operator:'=='}],operator:'&'},keys:['posterFrames']},function(result){setPosterFrames(newList,result.data.items[0].posterFrames);});}}
function setPosterFrames(newList,posterFrames){pandora.api.editList({id:newList,posterFrames:posterFrames},function(){reloadFolder(newList);});}
function reloadFolder(newList){pandora.$ui.folder[0].options({collapsed:false});Ox.Request.clearCache('findLists');$folderList.bindEventOnce({load:function(){$folderList.gainFocus().options({selected:[newList]}).editCell(newList,'name',true);pandora.UI.set({find:{conditions:[{key:'list',value:newList,operator:'=='}],operator:'&'}});}}).reloadList();}};pandora.addText=function(options){var $folderList=pandora.$ui.folderList.personal;options=options||{};pandora.api.addText(options,function(result){reloadFolder(result.data.id);});function reloadFolder(newId){pandora.$ui.folder[0].options({collapsed:false});Ox.Request.clearCache('findTexts');$folderList.bindEventOnce({load:function(data){$folderList.gainFocus().options({selected:[newId]}).editCell(newId,'name',true);pandora.UI.set(pandora.user.ui.section.slice(0,-1),newId);}}).reloadList();}}
pandora.beforeUnloadWindow=function(){if(pandora.firefogg)
return Ox._("Encoding is currently running\nDo you want to leave this page?");pandora.isUnloading=true;};pandora.changeFolderItemStatus=function(id,status,callback){var ui=pandora.user.ui,folderItems=ui.section=='items'?'Lists':Ox.toTitleCase(ui.section),folderItem=folderItems.slice(0,-1);if(status=='private'){pandora.api['find'+folderItems]({query:{conditions:[{key:'id',value:id,operator:'=='}]},keys:['name','subscribers']},function(result){var name=result.data.items[0].name,subscribers=result.data.items[0].subscribers;if(subscribers){pandora.ui.makeListPrivateDialog(name,subscribers,function(makePrivate){if(makePrivate){changeListStatus();}else{callback({data:{id:id,status:'public'}});}}).open();}else{changeFolderItemStatus();}});}else{changeFolderItemStatus();}
function changeFolderItemStatus(){pandora.api['edit'+folderItem]({id:id,status:status},callback);}};pandora.clickLink=function(e){var match=e.target.id.match(/^embed(\d+)$/)
if(match){pandora.$ui.textPanel.selectEmbed(parseInt(match[1]));}else if(e.target.hostname==document.location.hostname&&!Ox.startsWith(e.target.pathname,'/static')){if(pandora.$ui.home&&e.target.pathname!='/home'){pandora.$ui.home.fadeOutScreen();}
pandora.URL.push(e.target.pathname,true);}else{window.open('/url='+encodeURIComponent(e.target.href),'_blank');}};pandora.createLinks=function($element){function isExternalLink(target){return target.hostname!=document.location.hostname||Ox.startsWith(target.pathname,'/static');}$element.on({click:function(e){var $target=$(e.target);if($target.is('a')&&!$($target.parent()).is('.OxEditable')&&!$($target.parent()).is('.OxEditableContent')){e.preventDefault();if(isExternalLink(e.target)){window.open('/url='+encodeURIComponent(e.target.href),'_blank');}else{pandora.clickLink(e);}}
return false;}});};(function(){pandora.doHistory=function(action,items,targets,callback){items=Ox.makeArray(items);targets=Ox.makeArray(targets);if(action=='copy'||action=='paste'){addItems(items,targets[0],addToHistory);}else if(action=='cut'||action=='delete'){removeItems(items,targets[0],addToHistory);}else if(action=='edit'){editItem(items[1],addToHistory);}else if(action=='join'||action=='split'){removeItems(items[0],targets[0],function(){addItems(items[1],targets[0],addToHistory);});}else if(action=='move'){removeItems(items,targets[0],function(){addItems(items,targets[1],addToHistory);});}function addToHistory(result,addedItems){var actions={copy:'Copying',cut:'Cutting','delete':'Deleting',edit:'Editing',join:'Joining',move:'Moving',paste:'Pasting',split:'Splitting'},length=action=='edit'?1:action=='join'||action=='split'?items[0].length:items.length,type=getType(items),text=Ox._(actions[action])+' '+(length==1?Ox._(type=='item'?pandora.site.itemName.singular:'Clip'):length+' '+Ox._(type=='item'?pandora.site.itemName.plural:'Clips'));pandora.history.add({action:action,items:action=='cut'||action=='delete'?[items]:action=='copy'||action=='paste'?[addedItems]:action=='edit'?items:action=='join'||action=='split'?[items[0],addedItems]:[items,addedItems],positions:[],targets:targets,text:text});callback(result);}};pandora.redoHistory=function(callback){var object=pandora.history.redo();if(object){if(object.action=='copy'||object.action=='paste'){addItems(object.items[0],object.targets[0],done);}else if(object.action=='cut'||object.action=='delete'){removeItems(object.items[0],object.targets[0],done);}else if(object.action=='edit'){editItem(object.items[1],done);}else if(object.action=='join'||object.action=='split'){removeItems(object.items[0],object.targets[0],function(){addItems(object.items[1],object.targets[0],done);});}else if(object.action=='move'){removeItems(object.items[0],object.targets[0],function(){addItems(object.items[1],object.targets[1],done);});}}
function done(){doneHistory(object,callback);}};pandora.undoHistory=function(callback){var object=pandora.history.undo();if(object){if(object.action=='copy'||object.action=='paste'){removeItems(object.items[0],object.targets[0],done);}else if(object.action=='cut'||object.action=='delete'){addItems(object.items[0],object.targets[0],done);}else if(object.action=='edit'){editItem(object.items[0],done);}else if(object.action=='join'||object.action=='split'){removeItems(object.items[1],object.targets[0],function(){addItems(object.items[0],object.targets[0],done);});}else if(object.action=='move'){removeItems(object.items[1],object.targets[1],function(){addItems(object.items[0],object.targets[0],done);});}}
function done(){doneHistory(object,callback);}};function addItems(items,target,callback){var clips,type=getType(items);if(type=='item'){pandora.api.find({query:{conditions:[{key:'list',operator:'==',value:target}],operator:'&'},positions:items},function(result){var existingItems=Object.keys(result.data.positions),addedItems=items.filter(function(item){return!Ox.contains(existingItems,item);});if(addedItems.length){pandora.api.addListItems({items:addedItems,list:target},function(result){callback(result,addedItems);});}else{callback(null,[]);}});}else{pandora.api.addClips({clips:getClipData(items),edit:target,index:0},function(result){items.splice.apply(items,[0,items.length].concat(getClipItems(result.data.clips)));callback(result,items);});}}
function doneHistory(object,callback){var list,listData,type=getType(object.items),ui=pandora.user.ui;if(type=='item'&&ui.section=='items'){Ox.Request.clearCache('find');object.targets.filter(function(list){return list!=ui._list;}).forEach(function(list){listData=pandora.getListData(list);pandora.api.find({query:{conditions:[{key:'list',value:list,operator:'=='}],operator:'&'}},function(result){pandora.$ui.folderList[listData.folder].value(list,'items',result.data.items);});});if(Ox.contains(object.targets,ui._list)){setTimeout(pandora.reloadList,250);}}else if(type=='clip'&&ui.section=='edits'){if(Ox.contains(object.targets,ui.edit)){pandora.$ui.editPanel.updatePanel();}}
callback&&callback();}
function editItem(item,callback){var clip=getClipData([item])[0],id=getClipIds([item])[0];pandora.api.editClip({id:id,'in':clip['in'],out:clip.out},callback);}
function getClipData(items){return items.map(function(clip){var split=clip.split('/'),item=split[0],points=split[1].split('-');return Ox.extend({item:item},points.length==1?{annotation:clip}:{'in':parseFloat(points[0]),out:parseFloat(points[1])});});}
function getClipIds(items){return items.map(function(clip){return clip.split('/').pop();});}
function getClipItems(clips){return clips.map(function(clip){return(clip.annotation||clip.item+'/'+clip['in']+'-'+clip.out)+'/'+(clip.id||'');});}
function getType(items){return Ox.contains(items[0],'/')||Ox.contains(items[0][0],'/')?'clip':'item';}
function removeItems(items,target,callback){var type=getType(items);if(type=='item'){pandora.api.removeListItems({items:items,list:target},callback);}else{pandora.api.removeClips({ids:getClipIds(items),edit:target},callback);}}}());pandora.enableDragAndDrop=function($list,canMove,section){section=section||pandora.user.ui.section;var $tooltip=Ox.Tooltip({animate:false}),drag={},scrollInterval;$list.bindEvent({draganddropstart:function(data){if(section!=pandora.user.ui.section){pandora.$ui.mainPanel.replaceElement(0,pandora.$ui.leftPanel=pandora.ui.leftPanel(section));}
drag.action='copy';drag.ids=$list.options('selected'),drag.item=drag.ids.length==1?$list.value(drag.ids[0],'title')||1:drag.ids.length;drag.source=pandora.getListData(),drag.targets={};setTimeout(function(){Ox.forEach(pandora.$ui.folderList,function($list){$list.addClass('OxDroppable').find('.OxItem').each(function(){var $item=$(this),id=$item.data('id'),data=$list.value(id);if(drag.targets){drag.targets[id]=Ox.extend({editable:data.user==pandora.user.username&&data.type=='static',selected:$item.is('.OxSelected')},data);if(!drag.targets[id].selected&&drag.targets[id].editable){$item.addClass('OxDroppable');}}});});},section!=pandora.user.ui.section?2000:0);$tooltip.options({title:getTitle()}).show(data.event);canMove&&Ox.UI.$window.on({keydown:keydown,keyup:keyup});},draganddrop:function(data){var event=data.event;$tooltip.options({title:getTitle(event)}).show(event);if(scrollInterval&&!isAtListsTop(event)&&!isAtListsBottom(event)){clearInterval(scrollInterval);scrollInterval=0;}},draganddroppause:function(data){var event=data.event,scroll,$parent,$grandparent,$panel,title;if(!pandora.user.ui.showSidebar){if(event.clientX<16&&event.clientY>=44&&event.clientY<window.innerHeight-16){pandora.$ui.mainPanel.toggle(0);}}else{$parent=$(event.target).parent();$grandparent=$parent.parent();$panel=$parent.is('.OxCollapsePanel')?$parent:$grandparent.is('.OxCollapsePanel')?$grandparent:null;if($panel){title=$panel.children('.OxBar').children('.OxTitle').html().split(' ')[0].toLowerCase();if(!pandora.user.ui.showFolder.items[title]){Ox.UI.elements[$panel.data('oxid')].options({collapsed:false});}}
if(!scrollInterval){scroll=isAtListsTop(event)?-16:isAtListsBottom(event)?16:0
if(scroll){scrollInterval=setInterval(function(){pandora.$ui.folders.scrollTop(pandora.$ui.folders.scrollTop()+scroll);},100);}}}},draganddropenter:function(data){var $parent=$(data.event.target).parent(),$item=$parent.is('.OxItem')?$parent:$parent.parent(),$list=$item.parent().parent().parent().parent();if($list.is('.OxDroppable')){$item.addClass('OxDrop');drag.target=drag.targets[$item.data('id')];}else{drag.target=null;}},draganddropleave:function(data){var $parent=$(data.event.target).parent(),$item=$parent.is('.OxItem')?$parent:$parent.parent();if($item.is('.OxDroppable')){$item.removeClass('OxDrop');drag.target=null;}},draganddropend:function(data){Ox.Log('',data,drag,'------------');canMove&&Ox.UI.$window.off({keydown:keydown,keyup:keyup});if(drag.target&&drag.target.editable&&!drag.target.selected){if(drag.action=='copy'||(drag.action=='move'&&drag.source.editable)){if(section=='items'){var targets=drag.action=='copy'?drag.target.id:[pandora.user.ui._list,drag.target.id];pandora.doHistory(drag.action,data.ids,targets,function(){Ox.Request.clearCache('find');pandora.api.find({query:{conditions:[{key:'list',value:drag.target.id,operator:'=='}],operator:'&'}},function(result){var folder=drag.target.status!='featured'?'personal':'featured';pandora.$ui.folderList[folder].value(drag.target.id,'items',result.data.items);cleanup(250);});drag.action=='move'&&pandora.reloadList();});}else if(section=='edits'){var targets=drag.action=='copy'?drag.target.id:[pandora.user.ui.edit,drag.target.id];pandora.doHistory(drag.action,data.ids,targets,function(){Ox.print('FIXME, reload clipslist on move');pandora.$ui.editPanel.updatePanel();cleanup(250);});}}}else{cleanup(0);}
function cleanup(ms){drag={};clearInterval(scrollInterval);scrollInterval=0;setTimeout(function(){$('.OxDroppable').removeClass('OxDroppable');$('.OxDrop').removeClass('OxDrop');$tooltip.hide();section!=pandora.user.ui.section&&setTimeout(function(){pandora.$ui.mainPanel.replaceElement(0,pandora.$ui.leftPanel=pandora.ui.leftPanel());},500);},ms);}}});function getTitle(){var image,text,itemName=section=='items'?{plural:Ox._(pandora.site.itemName.plural.toLowerCase()),singular:Ox._(pandora.site.itemName.singular.toLowerCase())}:{plural:Ox._('clips'),singular:Ox._('clip')},targetName=section=='items'?{plural:Ox._('lists'),singular:Ox._('list')}:{plural:Ox._('edits'),singular:Ox._('edit')};if(drag.action=='move'&&section=='edits'&&pandora.user.ui.section=='items'){image='symbolClose';text=Ox._('You can only remove {0}<br>from {1}.',[itemName.plural,targetName.plural]);}else if(drag.action=='move'&&drag.source.user!=pandora.user.username){image='symbolClose';text=Ox._('You can only remove {0}<br>from your own {1}.',[itemName.plural,targetName.plural]);}else if(drag.action=='move'&&drag.source.type=='smart'){image='symbolClose';text=Ox._('You can\'t remove {0}<br>from smart {1}.',[itemName.plural,targetName.plural]);}else if(drag.target&&drag.target.user!=pandora.user.username){image='symbolClose';text=Ox._('You can only {0} {1}<br>to your own {2}',[drag.action,itemName.plural,targetName.plural]);}else if(drag.target&&drag.target.type=='smart'){image='symbolClose';text=Ox._('You can\'t {0} {1}<br>to smart {2}',[drag.action,itemName.plural,targetName.plural]);}else{image=drag.action=='copy'?'symbolAdd':'symbolRemove';text=Ox._(Ox.toTitleCase(drag.action))+' '+(Ox.isString(drag.item)?'"'+drag.item+'"':drag.item+' '+itemName[drag.item==1?'singular':'plural'])+'<br>'+(drag.target&&!drag.target.selected?Ox._('to the {0} "{1}"',[targetName.singular,Ox.encodeHTMLEntities(drag.target.name)]):Ox._('to '+((section=='items'&&pandora.user.ui._list)||(section=='edits'&&pandora.user.ui.section=='edits')?'another':(section=='items'?'a':'an'))+' {0}',[targetName.singular]));}
return $('<div>').append($('<div>').css({float:'left',width:'16px',height:'16px',padding:'2px',border:'2px solid rgb('+Ox.Theme.getThemeData().symbolDefaultColor.join(', ')+')',borderRadius:'12px',margin:'3px 2px 2px 2px'}).append($('<img>').attr({src:Ox.UI.getImageURL(image)}).css({width:'16px',height:'16px'}))).append($('<div>').css({float:'left',margin:'1px 2px 2px 2px',fontSize:'11px',whiteSpace:'nowrap'}).html(text))}
function isAtListsTop(e){return pandora.user.ui.showSidebar&&e.clientX<pandora.user.ui.sidebarSize&&e.clientY>=44&&e.clientY<60;}
function isAtListsBottom(e){var listsBottom=window.innerHeight-pandora.getInfoHeight();return pandora.user.ui.showSidebar&&e.clientX<pandora.user.ui.sidebarSize&&e.clientY>=listsBottom-16&&e.clientY<listsBottom;}
function keydown(e){if(e.metaKey){drag.action='move';$tooltip.options({title:getTitle()}).show();}}
function keyup(e){if(drag.action=='move'){drag.action='copy';$tooltip.options({title:getTitle()}).show();}}};pandora.enterFullscreen=function(){pandora.$ui.appPanel.size(0,0);pandora.user.ui.showSidebar&&pandora.$ui.mainPanel.size(0,0);pandora.$ui.rightPanel.size(0,0).size(2,0);!pandora.user.ui.showBrowser&&pandora.$ui.contentPanel.css({top:(-112-Ox.UI.SCROLLBAR_SIZE)+'px'});pandora.user.ui.showBrowser&&pandora.$ui.contentPanel.size(0,0);pandora.$ui.player.options({height:pandora.$document.height()-2,width:pandora.$document.width()-2});};pandora.exitFullscreen=function(){pandora.$ui.appPanel.size(0,20);pandora.user.ui.showSidebar&&pandora.$ui.mainPanel.size(0,pandora.user.ui.sidebarSize);pandora.$ui.rightPanel.size(0,24).size(2,16);!pandora.user.ui.showBrowser&&pandora.$ui.contentPanel.css({top:24+(-112-Ox.UI.SCROLLBAR_SIZE)+'px'});pandora.user.ui.showBrowser&&pandora.$ui.contentPanel.size(0,112+Ox.UI.SCROLLBAR_SIZE);};pandora.getAllItemsTitle=function(section){section=section||pandora.user.ui.section;return section=='items'?Ox._('All {0}',[Ox._(pandora.site.itemName.plural)]):Ox._('{0} '+Ox.toTitleCase(section),[pandora.site.site.name]);};pandora.getClipsItems=function(width){width=width||window.innerWidth
-pandora.user.ui.showSidebar*pandora.user.ui.sidebarSize-1
-Ox.UI.SCROLLBAR_SIZE;return Math.floor((width-8)/(128+8))-1;};pandora.getClipsQuery=function(){function addClipsConditions(conditions){conditions.forEach(function(condition){if(condition.conditions){addClipsConditions(condition.conditions);}else if((condition.key=='annotations'||Ox.getIndexById(pandora.site.layers,condition.key)>-1)&&condition.operator=='='){clipsQuery.conditions.push(condition);}});}
var clipsQuery={conditions:[]};addClipsConditions(pandora.user.ui.find.conditions);clipsQuery.operator=clipsQuery.conditions.length?'|':'&';return clipsQuery;};pandora.getClipVideos=function(clip,resolution){var currentTime=0,start=clip['in']||0,end=clip.out;resolution=resolution||pandora.user.ui.videoResolution;return Ox.flatten(Ox.range(clip.parts).map(function(i){var item={src:pandora.getVideoURL(clip.item,resolution,i+1)};if(currentTime+clip.durations[i]<=start||currentTime>end){item=null;}else{if(currentTime<=start&&currentTime+clip.durations[i]>start){item['in']=start-currentTime;}
if(currentTime+clip.durations[i]>=end){item.out=end-currentTime;}
if(item['in']&&item.out){item.duration=item.out-item['in']}else if(item.out){item.duration=item.out;}else if(!Ox.isUndefined(item['in'])){item.duration=clip.durations[i]-item['in'];item.out=clip.durations[i];}else{item.duration=clip.durations[i];item['in']=0;item.out=item.duration;}}
currentTime+=clip.durations[i];return item;}).filter(function(c){return!!c;}));};(function(){var itemTitles={};pandora.getDocumentTitle=function(itemData){var parts=[pandora.site.site.name];if(itemData){itemTitles[pandora.user.ui.item]=Ox.decodeHTMLEntities(pandora.getItemTitle(itemData));}
if(pandora.user.ui.section=='items'){if(!pandora.user.ui.item){pandora.user.ui._list&&parts.push(Ox._('List')+' '+pandora.user.ui._list);parts.push(Ox._(Ox.toTitleCase(pandora.user.ui.listView)+' View'));}else{parts.push(itemTitles[pandora.user.ui.item]||pandora.user.ui.item);parts.push(Ox._(Ox.toTitleCase(pandora.user.ui.itemView)+' View'));}}else if(pandora.user.ui.section=='edits'){parts.push(pandora.user.ui.edit?Ox._('Edit{noun}',{noun:''})+' '+pandora.user.ui.edit:Ox._('Edits'));}else if(pandora.user.ui.section=='texts'){parts.push(pandora.user.ui.text?Ox._('Text')+' '+pandora.user.ui.text:Ox._('Texts'));}
return parts.join('  ');};}());pandora.getDownloadLink=function(item){return'/'+item+(pandora.site.video.torrent?'/torrent/':'/download/');}
pandora.getEditTooltip=function(title){return function(e){var $target=$(e.target);return($target.is('a')||$target.parents('a').length?Ox._('Shift+doubleclick to edit'):Ox._('Doubleclick to edit'))+(title?' '+title:'');}};pandora.getFilterSizes=function(){return Ox.splitInt(window.innerWidth
-pandora.user.ui.showSidebar*pandora.user.ui.sidebarSize
-1,5);};pandora.getFoldersHeight=function(section){section=section||pandora.user.ui.section;var height=0;pandora.site.sectionFolders[section].forEach(function(folder,i){height+=16+pandora.user.ui.showFolder[section][folder.id]*(!!folder.showBrowser*40+folder.items*16);});return height;};pandora.getFoldersWidth=function(section){section=section||pandora.user.ui.section;var width=pandora.user.ui.sidebarSize;if(pandora.$ui.appPanel&&pandora.getFoldersHeight(section)>window.innerHeight-20-24-16-1-pandora.getInfoHeight(section)){width-=Ox.UI.SCROLLBAR_SIZE;}
return width;};pandora.getHash=function(state,callback){var embedKeys=['annotationsFont','annotationsRange','annotationsSort','embed','ignoreRights','invertHighlight','matchRatio','paused','playInToOut','showAnnotations','showCloseButton','showLayers','showTimeline','timeline','title'],isEmbed=state.hash&&state.hash.anchor=='embed',isPrint=state.hash&&state.hash.anchor=='print',printKeys=[],removeKeys=[];if(state.hash&&state.hash.anchor&&!isEmbed&&!isPrint){delete state.hash.anchor;}
if(state.hash&&state.hash.query){if(isEmbed){state.hash.query.forEach(function(condition){if(!Ox.contains(embedKeys,condition.key)){removeKeys.push(condition.key);}});}else if(isPrint){state.hash.query.forEach(function(condition){if(!Ox.contains(printKeys,condition.key)){removeKeys.push(condition.key);}});}else{state.hash.query.forEach(function(condition){var key=condition.key.split('.')[0];if(pandora.site.user.ui[key]===void 0){removeKeys.push(condition.key);}});}
state.hash.query=state.hash.query.filter(function(condition){return!Ox.contains(removeKeys,condition.key);});if(Ox.isEmpty(state.hash.query)){delete state.hash.query;}}
if(Ox.isEmpty(state.hash)){delete state.hash;}
callback();};pandora.getInfoHeight=function(section,includeHidden){section=section||pandora.user.ui.section;if(arguments.length==1&&Ox.isBoolean(arguments[0])){section=pandora.user.ui.section;includeHidden=arguments[0];}
var height=0,isVideoPreview;if(pandora.user.ui.showInfo||includeHidden){isVideoPreview=section=='items'&&(pandora.user.ui.item||(pandora.user.ui.listSelection.length&&!pandora.isClipView()));height=Math.min(isVideoPreview?Math.round(pandora.user.ui.sidebarSize/pandora.site.video.previewRatio)+16:pandora.user.ui.sidebarSize,window.innerHeight-109);}
return height;}
pandora.getItem=function(state,str,callback){if(state.type==pandora.site.itemName.plural.toLowerCase()){var secondaryId=pandora.site.itemKeys.filter(function(key){return key.secondaryId;}).map(function(key){return key.id;})[0],sortKey=Ox.getObjectById(pandora.site.itemKeys,'votes')?'votes':'timesaccessed';Ox.getObjectById(pandora.site.itemKeys,'alt')
pandora.api.get({id:str,keys:['id']},function(result){if(result.status.code==200){state.item=result.data.id;callback();}else{(secondaryId?pandora.api.find:Ox.noop)({query:{conditions:[{key:secondaryId,value:str,operator:'=='}],operator:'&'},sort:[{key:sortKey,operator:'-'}],range:[0,1],keys:['id']},function(result){if(result&&result.data.items.length){state.item=result.data.items[0].id;callback();}else{pandora.api.find({query:{conditions:[{key:'title',value:str,operator:'=='}],operator:'&'},sort:[{key:sortKey,operator:'-'}],range:[0,100],keys:['id','title',sortKey]},function(result){if(result.data.items.length){var regexp=new RegExp('^'+Ox.escapeRegExp(str)+'$','i'),items=result.data.items.map(function(item){return{id:item.id,sort:(item.title==str?1000000:0)
+(parseInt(item[sortKey])||0)};});state.item=items.sort(function(a,b){return b.sort-a.sort;})[0].id;}
callback();});}});}});}else if(state.type=='texts'){pandora.api.getText({id:str},function(result){if(result.status.code==200){state.item=result.data.id;callback();}else{state.item='';callback();}});}else if(state.type=='edits'){pandora.api.getEdit({id:str},function(result){if(result.status.code==200){state.item=result.data.id;callback();}else{state.item='';callback();}});}else{callback();}}
pandora.getItemFind=function(find){var itemFind='';Ox.forEach(find.conditions,function(condition){if((condition.key=='*'||condition.key=='annotations'||Ox.getIndexById(pandora.site.layers,condition.key)>-1)&&condition.value.length&&['=','=='].indexOf(condition.operator)>-1){itemFind=condition.value;return false;}})
return itemFind;};pandora.getItemIdAndPosition=function(){var selected,ret,ui=pandora.user.ui;function getIdAndPositionByClipId(clipId){var split=clipId.replace('-','/').split('/');return{id:split[0],position:parseFloat(split[1])};}
function getIdAndPositionByItemId(itemId){return{id:itemId,position:ui.videoPoints[itemId]?ui.videoPoints[itemId].position:0};}
if(!ui.item){if(ui.listView=='timelines'&&(selected=ui.listSelection).length==1){ret=getIdAndPositionByItemId(selected[0]);}else if(['clip','map','calendar'].indexOf(ui.listView)>-1&&pandora.$ui.clipList&&(selected=pandora.$ui.clipList.options('selected')).length==1){ret=getIdAndPositionByClipId(selected[0]);}}else{if(pandora.isVideoView()){ret=getIdAndPositionByItemId(ui.item);}else if(['clips','map','calendar'].indexOf(ui.itemView)>-1&&pandora.$ui.clipList&&(selected=pandora.$ui.clipList.options('selected')).length==1){ret=getIdAndPositionByClipId(selected[0]);}}
return ret;}
pandora.getItemTitle=function(itemData){return(itemData.title||Ox._('Untitled'))+(Ox.len(itemData.director)||itemData.year?' ('+(Ox.len(itemData.director)?itemData.director:[Ox._('Unknown Director')]).join(', ')+')':'')+(itemData.year?' '+itemData.year:'')};pandora.getLargeClipTimelineURL=function(item,inPoint,outPoint,type,callback){var fps=25,width=Math.ceil((outPoint-inPoint)*fps),height=64,canvas=Ox.$('<canvas>').attr({width:width,height:height})[0],context=canvas.getContext('2d'),inIndex=Math.floor(inPoint/60),outIndex=Math.floor(outPoint/60),offset=inPoint%60*-fps;Ox.parallelForEach(Ox.range(inIndex,outIndex+1),function(index,i){var callback=Ox.last(arguments),image=Ox.$('<img>').on({load:function(){context.drawImage(image,offset+i*1500,0);callback();}}).attr({src:'/'+item+'/timeline'+type+'64p'+index+'.jpg'})[0];},function(){callback(canvas.toDataURL());});};pandora.getLargeEditTimelineURL=function(edit,type,i,callback){var clips=[],timelineIn=i*60,timelineOut=Math.min((i+1)*60,edit.duration),fps=25,width=(timelineOut-timelineIn)*fps,height=64,canvas=Ox.$('<canvas>').attr({width:width,height:height})[0],context=canvas.getContext('2d');Ox.forEach(edit.clips,function(clip){var clipIn=clip.position,clipOut=clip.position+clip.duration;if(clipIn>=timelineOut){return false;}
if((timelineIn<=clipIn&&clipIn<=timelineOut)||(timelineIn<=clipOut&&clipOut<=timelineOut)||(clipIn<=timelineIn&&timelineOut<=clipOut)){clips.push({'in':clip['in']+(clipIn<timelineIn?timelineIn-clipIn:0),item:clip.item,offset:Math.floor(Math.max(clipIn-timelineIn,0)*fps),out:clip.out-(clipOut>timelineOut?clipOut-timelineOut:0)});}});Ox.parallelForEach(clips,function(clip){var callback=Ox.last(arguments);pandora.getLargeClipTimelineURL(clip.item,clip['in'],clip.out,type,function(url){var image=Ox.$('<img>').on({load:function(){context.drawImage(image,clip.offset,0);callback();}}).attr({src:url})[0];});},function(){callback(canvas.toDataURL());});};pandora.getListData=function(list){var data={},folder;if(Ox.isUndefined(list)){list=pandora.user.ui[pandora.user.ui.section=='items'?'_list':pandora.user.ui.section.slice(0,-1)];}
if(list&&pandora.$ui.folderList){Ox.forEach(pandora.$ui.folderList,function($list,id){var ret=true;if(list==pandora.user.ui._list&&$list.options('selected').length){folder=id;ret=false;}else if(!Ox.isEmpty($list.value(list))){folder=id
ret=false;}});if(folder){data=pandora.$ui.folderList[folder].value(list);if(pandora.user.ui.section=='item'){data.editable=data.user==pandora.user.username&&data.type=='static';}else{data.editable=data.user==pandora.user.username;}
data.folder=folder;}}
return data;};pandora.getPageTitle=function(stateOrURL){var pages=[{id:'',title:''},{id:'api',title:Ox._('API Documentation')},{id:'help',title:Ox._('Help')},{id:'home',title:''},{id:'preferences',title:Ox._('Preferences')},{id:'signin',title:Ox._('Sign In')},{id:'signout',title:Ox._('Sign Out')},{id:'signup',title:Ox._('Sign Up')},{id:'software',title:Ox._('Software')},{id:'tv',title:Ox._('TV')}].concat(pandora.site.sitePages),page=Ox.getObjectById(pages,Ox.isObject(stateOrURL)?stateOrURL.page:stateOrURL.slice(1));return page?pandora.site.site.name
+(page.title?'  '+page.title:''):null;};pandora.getPart=function(state,str,callback){if(state.page=='api'){pandora.api.api(function(result){if(Ox.contains(Object.keys(result.data.actions),str)){state.part=str;}
callback();})}else if(state.page=='faq'){callback();}else if(state.page=='help'){if(Ox.getObjectById(pandora.site.help,str)){state.part=str;}
callback();}else if(state.page=='news'){pandora.api.getNews(function(result){if(Ox.getObjectById(result.data.items,str)){state.part=str;}else if(result.data.items.length){state.part=result.data.items[0].id;}
callback();});}else if(state.page=='preferences'){if(Ox.contains(['account','appearance','advanced'],str)){state.part=str;}
callback();}else if(state.page=='tv'){var split=str.split(':'),user,name;if(split.length>=2){user=split.shift();name=split.join(':');pandora.api.findLists({keys:['name','user'],query:{conditions:[{key:'user',operator:'==',value:user},{key:'name',operator:'==',value:name}],operator:'&'}},function(result){if(result.data.items.length){state.part=str;}
callback();});}else{callback();}}else{callback();}};pandora.getSmallClipTimelineURL=function(item,inPoint,outPoint,type,callback){var width=Math.ceil(outPoint-inPoint),height=16,canvas=Ox.$('<canvas>').attr({width:width,height:height})[0],context=canvas.getContext('2d'),inIndex=Math.floor(inPoint/3600),outIndex=Math.floor(outPoint/3600),offset=inPoint%3600*-1;Ox.parallelForEach(Ox.range(inIndex,outIndex+1),function(index,i){var callback=Ox.last(arguments),image=Ox.$('<img>').on({load:function(){context.drawImage(image,offset+i*3600,0);callback();}}).attr({src:'/'+item+'/timeline'+type+'16p'+index+'.jpg'})[0];},function(){callback(canvas.toDataURL());});};pandora.getSortKeyData=function(key){return Ox.getObjectById(pandora.site.itemKeys,key)||Ox.getObjectById(pandora.site.clipKeys,key);};pandora.getSortKeys=function(){return pandora.site.itemKeys.filter(function(key){return key.sort&&(!key.capability||pandora.site.capabilities[key.capability][pandora.user.level]);}).map(function(key){return Ox.extend(key,{operator:pandora.getSortOperator(key.id)});});};pandora.getSortOperator=function(key){var data=pandora.getSortKeyData(key);return data.sortOperator||['string','text'].indexOf(Ox.isArray(data.type)?data.type[0]:data.type)>-1?'+':'-';};pandora.getSpan=function(state,val,callback){if(state.type==pandora.site.itemName.plural.toLowerCase()){var isArray=Ox.isArray(val),isName,isVideoView,canBeAnnotation,canBeEvent,canBePlace;if(isArray){pandora.api.get({id:state.item,keys:['duration']},function(result){state.span=val.map(function(number){return Math.min(number,result.data.duration);});callback();});}else{isName=val[0]=='@';isVideoView=pandora.isVideoView(state.view);canBeAnnotation=state.item&&(!state.view||isVideoView)&&!isName;canBeEvent=!state.view||state.view=='calendar';canBePlace=!state.view||state.view=='map';val=isName?val.slice(1):val;getId(canBeAnnotation?'annotation':'',function(id){if(id){Ox.Log('URL','id?',id)
state.span=id;state.view=pandora.user.ui.videoView;callback();}else{getId(canBePlace?'place':'',function(id){if(id){Ox.Log('URL','found place id',id)
state.span=id;state.view='map';callback();}else{getId(canBeEvent?'event':'',function(id){if(id){Ox.Log('URL','found event id',id)
state.span=id;state.view='calendar';}else if(canBePlace&&isName){Ox.Log('URL','setting place id','@'+val)
state.span='@'+val;state.view='map';}
callback();});}});}});}}else if(state.type=='edits'){if(isArray){pandora.api.getEdit({id:state.item,keys:['duration']},function(result){state.span=val.map(function(number){return Math.min(number,result.data.duration);});callback();});}else{pandora.api.getEdit({id:state.item,keys:['clips']},function(result){if(Ox.getObjectById(result.data.clips,val)){state.span=val;}
callback();});}}else if(state.type=='texts'){state.span=val;callback();}
function getId(type,callback){if(type){pandora.api['find'+Ox.toTitleCase(type+'s')](Ox.extend({query:{conditions:[{key:isName?'name':'id',value:type!='annotation'?val:state.item+'/'+val,operator:'=='}],operator:'&'},keys:type!='annotation'?['id']:['id','in','out'],range:[0,1]},state.item&&type!='annotation'?{itemQuery:{conditions:[{key:'id',value:state.item,operator:'=='}],operator:'&'}}:{}),function(result){var annotation,span;if(result.data.items.length){span=result.data.items[0];annotation=span.id.split('/')[1];type=='annotation'&&pandora.UI.set('videoPoints.'+state.item,{annotation:annotation,'in':span['in'],out:span.out,position:span['in']});}
callback(!span?'':type!='annotation'?span.id:annotation);});}else{callback();}}};pandora.getStatusText=function(data){var ui=pandora.user.ui,canSeeMedia=pandora.site.capabilities.canSeeMedia[pandora.user.level],canSeeSize=pandora.site.capabilities.canSeeSize[pandora.user.level],itemName=['clip','video'].indexOf(ui.listView)>-1?(data.items==1?Ox._('Clip'):Ox._('Clips')):(pandora.site.itemName[data.items==1?'singular':'plural']),parts=[];parts.push(Ox.formatNumber(data.items)+' '+itemName);if(data.runtime){parts.push(Ox.formatDuration(data.runtime,'short'));}else if(data.duration){parts.push(Ox.formatDuration(data.duration,'short'));}
if(canSeeMedia){data.files&&parts.push(Ox.toTitleCase(Ox.formatCount(data.files,'file')));data.duration&&parts.push(Ox.formatDuration(data.duration));}
if(canSeeSize){data.size&&parts.push(Ox.formatValue(data.size,'B'));}
if(canSeeMedia){data.pixels&&parts.push(Ox.formatValue(data.pixels,'px'));}
return parts.join(', ');};pandora.getVideoURL=function(id,resolution,part){var prefix=pandora.site.site.videoprefix.replace('{id}',id).replace('{part}',part).replace('{resolution}',resolution).replace('{uid}',Ox.uid());return prefix+'/'+id+'/'+resolution+'p'+part+'.'+pandora.user.videoFormat;}
pandora.getVideoOptions=function(data){var canPlayClips=data.editable||pandora.site.capabilities.canPlayClips[pandora.user.level]>=data.rightslevel,canPlayVideo=data.editable||pandora.site.capabilities.canPlayVideo[pandora.user.level]>=data.rightslevel,options={};options.subtitlesLayer=pandora.site.layers.filter(function(layer){return layer.isSubtitles;}).map(function(layer){return layer.id;})[0];options.subtitles=options.subtitlesLayer?data.layers[options.subtitlesLayer].map(function(subtitle){return{id:subtitle.id,'in':subtitle['in'],out:subtitle.out,text:subtitle.value.replace(/\n/g,' ').replace(/<br\/?>/g,'\n')};}):[];options.censored=canPlayVideo?[]:canPlayClips?(options.subtitles.length?options.subtitles.map(function(subtitle,i){return{'in':i==0?0:options.subtitles[i-1].out,out:subtitle['in']};}).concat([{'in':Ox.last(options.subtitles).out,out:data.duration}]).filter(function(censored){return censored.out-censored['in']>=1;}):Ox.range(0,data.duration-5,60).map(function(position){return{'in':position+5,out:Math.min(position+60,data.duration)};})):[{'in':0,out:data.duration}];options.video={};pandora.site.video.resolutions.forEach(function(resolution){options.video[resolution]=Ox.range(data.parts).map(function(i){return{duration:data.durations[i],src:pandora.getVideoURL(data.item||pandora.user.ui.item,resolution,i+1)};});});options.annotations=[];pandora.site.layers.forEach(function(layer,i){options.annotations[i]=Ox.extend({},layer,{title:Ox._(layer.title),item:Ox._(layer.item),items:data.layers[layer.id].map(function(annotation){annotation.duration=Math.abs(annotation.out-annotation['in']);annotation.editable=annotation.editable||annotation.user==pandora.user.username||pandora.site.capabilities['canEditAnnotations'][pandora.user.level];return annotation;})});});return options;};pandora.getVideoPartsAndPoints=function(durations,points){var parts=durations.length,offsets=Ox.range(parts).map(function(i){return Ox.sum(durations.slice(0,i));}),ret={parts:[],points:[]};points.forEach(function(point,i){Ox.loop(parts-1,-1,-1,function(i){if(offsets[i]<=point){ret.parts[i]=i;return false;}});});ret.parts=Ox.unique(ret.parts);ret.points=points.map(function(point){return point-offsets[ret.parts[0]];});return ret;};pandora.hasDialogOrScreen=function(){return $('.OxDialog:visible').length||$('.OxFullscreen').length||$('.OxScreen').length;};pandora.hasEventsLayer=function(){return pandora.site.layers.some(function(layer){return layer.type=='event';});};pandora.hasFocusedInput=function(){var focused=Ox.Focus.focused();return focused&&Ox.UI.elements[focused].is('.OxInput');};pandora.hasPlacesLayer=function(){return pandora.site.layers.some(function(layer){return layer.type=='place';});};pandora.isClipView=function(view,item){if(arguments.length==0){item=pandora.user.ui.item;view=!item?pandora.user.ui.listView:pandora.user.ui.itemView;}else if(arguments.length==1){item=pandora.user.ui.item;}
return(!item?['calendar','clip','map']:['calendar','clips','map']).indexOf(view)>-1;};pandora.isEmbedURL=function(url){url=url||document.location.href;var hash=Ox.parseURL(url).hash;return/^#embed(\?.*?)?$/.test(hash);};pandora.isPrintURL=function(url){url=url||document.location.href;var hash=Ox.parseURL(url).hash;return/^#print(\?.*?)?$/.test(hash);};pandora.isVideoView=function(view,item){if(arguments.length==0){item=pandora.user.ui.item;view=!item?pandora.user.ui.listView:pandora.user.ui.itemView;}else if(arguments.length==1){item=pandora.user.ui.item;}
return(!item?['video']:['player','editor','timeline']).indexOf(view)>-1;};pandora.logEvent=function(data,event,element){var element=this,handlers=self.eventHandlers?self.eventHandlers[event]:[];if(!Ox.contains(['mousedown','mouserepeat','anyclick','singleclick','doubleclick','dragstart','drag','dragenter','dragleave','dragpause','dragend','draganddropstart','draganddrop','draganddropenter','draganddropleave','draganddropend','playing','position','progress','request'],event)&&!Ox.startsWith(event,'pandora_')){try{data=JSON.stringify(data)}catch(e){}
Ox.print('EVENT',element.oxid,'"'+element[0].className.split(' ').filter(function(className){return/^Ox/.test(className);}).map(function(className){return className.replace(/^Ox/,'');}).join(' ')+'"',event,data,handlers.length,handlers.map(function(handler){return handler.toString().split('\n').shift();}));}};pandora.signin=function(data){pandora.user=Ox.extend(data.user,{sectionElement:'buttons',videoFormat:Ox.getVideoFormat(pandora.site.video.formats)});pandora.user.ui._list=pandora.getListState(pandora.user.ui.find);pandora.user.ui._filterState=pandora.getFilterState(pandora.user.ui.find);pandora.user.ui._findState=pandora.getFindState(pandora.user.ui.find);pandora.site.sortKeys=pandora.getSortKeys();pandora.URL.init();pandora.URL.update();Ox.Theme(pandora.user.ui.theme);pandora.$ui.appPanel.reload();};pandora.signout=function(data){pandora.user=data.user;pandora.user.ui._list=pandora.getListState(pandora.user.ui.find);pandora.user.ui._filterState=pandora.getFilterState(pandora.user.ui.find);pandora.user.ui._findState=pandora.getFindState(pandora.user.ui.find);pandora.site.sortKeys=pandora.getSortKeys();pandora.URL.init();pandora.URL.update();Ox.Theme(pandora.user.ui.theme);pandora.$ui.appPanel.reload();};pandora.reloadList=function(){Ox.Log('','reloadList')
var listData=pandora.getListData();Ox.Request.clearCache();pandora.$ui.filters.forEach(function($filter){$filter.reloadList();});pandora.$ui.list.bindEvent({init:function(data){var folder=listData.status!='featured'?'personal':'featured';pandora.$ui.folderList[folder].value(listData.id,'items',data.items);}}).bindEventOnce({load:function(data){pandora.$ui.list.gainFocus();}}).reloadList();};pandora.renameList=function(oldId,newId,newName,folder){folder=folder||pandora.getListData(oldId).folder;pandora.$ui.folderList[folder].value(oldId,'name',newName);pandora.$ui.folderList[folder].value(oldId,'id',newId);if(pandora.user.ui.section=='items'){pandora.$ui.toolbar.updateListName(newId);pandora.replaceURL=true;pandora.UI.set({find:{conditions:[{key:'list',value:newId,operator:'=='}],operator:'&'}},false);}else{pandora.replaceURL=true;pandora.UI.set(pandora.user.ui.section.slice(0,-1),newId);}};pandora.resizeFilters=function(width){pandora.user.ui.filterSizes=pandora.getFilterSizes();pandora.$ui.browser&&pandora.$ui.browser.size(0,pandora.user.ui.filterSizes[0]).size(2,pandora.user.ui.filterSizes[4]);pandora.$ui.filtersInnerPanel&&pandora.$ui.filtersInnerPanel.size(0,pandora.user.ui.filterSizes[1]).size(2,pandora.user.ui.filterSizes[3]);pandora.$ui.filters&&pandora.$ui.filters.forEach(function($list,i){$list.resizeColumn('name',pandora.user.ui.filterSizes[i]-44-Ox.UI.SCROLLBAR_SIZE);if(pandora.site.flags){$list.find('.flagname').css({width:pandora.user.ui.filterSizes[i]-68-Ox.UI.SCROLLBAR_SIZE})}});};pandora.resizeFolders=function(section){section=section||pandora.user.ui.section;var width=pandora.getFoldersWidth(section),columnWidth=width-(section=='items'?96:48),userColumnWidth=Math.round(columnWidth*0.4),nameColumnWidth=columnWidth-userColumnWidth;pandora.$ui.allItems&&pandora.$ui.allItems.resizeElement(columnWidth-8);Ox.forEach(pandora.$ui.folderList,function($list,id){var pos=Ox.getIndexById(pandora.site.sectionFolders[section],id);pandora.$ui.folder[pos].css({width:width+'px'});$list.css({width:width+'px'});if(pandora.site.sectionFolders[section][pos].showBrowser){pandora.$ui.findListInput[id]&&pandora.$ui.findListInput[id].options({width:width-24});$list.resizeColumn('user',userColumnWidth).resizeColumn('name',nameColumnWidth);}else{$list.resizeColumn(id=='favorite'?'id':'name',columnWidth);}
if(!pandora.user.ui.showFolder[section][id]){pandora.$ui.folder[pos].updatePanel();}});if(pandora.user.ui.section=='texts'){pandora.$ui.text&&pandora.$ui.text.update();}};pandora.resizeWindow=function(){if(pandora.$ui.embedPanel){pandora.$ui.embedPanel.resizePanel();}
if(pandora.$ui.embedPanel||pandora.$ui.printView){return;}
pandora.$ui.leftPanel&&pandora.$ui.leftPanel.size(2,pandora.getInfoHeight(true));pandora.resizeFolders();if(pandora.user.ui.section=='items'){if(!pandora.user.ui.item){pandora.resizeFilters(pandora.$ui.rightPanel.width());if(pandora.user.ui.listView=='clips'){var clipsItems=pandora.getClipsItems(),previousClipsItems=pandora.getClipsItems(pandora.$ui.list.options('width'));pandora.$ui.list.options({width:window.innerWidth
-pandora.user.ui.showSidebar*pandora.user.ui.sidebarSize-1
-Ox.UI.SCROLLBAR_SIZE});if(clipsItems!=previousClipsItems){Ox.Request.clearCache();pandora.$ui.list.reloadList(true);}}else if(pandora.user.ui.listView=='timelines'){pandora.$ui.list.options({width:window.innerWidth
-pandora.user.ui.showSidebar*pandora.user.ui.sidebarSize-1
-Ox.UI.SCROLLBAR_SIZE});}else if(pandora.user.ui.listView=='map'){pandora.$ui.map&&pandora.$ui.map.resizeMap();}else if(pandora.user.ui.listView=='calendar'){pandora.$ui.calendar&&pandora.$ui.calendar.resizeCalendar();}else{pandora.$ui.list&&pandora.$ui.list.size();}}else{pandora.$ui.browser.scrollToSelection();if(pandora.user.ui.itemView=='info'){pandora.$ui.item.resizeElement&&pandora.$ui.item.resizeElement();}else if(pandora.user.ui.itemView=='clips'){pandora.$ui.clipList.size();}else if(pandora.user.ui.itemView=='timeline'){pandora.$ui.timeline&&pandora.$ui.timeline.options({height:pandora.$ui.contentPanel.size(1),width:pandora.$ui.document.width()-pandora.$ui.mainPanel.size(0)-1});}else if(pandora.user.ui.itemView=='player'){pandora.$ui.player&&pandora.$ui.player.options({height:pandora.$ui.contentPanel.size(1),width:pandora.$ui.document.width()-pandora.$ui.mainPanel.size(0)-1});}else if(pandora.user.ui.itemView=='editor'){pandora.$ui.editor&&pandora.$ui.editor.options({height:pandora.$ui.contentPanel.size(1),width:pandora.$ui.document.width()-pandora.$ui.mainPanel.size(0)-1});}else if(pandora.user.ui.itemView=='map'){pandora.$ui.map.resizeMap();}else if(pandora.user.ui.itemView=='calendar'){pandora.$ui.calendar.resizeCalendar();}}}else if(pandora.user.ui.section=='edits'){if(!pandora.user.ui.edit){}else{pandora.$ui.editPanel&&pandora.$ui.editPanel.options({height:pandora.$ui.appPanel.size(1),width:pandora.$ui.document.width()-pandora.$ui.mainPanel.size(0)-1});}}else if(pandora.user.ui.section=='texts'){pandora.$ui.text&&pandora.$ui.text.update();}};pandora.selectList=function(){if(pandora.user.ui.section=='items'){if(pandora.user.ui._list){pandora.api.findLists({keys:['status','user'],query:{conditions:[{key:'id',value:pandora.user.ui._list,operator:'=='}],operator:''},range:[0,1]},function(result){var folder,list;if(result.data.items.length){list=result.data.items[0];folder=list.status=='featured'?'featured':(list.user==pandora.user.username?'personal':'favorite');pandora.$ui.folderList[folder].options({selected:[pandora.user.ui._list]});if(!pandora.hasDialogOrScreen()&&!pandora.hasFocusedInput()){pandora.$ui.folderList[folder].gainFocus();}}});}}else{var id=pandora.user.ui[pandora.user.ui.section.slice(0,-1)],section=Ox.toTitleCase(pandora.user.ui.section.slice(0,-1));if(id){pandora.api['get'+section]({id:id},function(result){var folder;if(result.data.id){folder=result.data.status=='featured'?'featured':(result.data.user==pandora.user.username?'personal':'favorite');pandora.$ui.folderList[folder].options({selected:[id]});}});}}};pandora.setLocale=function(locale,callback){var url;if(Ox.isUndefined(Ox.LOCALE_NAMES[locale])){locale=pandora.site.user.ui.locale;}
if(locale!='en'){if(pandora.localStorage('enableDebugMode')){url=['/static/json/locale.pandora.'+locale+'.json','/static/json/locale.'+pandora.site.site.id+'.'+locale+'.json',];}else{url='/static/json/locale.'+locale+'.json'}}
Ox.setLocale(locale,url,callback);};pandora.setTheme=function(theme){var iframe,src;Ox.Theme(theme);iframe=Ox.UI.elements[$('#embed').data('oxid')];if(iframe){src=iframe.attr('src');if(src&&Ox.parseURL(src).hostname==document.location.hostname){iframe.postMessage('settheme',{theme:theme});}}};pandora.unloadWindow=function(){};pandora.updateItemContext=function(){Ox.Request.clearCache('find');if(!Ox.isEqual(pandora.user.ui.find,pandora.site.user.ui.find)){pandora.api.find({query:pandora.user.ui.find,positions:[pandora.user.ui.item],sort:pandora.user.ui.sort},function(result){if(result.data.positions[pandora.user.ui.item]===void 0){pandora.stayInItemView=true;pandora.UI.set({find:pandora.site.user.ui.find});pandora.$ui.contentPanel.replaceElement(0,pandora.$ui.browser=pandora.ui.browser());}else{pandora.$ui.browser.reloadList();}});}else{pandora.$ui.browser.reloadList();}};pandora.wait=function(taskId,callback,timeout){var task={};timeout=timeout||5000;task.timeout=setTimeout(function(){pandora.api.taskStatus({taskId:taskId},function(result){var t;if(result.data.status=='PENDING'){t=pandora.wait(taskId,callback);task.timeout=t.timeout;}else{callback(result);}});},5000);return task;};(function(){function everyCondition(conditions,key,operator){return Ox.every(conditions,function(condition){return condition.key==key&&condition.operator==operator;});}
function oneCondition(conditions,key,operator,includeSubconditions){var indices=Ox.indicesOf(conditions,function(condition){return(condition.conditions?includeSubconditions&&everyCondition(condition.conditions,key,operator):condition.key==key&&condition.operator==operator);});return indices.length==1?indices[0]:-1;}
pandora.getFilterState=function(find){return pandora.user.ui.filters.map(function(filter){var key=filter.id,state={index:-1,find:Ox.clone(find,true),selected:[]};if(find.operator=='&'){state.index=oneCondition(find.conditions,key,'==',true);if(state.index>-1){state.selected=find.conditions[state.index].conditions?find.conditions[state.index].conditions.map(function(condition){return condition.value;}):[find.conditions[state.index].value];}}else{if(everyCondition(find.conditions,key,'==')){state.index=Ox.range(find.conditions.length);state.selected=find.conditions.map(function(condition){return condition.value;});}}
if(state.selected.length){if(Ox.isArray(state.index)){state.find={conditions:[],operator:''};}else{state.find.conditions.splice(state.index,1);if(state.find.conditions.length==1&&state.find.conditions[0].conditions){state.find={conditions:state.find.conditions[0].conditions,operator:state.find.conditions[0].operator};}}}
return state;});}
pandora.getFindState=function(find){Ox.Log('Find','getFindState',find)
var conditions,indices,state={index:-1,key:'*',value:''};if(find.operator=='&'){conditions=find.conditions.length
-!!pandora.user.ui._list
-pandora.user.ui._filterState.filter(function(filter){return filter.index>-1;}).length;indices=pandora.site.findKeys.map(function(findKey){return oneCondition(find.conditions,findKey.id,'=');}).filter(function(index){return index>-1;});state=conditions==1&&indices.length==1?{index:indices[0],key:find.conditions[indices[0]].key,value:Ox.decodeURIComponent(find.conditions[indices[0]].value)}:{index:-1,key:conditions==0&&indices.length==0?'*':'advanced',value:''};}else{state={index:-1,key:'advanced',value:''};Ox.forEach(pandora.user.ui.filters,function(key){if(everyCondition(find.conditions,key,'==')){state.key='*';return false;}});}
return state;}
pandora.getListState=function(find){var index,state='';if(find.operator=='&'){index=oneCondition(find.conditions,'list','==');if(index>-1){state=find.conditions[index].value;}}
return state;};}());'use strict';pandora.ui.news=function(width,height){var that=Ox.Element(),$left=$('<div>').css({position:'absolute',width:width-512}).appendTo(that),$right=$('<div>').css({position:'absolute',top:'16px',right:'16px',width:'192px'}).appendTo(that),backgroundColor=Ox.Theme()=='oxlight'?'rgb(224, 224, 224)':Ox.Theme()=='oxmedium'?'rgb(128, 128, 128)':'rgb(32, 32, 32)',isEditable=pandora.site.capabilities.canEditSitePages[pandora.user.level],items=[],$text;pandora.api.getNews(function(result){items=result.data.items;selectItem();});function addItem(){pandora.api.addNews({title:Ox._('Untitled'),date:Ox.formatDate(new Date(),'%Y-%m-%d'),text:''},function(result){items.splice(0,0,result.data);pandora.UI.set({'part.news':result.data.id});});}
function editItem(key,value){var data={id:pandora.user.ui.part.news},index=Ox.getIndexById(items,pandora.user.ui.part.news);if(index==-1){index=0;}
data[key]=value;pandora.api.editNews(data,function(result){items[index]=result.data;['title','date'].indexOf(key)>-1&&renderList();});}
function removeItem(){var index=Ox.getIndexById(items,pandora.user.ui.part.news);if(index==-1){index=0;}
items.splice(index,1);pandora.api.removeNews({id:pandora.user.ui.part.news},function(result){pandora.UI.set({'part.news':items.length==0?'':items[Math.min(index,items.length-1)].id});});}
function renderItem(){var $title,$date,index=Ox.getIndexById(items,pandora.user.ui.part.news);if(index==-1){index=0;}
$left.empty();if(items.length){$title=Ox.Editable({editable:isEditable,tooltip:isEditable?pandora.getEditTooltip():'',value:items[index].title}).addClass('OxSelectable').css({display:'inline-block',fontWeight:'bold',fontSize:'16px',}).bindEvent({submit:function(data){editItem('title',data.value);}}).appendTo($left);$('<div>').css({height:'2px'}).appendTo($left);$date=Ox.Editable({editable:isEditable,format:function(value){return Ox.formatDate(value,'%B %e, %Y');},tooltip:isEditable?pandora.getEditTooltip():'',value:items[index].date}).addClass('OxSelectable').css({display:'inline-block',fontSize:'9px'}).bindEvent({submit:function(data){editItem('date',data.value);}}).appendTo($left);$('<div>').css({height:'8px'}).appendTo($left);$text=Ox.Editable({clickLink:pandora.clickLink,editable:isEditable,maxHeight:height-96,placeholder:Ox._('No text'),tooltip:isEditable?pandora.getEditTooltip():'',type:'textarea',value:items[index].text,width:width-512}).addClass('OxSelectable').bindEvent({submit:function(data){editItem('text',data.value);}}).appendTo($left);$('<div>').css({height:'16px'}).appendTo($left);}}
function renderList(){$right.empty();if(isEditable){$('<div>').css({height:'16px',marginBottom:'8px'}).append(Ox.Button({title:Ox._('Add'),width:92}).css({float:'left',margin:'0 4px 0 0'}).bindEvent({click:addItem})).append(Ox.Button({title:Ox._('Remove'),width:92}).css({float:'left',margin:'0 0 0 4px'}).bindEvent({click:removeItem})).appendTo($right);}
items.sort(function(a,b){return a.date<b.date?1:a.date>b.date?-1:0;}).forEach(function(item,i){Ox.Element().addClass('item').css({width:'172px',padding:'4px 8px 3px 8px',borderRadius:'8px',margin:'2px',backgroundColor:(item.id==pandora.user.ui.part.news)||(!pandora.user.ui.part.news&&i==0)?backgroundColor:'',cursor:'pointer'}).html('<span style="font-size: 14px; font-weight: bold">'+item.title+'</span>'
+'<br><span style="font-size: 9px">'
+Ox.formatDate(item.date,'%B %e, %Y')
+'</span>').bindEvent({anyclick:function(){pandora.UI.set('part.news',item.id);}}).appendTo($right);});$('<div>').css({height:'16px'}).appendTo($right);}
function selectItem(){renderItem();renderList();}
that.resizeElement=function(data){width=data.width;height=data.height;$left.css({width:width-512});$text&&$text.css({width:width-512});};that.selectItem=function(direction){var index=Ox.getIndexById(items,pandora.user.ui.part.news)+direction;if(index>-1&&index<items.length){pandora.UI.set('part.news',items[index].id);}};that.bindEvent({'pandora_part.news':selectItem});return that;};'use strict';pandora.ui.similarClipsDialog=function(){var dialogSize={height:Math.round((window.innerHeight-48)*0.9),width:Math.round(window.innerWidth*0.9)},left=getLeft(),fixedRatio=pandora.site.video.previewRatio,fps=25,item=pandora.getItemIdAndPosition(),itemWidth=160,sequence,$item,$list,$innerPanel=Ox.SplitPanel({elements:[{element:Ox.Element(),size:itemWidth},{element:Ox.Element()}],orientation:'horizontal'}),$toolbar=Ox.Bar({size:24}),$clipButtons=Ox.ButtonGroup({buttons:[{id:'previous',title:'left',disabled:true},{id:'next',title:'right',disabled:true}],type:'image'}).css({float:'left',width:'32px',margin:'4px'}).bindEvent({click:function(data){item.position=data.id=='previous'?sequence['in']-1/fps:sequence.out;getClips();}}).appendTo($toolbar),$modeButtons=Ox.ButtonGroup({buttons:[{id:'shape',title:Ox._('Similar Shapes')},{id:'color',title:Ox._('Similar Colors')}],selectable:true,value:pandora.user.ui.sequenceMode}).bindEvent({change:function(data){pandora.UI.set({sequenceMode:data.value});getClips();}}).css({position:'absolute',left:left,top:'4px',width:'256px',textAlign:'center'}).appendTo($toolbar),$sortSelect=Ox.Select({items:['title','director','position','duration'].map(function(id){var item=Ox.getObjectById(pandora.site.itemKeys,id)||Ox.getObjectById(pandora.site.clipKeys,id),title=Ox._(item?item.title:Ox.toTitleCase(id));return{id:id,title:Ox._('Sort by {0}',[title])};}),value:pandora.user.ui.sequenceSort[0].key,width:128}).bindEvent({change:function(data){var key=data.value;pandora.UI.set({sequenceSort:[{key:key,operator:pandora.getSortOperator(key)}]});updateOrderButton();$list.options({sort:pandora.user.ui.sequenceSort});}}),$orderButton=Ox.Button({overlap:'left',title:getTitle(),tooltip:getTooltip(),type:'image'}).bindEvent({click:function(){pandora.UI.set({sequenceSort:[{key:pandora.user.ui.sequenceSort[0].key,operator:pandora.user.ui.sequenceSort[0].operator=='+'?'-':'+'}]});updateOrderButton();$list.options({sort:pandora.user.ui.sequenceSort});}}),$sortElement=Ox.FormElementGroup({elements:[$sortSelect,$orderButton],float:'right'}).css({float:'right',margin:'4px'}).appendTo($toolbar),$outerPanel=Ox.SplitPanel({elements:[{element:$toolbar,size:24},{element:$innerPanel}],orientation:'vertical'}),$dialog=Ox.Dialog({buttons:[Ox.Button({disabled:true,id:'open',title:Ox._('Open Selected Clip'),width:128}).bindEvent({click:openClip}),Ox.Button({id:'close',title:Ox._('Close'),width:64}).bindEvent({click:function(){$dialog.close();}})],closeButton:true,content:$outerPanel,height:dialogSize.height,keys:{escape:'close'},maximizeButton:true,padding:0,removeOnClose:true,title:Ox._('Similar Clips'),width:dialogSize.width}).bindEvent({resize:function(data){dialogSize=data;left=getLeft();$modeButtons.css({left:left});$status.css({left:left});}}),$statusbar=$dialog.children('.OxButtonsbar'),$image=$('<img>').attr({src:getImageURL()}).css({float:'left',width:'24px',height:'16px',borderRadius:'2px',margin:'4px 4px 4px 8px',boxShadow:'0 0 1px rgb(128, 128, 128)'}).appendTo($statusbar),$status=Ox.Element().css({position:'absolute',left:left,top:'6px',width:'256px',fontSize:'9px',textAlign:'center'}).html(Ox._('Loading...')).appendTo($statusbar);getClips();function changeClip(data){var split=data.ids[0].replace('-','/').split('/');item.id=split[0];item.position=parseFloat(split[1]);$item=null;getClips();}
function getClips(){$dialog&&$dialog.disableButton('open');$status&&$status.html(Ox._('Loading...'));pandora.api.get({id:item.id,keys:['director','duration','title','videoRatio']},function(result){Ox.extend(item,result.data);pandora.api.getSequence({id:item.id,mode:pandora.user.ui.sequenceMode,position:item.position},function(result){if(Ox.isEmpty(result.data)){result.data['in']=item.position;result.data.out=item.position+1/fps;result.data.id=item.id+'/'
+Ox.formatNumber(result.data['in'],3)+'-'
+Ox.formatNumber(result.data.out,3)}
sequence=Ox.extend({},item,result.data);$clipButtons[sequence['in']>0?'enableButton':'disableButton']('previous');$clipButtons[sequence.out<item.duration?'enableButton':'disableButton']('next');$item=Ox.IconList({fixedRatio:fixedRatio,item:getItem,items:function(data,callback){setTimeout(function(){callback({data:{items:data.keys?[sequence]:1},status:{code:200,text:'ok'}});},25);},max:0,orientation:'both',size:128,sort:[{key:'id',operator:'+'}],unique:'id'});$innerPanel.replaceElement(0,$item);if(sequence.hash){$list=Ox.IconList({fixedRatio:fixedRatio,item:getItem,items:function(data,callback){pandora.api.findSequences(Ox.extend(data,{query:{conditions:[{key:'id',value:sequence.id,operator:'!='},{key:'mode',value:pandora.user.ui.sequenceMode,operator:'=='},{key:'hash',value:sequence.hash,operator:'=='}],operator:'&'}}),callback);},keys:['director','id','title','videoRatio'],max:1,orientation:'both',size:128,sort:Ox.clone(pandora.user.ui.sequenceSort),unique:'id'}).bindEvent({init:function(data){$status.html(Ox.toTitleCase(Ox.formatCount(data.items,'clip')));},open:changeClip,select:function(data){$dialog[data.ids.length?'enableButton':'disableButton']('open');}});}else{$list=Ox.Element();$status.html('No Clips');}
$innerPanel.replaceElement(1,$list);$image.attr({src:getImageURL(sequence.hash)});});});}
function getImageURL(hash){var canvas=$('<canvas>').attr({width:8,height:8})[0],context=canvas.getContext('2d'),imageData=context.getImageData(0,0,8,8),data=imageData.data;if(hash){if(pandora.user.ui.sequenceMode=='shape'){Ox.loop(8,function(y){var value=parseInt(hash.substr(14-y*2,2),16);Ox.loop(8,function(x){var color=value&Math.pow(2,x)?255:0,index=y*32+x*4;Ox.loop(3,function(i){data[index+i]=color;});data[index+3]=255;});});}else if(pandora.user.ui.sequenceMode=='color'){Ox.loop(8,function(part){var x=part%4*2,y=Math.floor(part/4)*4,value=parseInt(hash.substr(14-part*2,2),16),color=[(value>>5)*32,(value>>2&7)*32,(value&3)*64];Ox.loop(4,function(dy){Ox.loop(2,function(dx){var index=(y+dy)*32+(x+dx)*4;Ox.loop(3,function(i){data[index+i]=color[i];});data[index+3]=255;});});});}
context.putImageData(imageData,0,0);}
return canvas.toDataURL();}
function getItem(data,sort,size){var ratio=data.videoRatio,width=ratio>fixedRatio?size:Math.round(size*ratio/fixedRatio),height=Math.round(width/ratio);return{height:height,id:data.id,info:Ox.formatDuration(data['in'],2)+'-'+Ox.formatDuration(data.out,2),title:data.title+(data.director.length?' ('+data.director.join(', ')+')':''),url:'/'+data.id.split('/')[0]+'/'+height+'p'+data['in']+'.jpg',width:width};}
function getLeft(){return Math.floor((dialogSize.width-256)/2)+'px';}
function getTitle(){return pandora.user.ui.sequenceSort[0].operator=='+'?Ox._('up'):Ox._('down');}
function getTooltip(){return pandora.user.ui.sequenceSort[0].operator=='+'?Ox._('Ascending'):Ox._('Descending');}
function openClip(){var selected=$list.options('selected')[0],split=selected.replace('-','/').split('/'),item=split[0],inPoint=parseFloat(split[1]),outPoint=parseFloat(split[2]),set={item:item,itemView:pandora.user.ui.videoView};set['videoPoints.'+split[0]]={annotation:'','in':inPoint,out:outPoint,position:inPoint};$dialog.close();pandora.UI.set(set)}
function updateOrderButton(){$orderButton.options({title:getTitle(),tooltip:getTooltip()});}
return $dialog;};'use strict';pandora.ui.eventsDialog=function(options){var height=Math.round((window.innerHeight-48)*0.9),width=Math.round(window.innerWidth*0.9),that=Ox.Dialog({buttons:[Ox.Button({id:'managePlaces',title:Ox._('Manage Places...')}).bindEvent({click:function(){that.close();(pandora.$ui.placesDialog||(pandora.$ui.placesDialog=pandora.ui.placesDialog())).open();}}),{},Ox.Button({id:'exportEvents',title:Ox._('Export Events...')}).bindEvent({click:function(){var $button=this,keys=['name','alternativeNames','start','end'];$button.options({disabled:true});pandora.api.findEvents({query:{conditions:[],operator:'&'},keys:keys,range:[0,1000000],sort:[{key:'name',operator:'+'}]},function(result){pandora.ui.exportDialog({data:JSON.stringify(result.data.items.map(function(item){Object.keys(item).filter(function(key){return!Ox.contains(keys,key);}).forEach(function(key){delete item[key];});return item;}),null,'    '),title:Ox._('Events')}).open();$button.options({disabled:false});});}}),Ox.Button({id:'done',title:Ox._('Done'),width:48}).bindEvent({click:function(){that.close();}})],closeButton:true,content:Ox.LoadingScreen(),height:height,maximizeButton:true,minHeight:256,minWidth:512,padding:0,title:Ox._('Manage Events'),width:width}).bindEvent({resize:function(data){$content&&$content.options({height:data.height});},resizeend:function(data){$content&&$content.options({height:data.height,width:data.width});}}),$content;pandora.api.findEvents({query:{conditions:[],operator:'&'}},function(result){pandora.api.findEvents({query:{conditions:[],operator:'&'},keys:[],range:[0,result.data.items],sort:[{key:'name',operator:'+'}]},function(result){that.options({content:$content=Ox.CalendarEditor({addEvent:function(event,callback){pandora.api.addEvent(event,function(result){Ox.Request.clearCache();callback(result);});},editEvent:function(event,callback){pandora.api.editEvent(event,function(result){Ox.Request.clearCache();callback(result);});},events:result.data.items,hasMatches:true,height:height,mode:pandora.site.calendar=='auto'?'add':'define',removeEvent:function(event,callback){pandora.api.removeEvent(event,function(result){Ox.Request.clearCache();callback(result);});},selected:options?options.id:'',showControls:pandora.user.ui.showCalendarControls,width:width})});})})
return that;};'use strict';pandora.ui.sectionButtons=function(section){var that=Ox.ButtonGroup({buttons:[{id:'items',title:Ox._(pandora.site.itemName.plural)},{id:'edits',title:Ox._('Edits'),disabled:pandora.user.level!='admin'},{id:'texts',title:Ox._('Texts'),disabled:pandora.user.level!='admin'}],id:'sectionButtons',selectable:true,value:section||pandora.user.ui.section}).css({float:'left',margin:'4px'}).bindEvent({change:function(data){var section=data.value;pandora.UI.set({section:section});}});return that;};'use strict';pandora.ui.mainPanel=function(){var that=Ox.SplitPanel({elements:[{collapsible:true,collapsed:!pandora.user.ui.showSidebar,element:pandora.$ui.leftPanel=pandora.ui.leftPanel(),resizable:true,resize:[192,256,320,384],size:pandora.user.ui.sidebarSize,tooltip:'sidebar <span class="OxBright">'
+Ox.SYMBOLS.SHIFT+'S</span>'},{element:pandora.user.ui.section=='items'?pandora.$ui.rightPanel=pandora.ui.rightPanel():pandora.user.ui.section=='edits'?pandora.$ui.editPanel=pandora.ui.editPanel():pandora.$ui.textPanel=pandora.ui.textPanel()}],orientation:'horizontal'}).bindEvent({pandora_edit:function(data){that.replaceElement(1,pandora.$ui.editPanel=pandora.ui.editPanel());},pandora_find:function(){var previousUI=pandora.UI.getPrevious();Ox.Log('FIND','handled in mainPanel',previousUI.item,previousUI._list)
if(!previousUI.item&&pandora.user.ui._list==previousUI._list){if(['map','calendar'].indexOf(pandora.user.ui.listView)>-1){pandora.$ui.contentPanel.replaceElement(1,pandora.ui.navigationView(pandora.user.ui.listView));}else{if(['clips','clip'].indexOf(pandora.user.ui.listView)>-1){pandora.$ui.list.options({find:pandora.user.ui.itemFind});}
pandora.$ui.list.reloadList();}
pandora.user.ui._filterState.forEach(function(data,i){if(!Ox.isEqual(data.selected,previousUI._filterState[i].selected)){pandora.$ui.filters[i].options(pandora.user.ui.showFilters?{selected:data.selected}:{_selected:data.selected,selected:[]});}
if(!Ox.isEqual(data.find,previousUI._filterState[i].find)){if(!pandora.user.ui.showFilters){pandora.$ui.filters[i].options({_selected:data.selected});}
pandora.$ui.filters[i].reloadList();}});}else{if(pandora.stayInItemView){pandora.stayInItemView=false;}else{that.replaceElement(1,pandora.$ui.rightPanel=pandora.ui.rightPanel());}}},pandora_item:function(data){if(!data.value||!data.previousValue){that.replaceElement(1,pandora.$ui.rightPanel=pandora.ui.rightPanel());}},pandora_section:function(data){if(data.value!=data.previousValue){that.replaceElement(0,pandora.$ui.leftPanel=pandora.ui.leftPanel());that.replaceElement(1,pandora.$ui.rightPanel=pandora.ui.rightPanel());}},pandora_showsidebar:function(data){data.value==that.options('elements')[0].collapsed&&that.toggle(0);},pandora_text:function(data){that.replaceElement(1,pandora.$ui.textPanel=pandora.ui.textPanel());}});return that;};'use strict';pandora.ui.statusbar=function(){var $text={titleTotal:Ox.Element('<span>').html(Ox._('Total: ')),total:Ox.Element('<span>'),titleSelected:Ox.Element('<span>').html(' &mdash; '+Ox._('Selected: ')),selected:Ox.Element('<span>'),loading:Ox.Element('<span>').html(Ox._('Loading...'))},that=Ox.Bar({size:16}).css({textAlign:'center'}).append(Ox.Element().css({margin:'2px 4px',fontSize:'9px',overflow:'hidden',textOverflow:'ellipsis'}).append($text.loading).append($text.titleTotal).append($text.total).append($text.titleSelected).append($text.selected));function setTotal(){pandora.api.find({query:pandora.user.ui.find,sort:pandora.user.ui.listSort},function(result){that.set('selected',{items:0});that.set('total',result.data);});}
that.set=function(key,data){if(key=='loading'){Ox.forEach($text,function($element,key){$element[key=='loading'?'show':'hide']();});}else{$text.loading.hide();if(key=='selected'){if(data.items==0){$text.titleTotal.hide();$text.titleSelected.hide();$text.selected.hide();}else{$text.titleTotal.show();$text.titleSelected.show();$text.selected.html(pandora.getStatusText(data)).show();}}else{$text.total.html(pandora.getStatusText(data)).show();}}};that.bindEvent({pandora_find:function(){that.set('loading');if(['map','calendar'].indexOf(pandora.user.ui.listView)>-1){setTotal();}},pandora_listview:function(data){var isNavigationView=['map','calendar'].indexOf(data.value)>-1,wasNavigationView=['map','calendar'].indexOf(data.previousValue)>-1;that.set('loading');if(isNavigationView&&!wasNavigationView){setTotal();}}});that.set('loading');if(['map','calendar'].indexOf(pandora.user.ui.listView)>-1){setTotal();}
return that;};'use strict';pandora.ui.iconDialog=function(options){var options=Ox.extend({closeButton:false,content:'',height:128,keys:null,title:'',width:368,},options),that=Ox.Dialog({buttons:options.buttons,closeButton:options.closeButton,content:Ox.Element().append($('<img>').attr({src:'/static/png/icon.png'}).css({position:'absolute',left:'16px',top:'16px',width:'64px',height:'64px'})).append(Ox.isObject(options.content)?options.content.css({position:'absolute',left:'96px',top:'16px',width:options.width-112+'px'}):$('<div>').addClass('OxTextPage').css({position:'absolute',left:'96px',top:'16px',width:options.width-112+'px'}).html(options.content)),fixedSize:true,height:options.height,keys:options.keys,removeOnClose:true,title:options.title,width:options.width});return that;};'use strict';pandora.ui.insertEmbedDialog=function(){if(arguments.length==1){var url,callback=arguments[0];}else{var url=arguments[0],callback=arguments[1];}
var advanced=pandora.user.ui.showAdvancedEmbedOptions,dialogHeight=344,dialogWidth=416+Ox.UI.SCROLLBAR_SIZE,formWidth=dialogWidth-32-Ox.UI.SCROLLBAR_SIZE,that=Ox.Dialog({buttons:[Ox.Button({id:'cancel',title:Ox._('Cancel'),width:64}).bindEvent({click:function(){that.close();}}),Ox.Button({id:'insert',title:Ox._('Insert'),width:64}).bindEvent({click:function(){callback($input.url.options('value'));that.close();}})],closeButton:true,content:Ox.Element(),height:dialogHeight,keys:{enter:'insert',escape:'cancel'},removeOnClose:true,title:Ox._('Insert Embed'),width:dialogWidth}),$input={},api=pandora.api,duration,item,options={keys:['id','duration'],query:{conditions:[],operator:'&'},range:[0,1],sort:[{key:'id',operator:'+'}],},sites=[pandora.site.site].concat(pandora.site.sites).map(function(site){return{id:site.url,title:site.url,https:site.https};});api.find(options,function(result){duration=result.data.items[0].duration;item=result.data.items[0].id;var $panel=Ox.TabPanel({content:function(id){if(id=='video'){var $content=Ox.TabPanel({content:function(id_){pandora.UI.set({showAdvancedEmbedOptions:id_=='advanced'});return getForm(id);},tabs:[{id:'basic',title:Ox._('Basic'),selected:!advanced},{id:'advanced',title:Ox._('Advanced'),selected:advanced}]});}else{}
return $content;},tabs:[{id:'video',title:Ox._('Video'),selected:true},{id:'map',title:Ox._('Map'),disabled:true},{id:'calendar',title:Ox._('Calendar'),disabled:true}]});that.options({content:$panel});});function getForm(id){var $form;if(id=='video'){$form=$('<div>').attr({id:'form'}).css({padding:'16px',overflowY:'auto'});$input.url=Ox.Input({label:Ox._('URL'),labelWidth:128,width:formWidth,value:url}).bindEvent({change:function(data){parseURL(data.value);}}).css({display:'inline-block',margin:'4px 0'}).appendTo($form);space().appendTo($form);$input.protocol=Ox.Select({items:[{id:'http',title:'http'},{id:'https',title:'https',disabled:!pandora.site.site.https}],label:Ox._('Protocol'),labelWidth:128,value:pandora.site.site.https?'https':'http',width:formWidth}).bindEvent({change:formatURL}).addClass('advanced').css({display:'inline-block',margin:'4px 0'}).appendTo($form);$input.site=Ox.SelectInput({inputWidth:128,items:sites.concat([{id:'other',title:Ox._('Other...')}]),label:Ox._('Site'),labelWidth:128,placeholder:'example.com',max:1,min:1,value:pandora.site.site.url,width:formWidth}).bindEvent({change:function(data){if(data.value){var site=Ox.getObjectById(sites,data.value);$input.protocol[!site||site.https?'enableItem':'disableItem']('https').options({value:!site||!site.https?'http':'https'});updateAPI(data.value,formatURL);}}}).addClass('advanced').css({display:'inline-block',margin:'4px 0'}).appendTo($form);$input.item=Ox.Input({label:Ox._(pandora.site.itemName.singular),labelWidth:128,value:item,width:formWidth}).css({display:'inline-block',margin:'4px 0'}).bindEvent({change:function(data){api.get({id:data.value,keys:['duration']},function(result){if(result.data){duration=result.data.duration;}else{$input.item.options({value:item});}});formatURL();}}).appendTo($form);$input.link=Ox.Select({items:[{id:'default',title:Ox._('Default')},{id:'player',title:Ox._('Player')},{id:'editor',title:Ox._('Editor')},{id:'timeline',title:Ox._('Timeline')}],label:Ox._('Link'),labelWidth:128,value:'default',width:formWidth}).addClass('advanced').css({display:'inline-block',margin:'4px 0'}).bindEvent({change:formatURL}).appendTo($form);$input.position=Ox.Input({label:Ox._('Position'),labelWidth:128,placeholder:'00:00:00.000',width:formWidth}).addClass('advanced').css({display:'inline-block',margin:'4px 0'}).bindEvent({change:function(data){var hasInAndOut=$input['in'].options('value')!=='';if(data.value){$input.position.options({value:limitPoint(data.value,hasInAndOut?$input['in'].options('value'):0,hasInAndOut?$input.out.options('value'):duration)});}
$input.annotation.options({value:''});formatURL();}}).appendTo($form);$input['in']=Ox.Input({label:Ox._('In Point'),labelWidth:128,placeholder:'00:00:00.000',width:formWidth}).css({display:'inline-block',margin:'4px 0'}).bindEvent({change:function(data){if(data.value){$input['in'].options({value:limitPoint(data.value,0,duration)});if($input.out.options('value')===''){$input.out.options({value:Ox.formatDuration(duration)});}else if(Ox.parseDuration($input.out.options('value'))<Ox.parseDuration(data.value)){$input.out.options({value:data.value});}
$input.annotation.options({value:''});}
formatURL();}}).appendTo($form);$input.out=Ox.Input({label:Ox._('Out Point'),labelWidth:128,placeholder:'00:00:00.000',width:formWidth}).css({display:'inline-block',margin:'4px 0'}).bindEvent({change:function(data){if(data.value){$input.out.options({value:limitPoint(data.value,0,duration)});if($input['in'].options('value')===''){$input['in'].options({value:Ox.formatDuration(0)});}else if(Ox.parseDuration($input['in'].options('value'))>Ox.parseDuration(data.value)){$input['in'].options({value:data.value});}
$input.annotation.options({value:''});}
formatURL();}}).appendTo($form);$input.annotation=Ox.Input({label:Ox._('Annotation'),labelWidth:128,width:formWidth}).css({display:'inline-block',margin:'4px 0'}).bindEvent({change:function(data){['position','in','out'].forEach(function(key){$input[key].options({value:''});});formatURL();}}).appendTo($form);space().appendTo($form);$input.title=Ox.Input({label:Ox._('Title'),labelWidth:128,width:formWidth}).addClass('advanced').css({display:'inline-block',margin:'4px 0'}).bindEvent({change:formatURL}).appendTo($form);$input.showTimeline=Ox.Checkbox({label:Ox._('Show Large Timeline'),labelWidth:128,value:false,width:formWidth}).addClass('advanced').css({display:'inline-block',margin:'4px 0'}).bindEvent({change:function(){updateForm();formatURL();}}).appendTo($form);$input.timeline=Ox.Select({items:[{id:'default',title:Ox._('Default')}].concat(pandora.site.timelines),label:Ox._('Timeline'),labelWidth:128,value:'default',width:formWidth}).addClass('advanced').css({display:'inline-block',margin:'4px 0'}).bindEvent({change:formatURL}).appendTo($form);$input.showAnnotations=Ox.Checkbox({label:Ox._('Show Annotations'),labelWidth:128,value:false,width:formWidth}).addClass('advanced').css({display:'inline-block',margin:'4px 0'}).bindEvent({change:function(){updateForm();formatURL();}}).appendTo($form);var $showLayersLabel=Ox.Label({title:Ox._('Show Layers'),width:formWidth}).addClass('advanced').css({display:'inline-block',margin:'4px 0'}).bindEvent({change:formatURL}).appendTo($form);$input.showLayers=Ox.CheckboxGroup({checkboxes:pandora.site.layers.map(function(layer){return{id:layer.id,title:layer.title};}),max:pandora.site.layers.length,min:0,type:'list',value:pandora.site.layers.map(function(layer){return layer.id;}),width:formWidth-128}).addClass('advanced').css({display:'inline-block',margin:'4px 0 4px 128px'}).bindEvent({change:formatURL}).appendTo($form);url?parseURL(url):formatURL();updateForm();}else{}
function formatURL(){var data=Ox.map($input,function($element){return $element.options('value');});Ox.print('FU',data.protocol+'://'
+data.site+'/'
+data.item+'/'
+(data.link=='default'?'':data.link+'/')
+([data.position]||[]).concat(data['in']||data.out?[data['in'],data.out]:[]).join(','),+(data.annotation||'')
+'#embed?'
+Ox.serialize({title:data.title,showTimeline:data.showTimeline||null,timeline:data.timeline,showAnnotations:data.showAnnotations||null,showLayers:data.showAnnotations&&data.showLayers?data.showLayers:null,matchRatio:true},true));$input.url.options({value:data.protocol+'://'
+data.site+'/'
+data.item+'/'
+(data.link=='default'?'':data.link+'/')
+([data.position]||[]).concat(data['in']||data.out?[data['in'],data.out]:[]).join(',')
+(data.annotation||'')
+'#embed?'
+Ox.serialize({title:data.title,showTimeline:data.showTimeline||null,timeline:data.timeline,showAnnotations:data.showAnnotations||null,showLayers:data.showAnnotations&&data.showLayers?data.showLayers:null,matchRatio:true},true)});}
function limitPoint(value,min,max){if(Ox.typeOf(min)=='number'){min=Ox.formatDuration(min)}
if(Ox.typeOf(max)=='number'){max=Ox.formatDuration(max)}
return Ox.formatDuration(Ox.limit(Ox.parseDuration(value),Ox.parseDuration(min),Ox.parseDuration(max)));}
function parseURL(url){var parsed=Ox.parseURL(url),protocol=parsed.protocol.replace(/:$/,''),site=parsed.hostname,isSameSite=site==$input.site.options('value');(isSameSite?Ox.noop:updateAPI)(site,function(){pandora.URL.parse(parsed.pathname+parsed.search+parsed.hash,function(state){var isSameItem=isSameSite&&state.item==item,id=(isSameSite?state.item:url.split('/')[3])||item,query={};if(state.hash&&state.hash.query){state.hash.query.forEach(function(condition){query[condition.key]=condition.value;});}
(isSameItem?Ox.noop:api.get)({id:id,keys:['duration']},function(result){if(result&&result.data){duration=result.data.duration;item=id;}
Ox.forEach({protocol:protocol,site:site,item:item,link:state.view||'default',position:Ox.isArray(state.span)?Ox.formatDuration(state.span[0]):'','in':Ox.isArray(state.span)?Ox.formatDuration(state.span[state.span.length-2]):'',out:Ox.isArray(state.span)?Ox.formatDuration(state.span[state.span.length-1]):'',annotation:Ox.isString(state.span)?state.span:'',title:query.title||'',showTimeline:query.showTimeline||false,timeline:query.timeline||'default',showAnnotations:query.showAnnotations||false,showLayers:query.showLayers||pandora.site.layers.map(function(layer){return layer.id;})},function(value,key){Ox.print('????',key,value);$input[key].options({value:value});});});});});}
function updateAPI(url,callback){api=Ox.API({url:$input.protocol.options('value')+'://'+url+'/api/'},function(){api.find(options,function(result){duration=result.data.items[0].duration;item=result.data.items[0].id;$input.item.options({value:item});callback();});});}
function updateForm(){$form.find('.advanced')[pandora.user.ui.showAdvancedEmbedOptions?'show':'hide']();$input.timeline[$input.showTimeline.options('value')?'show':'hide']();$showLayersLabel[$input.showAnnotations.options('value')?'show':'hide']();$input.showLayers[$input.showAnnotations.options('value')?'show':'hide']();}
function space(){return $('<div>').css({height:'16px',width:formWidth+'px'});}
return $form;}
return that;};'use strict';pandora.ui.folderList=function(id,section){section=section||pandora.user.section;var ui=pandora.user.ui,i=Ox.getIndexById(pandora.site.sectionFolders[section],id),folderItems=section=='items'?'Lists':Ox.toTitleCase(section),folderItem=folderItems.slice(0,-1),canEditFeatured=pandora.site.capabilities['canEditFeatured'+folderItems][pandora.user.level],that;var columns,items;if(id!='volumes'){columns=[{clickable:function(data){return data.user==pandora.user.username||(id=='featured'&&canEditFeatured);},format:function(value,data){return $('<img>').attr({src:'/'+folderItem.toLowerCase()+'/'+encodeURIComponent(data.id)+'/icon.jpg?'+data.modified}).css({width:'14px',height:'14px',borderRadius:'4px',margin:'0 0 0 -3px'});},id:'user',operator:'+',tooltip:function(data){return data.user==pandora.user.username||(id=='featured'&&canEditFeatured)?Ox._('Edit Icon'):'';},visible:true,width:16},{format:function(value){return Ox.encodeHTMLEntities(value.split(':').join(': '));},id:'id',operator:'+',visible:id=='favorite',width:ui.sidebarWidth-(section=='items'?96:48)},{editable:function(data){return data.user==pandora.user.username;},format:function(value){return Ox.encodeHTMLEntities(value);},id:'name',input:{autovalidate:pandora.ui.autovalidateListname},operator:'+',tooltip:id=='personal'?Ox._('Edit Title'):'',unformat:function(value){return Ox.decodeHTMLEntities(value);},visible:id!='favorite',width:ui.sidebarWidth-(section=='items'?96:48)},{align:'right',id:'items',format:{type:'number'},operator:'-',visible:section=='items',width:48},{clickable:function(data){return section=='items'&&(data.type=='smart'||data.user==pandora.user.username);},format:function(value,data){return $('<img>').attr({src:Ox.UI.getImageURL(value=='static'?'symbolClick':value=='smart'?'symbolFind':value=='html'?'symbolFile':'symbolBook')}).css({width:'10px',height:'10px',padding:'3px',opacity:section=='texts'||data.user==pandora.user.username?1:0.25});},id:'type',operator:'+',tooltip:function(data){return data.type=='static'?(data.user==pandora.user.username?Ox._('Edit Default View'):Ox._('Default View: ...')):data.type=='smart'?(data.user==pandora.user.username?Ox._('Edit Query'):Ox._('Show Query')):data.type.toUpperCase();},visible:true,width:16},{clickable:id=='personal',format:function(value){var symbols={personal:'Publish',favorite:'Like',featured:'Star'};return $('<img>').attr({src:Ox.UI.getImageURL('symbol'+symbols[id])}).css({width:'10px',height:'10px',padding:'3px',opacity:value=='private'?0.25:1});},id:'status',operator:'+',tooltip:id=='personal'?function(data){return data.status=='private'?Ox._('Make Public'):Ox._('Make Private');}:null,visible:true,width:16}];items=function(data,callback){var query;if(id=='personal'){query={conditions:[{key:'user',value:pandora.user.username,operator:'=='},{key:'status',value:'featured',operator:'!='}],operator:'&'};}else if(id=='favorite'){query={conditions:[{key:'subscribed',value:true,operator:'='},{key:'status',value:'featured',operator:'!='}],operator:'&'};}else if(id=='featured'){query={conditions:[{key:'status',value:'featured',operator:'='}],operator:'&'};}
return pandora.api['find'+folderItems](Ox.extend(data,{query:query}),callback);};}else{columns=[{format:function(){return $('<img>').attr({src:Ox.UI.getImageURL('symbolVolume')}).css({width:'10px',height:'10px',padding:'3px'});},id:'user',operator:'+',visible:true,width:16},{editable:true,id:'name',operator:'+',tooltip:Ox._('Edit Title'),visible:true,width:ui.sidebarWidth-96},{align:'right',id:'items',format:{type:'number'},operator:'-',visible:true,width:48},{clickable:function(data){return data.mounted;},format:function(value,data){return $('<img>').attr({src:Ox.UI.getImageURL(data.mounted?'symbolSync':'symbolEdit')}).css({width:'10px',height:'10px',padding:'3px'});},id:'path',operator:'+',tooltip:function(data){return data.mounted?Ox._('Scan Volume'):Ox._('Edit Path');},visible:true,width:16},{clickable:true,format:function(value,data){return $('<img>').attr({src:Ox.UI.getImageURL('symbolMount')}).css({width:'10px',height:'10px',padding:'3px 2px 1px 2px',opacity:data.mounted?1:0.25});},id:'mounted',operator:'+',tooltip:function(data){return data.mounted?Ox._('Unmount Volume'):Ox._('Mount Volume');},visible:true,width:16}];items=function(data,callback){var volumes=pandora.user.volumes||[];if(!data.keys){data={items:volumes.length};}else{data={items:volumes.map(function(volume){return Ox.extend({id:volume.name,user:pandora.user.username},volume);})};}
setTimeout(function(){callback({data:data});},1000);};}
that=Ox.TableList({columns:columns,droppable:id!='volumes',items:items,keys:['modified'].concat(section=='items'?['query']:['rightslevel']),max:1,min:0,pageLength:1000,sort:[{key:'position',operator:'+'}],sortable:id!='featured'||canEditFeatured,unique:id!='volumes'?'id':'name'}).css({left:0,top:0,width:ui.sidebarWidth+'px'}).bindEvent({add:function(event){if(id=='personal'){if(event.keys==''||event.keys=='alt'){pandora.api.addList({name:Ox._('Untitled'),status:'private',type:event.keys==''?'static':'smart'},function(result){var id=result.data.id;pandora.UI.set({find:{conditions:[{key:'list',value:id,operator:'=='}],operator:'&'}});Ox.Request.clearCache();that.reloadList().bindEventOnce({load:function(data){that.gainFocus().options({selected:[id]}).editCell(id,'name');}});});}}else if(id=='favorite'||(id=='featured'&&canEditFeatured)){pandora.$ui.manageListsButton[id].options({value:true});}},click:function(data){if(data.key=='user'){pandora.$ui.listDialog=pandora.ui.listDialog('icon').open();}else if(data.key=='type'){if(that.value(data.id,'type')=='smart'){pandora.$ui.listDialog=pandora.ui.listDialog('query').open();}}else if(data.key=='status'){var status=that.value(data.id,data.key)=='private'?'public':'private';pandora.changeFolderItemStatus(data.id,status,function(result){that.value(result.data.id,'status',result.data.status);});}else if(data.key=='path'){}else if(data.key=='mounted'){alert(JSON.stringify(data));}},'delete':function(data){if(id=='personal'){pandora.ui.deleteListDialog(data.ids[0]).open();}else if(id=='favorite'){that.options({selected:[]});pandora.api['unsubscribeFrom'+folderItem]({id:data.ids[0]},function(result){Ox.Request.clearCache();that.reloadList();});}else if(id=='featured'&&canEditFeatured){that.options({selected:[]});pandora.api['edit'+folderItem]({id:data.ids[0],status:'public'},function(result){if(result.data.user==pandora.user.username||result.data.subscribed){Ox.Request.clearCache();pandora.$ui.folderList[result.data.user==pandora.user.username?'personal':'favorite'].reloadList();}
that.reloadList();});}},init:function(data){if(pandora.site.sectionFolders[section][i]){pandora.site.sectionFolders[section][i].items=data.items;pandora.$ui.folder[i].$content.css({height:data.items*16+'px'});pandora.$ui.folderList[id].css({height:data.items*16+'px'});}
pandora.resizeFolders();},move:function(data){pandora.api['sort'+folderItems]({section:id,ids:data.ids},function(){Ox.Request.clearCache('find'+folderItems);});},paste:function(){pandora.$ui.list.triggerEvent('paste');},select:function(data){var list=data.ids.length?data.ids[0]:'';if(list){Ox.forEach(pandora.$ui.folderList,function($list,id_){id!=id_&&$list.options('selected',[]);});}
if(section=='items'){pandora.UI.set({find:{conditions:list?[{key:'list',value:data.ids[0],operator:'=='}]:[],operator:'&'}});}else{pandora.UI.set(section.slice(0,-1),list);}},submit:function(data){var data_={id:data.id};data_[data.key]=data.value;pandora.api['edit'+folderItem](data_,function(result){if(result.data.id!=data.id){Ox.Request.clearCache();pandora.renameList(data.id,result.data.id,result.data.name,id);pandora.$ui.info.updateListInfo();}});}});return that;};'use strict';pandora.URL=(function(){var self={},that={};function getState(){Ox.Log('URL','getState:, UI',pandora.user.ui)
var state={};if(pandora.user.ui.page){state.page=pandora.user.ui.page;if(Ox.contains(Object.keys(pandora.site.user.ui.part),state.page)){state.part=pandora.user.ui.part[state.page];}}else{state.type=pandora.user.ui.section=='items'?pandora.site.itemsSection:pandora.user.ui.section;state.item=pandora.user.ui[pandora.user.ui.section.slice(0,-1)];if(pandora.user.ui.section=='items'){if(!pandora.user.ui.item){state.view=pandora.user.ui.listView;state.sort=pandora.user.ui.listSort;state.find=pandora.user.ui.find;}else{state.view=pandora.user.ui.itemView;state.sort=pandora.user.ui.itemSort;}
if(state.view=='map'){state.span=pandora.user.ui.mapFind?'@'+pandora.user.ui.mapFind:pandora.user.ui.mapSelection?'@'+pandora.user.ui.mapSelection:'';}else if(state.view=='calendar'){}else if(['timeline','player','editor'].indexOf(state.view)>-1){var videoPoints=pandora.user.ui.videoPoints[state.item]||{};state.span=videoPoints.annotation||[].concat(videoPoints.position?videoPoints.position:[],videoPoints['in']||videoPoints.out?[videoPoints['in'],videoPoints.out]:[]);}}else if(pandora.user.ui.section=='edits'){var editPoints=pandora.user.ui.edits[state.item]||{};state.span=editPoints.clip||[].concat(editPoints.position?editPoints.position:[],editPoints['in']||editPoints.out?[editPoints['in'],editPoints.out]:[]);}else if(pandora.user.ui.section=='texts'){var position=pandora.user.ui.texts[state.item]?pandora.user.ui.texts[state.item].position:0;if(position){state.span=[position];}}}
if(pandora.user.ui._hash&&(pandora.user.ui._hash.anchor||!Ox.isEmpty(pandora.user.ui._hash.query))){state.hash={};if(pandora.user.ui._hash.anchor){state.hash.anchor=pandora.user.ui._hash.anchor;}
if(!Ox.isEmpty(pandora.user.ui._hash.query)){state.hash.query=pandora.user.ui._hash.query;}}
Ox.Log('URL','GOT STATE ...',state)
return state;}
function setState(state,callback){var set={};Ox.Log('URL','setState:',state);pandora.user.ui._list=pandora.getListState(pandora.user.ui.find);pandora.user.ui._filterState=pandora.getFilterState(pandora.user.ui.find);pandora.user.ui._findState=pandora.getFindState(pandora.user.ui.find);if(Ox.isEmpty(state)){callback&&callback();}else{pandora.user.ui._hash=state.hash;if(state.hash&&!Ox.contains(['embed','print'],state.hash.anchor)&&state.hash.query){state.hash.query.forEach(function(kv){set[kv.key]=kv.value;});}
if(state.page){set.page=state.page;if(Ox.contains(Object.keys(pandora.site.user.ui.part),state.page)&&state.part){set['part.'+state.page]=state.part;}
pandora.UI.set(set);callback&&callback();}else{set.page='';if(state.type){set.section=state.type==pandora.site.itemsSection?'items':state.type
set[set.section.slice(0,-1)]=state.item;}
if(set.section=='items'){if(state.view){set[!state.item?'listView':'itemView']=state.view;}
if(state.span){if(['timeline','player','editor'].indexOf(state.view)>-1){if(Ox.isArray(state.span)){set['videoPoints.'+state.item]={annotation:'','in':state.span[state.span.length-2]||0,out:state.span.length==1?0:Math.max(state.span[state.span.length-2],state.span[state.span.length-1]),position:state.span[0]};}else{set['videoPoints.'+state.item+'.annotation']=state.span;}}else if(state.view=='map'){if(state.span[0]!='@'){set.mapSelection=state.span;set.mapFind='';}else{set.mapFind=state.span.slice(1);set.mapSelection='';}}else if(state.view=='calendar'){if(state.span.length==1&&/^\d/.test(state.span)){set.calendarFind=state.span[0];}else if(state.span.length==2){set.calendarFind=state.span[0];}}}
if(state.sort){set[!state.item?'listSort':'itemSort']=state.sort;}
if(!state.item){if(state.find){set.find=state.find;}else if(!pandora.$ui.appPanel){set.find=pandora.site.user.ui.find;}}}else if(state.type=='edits'){if(state.span){var key='edits.'+pandora.UI.encode(state.item);set[key]={};if(Ox.isArray(state.span)){set[key+'.clip']='';set[key+'.in']=state.span[state.span.length-2]||0;set[key+'.out']=state.span.length==1?0:Math.max(state.span[state.span.length-2],state.span[state.span.length-1]);set[key+'.position']=state.span[0];}else{set[key+'.clip']=state.span;}}}else if(state.type=='texts'){if(state.span){set['texts.'+pandora.UI.encode(state.item)+'.position']=state.span[0];}}
Ox.Request.cancel();$('video').each(function(){$(this).trigger('stop');});Ox.Log('URL','UI.set',set)
if(!pandora.$ui.appPanel&&state.item&&pandora.user.ui.find){pandora.api.find({query:pandora.user.ui.find,positions:[state.item],sort:[{key:'id',operator:''}]},function(result){if(Ox.isUndefined(result.data.positions[state.item])){set.find=pandora.site.user.ui.find}
pandora.UI.set(set);callback&&callback();});}else{pandora.UI.set(set);callback&&callback();}}}}
function getOptions(){var itemsSection=pandora.site.itemsSection,sortKeys={},views={};views[itemsSection]={list:[pandora.user.ui.listView].concat(pandora.site.listViews.filter(function(view){return view.id!=pandora.user.ui.listView}).map(function(view){return view.id;})),item:[pandora.user.ui.itemView,pandora.user.ui.videoView].concat(pandora.site.itemViews.filter(function(view){return[pandora.user.ui.itemView,pandora.user.ui.videoView].indexOf(view.id)==-1;}).map(function(view){return view.id;}))};sortKeys[itemsSection]={list:{},item:{}};views[itemsSection].list.forEach(function(view){sortKeys[itemsSection].list[view]=[].concat(Ox.getObjectById(pandora.site.sortKeys,pandora.user.ui.listSort[0].key)||pandora.isClipView(view)&&Ox.getObjectById(pandora.site.clipKeys,pandora.user.ui.listSort[0].key)||[],pandora.isClipView(view)?pandora.site.clipKeys.filter(function(key){return key.id!=pandora.user.ui.listSort[0].key;}):[],pandora.site.sortKeys.filter(function(key){return key.id!=pandora.user.ui.listSort[0].key;}));});views[itemsSection].item.forEach(function(view){if(pandora.isClipView(view,true)){sortKeys[itemsSection].item[view]=[Ox.getObjectById(pandora.site.clipKeys,pandora.user.ui.itemSort[0].key)].concat(pandora.site.clipKeys.filter(function(key){return key.id!=pandora.user.ui.itemSort[0].key;}));}});views['edits']={list:[],item:['edit']};sortKeys['edits']={list:{},item:{}};views['texts']={list:[],item:['text']};sortKeys['texts']={list:{},item:{}};return{views:views,sortKeys:sortKeys};}
that.init=function(){var itemsSection=pandora.site.itemsSection,findKeys,spanType={};spanType[itemsSection]={list:{map:'location',calendar:'date'},item:{timeline:'duration',player:'duration',editor:'duration',map:'location',calendar:'date'}};spanType['edits']={list:[],item:{edit:'duration'}};spanType['texts']={list:[],item:{text:'number'}};findKeys=[{id:'list',type:'string'}].concat(pandora.site.itemKeys);self.URL=Ox.URL(Ox.extend({findKeys:findKeys,getHash:pandora.getHash,getItem:pandora.getItem,getPart:pandora.getPart,getSpan:pandora.getSpan,pages:[].concat(['home','software','api','help','tv'],pandora.site.sitePages.map(function(page){return page.id;}),['preferences','signup','signin','signout']),spanType:spanType,types:[pandora.site.itemName.plural.toLowerCase(),'edits','texts'],},getOptions()));window.addEventListener('hashchange',function(){Ox.Request.cancel();that.parse();});window.addEventListener('popstate',function(e){Ox.Request.cancel();self.isPopState=true;$('.OxDialog:visible').each(function(){Ox.UI.elements[$(this).data('oxid')].close();});if(pandora.$ui.home){pandora.UI.set({page:''});pandora.$ui.home.fadeOutScreen();}else if(pandora.$ui.tv){pandora.UI.set({page:''});pandora.$ui.tv.fadeOutScreen();}
if(pandora.user.ui.item&&pandora.user.ui.itemView=='video'&&pandora.$ui.player&&pandora.$ui.player.options('fullscreen')){pandora.$ui.player.remove();}
if(e.state&&!Ox.isEmpty(e.state)){Ox.Log('URL','E.STATE',e.state)
document.title=Ox.decodeHTMLEntities(e.state.title);setState(e.state);}else if(window.location.pathname=='/'){pandora.$ui.home=pandora.ui.home().fadeInScreen();}else{that.parse();}});return that;};that.parse=function(url,callback){if(arguments.length==2){self.URL.parse(url,callback);}else{callback=arguments[0];url=null;if(document.location.pathname.slice(0,4)=='url='){document.location.href=Ox.decodeURI(document.location.pathname.slice(4));}else{self.URL.parse(function(state){setState(state,callback);});}}
return that;};that.pop=function(){self.URL.pop()||that.update();};that.push=function(stateOrURL,expandURL){var state,title=pandora.getPageTitle(stateOrURL)||pandora.getDocumentTitle(),url;pandora.replaceURL=expandURL;if(Ox.isObject(stateOrURL)){state=stateOrURL;}else{url=stateOrURL;}
self.URL.push(state,title,url,setState);return that;};that.replace=function(stateOrURL,title){var state,title=pandora.getPageTitle(stateOrURL)||pandora.getDocumentTitle(),url;if(Ox.isObject(stateOrURL)){state=stateOrURL;}else{url=stateOrURL;}
self.URL.replace(state,title,url,setState);return that;};that.update=function(keys){Ox.Log('URL','update.........',keys)
var action,state;if(!keys){keys=!pandora.user.ui.item?['listView','listSort','find']:['item','itemView','itemSort'];}else{if(keys.some(function(key){return Ox.contains(['itemSort','itemView','listSort','listView'],key);})){self.URL.options(getOptions());}}
if(self.isPopState){self.isPopState=false;}else{if(!pandora.$ui.appPanel||pandora.replaceURL||keys.every(function(key){return['listColumnWidth','listColumns','listSelection','mapFind','mapSelection'].indexOf(key)>-1||/^videoPoints/.test(key)||/^edits/.test(key)||/^texts/.test(key);})){action='replace';}else{action='push';}
state=getState();self.URL[action](state,pandora.getPageTitle(state)||pandora.getDocumentTitle());pandora.replaceURL=false;}};return that;}());'use strict';pandora.ui.errorDialog=function(data){var that,error,showLogsButton;if($('.OxErrorDialog').length||pandora.isUnloading){return;}
if(data.status.code==401||data.status.code==403){that=pandora.ui.iconDialog({buttons:[Ox.Button({id:'close',title:Ox._('Close')}).bindEvent({click:function(){that.close();}})],content:Ox._('Sorry, you have made an unauthorized request.'),keys:{enter:'close',escape:'close'},title:Ox.toTitleCase(data.status.text)}).addClass('OxErrorDialog').open();}else{error=data.status.code==0?'timeout':'error';setTimeout(function(){if($('.OxErrorDialog').length==0&&!pandora.isUnloading){showLogsButton=error=='error'&&pandora.site.capabilities.canSeeDebugMenu[pandora.user.level]
that=pandora.ui.iconDialog({buttons:(showLogsButton?[Ox.Button({title:Ox._('View Error Logs...')}).bindEvent({click:function(){that.close();pandora.$ui.logsDialog=pandora.ui.logsDialog().open();}}),{}]:[]).concat([Ox.Button({id:'close',title:Ox._('Close')}).bindEvent({click:function(){that.close();}})]),content:Ox._('Sorry, a server {0}'
+' occured while handling your request.'
+' To help us find out what went wrong,'
+' you may want to report this error to an administrator.'
+' Otherwise, please try again later.',[error]),keys:{enter:'close',escape:'close'},title:Ox._('Server {0}',[Ox.toTitleCase(error)])}).addClass('OxErrorDialog').open();}},250);}};'use strict';pandora.ui.embedTimeline=function(){var that=Ox.Element(),ui=pandora.user.ui,defaults={annotationsFont:ui.annotationsFont,annotationsRange:ui.annotationsRange,annotationsSort:ui.annotationsSort,paused:true,showAnnotations:false,showLayers:pandora.site.layers.map(function(layer){return layer.id;}),timeline:ui.videoTimeline},options=getOptions(),removed=false,video,$title,$panel,$player,$annotations;pandora.api.get({id:ui.item,keys:['duration','durations','layers','parts','posterFrame','rightslevel','size','title','videoRatio']},function(result){if(removed){return;}
video=Ox.extend(result.data,pandora.getVideoOptions(result.data));if(options.title){$title=Ox.Element().css({position:'absolute'}).append($('<div>').css({marginTop:!options.title.match(/\\n/)?'8px':'2px',textAlign:'center'}).html(options.title.replace(/\\n/g,'<br>')));}else{$title=Ox.Element();}
var sizes=getSizes();$player=Ox.VideoTimelinePlayer({censored:video.censored,censoredIcon:pandora.site.cantPlay.icon,censoredTooltip:pandora.site.cantPlay.text,duration:video.duration,followPlayer:ui.followPlayer,getFrameURL:function(position){return'/'+ui.item+'/'+ui.videoResolution+'p'+position+'.jpg';},getLargeTimelineURL:function(type,i){return'/'+ui.item+'/timeline'+type+'64p'+i+'.jpg';},height:sizes.innerHeight,muted:ui.videoMuted,paused:options.paused,position:options.position,resolution:Ox.min(pandora.site.video.resolutions),smallTimelineURL:'/'+ui.item+'/timeline16p.jpg',subtitles:video.subtitles,timeline:ui.videoTimeline,timelines:pandora.site.timelines,video:video.video,videoRatio:video.videoRatio,volume:ui.videoVolume,width:sizes.innerWidth}).bindEvent({playing:function(data){setPosition(data.position,true);},position:function(data){setPosition(data.position);},});if(options.showAnnotations){video.annotations=video.annotations.filter(function(layer){return Ox.contains(options.showLayers,layer.id);});if(options.playInToOut){video.annotations.forEach(function(layer){var items=[];layer.items.forEach(function(item){if((item['in']>=options['in']&&item['in']<=options.out)||(item.out>=options['in']&&item.out<=options.out)){items.push(item);}});layer.items=items;});}
$annotations=Ox.AnnotationPanel(Ox.extend({font:options.annotationsFont,layers:video.annotations,position:options.position,range:options.annotationsRange,showLayers:ui.showLayers,showUsers:true,sort:options.annotationsSort,width:window.innerWidth},options['in']?{'in':options['in']}:{},options.out?{out:options.out}:{})).bindEvent({select:selectAnnotation})}else{$annotations=Ox.Element();}
$panel=Ox.SplitPanel({elements:[{element:$title,size:options.title?32:0},{element:$player},{element:$annotations,size:options.showAnnotations?256:0}],orientation:'vertical'});that.setElement($panel);Ox.$parent.postMessage('loaded');});function getOptions(){var options={};if(ui._hash.query){ui._hash.query.forEach(function(condition){options[condition.key]=condition.value;});}
options=Ox.extend({item:ui.item},ui.videoPoints[ui.item]||{},defaults,options);if(!options.position){options.position=options['in']||0;}
if(!options['in']&&!options.out){options.playInToOut=false;}else if(options['in']&&options['in']==options.out){options.invertHighlight=false;options.paused=true;options.playInToOut=false;}
return options;}
function getSizes(){var innerHeight,innerWidth,maxVideoHeight=window.innerHeight
-(options.title?32:0)
-(options.showTimeline?80:0)
-(options.showAnnotations?128:0),videoHeight;if(options.matchRatio||options.showAnnotations){videoHeight=Math.round(window.innerWidth/video.videoRatio);options.matchRatio=videoHeight<=maxVideoHeight;if(!options.matchRatio){videoHeight=maxVideoHeight;}}else{videoHeight=window.innerHeight
-(options.title?32:0)
-(options.showTimeline?80:0);}
innerHeight=videoHeight
+(options.title?32:0)
+(options.showTimeline?80:0);innerWidth=window.innerWidth;return{innerHeight:innerHeight,innerWidth:innerWidth,videoHeight:videoHeight};}
function getTimelineHeight(){return window.innerHeight
-(options.title?32:0)
-(options.showAnnotations?256:0);}
function selectAnnotation(data){if(data.id){setPosition(Math.max(data['in'],options['in']||0));$annotations.options({selected:''});}}
function setPosition(position,playing){!playing&&$player.options({position:position});options.showAnnotations&&$annotations.options({position:position});}
that.resizePanel=function(){var sizes=getSizes();$player.options({width:window.innerWidth,height:getTimelineHeight()});options.showAnnotations&&$annotations.options({width:window.innerWidth});return that;};return that;};'use strict';pandora.ui.embedError=function(notImplemented){var that=Ox.Element().addClass('OxScreen').css({position:'absolute',left:0,top:0,right:0,bottom:0,});$('<div>').css({position:'absolute',left:0,top:0,right:0,bottom:0,width:'96px',height:'48px',paddingTop:'16px',margin:'auto'}).append($('<img>').css({width:'96px'}).attr({src:'/static/png/logo.png'})).append($('<div>').css({marginTop:'4px',fontSize:'9px',textAlign:'center'}).html(notImplemented?Ox._('This view is not<br>implemented.'):Ox._('This view cannot<br>be embedded.'))).appendTo(that);return that;};'use strict';pandora.ui.statisticsDialog=function(){var colors={system:{'Android':[0,255,0],'BlackBerry':[64,64,64],'BSD':[255,0,0],'iOS':[0,128,255],'Java':[128,128,128],'Linux':[255,128,0],'Mac OS X':[0,255,255],'Nokia':[255,0,255],'PlayStation':[192,192,192],'RIM Tablet OS':[64,64,64],'Unix':[255,255,0],'Wii':[192,192,192],'Windows Phone':[0,0,128],'Windows':[0,0,255]},browser:{'Camino':[192,192,192],'Chrome Frame':[255,255,0],'Chrome':[0,255,0],'Chromium':[128,255,0],'Epiphany':[128,128,128],'Firefox':[255,128,0],'Internet Explorer':[0,0,255],'Konqueror':[64,64,64],'Nokia Browser':[255,0,255],'Opera':[255,0,0],'Safari':[0,255,255],'WebKit':[0,255,128]}},dialogHeight=Math.round((window.innerHeight-48)*0.9),dialogWidth=Math.round(window.innerWidth*0.9),tabs=[{id:'seen',title:Ox._('First Seen & Last Seen'),selected:true},{id:'locations',title:Ox._('Locations')},{id:'platforms',title:Ox._('Platforms & Browsers')}],$dialog=Ox.Dialog({buttons:[Ox.Button({id:'manageUsers',title:Ox._('Manage Users...')}).bindEvent({click:function(){$dialog.close();pandora.$ui.usersDialog=pandora.ui.usersDialog().open();}}),{},Ox.Button({id:'close',title:Ox._('Close')}).bindEvent({click:function(){$dialog.close();}})],closeButton:true,content:Ox.LoadingScreen(),height:dialogHeight,maximizeButton:true,minHeight:256,minWidth:512,removeOnClose:true,title:Ox._('Statistics'),width:dialogWidth}).bindEvent({resizeend:function(data){dialogWidth=data.width;$tabPanel.$element.replaceElement(1,$tabPanel.options('content')($tabPanel.selected()));}}),$tabPanel;pandora.api.statistics({},function(result){var data=result.data,flagCountry={},$guestsCheckbox;['all','registered'].forEach(function(mode){var keys,firstKey,lastKey;keys=Object.keys(data[mode].month).map(function(key){return key.slice(0,7);}).sort();firstKey=keys[0].split('-').map(function(str){return parseInt(str,10);});lastKey=Ox.formatDate(new Date(),'%F').split('-').map(function(str){return parseInt(str,10);});Ox.loop(firstKey[0],lastKey[0]+1,function(year){['firstseen','lastseen'].forEach(function(key){var key=[year,key].join('-');data[mode].year[key]=data[mode].year[key]||{};});Ox.loop(year==firstKey[0]?firstKey[1]:1,year==lastKey[0]?lastKey[1]+1:13,function(month){['firstseen','lastseen'].forEach(function(key){var key=[year,Ox.pad(month,2),key].join('-');data[mode].month[key]=data[mode].month[key]||0;});});});keys=Object.keys(data[mode].day).sort();firstKey=keys[0].split('-').map(function(str){return parseInt(str,10);});Ox.loop(firstKey[0],lastKey[0]+1,function(year){Ox.loop(year==firstKey[0]?firstKey[1]:1,year==lastKey[0]?lastKey[1]+1:13,function(month){Ox.loop(year==firstKey[0]&&month==firstKey[1]?firstKey[2]:1,year==lastKey[0]&&month==lastKey[1]?lastKey[2]+1:Ox.getDaysInMonth(year,month)+1,function(day){var key=[year,Ox.pad(month,2),Ox.pad(day,2)].join('-');data[mode].day[key]=data[mode].day[key]||{};});});});flagCountry[mode]={};['continent','region'].forEach(function(key){flagCountry[mode][key]={};Ox.forEach(data[mode][key],function(regionValue,regionKey){regionKey=regionKey.split(', ').pop();var max=0;Ox.forEach(data[mode].country,function(countryValue,countryKey){countryKey=countryKey.split(', ').pop();if((Ox.getCountryByName(countryKey)||{})[key]==regionKey&&countryValue>max){flagCountry[mode][key][regionKey]=countryKey;max=countryValue;}});});});});$guestsCheckbox=Ox.Checkbox({title:Ox._('Include Guests'),value:false}).css({float:'left',margin:'4px'}).bindEvent({change:function(){$tabPanel.$element.replaceElement(1,$tabPanel.options('content')($tabPanel.selected()));}});$tabPanel=Ox.TabPanel({content:function(id){var chartWidth=dialogWidth-32-Ox.UI.SCROLLBAR_SIZE,mode=$guestsCheckbox.options('value')?'all':'registered',top=16,$content=Ox.Element().css({padding:'16px',overflowY:'auto',background:pandora.user.ui.theme=='oxlight'?'rgb(240, 240, 240)':pandora.user.ui.theme=='oxmedium'?'rgb(160, 160, 160)':'rgb(16, 16, 16)'});if(id=='seen'){['year','month','lastdays','topdays','weekday','hour'].forEach(function(key){var isDate=['year','month'].indexOf(key)>-1,isDay=['lastdays','topdays'].indexOf(key)>-1;Ox.Chart({color:function(value){var split=value.split('-'),color=isDate?Ox.rgb(Ox.mod(8-parseInt(split[1],10),12)*30,1,0.5):Ox.rgb((Math.abs(11.5-parseInt(split[0],10))-0.5)*-11,1,0.5);if(pandora.user.ui.theme=='oxlight'){color=getColor(color);}
return color;},data:data[mode][isDay?'day':key],formatKey:function(value){var ret,split;if(isDate){split=value.split('-');ret=(split.pop()=='firstseen'?'First':'Last')+': '
+(key=='year'?'':Ox.MONTHS[parseInt(split[1],10)-1])
+' '+split[0];}else if(isDay){split=value.split('-');ret=Ox.SHORT_WEEKDAYS[parseInt(Ox.formatDate(value,'%u'))-1]+', '
+Ox.SHORT_MONTHS[parseInt(split[1],10)-1]+' '
+parseInt(split[2],10)+', '+split[0];}else{ret=key=='weekday'?Ox.WEEKDAYS[parseInt(value,10)-1]:value+':00';}
return ret;},keyAlign:'right',keyWidth:128,limit:isDay?30:0,rows:isDate?2:1,sort:{key:key=='topdays'?'value':'key',operator:isDate||isDay?'-':'+'},title:key=='lastdays'?Ox._('Last 30 Days'):key=='topdays'?Ox._('Top 30 Days'):Ox._(Ox.toTitleCase(key)+'s'),width:chartWidth}).css({position:'absolute',left:'16px',top:top+'px'}).appendTo($content);top+=(isDay?Math.min(Ox.len(data[mode].day),30):Ox.len(data[mode][key]))*16+32;});}else if(id=='locations'){['continent','region','country','city'].forEach(function(key){Ox.Chart({color:function(value){var color=Ox.getGeoColor(key=='continent'?value:value.split(', ')[1]);if(pandora.user.ui.theme=='oxlight'){color=getColor(color);}
return color;},data:data[mode][key],formatKey:function(value){var city,country,split=value.split(', ');if(key=='continent'||key=='region'){country=flagCountry[mode][key][Ox.last(split)];}else{country=split[2];city=key=='city'?split[3]:''}
return $('<div>').append($('<div>').css({float:'left',width:'104px',height:'14px',marginLeft:'-4px',marginRight:'4px',overflow:'hidden',textOverflow:'ellipsis'}).html(Ox.last(split))).append(Ox.Element({element:'<img>',tooltip:mode=='all'&&(key=='continent'||key=='region')?Ox.wordwrap(Ox.COUNTRIES.filter(function(country){return country[key]==split[key=='continent'?0:1]&&country.code.length==2&&!country.exception&&!country.disputed&&!country.dissolved;}).map(function(country){return country.name;}).sort().join(', '),64,'<br>',true).split(', ').map(function(country){return Ox.values(Ox.map(data.all.country,function(value,key){return key.split(', ').pop()})).indexOf(country.replace(/<br>/g,''))>-1?'<span class="OxBright">'+country+'</span>':country}).join(', '):''}).attr({src:Ox.getFlagByGeoname(country,16)}).css({float:'left',width:'14px',height:'14px',borderRadius:'4px',margin:'0 1px 0 1px'}));},keyAlign:'right',keyWidth:128,limit:1000,sort:{key:'value',operator:'-'},title:(Ox.endsWith(key,'y')?Ox.toTitleCase(key).slice(0,-1)+'ies':Ox.toTitleCase(key)+'s')+' ('+(Ox.len(data[mode][key])>1000?'1,000 of ':'')+Ox.formatNumber(Ox.len(data[mode][key]))+')',width:chartWidth}).css({position:'absolute',left:'16px',top:top+'px'}).appendTo($content);top+=Math.min(Ox.len(data[mode][key]),1000)*16+32;});}else if(id=='platforms'){['','version'].forEach(function(version,i){['system','browser'].forEach(function(key){Ox.Chart({color:function(value){var name=version?getName(key,value):value,color=colors[key][name];if(pandora.user.ui.theme=='oxlight'){color=getColor(color);}
return color;},data:data[mode][key+version],formatKey:function(value){var name=version?getName(key,value):value,$element=$('<div>');$element.append($('<div>').css({float:'left',width:'168px',height:'14px',marginLeft:'-4px',marginRight:'4px',overflow:'hidden',textOverflow:'ellipsis'}).html(value.replace(/BSD \((.+)\)/,'$1').replace(/Linux \((.+)\)/,'$1').replace(/Unix \((.+)\)/,'$1').replace(/Windows (NT \d+\.\d+) \((.+)\)/,'Windows $2 ($1)'))).append($('<img>').attr({src:Ox.UI.PATH+'png/'+key
+name.replace(/ /g,'')+'128.png'}).css({float:'left',width:'14px',height:'14px',margin:'0 1px 0 1px'}));return $element;},keyWidth:192,sort:version==''?{key:'value',operator:'-'}:{key:'key',operator:'+'},title:Ox._(key=='system'?(version==''?'Platforms':'Platform Versions'):(version==''?'Browsers':'Browser Versions')),width:chartWidth}).css({position:'absolute',left:'16px',top:top+'px'}).appendTo($content);top+=Ox.len(data[mode][key+version])*16+32;});Ox.Chart({color:function(value){var color=Ox.zip(value.split(' / ').map(function(v,i){var key=['system','browser'][i];v=version?getName(key,v):v;return colors[key][v];})).map(function(c){return Math.round(Ox.sum(c)/2);});if(pandora.user.ui.theme=='oxlight'){color=getColor(color);}
return color;},data:data[mode]['systemandbrowser'+version],formatKey:function(value){var $element=$('<div>').append($('<div>').css({float:'left',width:'152px',height:'14px',marginLeft:'-4px',marginRight:'4px',overflow:'hidden',textOverflow:'ellipsis'}).html(version?value.replace(/BSD \((.+)\)/,'$1').replace(/Linux \((.+)\)/,'$1').replace(/(Mac OS X \d+\.\d+) \(.+\)/,'$1').replace(/Unix \((.+)\)/,'$1').replace(/Windows NT \d+\.\d+ \((.+)\)/,'Windows $1').replace(/Chrome Frame/,'CF').replace(/Internet Explorer/,'IE'):value));value.split(' / ').forEach(function(value,i){var key=['system','browser'][i];value=version?getName(key,value):value;$element.append($('<img>').attr({src:Ox.UI.PATH+'png/'+key
+value.replace(/ /g,'')+'128.png'}).css({width:'14px',height:'14px',margin:'0 1px 0 1px'}));});return $element;},keyWidth:192,sort:version==''?{key:'value',operator:'-'}:{key:'key',operator:'+'},title:version==''?Ox._('Platforms & Browsers'):Ox._('Platform & Browser Versions'),width:chartWidth}).css({position:'absolute',left:'16px',top:top+'px'}).appendTo($content);top+=Ox.len(data[mode]['systemandbrowser'+version])*16+32;});}
$('<div>').css({position:'absolute',top:top-16+'px',width:'1px',height:'16px'}).appendTo($content);return $content;},tabs:tabs});$tabPanel.find('.OxButtonGroup').css({width:'512px'});$guestsCheckbox.appendTo($tabPanel.children('.OxBar'));$dialog.options({content:$tabPanel});});function getColor(color){var hsl=Ox.hsl(color);hsl[2]=Math.max(hsl[2]-0.1,0);return Ox.rgb(hsl);}
function getName(key,version){var name='';Ox.forEach(Object.keys(colors[key]),function(v){if(new RegExp('^'+v).test(version)){name=v;return false;}});return name;}
return $dialog;};'use strict';pandora.ui.documentsView=function(options,self){var self=self||{},that=Ox.Element({},self).defaults({id:''}).options(options||{});self.selected=null;self.$toolbar=Ox.Bar({size:24});self.$preview=Ox.Element();self.$documentsList=Ox.TableList({columns:[{align:'left',id:'index',operator:'+',title:Ox._('Index'),visible:false,width:60},{align:'left',id:'id',operator:'+',title:Ox._('ID'),visible:false,width:60},{align:'left',id:'user',operator:'+',title:Ox._('User'),visible:false,width:60},{align:'left',id:'name',operator:'+',title:Ox._('Name'),visible:true,width:360},{id:'extension',operator:'+',title:Ox._('Extension'),visible:false,width:60},{editable:true,id:'description',operator:'+',title:Ox._('Description'),visible:true,width:240}],columnsMovable:true,columnsRemovable:true,columnsResizable:true,columnsVisible:true,items:options.documents,scrollbarVisible:true,sort:[{key:'index',operator:'+'}],sortable:true,unique:'id'}).bindEvent({add:function(data){pandora.$ui.documentsDialog=pandora.ui.documentsDialog({callback:function(ids){if(ids){pandora.api.addDocument({item:pandora.user.ui.item,ids:ids},function(){Ox.Request.clearCache();pandora.$ui.contentPanel.replaceElement(1,pandora.$ui.item=pandora.ui.item());});}}}).open();},'delete':function(data){if(data.ids.length>0&&options.editable){pandora.api.removeDocument({ids:data.ids,item:pandora.user.ui.item},function(result){Ox.Request.clearCache();pandora.$ui.contentPanel.replaceElement(1,pandora.$ui.item=pandora.ui.item());});}},move:function(data){Ox.Request.clearCache();pandora.api.sortDocuments({item:pandora.user.ui.item,ids:data.ids})},select:selectDocument,submit:function(data){var value=self.$documentsList.value(data.id,data.key);if(data.value!=value&&!(data.value===''&&value===null)){self.$documentsList.value(data.id,data.key,data.value||null);data.key=='description'&&pandora.api.editDocument({description:data.value,id:data.id,item:pandora.user.ui.item},function(result){self.$documentsList.value(data.id,data.key,result.data.description);renderPreview();});}}});function renderPreview(){var isImage=Ox.contains(['jpg','png'],self.selected?self.selected.split('.').pop():''),size={width:256,height:256},src='/documents/'+self.selected+(isImage?'':'.jpg');self.$preview.empty();self.selected&&self.$preview.append(Ox.ImageElement({height:size.height,src:src,width:size.width})).append(Ox.Element().html(self.$documentsList.value(self.selected,'description')));}
function selectDocument(data){if(data.ids[0]!=self.selected){self.selected=data.ids[0];renderPreview();}}
that.setElement(Ox.SplitPanel({elements:[{element:Ox.SplitPanel({elements:[{element:self.$toolbar,size:24},{element:self.$documentsList},],orientation:'vertical'})},{collapsible:true,element:self.$preview,size:256}],orientation:'horizontal'}));that.reload=function(){self.$documentsList.reloadList();}
return that;};'use strict';pandora.ui.info=function(){var ui=pandora.user.ui,folderItems=ui.section=='items'?'Lists':Ox.toTitleCase(ui.section),folderItem=folderItems.slice(0,-1),view=getView(),that=Ox.Element().css({overflowX:'hidden',overflowY:'auto'}).bindEvent({toggle:function(data){pandora.UI.set({showInfo:!data.collapsed});},pandora_find:function(){if(pandora.user.ui._list!=pandora.UI.getPrevious('_list')){updateInfo();}},pandora_item:updateInfo,pandora_listselection:updateInfo,pandora_listview:function(data){if(pandora.isClipView(data.value)!=pandora.isClipView(data.previousValue)||data.value=='timelines'||data.previousValue=='timelines'){updateInfo();}},pandora_text:updateInfo});updateInfo();function emptyInfo(){pandora.$ui.listInfo&&pandora.$ui.listInfo.remove();pandora.$ui.posterInfo&&pandora.$ui.posterInfo.remove();pandora.$ui.videoPreview&&pandora.$ui.videoPreview.remove();that.empty();}
function getId(){return ui[folderItem.toLowerCase()]||(ui.listSelection.length?ui.listSelection[ui.listSelection.length-1]:null);}
function getView(){return ui.section=='items'?!getId()?'list':!ui.item&&pandora.isClipView()?'poster':'video':folderItem.toLowerCase();}
function resizeInfo(){var height=pandora.getInfoHeight(true);pandora.$ui.leftPanel.size(2,height);pandora.resizeFolders();!ui.showInfo&&pandora.$ui.leftPanel.css({bottom:-height+'px'});}
function updateInfo(){var id=getId(),previousView=view;view=getView();if(view=='list'||view=='text'){emptyInfo();that.append(pandora.$ui.listInfo=pandora.ui.listInfo());previousView=='video'&&resizeInfo();}else if(view=='poster'){pandora.api.get({id:id,keys:['director','modified','posterRatio','title']},function(result){var ratio=result.data.posterRatio,height=pandora.getInfoHeight(true);emptyInfo();that.append(pandora.$ui.posterInfo=pandora.ui.posterInfo(Ox.extend(result.data,{id:id})));previousView=='video'&&resizeInfo();});}else if(view=='video'){pandora.api.get({id:id,keys:['duration','posterFrame','rendered','videoRatio']},function(result){emptyInfo();if(result.data&&result.data.rendered){that.append(pandora.$ui.videoPreview=pandora.ui.videoPreview({duration:result.data.duration,frameRatio:result.data.videoRatio,height:pandora.getInfoHeight(true),id:id,position:!ui.item&&ui.listView=='timelines'?(ui.videoPoints[id]?ui.videoPoints[id].position:0):result.data.posterFrame,videoTooltip:function(){return(pandora.user.ui.item&&['timeline','player','editor'].indexOf(pandora.user.ui.itemView)>-1)?Ox._('Go to Position'):(Ox._(pandora.user.ui.item?'Switch to {0} View':'Open in {0} View',[Ox._(Ox.getObjectById(pandora.site.itemViews,pandora.user.ui.videoView).title)]));},width:ui.sidebarSize}).bindEvent({click:function(data){pandora.UI.set('videoPoints.'+id,{'in':0,out:0,position:data.position});if(ui.item&&['timeline','player','editor'].indexOf(ui.itemView)>-1){pandora.$ui[ui.itemView].options({position:data.position});}else{pandora.UI.set({item:id,itemView:ui.videoView});}}}));}else{that.append(Ox.Bar({size:16}).css({position:'absolute',bottom:0}).append($('<div>').css({marginTop:'2px',fontSize:'9px',textAlign:'center'}).html(Ox._('No Video'))));}
previousView!='video'&&resizeInfo();});}}
that.resizeInfo=function(){var view=getView();if(view=='list'||view=='text'){pandora.$ui.listInfo.resizeInfo();}else if(view=='poster'){pandora.$ui.posterInfo.resizeInfo();}else if(view=='video'){pandora.$ui.videoPreview&&pandora.$ui.videoPreview.options({height:pandora.getInfoHeight(true),width:ui.sidebarSize});}};that.updateListInfo=function(){['list','text'].indexOf(getView())>-1&&that.empty().append(pandora.$ui.listInfo=pandora.ui.listInfo());};return that;};pandora.ui.listInfo=function(){var ui=pandora.user.ui,folderItems=ui.section=='items'?'Lists':Ox.toTitleCase(ui.section),folderItem=folderItems.slice(0,-1),list=pandora.user.ui.section=='items'?pandora.user.ui._list:ui[folderItem.toLowerCase()],canEditFeaturedLists=pandora.site.capabilities['canEditFeatured'+folderItems][pandora.user.level],that=$('<div>').css({padding:'16px',textAlign:'center'}),$icon=Ox.Element('<img>').attr({src:list?'/'+folderItem.toLowerCase()+'/'+encodeURIComponent(list)+'/icon256.jpg?'+Ox.uid():'/static/png/icon.png'}).css(getIconCSS()).appendTo(that),$title,$description;that.append($('<div>').css({height:'16px'}));if(list){pandora.api['find'+folderItems]({query:{conditions:[{key:'id',value:list,operator:'=='}]},keys:['description','status','name','user']},function(result){if(result.data.items.length){var item=result.data.items[0],editable=item.user==pandora.user.username||(item.status=='featured'&&canEditFeaturedLists);if(editable){$icon.options({tooltip:Ox._('Doubleclick to edit icon')}).bindEvent({doubleclick:editIcon});}
that.append($title=Ox.Editable({editable:editable,format:function(value){return Ox.encodeHTMLEntities(Ox.decodeHTMLEntities(item.status=='featured'||editable?value:item.user+': '+value))},tooltip:editable?pandora.getEditTooltip('title'):'',value:item.name,width:pandora.user.ui.sidebarSize-32}).css({fontWeight:'bold',textAlign:'center'}).bindEvent({edit:function(){$title.options({width:that.width()});},submit:function(data){data.value=Ox.decodeHTMLEntities(data.value);if(data.value!=item.name){pandora.api['edit'+folderItem]({id:list,name:data.value},function(result){if(result.data.id!=list){pandora.renameList(list,result.data.id,result.data.name);list=result.data.id;item.name=result.data.name;}});}}})).append($('<div>').css({height:'8px'})).append($description=Ox.Editable({clickLink:pandora.clickLink,format:function(value){return'<div class="OxLight" style="text-align: center">'
+value+'</div>';},editable:editable,height:pandora.user.ui.sidebarSize-32,placeholder:editable?'<div class="OxLight" style="text-align: center">'+Ox._('No description')+'</span>':'',tooltip:editable?pandora.getEditTooltip('description'):'',type:'textarea',value:item.description,width:pandora.user.ui.sidebarSize-32}).css({textAlign:'center'}).bindEvent({edit:function(){setTimeout(function(){var width=that.width();$description.options({height:width,width:width});},25);},submit:function(data){if(data.value!=item.description){pandora.api['edit'+folderItem]({id:list,description:data.value},function(result){item.description=result.data.description;Ox.Request.clearCache('find'+folderItems);});}}}));}else{that.append($('<div>').css({paddingTop:'16px'}).html(Ox._('{0} not found',[Ox._(folderItem)])));}});}else{that.append($('<div>').css({fontWeight:'bold'}).html(ui.section=='items'?Ox._('All {0}',[Ox._(pandora.site.itemName.plural)]):Ox._('{0} '+folderItems,[pandora.site.site.name])));}
function editIcon(){if(pandora.getListData().id){pandora.$ui.listDialog=pandora.ui.listDialog('icon').open();}else{setTimeout(editIcon,250);}}
function getIconCSS(){var size=Math.round(pandora.user.ui.sidebarSize/2);return{width:size+'px',height:size+'px',borderRadius:Math.round(size/4)+'px'};}
that.resizeInfo=function(){var width=that.width();$icon.css(getIconCSS());$title&&$title.options({width:width});$description&&$description.options({height:width,width:width});};return that;};pandora.ui.posterInfo=function(data){var $poster=Ox.Element({element:'<img>',tooltip:function(){return Ox._('Open in Info View');}}).attr({src:'/'+data.id+'/poster512.jpg?'+data.modified}).css(getPosterCSS()).bindEvent({anyclick:function(){pandora.UI.set({item:data.id,itemView:'info'});}}),$text=$('<div>').css({width:pandora.user.ui.sidebarSize-8+'px',height:'12px',padding:'2px 4px 2px 4px',fontSize:'9px',textAlign:'center',textOverflow:'ellipsis',overflow:'hidden'}).html(data.title+(Ox.len(data.director)?' ('+data.director.join(', ')+')':'')),that=Ox.SplitPanel({elements:[{element:$('<div>').append($poster)},{element:Ox.Bar({size:16}).append($text),size:16}],orientation:'vertical'});function getPosterCSS(){var css={},ratio=pandora.user.ui.sidebarSize/(pandora.user.ui.sidebarSize-16);if(data.posterRatio<ratio){css.height=pandora.user.ui.sidebarSize-16;css.width=Math.round(css.height*data.posterRatio);css.marginLeft=Math.floor((pandora.user.ui.sidebarSize-css.width)/2);}else{css.width=pandora.user.ui.sizebarSize;css.height=Math.round(css.width/data.posterRatio);css.marginTop=Math.floor((pandora.user.ui.sidebarSize-16-css.height)/2);}
return Ox.map(css,function(value){return value+'px';});}
that.resizeInfo=function(){$poster.css(getPosterCSS());$text.css({width:pandora.user.ui.sidebarSize-8+'px'})}
return that;};'use strict';pandora.ui.usersDialog=function(){var browsers=['Camino','Chrome Frame','Chrome','Chromium','Epiphany','Firefox','Internet Explorer','Konqueror','Nokia Browser','Opera','Safari','WebKit'],dialogHeight=Math.round((window.innerHeight-48)*0.9),dialogWidth=Math.round(window.innerWidth*0.9),formWidth=256,numberOfUsers=0,systems=['Android','BlackBerry','BSD','iOS','Java','Linux','Mac OS X','Nokia','PlayStation','RIM Tablet OS','Unix','Wii','Windows Phone','Windows'],userLevels=pandora.site.userLevels.map(function(userLevel){return Ox.toTitleCase(userLevel);}).concat(['Robot']),$reloadButton=Ox.Button({disabled:true,title:'redo',tooltip:Ox._('Reload'),type:'image'}).css({float:'left',margin:'4px 2px 4px 4px'}).bindEvent({click:function(){$reloadButton.options({disabled:true});Ox.Request.clearCache('findUsers');$list.reloadList(true);}}),$guestsCheckbox=Ox.Checkbox({title:Ox._('Include Guests'),value:false}).css({float:'left',margin:'4px 2px'}).bindEvent({change:function(data){data.value?$robotsCheckbox.show():$robotsCheckbox.hide().options({value:false});updateList();}}),$robotsCheckbox=Ox.Checkbox({title:Ox._('Include Robots'),value:false}).css({float:'left',margin:'4px 2px'}).hide().bindEvent({change:updateList}),$findSelect=Ox.Select({items:[{id:'all',title:Ox._('Find: All')},{id:'username',title:Ox._('Find: Username')},{id:'email',title:Ox._('Find: E-Mail Address')}],overlap:'right',type:'image'}).bindEvent({change:function(data){$findInput.value()&&updateList();$findInput.options({placeholder:data.title});}}),$findInput=Ox.Input({changeOnKeypress:true,clear:true,placeholder:Ox._('Find: All'),width:192}).bindEvent({change:updateList}),$findElement=Ox.FormElementGroup({elements:[$findSelect,$findInput]}).css({float:'right',margin:'4px'}),$list=Ox.TableList({columns:[{format:function(value,data){return $('<img>').attr({src:Ox.UI.getImageURL('symbolCheck')}).css({width:'10px',height:'10px',padding:'3px',opacity:value||['guest','robot'].indexOf(data.level)>-1?0:1});},id:'disabled',operator:'-',title:Ox._('Enabled'),titleImage:'check',visible:true,width:16},{format:function(value){return $('<img>').attr({src:Ox.UI.getImageURL('symbolMail')}).css({width:'10px',height:'10px',padding:'3px',opacity:+value});},id:'newsletter',title:Ox._('Newsletter'),titleImage:'mail',operator:'-',visible:true,width:16},{format:function(value,data){return'<span style="opacity: '+(data.disabled?0.5:1)+'">'+Ox.encodeHTMLEntities(value)+'</span>';},id:'username',operator:'+',removable:false,title:Ox._('Username'),visible:true,width:128},{format:function(value,data){return'<span style="opacity: '+(data.disabled?0.5:1)+'">'+value+'</span>';},id:'email',operator:'+',title:Ox._('E-Mail Address'),visible:true,width:192},{align:'center',format:function(value){return Ox.Theme.formatColorLevel(userLevels.indexOf(Ox.toTitleCase(value)),userLevels,[0,300]);},id:'level',operator:'-',title:Ox._('Level'),type:'label',visible:true,width:64},{format:function(value){return value?Ox.Element({element:'<img>',tooltip:value}).attr({src:Ox.getFlagByGeoname(value,16)}).css({width:'14px',height:'14px',borderRadius:'4px',marginLeft:'-3px',marginTop:0}):'';},id:'location',operator:'+',title:Ox._('Location'),titleImage:'flag',visible:true,width:16},{format:function(value){var system;Ox.forEach(systems,function(s){if(new RegExp('^'+s).test(value)){system=s;return false;}});return system?Ox.Element({element:'<img>',tooltip:value.replace(/BSD \((.+)\)/,'$1').replace(/Linux \((.+)\)/,'$1').replace(/Unix \((.+)\)/,'$1').replace(/Windows (NT \d+\.\d+) \((.+)\)/,'Windows $2 ($1)')}).attr({src:Ox.UI.PATH+'png/system'
+system.replace(/ /g,'')+'128.png'}).css({width:'14px',height:'14px',marginLeft:'-3px',marginTop:0}):'';},id:'system',operator:'+',title:Ox._('System'),titleImage:'square',visible:true,width:16},{format:function(value){var browser;Ox.forEach(browsers,function(b){if(new RegExp('^'+b).test(value)){browser=b;return false;}});return browser?Ox.Element({element:'<img>',tooltip:value}).attr({src:Ox.UI.PATH+'png/browser'
+browser.replace(/ /g,'')+'128.png'}).css({width:'14px',height:'14px',marginLeft:'-3px',marginTop:0}):'';},id:'browser',operator:'+',title:Ox._('Browser'),titleImage:'circle',visible:true,width:16},{align:'right',format:function(value){return Ox.formatNumber(value);},id:'timesseen',operator:'-',title:Ox._('Times Seen'),visible:true,width:80},{align:'right',format:function(value){return Ox.formatDate(value,'%F %T');},id:'firstseen',operator:'-',title:Ox._('First Seen'),visible:true,width:144},{align:'right',format:function(value){return Ox.formatDate(value,'%F %T');},id:'lastseen',operator:'-',title:Ox._('Last Seen'),visible:true,width:144},{align:'right',format:function(value,data){return['guest','robot'].indexOf(data.level)>-1?'':value;},id:'numberoflists',operator:'-',title:Ox._('Lists'),visible:true,width:64},{id:'groups',operator:'+',title:Ox._('Groups'),visible:true,width:64},{id:'screensize',align:'right',operator:'-',title:Ox._('Screen Size'),visible:true,width:80},{align:'right',id:'windowsize',operator:'-',title:Ox._('Window Size'),visible:true,width:80},{align:'right',id:'ip',operator:'+',title:Ox._('IP Address'),visible:true,width:128},{id:'useragent',operator:'+',title:Ox._('User Agent'),visible:true,width:768}],columnsRemovable:true,columnsVisible:true,items:pandora.api.findUsers,query:{conditions:[{key:'level',value:'guest',operator:'!='},{key:'level',value:'robot',operator:'!='}],operator:'&'},keys:['notes','groups'],max:-1,scrollbarVisible:true,sort:[{key:'lastseen',operator:'-'}],unique:'id'}).bindEvent({init:function(data){numberOfUsers=data.users;$status.html(Ox.formatNumber(data.items)
+' user'+(data.items==1?'':'s')
+($guestsCheckbox.value()?' ('+Ox.formatNumber(data.users)+' registered, '
+Ox.formatNumber(data.guests)+' guest'
+(data.guests==1?'':'s')
+($robotsCheckbox.value()?', '
+Ox.formatNumber(data.robots)+' robot'
+(data.robots==1?'':'s'):'')+')':''));},load:function(){$reloadButton.options({disabled:false});},select:selectUsers}),$formButton=Ox.ButtonGroup({buttons:[{id:'edit',selected:true,title:'edit',tooltip:Ox._('Edit')},{id:'mail',title:'mail',tooltip:Ox._('Mail')}],selectable:true,type:'image'}).css({float:'left',margin:'4px 2px 4px 4px'}).bindEvent({change:selectForm}),$formLabel=Ox.Label({textAlign:'center',title:Ox._('No user selected'),width:192}).css({float:'left',margin:'4px 2px'}),$deselectButton=Ox.Button({disabled:true,title:'close',tooltip:Ox._('Done'),type:'image'}).css({float:'left',margin:'4px 4px 4px 2px'}).bindEvent({click:function(){$list.options({selected:[]});selectUsers({ids:[]});}}),$form=Ox.Element(),$editForm,$sendButton=Ox.Button({disabled:true,id:'send',title:Ox._('Send'),width:64}).bindEvent({click:sendMail}),$mailForm=renderMailForm(),$content=Ox.SplitPanel({elements:[{element:Ox.SplitPanel({elements:[{element:Ox.Bar({size:24}).append($reloadButton).append($guestsCheckbox).append($robotsCheckbox).append($findElement),size:24},{element:$list}],orientation:'vertical'})},{element:Ox.SplitPanel({elements:[{element:Ox.Bar({size:24}).append($formButton).append($formLabel).append($deselectButton),size:24},{element:$form}],orientation:'vertical'}).bindEvent({resize:setWidth}),resizable:true,resize:[256,384,512],size:256}],orientation:'horizontal'}),that=Ox.Dialog({buttons:[Ox.Button({id:'statistics',title:Ox._('Statistics...')}).bindEvent({click:function(){that.close();pandora.$ui.statisticsDialog=pandora.ui.statisticsDialog().open();}}),{},Ox.Button({title:Ox._('Export E-Mail Addresses...')}).css({margin:'4px 4px 4px 0'}).bindEvent({click:function(){var $button=this;$button.options({disabled:true});pandora.api.findUsers({query:{conditions:[],operator:'&'},keys:['email','username'],range:[0,numberOfUsers],sort:[{key:'username',operator:'+'}]},function(result){pandora.ui.exportDialog({data:result.data.items.filter(function(item){return item.email;}).map(function(item){return Ox.encodeHTMLEntities(item.username)
+' <'+item.email+'>';}).join(', '),title:Ox._('E-Mail Addresses')}).open();$button.options({disabled:false});});}}),Ox.Button({id:'done',title:Ox._('Done'),width:48}).bindEvent({click:function(){that.close();}})],closeButton:true,content:$content,height:dialogHeight,maximizeButton:true,minHeight:256,minWidth:512,padding:0,removeOnClose:true,title:Ox._('Manage Users'),width:dialogWidth}).bindEvent({resize:setHeight}),$status=$('<div>').css({position:'absolute',top:'4px',left:'128px',right:'384px',bottom:'4px',paddingTop:'2px',fontSize:'9px',textAlign:'center'}).appendTo(that.find('.OxButtonsbar'));that.superClose=that.close;that.close=function(){Ox.Request.clearCache('findUsers');that.superClose();};function getFormItemById(id){var ret;Ox.forEach(($formButton.value()=='edit'?$editForm:$mailForm).options('items'),function($item){if($item.options('id')==id){ret=$item;return false;}});return ret;};function getTo(){return $list.options('selected').map(function(id){return $list.value(id);}).filter(function(user){return['guest','robot'].indexOf(user.level)==-1&&($mailForm.values().include=='users'||user.newsletter);}).map(function(user){return user.username;});}
function renderEditForm(){var user=$list.value($list.options('selected')[0]);return Ox.Form({items:[Ox.Checkbox({id:'status',label:Ox._('Status'),labelWidth:80,title:!user.disabled?Ox._('Enabled'):Ox._('Disabled'),value:!user.disabled,width:formWidth-16}).bindEvent({change:function(data){this.options({title:this.options('title')==Ox._('Enabled')?Ox._('Disabled'):Ox._('Enabled')});}}),Ox.Input({id:'username',label:Ox._('Username'),labelWidth:80,value:user.username,width:formWidth-16}).bindEvent({submit:function(data){}}),Ox.Input({id:'email',label:Ox._('E-Mail'),labelWidth:80,value:user.email,width:formWidth-16}).bindEvent({submit:function(data){}}),Ox.Select({id:'level',items:pandora.site.userLevels.slice(1).map(function(level){return{id:level,title:Ox.toTitleCase(level)};}),label:Ox._('Level'),labelWidth:80,value:user.level,width:formWidth-16}),Ox.Checkbox({id:'newsletter',label:Ox._('Newsletter'),labelWidth:80,title:user.newsletter?Ox._('Subscribed'):Ox._('Unsubscribed'),value:user.newsletter,width:formWidth-16}).bindEvent({change:function(data){this.options({title:this.options('title')==Ox._('Subscribed')?Ox._('Unsubscribed'):Ox._('Subscribed')});}}),Ox.Input({id:'groups',label:Ox._('Groups'),labelWidth:80,value:user.groups?user.groups.join(', '):'',width:formWidth-16}).bindEvent({submit:function(data){}}),Ox.Input({height:dialogHeight-184,id:'notes',placeholder:Ox._('Notes'),type:'textarea',value:user.notes,width:formWidth-16})],width:240}).css({margin:'8px'}).bindEvent({change:function(event){var data={id:user.id},key,value;if(event.id=='status'){data.disabled=!event.data.value;}else if(event.id=='level'){data.level=event.data.value;}else if(event.id=='newsletter'){data.newsletter=event.data.value;}else if(event.id=='groups'){data.groups=event.data.value.split(', ');}else{data[event.id]=event.data.value;}
if(event.id=='status'){$list.value(user.id,'disabled',data.disabled);}else{$list.value(user.id,event.id,data[event.id]);}
pandora.api.editUser(data,function(result){Ox.Request.clearCache('findUsers');});}});}
function renderMailForm(){return Ox.Form({items:[Ox.Input({disabled:true,id:'from',label:Ox._('From'),labelWidth:80,value:pandora.site.site.name+' <'+pandora.site.site.email.contact+'>',width:formWidth-16}),Ox.Input({disabled:true,id:'to',label:Ox._('To'),labelWidth:80,value:'',width:formWidth-16}),Ox.Select({id:'include',items:[{id:'users',title:Ox._('All users')},{id:'subscribers',title:Ox._('Subscribers only')},],label:Ox._('Include'),labelWidth:80,width:formWidth-16}).bindEvent({change:function(){setTo();setSend();}}),Ox.Input({id:'subject',label:Ox._('Subject'),labelWidth:80,value:pandora.site.site.email.prefix+' ',width:formWidth-16}).bindEvent({change:setSend}),Ox.Input({height:dialogHeight-208,id:'message',placeholder:Ox._('Message'),type:'textarea',value:'\n\n'+pandora.site.site.email.footer,width:formWidth-16}).bindEvent({change:setSend}),Ox.MenuButton({id:'insert',items:[{id:'username',title:Ox._('Username')},{id:'email',title:Ox._('E-Mail Address')},],title:Ox._('Insert...'),width:formWidth-16}).bindEvent({click:function(data){var $input=getFormItemById('message'),textarea=$input.find('textarea')[0],value=$input.value();$input.value(value.slice(0,textarea.selectionStart)
+'{'+data.id+'}'
+value.slice(textarea.selectionEnd)).focusInput(textarea.selectionStart+data.id.length+2);}}),Ox.Checkbox({id:'receipt',title:Ox._('Send a receipt to {0}',[pandora.user.email]),value:false,width:formWidth-16}),$sendButton],width:formWidth-16}).css({margin:'8px',textAlign:'right'});}
function selectForm(data){var selected;if(data.value=='edit'){$mailForm.detach();selected=$list.options('selected');if(selected.length==1&&['guest','robot'].indexOf(selected[0].level)==-1){$form.append($editForm=renderEditForm());}}else{setTo();setSend();setWidth();$editForm&&$editForm.remove();$form.append($mailForm);}}
function selectUsers(data){var users=data.ids.map(function(id){return $list.value(id);});setLabel();$deselectButton.options({disabled:data.ids.length==0});if($formButton.value()=='edit'){$form.empty();if(data.ids.length==1&&['guest','robot'].indexOf(users[0].level)==-1){$form.append($editForm=renderEditForm());}}else{setTo();setSend();}}
function sendMail(){$sendButton.options({title:Ox._('Sending'),disabled:true});pandora.api.mail({to:getTo(),subject:getFormItemById('subject').value(),message:getFormItemById('message').value(),receipt:getFormItemById('receipt').value()},function(result){var $dialog=pandora.ui.iconDialog({buttons:[Ox.Button({id:'close',title:Ox._('Close')}).bindEvent({click:function(){$dialog.close();}})],content:result.status.code==200?Ox._('Your message has been sent.'):Ox._('Your message could not be sent. Please try again.'),keys:{enter:'close',escape:'close'},title:result.status.code==200?Ox._('Message Sent'):Ox._('Application Error')}).open();$sendButton.options({title:Ox._('Send'),disabled:false});});}
function setHeight(data){var form=$formButton.value(),$item=getFormItemById(form=='edit'?'notes':'message');dialogHeight=data.height;$item&&$item.options({height:dialogHeight-(form=='edit'?160:208)});}
function setLabel(){var users=$list.options('selected').map(function(id){return $list.value(id);}),title=users.length==0?Ox._('No user selected'):users.length==1?(['guest','robot'].indexOf(users[0].level)>-1?Ox.toTitleCase(users[0].level):Ox.encodeHTMLEntities(users[0].username)
+' &lt;'+users[0].email+'&gt;'):Ox._('{0} users selected',[users.length]);$formLabel.options({title:title});}
function setSend(){getFormItemById('send').options({disabled:getFormItemById('to').value()==Ox._('No recipients')||getFormItemById('subject').value()===''||getFormItemById('message').value()===''});}
function setTo(){var recipients=getTo().length;$mailForm.values({to:Ox.formatCount(recipients,'recipient').replace('no','No')});}
function setWidth(){var $form=$formButton.value()=='edit'?$editForm:$mailForm;formWidth=$content.size(1);$formLabel.options({width:formWidth-64});$form&&$form.options('items').forEach(function($item){if($item.options('id')!='send'){$item.options({width:formWidth-16});}});$status.css({right:formWidth+128+'px'});}
function updateList(){var guests=$guestsCheckbox.value(),robots=$robotsCheckbox.value(),key=$findSelect.value(),value=$findInput.value(),query={conditions:value?[].concat(key!='email'?[{key:'username',value:value,operator:'='}]:[],key!='username'?[{key:'email',value:value,operator:'='}]:[]):[].concat(!guests?[{key:'level',value:'guest',operator:'!='}]:[],!robots?[{key:'level',value:'robot',operator:'!='}]:[]),operator:key=='all'&&value?'|':'&'};$list.options({query:query});}
return that;};'use strict';pandora.ui.publicListsDialog=function(){var that=Ox.Dialog({buttons:[Ox.Button({id:'done',title:Ox._('Done')}).bindEvent({click:function(){that.close();}})],content:pandora.ui.publicListsList(),height:320,keys:{enter:'close',escape:'close'},padding:0,title:Ox._('Public Lists'),width:420}).css({position:'absolute'});return that;};'use strict';pandora.ui.previewDialog=function(){var $image,$list=pandora.$ui.list,item=Ox.last($list.options('selected')),posterRatio=pandora.user.ui.showSitePosters?pandora.site.posters.ratio:($list.value(item,'posterRatio')||pandora.site.posters.ratio),size=getSize(posterRatio),that=Ox.Dialog({closeButton:true,content:Ox.Element(),fixedRatio:true,focus:false,height:size.height,maximizeButton:true,title:Ox._('Loading...'),width:size.width}).bindEvent({resize:function(data){$image.css({width:data.width,height:data.height});},pandora_find:function(){that.close();},pandora_item:function(){that.close();},pandora_page:function(){that.close();},pandora_section:function(){that.close();},pandora_showsiteposters:function(){that.update();}});function getSize(posterRatio){var windowWidth=window.innerWidth*0.8,windowHeight=window.innerHeight*0.8,windowRatio=windowWidth/windowHeight;return{width:Math.round(posterRatio>windowRatio?windowWidth:windowHeight*posterRatio),height:Math.round(posterRatio<windowRatio?windowHeight:windowWidth/posterRatio)};}
that.update=function(){pandora.requests.preview&&pandora.api.cancel(pandora.requests.preview);pandora.requests.preview=pandora.api.find({keys:['director','id','modified','posterRatio','title','year'],query:{conditions:[{key:'id',operator:'==',value:Ox.last($list.options('selected'))}],operator:'&'}},function(result){var item=result.data.items[0],posterRatio=pandora.user.ui.showSitePosters?pandora.site.posters.ratio:item.posterRatio,size=getSize(posterRatio),title=item.title+(item.director?' ('+item.director.join(', ')+')':'')+(item.year?' '+item.year:'');$image=$('<img>').attr({src:'/'+item.id+'/'+(pandora.user.ui.showSitePosters?'siteposter':'poster')+'128.jpg?'+item.modified}).css({width:size.width+'px',height:size.height+'px'});$('<img>').load(function(){$image.attr({src:$(this).attr('src')});}).attr({src:'/'+item.id+'/'+(pandora.user.ui.showSitePosters?'siteposter':'poster')+'1024.jpg?'+item.modified});that.options({content:$image,title:title,}).setSize(size.width,size.height);});return that;}
return that.update();};'use strict';pandora.ui.navigationView=function(type,videoRatio){var ui=pandora.user.ui,isEmbed=pandora.isEmbedURL(),itemName=type=='map'?'place':'event',listSizes=[144+Ox.UI.SCROLLBAR_SIZE,280+Ox.UI.SCROLLBAR_SIZE,416+Ox.UI.SCROLLBAR_SIZE],listSize=listSizes[ui.clipColumns-1],$element=Ox.Element(),$toolbar=Ox.Bar({size:24}).append(pandora.$ui.sortElement=pandora.ui.sortElement(true)).bindEvent({doubleclick:function(e){if($(e.target).is('.OxBar')){$list.animate({scrollTop:0},250);}}}),$list=pandora.ui.clipList(videoRatio).bindEvent({init:function(data){updateStatusbar(data.items);}}),$status=$('<div>').css({width:'100%',marginTop:'2px',fontSize:'9px',textAlign:'center',textOverflow:'ellipsis'}),$statusbar=Ox.Bar({size:16}).append($status),$listPanel=Ox.SplitPanel({elements:[{element:$toolbar,size:24},{element:$list},{element:$statusbar,size:16}],orientation:'vertical'}).bindEvent({resize:function(){$list.size()},resizeend:function(data){var size=data.size;if(listSizes.indexOf(size)==-1){if(size<=(listSizes[0]+listSizes[1])/2){size=listSizes[0];}else if(size<(listSizes[1]+listSizes[2])/2){size=listSizes[1];}else{size=listSizes[2];}
that.size(1,size,function(){setTimeout(function(){$element['resize'+Ox.toTitleCase(type)]();$list.size();},0);});}
pandora.UI.set({clipColumns:listSizes.indexOf(size)+1});}}),that=!isEmbed?Ox.SplitPanel({elements:[{element:$element},{element:$listPanel,resizable:true,resize:listSizes,size:listSize,tooltip:Ox._('clips')}],orientation:'horizontal'}):Ox.SplitPanel({elements:[{element:$element},{element:$listPanel,size:188+Ox.UI.SCROLLBAR_SIZE}],orientation:'vertical'});if(type=='map'){that.replaceElement(0,$element=Ox.Map({find:ui.mapFind,height:isEmbed?window.innerHeight-40:!ui.item?window.innerHeight-ui.showFilters*ui.filtersSize-61:window.innerHeight-ui.showBrowser*(112+Ox.UI.SCROLLBAR_SIZE)-45,places:function(data,callback){var itemsQuery;if(!ui.item){itemsQuery=ui.find;}else{itemsQuery={conditions:[{key:'id',value:ui.item,operator:'=='}],operator:'&'};}
return pandora.api.findPlaces(Ox.extend({itemsQuery:itemsQuery},data),callback);},selected:ui.mapSelection,showControls:ui.showMapControls,showLabels:ui.showMapLabels,showTypes:true,toolbar:true,width:isEmbed?window.innerWidth:window.innerWidth-ui.showSidebar*ui.sidebarSize-listSize-2,zoombar:true}).bindEvent({resize:function(){$element.resizeMap();},selectplace:selectItem,togglecontrols:function(data){pandora.UI.set({showMapControls:data.visible});},togglelabels:function(data){pandora.UI.set({showMapLabels:data.visible});}}));pandora.$ui.map=$element;}else{pandora.api.findEvents({itemsQuery:!ui.item?ui.find:{conditions:[{key:'id',value:ui.item,operator:'=='}],operator:'&'},keys:['id','name','start','end'],query:{conditions:[{key:'start',value:'',operator:'!='}]},range:[0,1000000]},function(result){that.replaceElement(0,$element=Ox.Calendar({date:new Date(ui.calendarFind||0),events:result.data.items,height:!ui.item?window.innerHeight-ui.showFilters*ui.filtersSize-61:window.innerHeight-ui.showBrowser*(112+Ox.UI.SCROLLBAR_SIZE)-45,range:[-5000,5000],selected:ui.calendarSelection,showControls:ui.showCalendarControls,showToolbar:true,showZoombar:true,width:window.innerWidth-ui.showSidebar*ui.sidebarSize-listSize-2,zoom:4}).bindEvent({resize:function(data){$element.resizeCalendar();},select:selectItem}));pandora.$ui.calendar=$element;});}
updateStatusbar(0);function selectItem(data){var id=data.id||'';if(id&&id[0]!='_'){$status.html(Ox._('Loading...'));$list.options({items:function(data,callback){var itemsQuery;if(!ui.item){itemsQuery=ui.find;}else{itemsQuery={conditions:[{key:'id',value:ui.item,operator:'=='}],operator:'&'};}
return pandora.api.findClips(Ox.extend(data,{itemsQuery:itemsQuery,query:{conditions:[{key:itemName,value:id,operator:'=='}],operator:'&'}}),callback);}});type=='map'&&pandora.UI.set({mapSelection:data.name});}else{$list.options({selected:[]}).options({items:function(data,callback){callback({data:{items:data.keys?[]:0}});}});type=='map'&&pandora.UI.set({mapSelection:id?$element.options('find'):''});}}
function updateStatusbar(items){$status.html(Ox.toTitleCase(Ox.formatCount(items,'clip')));}
pandora.$ui.clipList=$list;return that;};'use strict';pandora.ui.videoPreview=function(data){var that=Ox.VideoPreview({duration:data.duration,getFrame:function(position){var resolutions=pandora.site.video.resolutions.filter(function(resolution,i){return resolution>=data.height;}),resolution=resolutions.length?Ox.min(resolutions):Ox.max(pandora.site.video.resolutions);return'/'+data.id+'/'+resolution+'p'+(Ox.isUndefined(position)?'':position)+'.jpg';},frameRatio:data.frameRatio,height:data.height,position:data.position,scaleToFill:true,timeline:'/'+data.id+'/timeline16p.jpg',videoTooltip:data.videoTooltip,width:data.width});return that;};'use strict';pandora.ui.contentPanel=function(){var that=Ox.SplitPanel({elements:!pandora.user.ui.item?[{collapsed:!pandora.user.ui.showFilters,collapsible:true,element:pandora.$ui.browser=pandora.ui.browser(),resizable:true,resize:[96,112,128,144,160,176,192,208,224,240,256],size:pandora.user.ui.filtersSize,tooltip:'filters <span class="OxBright">'
+Ox.SYMBOLS.SHIFT+'F</span>'},{element:pandora.$ui.list=pandora.ui.list()},{element:pandora.$ui.statusbar=pandora.ui.statusbar(),size:16}]:[{collapsed:!pandora.user.ui.showBrowser,collapsible:true,element:pandora.$ui.browser=pandora.ui.browser(),size:112+Ox.UI.SCROLLBAR_SIZE,tooltip:pandora.site.itemName.singular.toLowerCase()
+' browser <span class="OxBright">'
+Ox.SYMBOLS.SHIFT+'B</span>'},{element:pandora.$ui.item=pandora.ui.item()}],orientation:'vertical'}).bindEvent({pandora_item:function(data){if(data.value&&data.previousValue){that.replaceElement(1,pandora.$ui.item=pandora.ui.item());}},pandora_itemview:function(){pandora.user.ui.item&&that.replaceElement(1,pandora.$ui.item=pandora.ui.item());},pandora_listview:function(){!pandora.user.ui.item&&that.replaceElement(1,pandora.$ui.list=pandora.ui.list());},pandora_showbrowser:function(data){data.value==that.options('elements')[0].collapsed&&that.toggle(0);},pandora_showfilters:function(data){data.value==that.options('elements')[0].collapsed&&that.toggle(0);}});return that;};'use strict';pandora.ui.sectionSelect=function(section){var that=Ox.Select({id:'sectionSelect',items:[{id:'items',title:Ox._(pandora.site.itemName.plural)},{id:'edits',title:Ox._('Edits'),disabled:pandora.user.level!='admin'},{id:'texts',title:Ox._('Texts'),disabled:pandora.user.level!='admin'}],value:section||pandora.user.ui.section}).css({float:'left',margin:'4px'}).bindEvent({});return that;};'use strict';pandora.ui.userButton=function(){var isGuest=pandora.user.level=='guest',that=Ox.Element({tooltip:Ox._(isGuest?'Click to sign up or doubleclick to sign in':'Click to open preferences or doubleclick to sign out')}).css({marginLeft:'3px'}).bindEvent({singleclick:function(){pandora.UI.set({page:isGuest?'signup':'preferences'});},doubleclick:function(){pandora.UI.set({page:isGuest?'signin':'signout'});}});$('<div>').addClass('OxLight').css({float:'left',marginTop:'2px',fontSize:'9px'}).html(isGuest?Ox._('not signed in'):Ox.encodeHTMLEntities(pandora.user.username)).appendTo(that);Ox.Button({style:'symbol',title:'user',type:'image'}).css({float:'left'}).appendTo(that);return that;};'use strict';pandora.ui.deleteListDialog=function(list){var ui=pandora.user.ui,folderItems=ui.section=='items'?'Lists':Ox.toTitleCase(ui.section),folderItem=folderItems.slice(0,-1),listData=pandora.getListData(list),$folderList=pandora.$ui.folderList[listData.folder],that=pandora.ui.iconDialog({buttons:[Ox.Button({id:'keep',title:Ox._('Keep {0}',[folderItem])}).bindEvent({click:function(){that.close();}}),Ox.Button({id:'delete',title:Ox._('Delete {0}',[folderItem])}).bindEvent({click:function(){that.close();pandora.api['remove'+folderItem]({id:listData.id},function(result){Ox.Request.clearCache('find'+folderItems);Ox.Request.clearCache(listData.id);$folderList.options({selected:[]}).bindEventOnce({load:function(){if(ui.section=='items'){pandora.UI.set('lists.'+listData.id,null);pandora.UI.set({find:pandora.site.user.ui.find});}else{pandora.UI.set(folderItem.toLowerCase(),'');}}}).reloadList();});}})],content:Ox._('Are you sure you want to delete the {0} "{1}"?',[folderItem.toLowerCase(),listData.name]),keys:{enter:'delete',escape:'keep'},title:Ox._('Delete {0}',[folderItem])});return that;};'use strict';pandora.chunkupload=function(options){var chunkSize=options.size||1024*1024,chunkURL,file=options.file,maxRetry=-1,nextChunkId,paused=false,retries=0,request,that=Ox.Element();options.data=options.data||{};initUpload();function done(){that.triggerEvent('done',{status:that.status,progress:that.progress,responseText:that.responseText});}
function initUpload(){that.status='requesting chunk upload';that.progress=0;request=new XMLHttpRequest();request.addEventListener('load',function(evt){var response={};that.responseText=evt.target.responseText;try{response=JSON.parse(evt.target.responseText);}catch(e){response={};that.status='failed to parse response';that.progress=-1;done();}
if(response.maxRetry){maxRetry=response.maxRetry;}
chunkURL=response.uploadUrl;if(document.location.protocol=='https:'){chunkURL=chunkURL.replace(/http:\/\//,'https://');}
if(chunkURL){that.status='uploading';that.progress=0.0;uploadChunk(0);}else{that.status='upload failed, no upload url provided';that.progress=-1;done();}},false);request.addEventListener('error',function(evt){that.status='uplaod failed';that.progress=-1;that.responseText=evt.target.responseText;done();},false);request.addEventListener('abort',function(evt){that.status='aborted';that.progress=-1;done();},false);var formData=new FormData();Object.keys(options.data).forEach(function(key){formData.append(key,options.data[key]);});request.open('POST',options.url);request.send(formData);}
function progress(p){that.progress=p;that.triggerEvent('progress',{progress:that.progress,status:that.status});}
function uploadChunk(chunkId){var bytesAvailable=file.size,chunk,chunkOffset=chunkId*chunkSize;if(file.mozSlice){chunk=file.mozSlice(chunkOffset,chunkOffset+chunkSize,file.type);}else if(file.webkitSlice){chunk=file.webkitSlice(chunkOffset,chunkOffset+chunkSize,file.type);}else if(file.slice){chunk=file.slice(chunkOffset,chunkOffset+chunkSize,file.type);}else{that.status=Ox._('Sorry, your browser is currently not supported.');done();}
progress(parseFloat(chunkOffset)/bytesAvailable);request=new XMLHttpRequest();request.addEventListener('load',function(evt){var response;that.responseText=evt.target.responseText;try{response=JSON.parse(evt.target.responseText);}catch(e){response={};}
if(response.done==1){that.resultUrl=response.resultUrl;that.progress=1;that.status='done';done();}else if(response.result==1){retries=0;if(paused){nextChunkId=chunkId+1;that.triggerEvent('paused',{next:nextChunkId});}else{uploadChunk(chunkId+1);}}else{retries++;if(maxRetry>0&&retries>maxRetry){that.status='uplaod failed';that.progress=-1;done();}else{setTimeout(function(){if(paused){nextChunkId=chunkId;that.triggerEvent('paused',{next:nextChunkId});}else{uploadChunk(chunkId);}},5000);}}},false);request.addEventListener('error',function(evt){retries++;if(maxRetry>0&&retries>maxRetry){that.status='uplaod failed';that.progress=-1;done();}else{setTimeout(function(){if(paused){nextChunkId=chunkId;that.triggerEvent('paused',{next:nextChunkId});}else{uploadChunk(chunkId);}},3000);}},false);request.upload.addEventListener('progress',function(evt){if(evt.lengthComputable){progress(parseFloat(chunkOffset+evt.loaded)/bytesAvailable);}},false);request.addEventListener('abort',function(evt){that.status='aborted';that.progress=-1;done();},false);var formData=new FormData();Object.keys(options.data).forEach(function(key){formData.append(key,options.data[key]);});formData.append('chunkId',chunkId);if(bytesAvailable<=chunkOffset+chunkSize){formData.append('done',1);}
formData.append('chunk',chunk);request.open('POST',chunkURL,true);request.send(formData);}
that.abort=function(){if(request){request.abort();request=null;}
return that;};that.pause=function(){paused=true;return that;};that.resume=function(){if(paused){paused=false;if(nextChunkId){uploadChunk(nextChunkId);nextChunkId=null;}}
return that;};return that;};'use strict';pandora.ui.printView=function(data){var that=Ox.Element().css({padding:'64px 128px'}),$loading=Ox.LoadingScreen().appendTo(that),sortKey=pandora.user.ui.listSort[0].key,keys=Ox.unique(['director','id','summary','title','year'].concat(sortKey));$($loading.find('img')[0]).attr({src:Ox.UI.getImageURL('symbolLoadingAnimated',null,'oxlight')});Ox.$body.css({background:'rgb(255, 255, 255)',overflow:'auto'});pandora.api.find({query:pandora.user.ui.find},function(result){var totals=pandora.getStatusText(result.data);pandora.api.find({keys:keys,query:pandora.user.ui.find,range:[0,result.data.items],sort:pandora.user.ui.listSort},function(result){var padding;$loading.remove();$('<div>').css({height:'16px',color:'rgb(0, 0, 0)'}).html('<b>'+pandora.site.site.name+' - '
+(pandora.user.ui._list?'List '+pandora.user.ui._list:'All '+pandora.site.itemName.plural)+'</b>').appendTo(that);$('<div>').css({height:'16px'}).appendTo(that);result.data.items&&result.data.items.forEach(function(item){var format=Ox.clone(Ox.getObjectById(pandora.site.itemKeys,sortKey).format),url=(pandora.site.https?'https://':'http://')
+pandora.site.site.url+'/'+item.id;if(format&&format.type=='ColorPercent'){format={type:'percent',args:[100,1]};}
$('<div>').attr({title:url}).css({height:'16px',color:'rgb(0, 0, 0)',textAlign:'justify',textOverflow:'ellipsis',cursor:'pointer',overflow:'hidden'}).html((item.director?item.director.join(', ')+' ':'')
+'<b>'+item.title+'</b>'
+(item.year?' ('+item.year+')':'')
+(item[sortKey]&&!Ox.contains(['director','title','year'],sortKey)?' '+(format&&!/^color/.test(format.type)?Ox['format'+Ox.toTitleCase(format.type)].apply(this,[item[sortKey]].concat(format.args||[])):item[sortKey]):'')
+(item.summary?' <span style="color: rgb(128, 128, 128)">'
+Ox.encodeHTMLEntities(item.summary)
+'</span>':'')).on({click:function(){document.location.href=url;}}).appendTo(that);});if(result.data.items.length){$('<div>').css({height:'16px'}).appendTo(that);}
$('<div>').css({height:'16px'}).html('<span style="color: rgb(128, 128, 128)">'
+totals+'</span>').appendTo(that);});});that.display=function(){var animate=$('.OxScreen').length==0;Ox.Log('','ANIMATE?',animate)
animate&&pandora.$ui.body.css({opacity:0});that.appendTo(pandora.$ui.body);animate&&pandora.$ui.body.animate({opacity:1},1000);return that;};return that;};'use strict';pandora.ui.deleteItemDialog=function(item){var that=pandora.ui.iconDialog({buttons:[Ox.Button({id:'keep',title:Ox._('Keep {0}',[Ox._(pandora.site.itemName.singular)])}).bindEvent({click:function(){that.close();}}),Ox.Button({id:'delete',title:Ox._('Delete {0}',[Ox._(pandora.site.itemName.singular)])}).bindEvent({click:function(){that.close();pandora.api.remove({id:item.id},function(result){Ox.Request.clearCache();pandora.UI.set({item:''});});}})],content:Ox._('Are you sure you want to delete the {0} "{1}"?'
+'<br><br>All data will be removed.',[Ox._(pandora.site.itemName.singular),item.title]),keys:{enter:'delete',escape:'keep'},title:Ox._('Delete {0}',[Ox._(pandora.site.itemName.singular)])});return that;};'use strict';pandora.UI=(function(){var self={},that={};self.previousUI={};that.encode=function(val){return val.replace(/\./g,'\\.');};that.getPrevious=function(key){return!key?self.previousUI:self.previousUI[key];};that.reset=function(){pandora.api.resetUI({},function(){pandora.user.ui=pandora.site.user.ui;pandora.user.ui._list=pandora.getListState(pandora.user.ui.find);pandora.user.ui._filterState=pandora.getFilterState(pandora.user.ui.find);pandora.user.ui._findState=pandora.getFindState(pandora.user.ui.find);Ox.Theme(pandora.user.ui.theme);pandora.$ui.appPanel.reload();});};that.set=function(){var add={},args,editSettings=pandora.site.editSettings,item,list,listSettings=pandora.site.listSettings,listView,set={},textSettings=pandora.site.textSettings,trigger={},triggerEvents;if(Ox.isObject(arguments[0])){args=arguments[0];triggerEvents=Ox.isUndefined(arguments[1])?true:arguments[1];}else{args=Ox.makeObject([arguments[0],arguments[1]]);triggerEvents=Ox.isUndefined(arguments[2])?true:arguments[1];}
Ox.Log('UI','SET',JSON.stringify(args));self.previousUI=Ox.clone(pandora.user.ui,true);self.previousUI._list=pandora.getListState(self.previousUI.find);if(args.section=='texts'){trigger.section=args.section;trigger.text=args.text;}else if(args.section=='edits'){trigger.section=args.section;trigger.edit=args.edit;}else{if('find'in args){list=pandora.getListState(args.find);pandora.user.ui._list=list;pandora.user.ui._filterState=pandora.getFilterState(args.find);pandora.user.ui._findState=pandora.getFindState(args.find);if(pandora.$ui.appPanel&&!pandora.stayInItemView){args['item']='';}
if(list!=self.previousUI._list){Ox.Log('UI','FIND HAS CHANGED LIST')
Ox.forEach(listSettings,function(listSetting,setting){if(!pandora.user.ui.lists[list]){add[setting]=pandora.site.user.ui[setting];}else{add[setting]=pandora.user.ui.lists[list][listSetting]}});}
add.itemFind=pandora.getItemFind(args.find);}else{list=self.previousUI._list;}
item=args.item||pandora.user.ui.item;listView=add.listView||args.listView;if(listView){if(pandora.isClipView(listView)){add.listSelection=[];}else if(['text','position'].indexOf(pandora.user.ui.listSort[0].key)>-1){args.listSort=pandora.site.user.ui.listSort;}}
if(!pandora.user.ui.lists[list]){add['lists.'+that.encode(list)]={};}
Ox.forEach(listSettings,function(listSetting,setting){var key='lists.'+that.encode(list)+'.'+listSetting;if(setting in args){add[key]=args[setting];}else if(setting in add){add[key]=add[setting];}else if(!pandora.user.ui.lists[list]){add[key]=pandora.site.user.ui[setting];}});if(args.item){add['listSelection']=[args.item];add['lists.'+that.encode(list)+'.selection']=[args.item];if(!args.itemView&&['timeline','player','editor'].indexOf(pandora.user.ui.itemView)>-1&&!pandora.user.ui.videoPoints[item]&&!args['videoPoints.'+item]){add['videoPoints.'+item]={annotation:'','in':0,out:0,position:0};}}
if(['timeline','player','editor'].indexOf(args.itemView)>-1){args.videoView=args.itemView;if(!pandora.user.ui.videoPoints[item]&&!args['videoPoints.'+item]){add['videoPoints.'+item]={annotation:'','in':0,out:0,position:0};}}}
if(args.edit){add['edits.'+that.encode(args.edit)]=Ox.map(editSettings,function(value,key){var editsKey='edits.'+that.encode(args.edit)+'.'+key;return editsKey in args?args[editsKey]:pandora.user.ui.edits[args.edit]?pandora.user.ui.edits[args.edit][key]:value;});}
if(args.text){add['texts.'+that.encode(args.text)]=Ox.map(textSettings,function(value,key){var textsKey='texts.'+that.encode(args.text)+'.'+key;return textsKey in args?args[textsKey]:pandora.user.ui.texts[args.text]?pandora.user.ui.texts[args.text][key]:value;});}
[args,add].forEach(function(obj,isAdd){Ox.forEach(obj,function(val,key){var keys=key.replace(/\\\./g,'\n').split('.').map(function(key){return key.replace(/\n/g,'.')}),ui=pandora.user.ui;while(keys.length>1){ui=ui[keys.shift()];}
if(!Ox.isEqual(ui[keys[0]],val)){if(val===null){delete ui[keys[0]];}else{ui[keys[0]]=val;}
set[key]=val;if(!isAdd){trigger[key]=val;}}});});if(Ox.len(set)&&!pandora.isEmbedURL()&&!pandora.isPrintURL()){pandora.api.setUI(set);}
triggerEvents&&Ox.forEach(trigger,function(val,key){Ox.Log('UI','TRIGGER '+key+' '+val);Ox.forEach(pandora.$ui,function(element){Ox.UI.isElement(element)&&element.triggerEvent('pandora_'+key.toLowerCase(),{value:val,previousValue:self.previousUI[key]});});});pandora.URL.update(Object.keys(!pandora.$ui.appPanel?args:trigger));};return that;}());'use strict';pandora.ui.filterForm=function(list){var that=Ox.Element();pandora.api.findLists({query:{conditions:[{key:'type',value:'static',operator:'='}],operator:'&'},keys:['id'],range:[0,1000],sort:[{key:'user',operator:'+'},{key:'name',operator:'+'}]},function(result){that.append(that.$filter=Ox.Filter({findKeys:pandora.site.itemKeys.map(function(itemKey){var key=Ox.clone(itemKey,true);key.title=Ox._(key.title);key.type=key.type=='layer'?Ox.getObjectById(pandora.site.layers,key.id).type:key.type;if(key.format&&key.format.type=='ColorPercent'){key.format.type='percent';}
return key;}).concat([{id:'list',title:Ox._('List'),type:'list',values:result.data.items.map(function(item){return item.id;})}]),list:list?null:{sort:pandora.user.ui.listSort,view:pandora.user.ui.listView},query:Ox.clone(list?list.query:pandora.user.ui.find,true),sortKeys:pandora.site.sortKeys,viewKeys:pandora.site.listViews}).css({padding:'16px'}).bindEvent({change:function(data){if(list){pandora.api.editList({id:list.id,query:data.query},function(result){if(pandora.user.ui.updateAdvancedFindResults){that.updateResults(data.query);}});}else if(pandora.user.ui.updateAdvancedFindResults){that.updateResults();}
that.triggerEvent('change',data);}}));that.getList=that.$filter.getList;});that.updateResults=function(query){if(list){Ox.Request.clearCache(list.id);pandora.$ui.list.bindEventOnce({init:function(data){pandora.$ui.folderList[pandora.getListData().folder].value(list.id,'query',query);}}).reloadList();pandora.$ui.filters.forEach(function($filter){$filter.reloadList();});}else{pandora.UI.set({find:Ox.clone(that.$filter.options('query'),true)});pandora.$ui.findElement.updateElement();}};return that;};'use strict';pandora.ui.namesDialog=function(){var height=Math.round((window.innerHeight-48)*0.9),width=576+Ox.UI.SCROLLBAR_SIZE,$findInput=Ox.Input({changeOnKeypress:true,clear:true,placeholder:'Find',width:192}).css({float:'right',margin:'4px'}).bindEvent({change:function(data){var query={conditions:[{key:'name',value:data.value,operator:'='},{key:'sortname',value:data.value,operator:'='}],operator:'|'};$list.options({query:query,});}}),$list=Ox.TableList({columns:[{id:'id',title:Ox._('ID'),visible:false,width:0},{id:'name',operator:'+',removable:false,title:Ox._('Name'),visible:true,width:256},{editable:true,id:'sortname',operator:'+',title:Ox._('Sort Name'),tooltip:Ox._('Edit Sort Name'),visible:true,width:256},{id:'numberofnames',align:'right',operator:'-',title:Ox._('Names'),visible:true,width:64},],columnsVisible:true,items:pandora.api.findNames,max:1,scrollbarVisible:true,sort:[{key:'sortname',operator:'+'}],unique:'id'}).bindEvent({init:function(data){$status.html(Ox.toTitleCase(Ox.formatCount(data.items,'name')));},open:function(data){$list.find('.OxItem.OxSelected > .OxCell.OxColumnSortname').trigger('mousedown').trigger('mouseup');},select:function(data){$findButton.options({disabled:!data.ids.length});},submit:function(data){Ox.Request.clearCache('findNames');pandora.api.editName({id:data.id,sortname:data.value});}}),$findButton=Ox.Button({disabled:true,title:Ox._('Find'),width:48}).bindEvent({click:function(){that.close();pandora.UI.set({find:{conditions:[{key:'name',value:$list.value($list.options('selected'),'name'),operator:'='}],operator:'&'}});pandora.$ui.findElement.updateElement();}}),that=Ox.Dialog({buttons:[Ox.Button({title:Ox._('Manage Titles...')}).bindEvent({click:function(){that.close();(pandora.$ui.titlesDialog||(pandora.$ui.titlesDialog=pandora.ui.titlesDialog())).open();}}),{},$findButton,Ox.Button({title:Ox._('Done'),width:48}).bindEvent({click:function(){that.close();}})],closeButton:true,content:Ox.SplitPanel({elements:[{element:Ox.Bar({size:24}).append($status).append($findInput),size:24},{element:$list}],orientation:'vertical'}),height:height,maximizeButton:true,minHeight:256,minWidth:512,padding:0,title:Ox._('Manage Names'),width:width}).bindEvent({resizeend:function(data){var width=(data.width-64-Ox.UI.SCROLLBAR_SIZE)/2;[{id:'name',width:Math.ceil(width)},{id:'sortname',width:Math.floor(width)}].forEach(function(column){$list.resizeColumn(column.id,column.width);});}}),$status=$('<div>').css({position:'absolute',top:'4px',left:'128px',right:'128px',bottom:'4px',paddingTop:'2px',fontSize:'9px',textAlign:'center'}).appendTo(that.find('.OxButtonsbar'));return that;};'use strict';pandora.ui.toolbar=function(){var ui=pandora.user.ui,isNavigationView=!ui.item&&['map','calendar'].indexOf(ui.listView)>-1,that=Ox.Bar({size:24}).css({zIndex:2});ui.item&&that.append(pandora.$ui.backButton=pandora.ui.backButton());that.append(pandora.$ui.viewSelect=pandora.ui.viewSelect());!ui.item&&!isNavigationView&&that.append(pandora.$ui.sortElement=pandora.ui.sortElement());that.append(!ui.item?pandora.$ui.listTitle=Ox.Label({textAlign:'center',title:getListName(pandora.user.ui._list)}).addClass('OxSelectable').css({position:'absolute',left:getListTitleLeft()+'px',top:'4px',right:(ui._list?324:310)+'px',width:'auto'}):pandora.$ui.itemTitle=Ox.Label({textAlign:'center'}).addClass('OxSelectable').css({position:'absolute',left:'236px',top:'4px',right:(ui._list?324:310)+'px',width:'auto'}).hide());(!ui.item?pandora.$ui.listTitle:pandora.$ui.itemTitle).bindEvent({doubleclick:function(){if(!ui.item){pandora.$ui.list&&pandora.$ui.list.animate({scrollTop:0},250);}else{pandora.$ui.browser.scrollToSelection();}}})
that.append(pandora.$ui.findElement=pandora.ui.findElement());that.bindEvent({pandora_listview:function(data){var isNavigationView,wasNavigationView;if(!pandora.user.ui.item){isNavigationView=['map','calendar'].indexOf(data.value)>-1;wasNavigationView=['map','calendar'].indexOf(data.previousValue)>-1;if(isNavigationView!=wasNavigationView){if(isNavigationView){pandora.$ui.sortElement.remove();}else{pandora.$ui.sortElement=pandora.ui.sortElement().insertAfter(pandora.$ui.viewSelect);}
pandora.$ui.listTitle.css({left:getListTitleLeft()+'px'});}else if((data.value=='clip')!=(data.previousValue=='clip')){pandora.$ui.sortElement.replaceWith(pandora.$ui.sortElement=pandora.ui.sortElement());}}}});function getListName(listId){return'<b>'+(listId==''?Ox._('All {0}',[pandora.site.itemName.plural]):Ox.encodeHTMLEntities(listId.slice(listId.indexOf(':')+1)))+'</b>';}
function getListTitleLeft(){return['map','calendar'].indexOf(pandora.user.ui.listView)>-1?152:316;}
that.updateListName=function(listId){pandora.$ui.listTitle.options({title:getListName(listId)});};return that;};'use strict';pandora.ui.apiDialog=function(){var selected=pandora.user.ui.part.api,actions,$panel,$list,$text,that=Ox.Dialog({buttons:[Ox.Button({id:'switch',title:Ox._('Help...')}).bindEvent({click:function(){pandora.UI.set({page:'help'});}}),{},Ox.Button({id:'close',title:Ox._('Close')}).bindEvent({click:function(){that.close();}})],closeButton:true,content:Ox.LoadingScreen(),height:384,keys:{escape:'close'},maximizeButton:true,minHeight:256,minWidth:544+Ox.UI.SCROLLBAR_SIZE,removeOnClose:true,title:Ox._('API Documentation'),width:672+Ox.UI.SCROLLBAR_SIZE}).bindEvent({close:function(){pandora.user.ui.page=='api'&&pandora.UI.set({page:''});},resize:function(){$list.size();},'pandora_part.api':function(data){pandora.user.ui.page=='api'&&that.select(data.value);}});pandora.api.api({docs:true,code:true},function(results){var items=[{id:'',title:Ox._('API Documentation'),sort:'aaa'}];actions=results.data.actions;Ox.forEach(results.data.actions,function(v,k){items.push({'id':k,'title':k,'sort':k});});$list=Ox.TableList({_tree:true,columns:[{id:'title',visible:true,width:128-Ox.UI.SCROLLBAR_SIZE}],items:items,max:1,min:1,scrollbarVisible:true,selected:[selected],sort:[{key:'sort',operator:'+'}],unique:'id'}).bindEvent({select:function(data){var id=data.ids[0];pandora.UI.set({'part.api':id});}});$text=Ox.Element().css({padding:'16px',lineHeight:'16px',overflowY:'auto'});$panel=Ox.SplitPanel({elements:[{element:$list,size:128},{element:$text}],orientation:'horizontal'});that.select(selected).options({content:$panel});$list.gainFocus();});function getIndex(){var $index=Ox.Element().html(Ox._('<h1><b>API Documentation</b></h1>\n'
+'<p><b>{0}</b> uses a JSON API'
+' to communicate between the browser and the server.'
+' This API is 100% public, which means that there is'
+' virtually no limit to what you can do with the site,'
+' or build on top of it &mdash; from writing simple scripts'
+' to read or write specific information to including'
+' data from <b>{0}</b>'
+' (not just videos, but also metadata, annotations, lists,'
+' or a custom search interface) in your own website.</p>\n'
+'<p>If you are using the API in JavaScript, you may want to'
+' take a look at <a href="https://oxjs.org/#doc/Ox.API">'
+' OxJS</a>, and if you are using Python, there is'
+' <a href="https://wiki.0x2620.org/wiki/python-ox">'
+' python-ox</a>, which is used by'
+' <a href="https://wiki.0x2620.org/wiki/pandora_client">'
+' pandora_client</a> to automate certain tasks.</p>\n'
+'<p>To get started, just open the console and paste the'
+' following snippet. For the first ten items that are'
+' both shorter than one hour and whose title does not'
+' start with "X" (sorted by duration, then title, both'
+' in ascending order), it will return their duration,'
+' id and title properties.</p>',[pandora.site.site.name])).append(Ox.SyntaxHighlighter({source:"pandora.api.find({\n"
+"    keys: ['duration', 'id', 'title'],\n"
+"    query: {\n"
+"        conditions: [\n"
+"            {key: 'duration', operator: '<', value: '01:00:00'},\n"
+"            {key: 'title', operator: '!=', value: 'x*'}\n"
+"        ],\n"
+"        operator: '&'\n"
+"    },\n"
+"    range: [0, 10],\n"
+"    sort: [\n"
+"        {key: 'duration', operator: '+'},\n"
+"        {key: 'title', operator: '+'}\n"
+"    ]\n"
+"}, function(result) {\n"
+"    console.log(\n"
+"        result.status.code == 200 ? result.data : result.status\n"
+"    );\n"
+"});"}));pandora.createLinks($index);return $index;}
that.select=function(id){if(id&&actions[id]){$text.html('<h1><b>'+id+'</b><h1><br>');var code=actions[id].code[1],f=actions[id].code[0],line=Math.round(Ox.last(f.split(':'))||0),doc=actions[id].doc.replace('/\n/<br>\n/g'),$code,$doc;$doc=Ox.SyntaxHighlighter({source:doc,}).appendTo($text);Ox.Button({title:Ox._('Source ({0})',[f]),}).bindEvent({click:function(){$code.toggle();}}).css({margin:'4px'}).appendTo($text);$code=Ox.SyntaxHighlighter({showLineNumbers:true,source:code,offset:line}).css({borderWidth:'1px',}).appendTo($text);}else{$text.empty().append(getIndex());}
$text.scrollTop(0);return that;}
return that;};'use strict';pandora.ui.filter=function(id){var i=Ox.getIndexById(pandora.user.ui.filters,id),filter=Ox.getObjectById(pandora.site.filters,id),panelWidth=pandora.$ui.document.width()-(pandora.user.ui.showSidebar*pandora.user.ui.sidebarSize)-1,title=Ox._(Ox.getObjectById(pandora.site.filters,id).title),that=Ox.TableList({_selected:!pandora.user.ui.showFilters?pandora.user.ui._filterState[i].selected:false,columns:[{align:'left',id:'name',format:function(value){return pandora.site.flags&&['country','language'].indexOf(id)>-1?$('<div>').append($('<img>').attr({src:Ox[id=='country'?'getFlagByGeoname':'getFlagByLanguage'](value,16)}).css({float:'left',width:'14px',height:'14px',margin:'0 3px 0 -2px',borderRadius:'4px'})).append($('<div>').addClass('flagname').css({float:'left',width:pandora.user.ui.filterSizes[i]-68-Ox.UI.SCROLLBAR_SIZE,textOverflow:'ellipsis',overflowX:'hidden'}).html(value)):value},operator:filter.type=='string'?'+':'-',title:title,visible:true,width:pandora.user.ui.filterSizes[i]-44-Ox.UI.SCROLLBAR_SIZE},{align:'right',format:function(value){return Ox.formatNumber(value);},id:'items',operator:'-',title:'#',visible:true,width:44}],columnsVisible:true,id:'filter_'+id,items:function(data,callback){if(pandora.user.ui.showFilters){delete data.keys;return pandora.api.find(Ox.extend(data,{group:id,query:pandora.user.ui._filterState[i].find}),callback);}else{callback({data:{items:data.keys?[]:0}});}},scrollbarVisible:true,selected:pandora.user.ui.showFilters?pandora.user.ui._filterState[i].selected:[],sort:[{key:pandora.user.ui.filters[i].sort[0].key,operator:pandora.user.ui.filters[i].sort[0].operator}],unique:'name'}).bindEvent({init:function(data){that.setColumnTitle('name',Ox._(Ox.getObjectById(pandora.site.filters,id).title)
+'<div class="OxColumnStatus OxLight">'
+(data.items?Ox.formatNumber(data.items):'')
+'</div>');},paste:function(data){pandora.$ui.list.triggerEvent('paste',data);},select:function(data){var conditions=data.ids.map(function(value){return{key:id,value:value,operator:'=='};}),index=pandora.user.ui._filterState[i].index,find=Ox.clone(pandora.user.ui.find,true);if(Ox.isArray(index)){find={conditions:conditions,operator:conditions.length>1?'|':'&'}}else{if(index==-1){index=find.conditions.length;if(find.operator=='|'){find={conditions:[find],operator:'&'};index=1;}else{find.operator='&';}}
if(conditions.length==0){find.conditions.splice(index,1);if(find.conditions.length==1){if(find.conditions[0].conditions){find={conditions:find.conditions[0].conditions,operator:'|'};}else{find.operator='&';}}}else if(conditions.length==1){find.conditions[index]=conditions[0];}else{if(pandora.user.ui.find.conditions.length==1){find={conditions:conditions,operator:'|'};}else{find.conditions[index]={conditions:conditions,operator:'|'};}}}
pandora.UI.set({find:find});pandora.$ui.filters.updateMenus();},sort:function(data){Ox.Log('','SORT',data)
var filters=Ox.clone(pandora.user.ui.filters);pandora.$ui.mainMenu.checkItem('sortMenu_sortfilters_sortfilter'+id+'_'+data.key);pandora.$ui.mainMenu.checkItem('sortMenu_orderfilters_orderfilter'+id+'_'+(data.operator=='+'?'ascending':'descending'));filters[i].sort=[{key:data.key,operator:data.operator}];pandora.UI.set({filters:filters});}}),$menu=Ox.MenuButton({items:[{id:'clearFilter',title:Ox._('Clear Filter'),keyboard:'shift control a'},{id:'clearFilters',title:Ox._('Clear All Filters'),keyboard:'shift alt control a'},{},{group:'filter',max:1,min:1,items:pandora.site.filters.map(function(filter){return Ox.extend({checked:filter.id==id},filter);})}],type:'image',}).css(Ox.UI.SCROLLBAR_SIZE==16?{right:0,width:'14px'}:{right:'-1px',width:'8px',}).bindEvent({change:function(data){var filters=Ox.clone(pandora.user.ui.filters),find,id_=data.checked[0].id,i_=Ox.getIndexById(pandora.user.ui.filters,id_);if(i_==-1){if(pandora.user.ui._filterState[i].selected.length){find=Ox.clone(pandora.user.ui.find,true);find.conditions.splice(pandora.user.ui._filterState[i].index,1);}
filters[i]=makeFilter(id_);pandora.UI.set(Ox.extend({filters:filters},find?{find:find}:{}));replaceFilter(i,id_);}else{var filterData=Ox.clone(pandora.user.ui._filterState[i]);pandora.user.ui._filterState[i]=pandora.user.ui._filterState[i_];pandora.user.ui._filterState[i_]=filterData;filters[i]=makeFilter(id_,pandora.user.ui.filters[i_].sort);filters[i_]=makeFilter(id,pandora.user.ui.filters[i].sort);pandora.UI.set({filters:filters});replaceFilter(i,id_);replaceFilter(i_,id);}
pandora.$ui.filters.updateMenus();function makeFilter(id,sort){var filter=Ox.getObjectById(pandora.site.filters,id);return{id:filter.id,sort:sort||[{key:filter.type=='integer'?'name':'items',operator:'-'}]};}
function replaceFilter(i,id){var isOuter=i%4==0;pandora.$ui[isOuter?'browser':'filtersInnerPanel'].replaceElement(isOuter?i/2:i-1,pandora.$ui.filters[i]=pandora.ui.filter(id));}},click:function(data){if(data.id=='clearFilter'){if(!Ox.isEmpty(that.options('selected'))){that.options({selected:[]}).triggerEvent('select',{ids:[]});}}else if(data.id=='clearFilters'){pandora.$ui.filters.clearFilters();}}}).appendTo(that.$bar.$element);Ox.UI.SCROLLBAR_SIZE<16&&$($menu.find('input')[0]).css({marginRight:'-3px',marginTop:'1px',width:'8px',height:'8px'});that.disableMenuItem=function(id){$menu.disableItem(id);};that.enableMenuItem=function(id){$menu.enableItem(id);};return that;};pandora.ui.filters=function(){var $filters=[];pandora.user.ui.filters.forEach(function(filter,i){$filters[i]=pandora.ui.filter(filter.id);});$filters.clearFilters=function(){var find=Ox.clone(pandora.user.ui.find,true),indices=pandora.user.ui._filterState.map(function(filterState){return filterState.index;}).filter(function(index){return index>-1;});find.conditions=find.conditions.filter(function(condition,index){return!Ox.contains(indices,index);});pandora.UI.set({find:find})};$filters.updateMenus=function(){var selected=$filters.map(function($filter){return!Ox.isEmpty($filter.options('selected'));}),filtersHaveSelection=!!Ox.sum(selected);$filters.forEach(function($filter,i){$filter[selected[i]?'enableMenuItem':'disableMenuItem']('clearFilter');$filter[filtersHaveSelection?'enableMenuItem':'disableMenuItem']('clearFilters');});return $filters;};return $filters.updateMenus();};pandora.ui.filtersInnerPanel=function(){var that=Ox.SplitPanel({elements:[{element:pandora.$ui.filters[1],size:pandora.user.ui.filterSizes[1]},{element:pandora.$ui.filters[2]},{element:pandora.$ui.filters[3],size:pandora.user.ui.filterSizes[3]}],orientation:'horizontal'});return that;};'use strict';pandora.ui.timeline=function(data){var ui=pandora.user.ui,that=Ox.VideoTimelinePanel({annotationsCalendarSize:ui.annotationsCalendarSize,annotationsFont:ui.annotationsFont,annotationsMapSize:ui.annotationsMapSize,annotationsRange:ui.annotationsRange,annotationsSize:ui.annotationsSize,annotationsSort:ui.annotationsSort,annotationsTooltip:Ox._('annotations {0}',['<span class="OxBright">'+Ox.SYMBOLS.SHIFT+'A</span>']),censored:data.censored,censoredIcon:pandora.site.cantPlay.icon,censoredTooltip:pandora.site.cantPlay.text,clickLink:pandora.clickLink,cuts:data.cuts||[],duration:data.duration,followPlayer:ui.followPlayer,getFrameURL:function(position){return'/'+ui.item+'/'+ui.videoResolution+'p'+position+'.jpg';},getLargeTimelineURL:function(type,i){return'/'+ui.item+'/timeline'+type+'64p'+i+'.jpg';},height:pandora.$ui.contentPanel.size(1),layers:data.annotations,muted:ui.videoMuted,position:ui.videoPoints[ui.item].position,resolution:Ox.min(pandora.site.video.resolutions),selected:ui.videoPoints[ui.item].annotation?ui.item+'/'+ui.videoPoints[ui.item].annotation:'',showAnnotations:ui.showAnnotations,showAnnotationsCalendar:ui.showAnnotationsCalendar,showAnnotationsMap:ui.showAnnotationsMap,showLayers:Ox.clone(ui.showLayers),showUsers:pandora.site.annotations.showUsers,smallTimelineURL:'/'+ui.item+'/timeline16p.jpg',timeline:ui.videoTimeline,timelines:pandora.site.timelines,video:data.video,videoRatio:data.videoRatio,volume:ui.videoVolume,width:pandora.$ui.document.width()-pandora.$ui.mainPanel.size(0)-1}).bindEvent({annotationsfont:function(data){pandora.UI.set({annotationsFont:data.font});},annotationsrange:function(data){pandora.UI.set({annotationsRange:data.range});},annotationssize:function(data){pandora.UI.set({annotationsSize:data.size});},annotationssort:function(data){pandora.UI.set({annotationsSort:data.sort});},censored:function(){pandora.URL.push(pandora.site.cantPlay.link);},follow:function(data){pandora.UI.set({followPlayer:data.follow});},gainfocus:function(){pandora.$ui.mainMenu.replaceItemMenu();},info:function(data){pandora.ui.annotationDialog(Ox.getObjectById(pandora.site.layers,data.layer).title).open();},muted:function(data){pandora.UI.set({videoMuted:data.muted});},playing:function(data){pandora.UI.set('videoPoints.'+pandora.user.ui.item+'.position',data.position);},position:function(data){pandora.UI.set('videoPoints.'+pandora.user.ui.item+'.position',data.position);},resizeannotations:function(data){pandora.UI.set({annotationsSize:data.annotationsSize});},resizecalendar:function(data){pandora.UI.set({annotationsCalendarSize:data.size});},resizemap:function(data){pandora.UI.set({annotationsMapSize:data.size});},select:function(data){pandora.UI.set('videoPoints.'+pandora.user.ui.item+'.annotation',data.id.split('/')[1]);},timeline:function(data){pandora.UI.set({videoTimeline:data.timeline});},toggleannotations:function(data){pandora.UI.set({showAnnotations:data.showAnnotations});},togglelayer:function(data){pandora.UI.set('showLayers.'+data.layer,!data.collapsed);},togglemap:function(data){pandora.UI.set({showAnnotationsMap:!data.collapsed});},pandora_showannotations:function(data){that.options({showAnnotations:data.value});},pandora_videotimeline:function(data){that.options({timeline:data.value});}});return that;};'use strict';pandora.ui.clipsView=function(videoRatio){var $status=$('<div>').css({width:'100%',marginTop:'2px',fontSize:'9px',textAlign:'center'}).html(Ox._('Loading...')),that=Ox.SplitPanel({elements:[{element:Ox.Bar({size:24}).bindEvent({doubleclick:function(e){if($(e.target).is('.OxBar')){pandora.$ui.clipList.animate({scrollTop:0},250);}}}).append(pandora.$ui.sortElement=pandora.ui.sortElement()).append(Ox.Input({clear:true,placeholder:Ox._('Find Clips'),value:pandora.user.ui.itemFind,width:192}).css({float:'right',margin:'4px'}).bindEvent({submit:function(data){$status.html(Ox._('Loading...'));pandora.UI.set({itemFind:data.value});that.replaceElement(1,pandora.$ui.clipList=getClipList());}})),size:24},{element:pandora.$ui.clipList=getClipList()},{element:Ox.Bar({size:16}).append($status),size:16}],orientation:'vertical'});function getClipList(){return pandora.ui.clipList(videoRatio).bindEvent({init:function(data){var items=data.items;$status.html(Ox.toTitleCase(Ox.formatCount(items,'clip')));}});}
return that;};'use strict';pandora.ui.backButton=function(){var that=Ox.Button({title:Ox._('Back to {0}',[Ox._(pandora.site.itemName.plural)]),width:96}).css({float:'left',margin:'4px 0 0 4px'}).bindEvent({click:function(){if(['accessed','timesaccessed'].indexOf(pandora.user.ui.listSort[0].key)>-1){Ox.Request.clearCache('find');}
pandora.UI.set({item:''});}});return that;};'use strict';pandora.ui.filterDialog=function(list){var that=Ox.Dialog({buttons:[Ox.Button({id:'done',title:Ox._('Done')}).bindEvent({click:function(){var list=pandora.$ui.filterForm.getList();if(list.save){pandora.api.addList({name:list.name,query:list.query,status:'private',type:'smart'},function(result){var $list=pandora.$ui.folderList.personal,id=result.data.id;pandora.UI.set({find:{conditions:[{key:'list',value:id,operator:'=='}],operator:'&'}});Ox.Request.clearCache();$list.bindEventOnce({load:function(data){$list.gainFocus().options({selected:[id]});}}).reloadList();});}else if(!pandora.user.ui.updateAdvancedFindResults){pandora.$ui.filterForm.updateResults();}
that.close();}})],content:pandora.$ui.filterForm=pandora.ui.filterForm(list),maxWidth:648+Ox.UI.SCROLLBAR_SIZE,minHeight:264,minWidth:648+Ox.UI.SCROLLBAR_SIZE,height:264,removeOnClose:true,title:list?Ox._('Smart List - {0}',[list.name]):Ox._('Advanced Find'),width:648+Ox.UI.SCROLLBAR_SIZE}),$updateCheckbox=Ox.Checkbox({title:Ox._('Update Results in the Background'),value:pandora.user.ui.updateAdvancedFindResults}).css({float:'left',margin:'4px'}).bindEvent({change:function(data){pandora.UI.set({updateAdvancedFindResults:data.value});data.value&&pandora.$ui.filterForm.updateResults();}});$($updateCheckbox.find('.OxButton')[0]).css({margin:0});$(that.find('.OxBar')[1]).append($updateCheckbox);return that;};'use strict';pandora.ui.textPanel=function(){var that=Ox.SplitPanel({elements:[{element:Ox.Element(),size:24},{element:Ox.Element()},{element:Ox.Element(),size:16}],orientation:'vertical'}),embedURLs,selected=-1,selectedURL;pandora.api.getText({id:pandora.user.ui.text},function(result){var text=result.data;embedURLs=text.type=='html'?getEmbedURLs(text.text):[];var $toolbar=Ox.Bar({size:24}),$editMenu,$uploadButton,$find=Ox.Input({clear:true,placeholder:Ox._('Find in Texts'),value:pandora.user.ui.textFind,width:188}).css({float:'right',margin:'4px 4px 4px 2px'}).bindEvent({submit:function(data){Ox.print('SUBMIT',data);}}).appendTo($toolbar),$nextButton=Ox.Button({disabled:embedURLs.length<2,title:'arrowRight',tooltip:Ox._('Next Clip'),type:'image'}).css({float:'right',margin:'4px 2px 4px 2px'}).bindEvent({click:function(){that.selectEmbed(selected<embedURLs.length-1?selected+1:0,true);}}).appendTo($toolbar),$currentButton=Ox.Button({disabled:embedURLs.length<1,title:'center',tooltip:Ox._('Current Reference'),type:'image'}).css({float:'right',margin:'4px 2px 4px 2px'}).bindEvent({click:scrollToSelectedEmbed}).appendTo($toolbar),$previousButton=Ox.Button({disabled:embedURLs.length<2,title:'arrowLeft',tooltip:Ox._('Previous Clip'),type:'image'}).css({float:'right',margin:'4px 2px 4px 2px'}).bindEvent({click:function(){that.selectEmbed(selected?selected-1:embedURLs.length-1,true);}}).appendTo($toolbar),$statusbar=Ox.Bar({size:16}),$panel=Ox.SplitPanel({elements:[{element:pandora.$ui.text=text.type=='html'?pandora.ui.textHTML(text):pandora.ui.textPDF(text)},{element:pandora.$ui.textEmbed=pandora.ui.textEmbed(),size:text.type=='html'?pandora.user.ui.embedSize:0,resizable:text.type=='html',resize:[192,256,320,384,448,512]}],orientation:'horizontal'});if(text.editable){if(text.type=='html'){$editMenu=Ox.MenuButton({items:[{id:'insertHTML',title:Ox._('Insert HTML...')},{id:'insertEmbed',title:Ox._('Insert Embed...')}],title:'edit',tooltip:Ox._('Editing Options'),type:'image'}).css({float:'left',margin:'4px 2px 4px 4px'}).bindEvent({click:function(data){if(data.id=='insertEmbed'){pandora.$ui.insertEmbedDialog=pandora.ui.insertEmbedDialog(function(){}).open();}}}).appendTo($toolbar);}else{$uploadButton=Ox.FileButton({image:'upload',tooltip:Ox._('Upload PDF'),type:'image'}).css({float:'left',margin:'4px 2px 4px 4px'}).bindEvent({click:function(data){if(data.files.length){pandora.$ui.uploadPDFDialog=pandora.ui.uploadPDFDialog({file:data.files[0],id:pandora.user.ui.text}).open();}}}).appendTo($toolbar);}}
that.replaceElement(0,$toolbar);that.replaceElement(1,$panel);that.replaceElement(2,$statusbar);embedURLs.length&&that.selectEmbed(0);pandora.user.ui.texts[pandora.user.ui.text]&&pandora.$ui.text.scrollTo(pandora.user.ui.texts[pandora.user.ui.text].position||0);});function getEmbedURLs(text){var matches=text.match(/<a [^<>]*?href="(.+?)".*?>/gi),urls=[];if(matches){matches.forEach(function(match){var url=match.match(/"(.+?)"/)[1];if(pandora.isEmbedURL(url)){urls.push(url);}});}
return urls;}
function scrollToSelectedEmbed(){var scrollTop=Math.max(pandora.$ui.text[0].scrollTop+$('#embed'+selected).offset().top-50,0),position=100*scrollTop/pandora.$ui.text[0].scrollHeight;pandora.$ui.text.scrollTo(position);}
that.selectEmbed=function(index,scroll){if(index!=selected){selected=index;selectedURL=embedURLs[selected]
$('.OxSpecialLink').removeClass('OxActive');selected>-1&&$('#embed'+selected).addClass('OxActive');pandora.$ui.textEmbed.update(selectedURL);scroll&&scrollToSelectedEmbed();}};that.update=function(text){embedURLs=getEmbedURLs(text);selected=embedURLs.indexOf(selectedURL);if(selected==-1&&embedURLs.length){selected=0;}
that.selectEmbed(selected);};return that;};pandora.ui.textHTML=function(text){var height=getHeight(),width=getWidth(),that=Ox.Element().css({'overflow-y':'auto'}).bind({scroll:function(event){var position=Math.round(100*that[0].scrollTop/that[0].scrollHeight)
position=position-position%10;if(pandora.user.ui.texts[pandora.user.ui.text]&&position!=pandora.user.ui.texts[pandora.user.ui.text].position){pandora.UI.set('texts.'+pandora.UI.encode(pandora.user.ui.text)+'.position',position?position:0);}}}),$content=Ox.Element().css({margin:'16px',}).appendTo(that),$title=Ox.EditableContent({editable:text.name?text.editable:false,placeholder:text.editable?Ox._('Doubleclick to edit title'):Ox._('Untitled'),tooltip:text.editable?pandora.getEditTooltip('title'):'',value:text.name||Ox._('{0} Texts',[pandora.site.site.name]),width:width}).css({height:'32px',fontSize:'18px',}).bindEvent({submit:function(data){Ox.Request.clearCache('getText');pandora.api.editText({id:pandora.user.ui.text,name:data.value},function(result){if(result.data.id!=pandora.user.ui.text){Ox.Request.clearCache();pandora.renameList(pandora.user.ui.text,result.data.id,result.data.name);pandora.$ui.info.updateListInfo();}});}}).appendTo($content),$spaceTop=Ox.Element().css({height:'16px'}).appendTo($content),$text=Ox.EditableContent({clickLink:pandora.clickLink,collapseToEnd:false,editable:text.editable,format:function(text){var index=0;return text.replace(/<a [^<>]*?href="(.+?)".*?>/gi,function(){var link=arguments[0],ret,url=arguments[1];if(pandora.isEmbedURL(url)){ret='<a id="embed'+index
+'" class="OxSpecialLink" href="'+url
+'">'
index++;}else{ret=link;}
return ret;});},placeholder:text.editable?Ox._('Doubleclick to edit text'):'',tooltip:text.editable?pandora.getEditTooltip('text'):'',type:'textarea',width:width,value:text.text}).css({width:width+'px',fontSize:'12px'}).bindEvent({submit:function(data){Ox.Request.clearCache('getText');pandora.api.editText({id:pandora.user.ui.text,text:data.value});pandora.$ui.textPanel.update(data.value);}}).appendTo($content);function getHeight(){return window.innerHeight-128-1;}
function getWidth(){return window.innerWidth
-pandora.user.ui.showSidebar*pandora.user.ui.sidebarSize-1
-pandora.user.ui.embedSize-1
-32-16;}
function scrollTo(position){that[0].scrollTop=that[0].scrollHeight/100*position;}
that.scrollTo=scrollTo;that.update=function(){$text.options({width:getWidth()}).css({width:getWidth()+'px'});pandora.user.ui.texts[pandora.user.ui.text]&&scrollTo(pandora.user.ui.texts[pandora.user.ui.text].position||0);return that;};return that;};pandora.ui.textPDF=function(text){var that=Ox.Element(),$iframe,page=pandora.user.ui.texts[pandora.user.ui.text].position||1,url='/texts/'+pandora.user.ui.text+'/text.pdf.html#page='+page;if(text.uploaded){$iframe=Ox.Element('<iframe>').attr({frameborder:0,height:'100%',src:url,width:'100%'}).onMessage(function(event,data){if(event=='edit'){pandora.ui.insertEmbedDialog(data.src,function(url){data.src=url;var embed=text.embeds.filter(function(embed){return embed.id==data.id&&embed.type==data.type&&embed.page==data.page;})[0];if(embed){embed.src=url;}else{text.embeds.push(data);}
pandora.api.editText({id:text.id,embeds:text.embeds},function(result){$iframe.postMessage('update',data);});}).open();}else if(event=='page'){pandora.UI.set('texts.'+pandora.UI.encode(pandora.user.ui.text)+'.position',data.page);}}).appendTo(that);that.setPage=function(page){$iframe&&$iframe.postMessage('page',{page:page});}}else{that.html('Please upload PDF');}
return that;};pandora.ui.textEmbed=function(){var that=Ox.Element().bindEvent({resizestart:function(){$iframe.attr('src')&&$overlay.show();},resize:function(data){pandora.user.ui.embedSize=data.size;pandora.$ui.text.update();},resizeend:function(){$iframe.attr('src')&&$overlay.hide();}}),$message=$('<div>').css({marginTop:'16px',textAlign:'center'}).html(Ox._('No Embeds')).hide().appendTo(that),$iframe=Ox.Element('<iframe>').attr({height:'100%',id:'embed',frameborder:0,src:'',width:'100%',allowfullscreen:true,mozallowfullscreen:true,webkitAllowFullScreen:true}).hide().appendTo(that),$overlay=$('<div>').css({position:'absolute',left:0,top:0,right:0,bottom:0}).hide().appendTo(that);that.update=function(url){var parsed,src;if(url){url=url.replace(/&amp;/g,'&')+'&matchRatio=true';src=$iframe.attr('src');parsed={src:Ox.parseURL(src),url:Ox.parseURL(url)};if(src&&parsed.url.protocol==parsed.src.protocol&&parsed.url.hostname==parsed.src.hostname){$iframe.postMessage('seturl',{url:parsed.url.pathname+parsed.url.search+parsed.url.hash});}else{$iframe.attr({src:url});}
$message.hide();$iframe.show();}else{$iframe.hide();$message.show();}
return that;};return that;};'use strict';pandora.ui.exportDialog=function(options){var $content=Ox.Input({height:256,style:'square',type:'textarea',value:options.data,width:512-Ox.UI.SCROLLBAR_SIZE}),that=Ox.Dialog({buttons:[Ox.Button({title:Ox._('Select All')}).bindEvent({click:function(){$content.focusInput(true);}}),{},Ox.Button({title:Ox._('Close')}).bindEvent({click:function(){that.close();}})],content:$content,fixedSize:true,height:256,removeOnClose:true,title:options.title,width:512});that.superOpen=that.open;that.open=function(){that.superOpen();that.find('.OxContent').css({overflow:'hidden'});$content.find('textarea').addClass('OxMonospace');$content.focusInput(true);};return that;};'use strict';pandora.ui.placesDialog=function(options){var height=Math.round((window.innerHeight-48)*0.9),width=Math.round(window.innerWidth*0.9),$content=Ox.MapEditor({addPlace:function(place,callback){pandora.api.addPlace(place,function(result){Ox.Request.clearCache();callback(result);});},editPlace:function(place,callback){pandora.api.editPlace(place,function(result){Ox.Request.clearCache();callback(result);});},getMatches:function(names,callback){var conditions=[],keys,operator;if(names.length==0){callback(0);}else{keys=pandora.site.layers.filter(function(layer){return layer.type=='place'||layer.hasPlaces;}).map(function(layer){return layer.id;});keys.forEach(function(key){operator=Ox.getObjectById(pandora.site.layers,key).type=='place'?'==':'=';names.forEach(function(name){conditions.push({key:key,value:name,operator:operator});});});pandora.api.findClips({query:{conditions:conditions,operator:conditions.length==1?'&':'|'}},function(result){callback(result.data.items);});}},hasMatches:true,height:height-48,mode:pandora.site.map=='auto'?'add':'define',names:pandora.hasPlacesLayer?function(callback){pandora.api.getPlaceNames(function(result){callback(result.data.items);});}:null,places:function(data,callback){data.keys&&data.keys.push('matches');return pandora.api.findPlaces(Ox.extend({query:{conditions:[],operator:''}},data),callback);},removePlace:function(place,callback){pandora.api.removePlace(place,function(result){Ox.Request.clearCache();callback(result);});},selected:options?options.id:'',showControls:pandora.user.ui.showMapControls,showLabels:pandora.user.ui.showMapLabels,showTypes:true,width:width}),that=Ox.Dialog({buttons:[Ox.Button({id:'manageEvents',title:Ox._('Manage Events...')}).bindEvent({click:function(){that.close();(pandora.$ui.eventsDialog||(pandora.$ui.eventsDialog=pandora.ui.eventsDialog())).open();}}),{},Ox.Button({id:'exportPlaces',title:Ox._('Export Places...')}).bindEvent({click:function(){var $button=this,keys=['name','alternativeNames','geoname','lat','lng','south','west','north','east'];$button.options({disabled:true});pandora.api.findPlaces({query:{conditions:[],operator:'&'},keys:keys,range:[0,1000000],sort:[{key:'name',operator:'+'}]},function(result){pandora.ui.exportDialog({data:JSON.stringify(result.data.items.map(function(item){Object.keys(item).filter(function(key){return!Ox.contains(keys,key);}).forEach(function(key){delete item[key];});return item;}),null,'    '),title:Ox._('Places')}).open();$button.options({disabled:false});});}}),Ox.Button({id:'done',title:Ox._('Done'),width:48}).bindEvent({click:function(){that.close();}})],closeButton:true,content:$content,height:height,maximizeButton:true,minHeight:256,minWidth:512,padding:0,title:Ox._('Manage Places'),width:width}).bindEvent({resize:function(data){$content.options({width:width,height:height});}});return that;};'use strict';pandora.ui.deleteDocumentDialog=function(file,callback){var that=pandora.ui.iconDialog({buttons:[Ox.Button({id:'keep',title:Ox._('Keep Document')}).bindEvent({click:function(){that.close();}}),Ox.Button({id:'delete',title:Ox._('Delete Document')}).bindEvent({click:function(){that.close();pandora.api.removeDocument({id:file},callback);}})],content:Ox._('Are you sure you want to delete the document "{0}"?',[file]),keys:{enter:'delete',escape:'keep'},title:Ox._('Delete Document')});return that;};'use strict';pandora.ui.list=function(){var that,view=pandora.user.ui.listView;if(view=='list'){that=Ox.TableList({columns:[].concat([{align:'center',defaultWidth:16,format:function(value,data){var icon,width,height,margin,marginCSS,borderRadius;if(pandora.user.ui.icons=='posters'){icon='poster';width=value<1?Math.round(14*value/2)*2:14;height=value<1?14:Math.round(14/value/2)*2;margin=value<1?Math.floor(7-width/2)-3:Math.floor(7-height/2);marginCSS=value<1?'0 0 0 '+margin+'px':margin+'px 0 0 -3px';borderRadius=0;}else{icon='icon';width=14;height=14;marginCSS='0 0 0 -3px';borderRadius='3px';}
return $('<img>').css({width:width-2+'px',height:height-2+'px',border:'1px solid rgb(48, 48, 48)',borderRadius:'2px',margin:marginCSS,background:'-webkit-linear-gradient(top, rgb(32, 32, 32), rgb(0, 0, 0))'}).load(function(){$(this).css({width:width+'px',height:height+'px',border:0,borderRadius:borderRadius});}).attr({src:'/'+data.id+'/'+icon+'14.jpg?'+data.modified});},id:'posterRatio',resizable:false,title:Ox._('Icon'),titleImage:pandora.user.ui.icons=='posters'?'SetPoster':'Icon',visible:pandora.user.ui.listColumns.indexOf('posterRatio')>-1,width:16}],pandora.site.sortKeys.filter(function(key){return!key.capability||pandora.site.capabilities[key.capability][pandora.user.level];}).map(function(key){var position=pandora.user.ui.listColumns.indexOf(key.id);return{addable:key.id!='random',align:['string','text'].indexOf(Ox.isArray(key.type)?key.type[0]:key.type)>-1?'left':key.type=='list'?'center':'right',defaultWidth:key.columnWidth,format:key.format,id:key.id,operator:pandora.getSortOperator(key.id),position:position,removable:!key.columnRequired,title:Ox._(key.title),type:key.type,visible:position>-1,width:pandora.user.ui.listColumnWidth[key.id]||key.columnWidth};})),columnsMovable:true,columnsRemovable:true,columnsResizable:true,columnsVisible:true,draggable:true,id:'list',items:function(data,callback){pandora.api.find(Ox.extend(data,{query:pandora.user.ui.find,keys:data.keys?['modified'].concat(data.keys):void 0}),callback);return Ox.clone(data,true);},scrollbarVisible:true,selected:pandora.user.ui.listSelection,sort:pandora.user.ui.listSort,unique:'id'}).bindEvent({columnchange:function(data){var columnWidth={};pandora.UI.set({listColumns:data.ids});},columnresize:function(data){pandora.UI.set('listColumnWidth.'+data.id,data.width);},resize:function(data){that.size();},sort:function(data){pandora.UI.set({listSort:[{key:data.key,operator:data.operator}]});}});}else if(view=='grid'){that=Ox.IconList({borderRadius:pandora.user.ui.icons=='posters'?0:16,defaultRatio:pandora.user.ui.icons=='posters'?pandora.site.posters.ratio:1,draggable:true,id:'list',item:function(data,sort,size){var ui=pandora.user.ui,ratio=ui.icons=='posters'?(ui.showSitePosters?pandora.site.posters.ratio:data.posterRatio):1,url='/'+data.id+'/'+(ui.icons=='posters'?(ui.showSitePosters?'siteposter':'poster'):'icon')+size+'.jpg?'+data.modified,format,info,sortKey=sort[0].key;if(['title','director','random'].indexOf(sortKey)>-1){info=data['year'];}else{format=pandora.getSortKeyData(sortKey).format;if(format){info=(/^color/.test(format.type.toLowerCase())?Ox.Theme:Ox)['format'+Ox.toTitleCase(format.type)].apply(this,[data[sortKey]].concat(format.args||[]));if(sortKey=='rightslevel'){info.css({width:size*0.75+'px'});}}else{info=data[sortKey];}}
size=size||128;return{height:Math.round(ratio<=1?size:size/ratio),id:data.id,info:info,title:data.title+(data.director&&data.director.length?' ('+data.director.join(', ')+')':''),url:url,width:Math.round(ratio>=1?size:size*ratio)};},items:function(data,callback){pandora.api.find(Ox.extend(data,{query:pandora.user.ui.find}),callback);return Ox.clone(data,true);},keys:['director','id','modified','posterRatio','title','year'],selected:pandora.user.ui.listSelection,size:128,sort:pandora.user.ui.listSort,unique:'id'}).addClass('OxMedia');}else if(view=='info'){that=Ox.Element().css({margin:'16px'}).html(view+' results view still missing.');}else if(view=='clips'){that=Ox.InfoList({borderRadius:pandora.user.ui.icons=='posters'?0:16,defaultRatio:pandora.user.ui.icons=='posters'?pandora.site.posters.ratio:1,draggable:true,id:'list',item:function(data,sort,size){size=128;var ui=pandora.user.ui,ratio=ui.icons=='posters'?(ui.showSitePosters?pandora.site.posters.ratio:data.posterRatio):1,url='/'+data.id+'/'+(ui.icons=='posters'?(ui.showSitePosters?'siteposter':'poster'):'icon')+size+'.jpg?'+data.modified,format,info,sortKey=sort[0].key;if(['title','director'].indexOf(sortKey)>-1){info=data['year'];}else{format=pandora.getSortKeyData(sortKey).format;if(format){info=(/^color/.test(format.type.toLowerCase())?Ox.Theme:Ox)['format'+Ox.toTitleCase(format.type)].apply(this,[data[sortKey]].concat(format.args||[]));if(sortKey=='rightslevel'){info.css({width:size*0.75+'px'});}}else{info=data[sortKey];}}
return{icon:{height:Math.round(ratio<=1?size:size/ratio),id:data.id,info:info,title:data.title+(data.director.length?' ('+data.director.join(', ')+')':''),url:url,width:Math.round(ratio>=1?size:size*ratio)},info:{css:{marginTop:'2px'},element:pandora.ui.itemClips,id:data.id,options:{clips:data.clips,duration:data.duration,id:data.id,ratio:data.videoRatio}}};},items:function(data,callback){pandora.api.find(Ox.extend(data,{query:pandora.user.ui.find,clips:{query:pandora.getClipsQuery(),items:pandora.getClipsItems(),keys:[]}}),callback);return Ox.clone(data,true);},keys:['clips','director','duration','id','modified','posterRatio','title','videoRatio','year'],selected:pandora.user.ui.listSelection,size:192,sort:pandora.user.ui.listSort,unique:'id',width:window.innerWidth
-pandora.user.ui.showSidebar*pandora.user.ui.sidebarSize-1
-Ox.UI.SCROLLBAR_SIZE}).addClass('OxMedia').bindEvent({key_left:function(){},key_right:function(){}});}else if(view=='timelines'){that=Ox.InfoList({borderRadius:pandora.user.ui.icons=='posters'?0:16,defaultRatio:pandora.user.ui.icons=='posters'?pandora.site.posters.ratio:1,draggable:true,id:'list',item:function(data,sort,size){size=128;var clipsQuery=pandora.getClipsQuery(),isClipsQuery=!!clipsQuery.conditions.length,ui=pandora.user.ui,ratio=ui.icons=='posters'?(ui.showSitePosters?pandora.site.posters.ratio:data.posterRatio):1,url='/'+data.id+'/'+(ui.icons=='posters'?(ui.showSitePosters?'siteposter':'poster'):'icon')+size+'.jpg?'+data.modified,format,info,sortKey=sort[0].key;if(['title','director'].indexOf(sortKey)>-1){info=data['year'];}else{format=pandora.getSortKeyData(sortKey).format;if(format){info=(/^color/.test(format.type.toLowerCase())?Ox.Theme:Ox)['format'+Ox.toTitleCase(format.type)].apply(this,[data[sortKey]].concat(format.args||[]));if(sortKey=='rightslevel'){info.css({width:size*0.75+'px'});}}else{info=data[sortKey];}}
return{icon:{height:Math.round(ratio<=1?size:size/ratio),id:data.id,info:info,title:data.title+(data.director.length?' ('+data.director.join(', ')+')':''),url:url,width:Math.round(ratio>=1?size:size*ratio)},info:data.rendered?{css:{marginTop:'2px'},element:Ox.BlockVideoTimeline,events:{position:function(event){if(pandora.user.ui.videoPoints[data.id]){pandora.UI.set('videoPoints.'+data.id+'.position',event.position);}else{pandora.UI.set('videoPoints.'+data.id,{'in':0,out:0,position:event.position});}
pandora.$ui.videoPreview&&pandora.$ui.videoPreview.options({position:event.position});}},id:data.id,options:{duration:data.duration,find:isClipsQuery?clipsQuery.conditions[0].value:'',getImageURL:function(type,i){return'/'+data.id+'/timeline'+type+'16p'+i+'.jpg';},position:pandora.user.ui.videoPoints[data.id]?pandora.user.ui.videoPoints[data.id].position:0,results:isClipsQuery?data.clips.map(function(clip){return{'in':clip['in'],out:clip.out};}):[],subtitles:isClipsQuery?data.clips.map(function(clip){return{'in':clip['in'],out:clip.out,text:clip.annotations[0].value};}):[],type:pandora.user.ui.videoTimeline}}:{css:{marginTop:'2px'},element:Ox.Element,id:data.id,options:{}}};},items:function(data,callback){var clipsQuery=pandora.getClipsQuery(),isClipsQuery=!!clipsQuery.conditions.length;pandora.api.find(Ox.extend(data,Ox.extend({query:pandora.user.ui.find},isClipsQuery?{clips:{query:clipsQuery,items:1000000,keys:[]}}:{})),callback);return Ox.clone(data,true);},keys:['clips','director','duration','id','modified','posterRatio','rendered','title','year'],selected:pandora.user.ui.listSelection,size:192,sort:pandora.user.ui.listSort,unique:'id'}).bindEvent({key_left:function(){},key_right:function(){}});}else if(view=='maps'){that=Ox.Element().css({margin:'16px'}).html(view+' results view still missing.');}else if(view=='calendars'){that=Ox.Element().css({margin:'16px'}).html(view+' results view still missing.');}else if(view=='clip'){that=pandora.$ui.clipList=pandora.ui.clipList();}else if(view=='video'){that=pandora.ui.videoView();}else if(['map','calendar'].indexOf(view)>-1){that=pandora.ui.navigationView(view);}
if(['list','grid','clips','timelines','video'].indexOf(view)>-1){pandora.enableDragAndDrop(that,true);that.bindEvent({closepreview:function(data){pandora.$ui.previewDialog.close();delete pandora.$ui.previewDialog;},copy:function(data){pandora.clipboard.copy(data.ids,'item');},copyadd:function(data){pandora.clipboard.add(data.ids,'item');},cut:function(data){var listData=pandora.getListData();if(listData.editable&&listData.type=='static'){pandora.clipboard.copy(data.ids,'item');pandora.doHistory('cut',data.ids,pandora.user.ui._list,function(){pandora.UI.set({listSelection:[]});pandora.reloadList();});}},cutadd:function(data){var listData=pandora.getListData();if(listData.editable&&listData.type=='static'){pandora.clipboard.add(data.ids,'item');pandora.doHistory('cut',data.ids,pandora.user.ui._list,function(){pandora.UI.set({listSelection:[]});pandora.reloadList();});}},'delete':function(data){var listData=pandora.getListData();if(listData.editable&&listData.type=='static'){pandora.doHistory('delete',data.ids,pandora.user.ui._list,function(){pandora.UI.set({listSelection:[]});pandora.reloadList();});}},init:function(data){var folder,list;if(data.query.conditions.length==0){pandora.$ui.allItems.update(data.items);}else if(data.query.conditions.length==1&&data.query.conditions[0].key=='list'&&data.query.conditions[0].operator=='=='){list=data.query.conditions[0].value;folder=pandora.getListData(list).folder;if(pandora.$ui.folderList[folder]){pandora.$ui.folderList[folder].value(list,'items',data.items);}}
pandora.$ui.statusbar.set('total',data);data=[];pandora.site.totals.forEach(function(v){data[v.id]=0;});pandora.$ui.statusbar.set('selected',data);},open:function(data){var set={item:data.ids[0]};if(data.isSpecialTarget){set.itemView=pandora.user.ui.videoView;}
if(['accessed','timesaccessed'].indexOf(pandora.user.ui.listSort[0].key)>-1){Ox.Request.clearCache('find');}
pandora.UI.set(set);},openpreview:function(data){if(!pandora.$ui.previewDialog){pandora.$ui.previewDialog=pandora.ui.previewDialog().open().bindEvent({close:function(){that.closePreview();delete pandora.$ui.previewDialog;}});}else{pandora.$ui.previewDialog.update();}},paste:function(data){var items=pandora.clipboard.paste();if(items.length&&pandora.clipboard.type()=='item'&&pandora.getListData().editable){pandora.doHistory('paste',items,pandora.user.ui._list,function(){pandora.UI.set({listSelection:items});pandora.reloadList();});}},select:function(data){var query;pandora.UI.set('listSelection',data.ids);if(data.ids.length==0){pandora.$ui.statusbar.set('selected',{items:0});}else{if(Ox.isUndefined(data.rest)){query={conditions:data.ids.map(function(id){return{key:'id',value:id,operator:'=='}}),operator:'|'};}else{query={conditions:[pandora.user.ui.find].concat(data.rest.map(function(id){return{key:'id',value:id,operator:'!='};})),operator:'&'};}
pandora.api.find({query:query},function(result){pandora.$ui.statusbar.set('selected',result.data);});}},pandora_listselection:function(data){that.options({selected:data.value});},pandora_listsort:function(data){that.options({sort:data.value});}});}
if(['list','grid','timelines'].indexOf(view)>-1){that.bindEvent({pandora_icons:function(data){var src,previousSrc;if(hasIcons()){if(pandora.user.ui.listView=='list'){src=Ox.UI.getImageURL(data.value=='posters'?'symbolSetPoster':'symbolIcon');previousSrc=Ox.UI.getImageURL(data.previousValue=='posters'?'symbolSetPoster':'symbolIcon');that.find('img[src="'+previousSrc+'"]').attr({src:src});}else{that.options({borderRadius:data.value=='posters'?0:16,defaultRatio:data.value=='posters'?pandora.site.posters.ratio:1});}
that.reloadList(true);}},pandora_showsiteposters:function(){hasIcons()&&pandora.user.ui.icons=='posters'&&that.reloadList(true);}});}
if(view=='timelines'){that.bindEvent({pandora_videotimeline:function(data){that.reloadList(true);}});}
function hasIcons(){return(pandora.user.ui.listView=='list'&&pandora.user.ui.listColumns.indexOf('posterRatio')>-1)||['grid','timelines'].indexOf(pandora.user.ui.listView)>-1;}
return that;};